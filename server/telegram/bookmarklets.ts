import crypto from "crypto";

export function generateScanToken(chatId: string, businessId: number): string {
  const secret = process.env.SESSION_SECRET || "gemin-eye-default";
  return crypto.createHmac("sha256", secret).update(`${chatId}:${businessId}`).digest("hex").slice(0, 32);
}

export function generateLinkedInBookmarkletCode(baseUrl: string, chatId: string, businessId: number, token: string): string {
  const apiUrl = `${baseUrl}/api/li-scan`;
  const code = `javascript:void((function(){if(window.__geminEyeLiActive){alert('Gemin-Eye is already scanning this page. Click X on the banner to stop first.');return}window.__geminEyeLiActive=true;var CID='${chatId}',BID=${businessId},TOK='${token}',API='${apiUrl}';var seenPosts={},scannedCount=0,sentCount=0,pendingCount=0,autoScrolling=true,scrollsDone=0,maxScrolls=150,noNewCount=0;var banner=document.createElement('div');banner.id='gemin-eye-li-banner';banner.style.cssText='position:fixed;top:0;left:0;width:100%;background:linear-gradient(135deg,#0077B5,#00A0DC);color:white;padding:10px 20px;z-index:2147483647;font-family:system-ui,sans-serif;font-size:14px;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.2);display:flex;align-items:center;justify-content:center;gap:10px;';var counter=document.createElement('span');counter.style.cssText='font-weight:normal;opacity:0.85;font-size:13px;';counter.textContent='0 scanned';function updateCounter(){var t=scannedCount+' scanned, '+sentCount+' leads';if(pendingCount>0)t+=' ('+pendingCount+' checking...)';if(!autoScrolling&&scrollsDone>=maxScrolls)t+=' - Done';counter.textContent=t}var pauseBtn=document.createElement('span');pauseBtn.textContent='Pause';pauseBtn.style.cssText='cursor:pointer;background:rgba(255,255,255,0.25);padding:4px 14px;border-radius:4px;font-size:12px;font-weight:700;';pauseBtn.onclick=function(){autoScrolling=!autoScrolling;pauseBtn.textContent=autoScrolling?'Pause':'Resume'};var closeBtn=document.createElement('span');closeBtn.textContent='[X] Close';closeBtn.style.cssText='cursor:pointer;background:rgba(255,0,0,0.35);padding:4px 12px;border-radius:4px;font-size:12px;font-weight:700;margin-left:4px;';closeBtn.onclick=function(){banner.remove();window.__geminEyeLiActive=false;autoScrolling=false;clearInterval(si);clearInterval(scrollInterval)};banner.appendChild(document.createTextNode('Gemin-Eye LinkedIn '));banner.appendChild(counter);banner.appendChild(pauseBtn);banner.appendChild(closeBtn);document.body.appendChild(banner);function extractPosts(){var found=[];var els=document.querySelectorAll('.feed-shared-update-v2__description,.feed-shared-inline-show-more-text,.feed-shared-text,.update-components-text,.break-words');els.forEach(function(el){var t=(el.innerText||'').trim();if(t.length<25||t.length>5000||seenPosts[t])return;found.push({text:t,element:el})});return found}function sendPost(text,el){seenPosts[text]=true;scannedCount++;pendingCount++;updateCounter();var authorName='';try{var card=el.closest('.feed-shared-update-v2');if(card){var nameEl=card.querySelector('.update-components-actor__name span[aria-hidden],.feed-shared-actor__name span');if(nameEl)authorName=nameEl.innerText||''}}catch(e){}fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chatId:CID,businessId:BID,token:TOK,postText:text,authorName:authorName||'LinkedIn user',pageUrl:window.location.href})}).then(function(r){return r.json()}).then(function(d){pendingCount--;if(d.matched){sentCount++;el.style.outline='3px solid #0077B5';el.style.outlineOffset='4px';el.style.borderRadius='4px'}updateCounter()}).catch(function(){pendingCount--;updateCounter()})}function scan(){var posts=extractPosts();if(posts.length===0)noNewCount++;else noNewCount=0;posts.forEach(function(p){if(scannedCount>=500)return;sendPost(p.text,p.element)});if(scannedCount>=500||noNewCount>=10){autoScrolling=false;clearInterval(scrollInterval);updateCounter()}}scan();var si=setInterval(scan,2000);var scrollInterval=setInterval(function(){if(!autoScrolling)return;scrollsDone++;if(scrollsDone>=maxScrolls){autoScrolling=false;clearInterval(scrollInterval);updateCounter();return}window.scrollBy({top:600,behavior:'smooth'})},1500)})())`;
  return code;
}

export function generateBookmarkletCode(baseUrl: string, chatId: string, businessId: number, token: string): string {
  const apiUrl = `${baseUrl}/api/fb-scan`;
  const code = `javascript:void((function(){if(window.__geminEyeActive){alert('Gemin-Eye is already scanning this page. Click X on the banner to stop first.');return}window.__geminEyeActive=true;var CID='${chatId}',BID=${businessId},TOK='${token}',API='${apiUrl}';var seenPosts={},scannedCount=0,sentCount=0,pendingCount=0,autoScrolling=true,scrollsDone=0,maxScrolls=150,noNewCount=0;var banner=document.createElement('div');banner.id='gemin-eye-banner';banner.style.cssText='position:fixed;top:0;left:0;width:100%;background:linear-gradient(135deg,#4338ca,#6d28d9);color:white;padding:10px 20px;z-index:2147483647;font-family:system-ui,sans-serif;font-size:14px;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.2);display:flex;align-items:center;justify-content:center;gap:10px;';var counter=document.createElement('span');counter.style.cssText='font-weight:normal;opacity:0.85;font-size:13px;';counter.textContent='0 scanned';function updateCounter(){var t=scannedCount+' scanned, '+sentCount+' leads';if(pendingCount>0)t+=' ('+pendingCount+' checking...)';if(!autoScrolling&&scrollsDone>=maxScrolls)t+=' - Done';counter.textContent=t}var pauseBtn=document.createElement('span');pauseBtn.textContent='Pause';pauseBtn.style.cssText='cursor:pointer;background:rgba(255,255,255,0.25);padding:4px 14px;border-radius:4px;font-size:12px;font-weight:700;';pauseBtn.onclick=function(){autoScrolling=!autoScrolling;pauseBtn.textContent=autoScrolling?'Pause':'Resume'};var closeBtn=document.createElement('span');closeBtn.textContent='[X] Close';closeBtn.style.cssText='cursor:pointer;background:rgba(255,0,0,0.35);padding:4px 12px;border-radius:4px;font-size:12px;font-weight:700;margin-left:4px;';closeBtn.onclick=function(){banner.remove();window.__geminEyeActive=false;autoScrolling=false;clearInterval(si);clearInterval(scrollInterval)};banner.appendChild(document.createTextNode('Gemin-Eye '));banner.appendChild(counter);banner.appendChild(pauseBtn);banner.appendChild(closeBtn);document.body.appendChild(banner);function extractPosts(){var found=[];var els=document.querySelectorAll('div[dir="auto"]');els.forEach(function(el){var t=(el.innerText||'').trim();if(t.length<25||t.length>5000||seenPosts[t])return;var a=el.closest('a');if(a&&a.href&&a.href.indexOf('/comment')===-1)return;found.push({text:t,element:el})});return found}function sendPost(text,el){seenPosts[text]=true;scannedCount++;pendingCount++;updateCounter();var groupName='';var h1=document.querySelector('h1');if(h1)groupName=h1.innerText||'';if(!groupName){var titleEl=document.querySelector('[role="banner"] a[href*="/groups/"]');if(titleEl)groupName=titleEl.innerText||''}fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chatId:CID,businessId:BID,token:TOK,postText:text,groupName:groupName||document.title||'Facebook Group',pageUrl:window.location.href})}).then(function(r){return r.json()}).then(function(d){pendingCount--;if(d.matched){sentCount++;el.style.outline='3px solid #6d28d9';el.style.outlineOffset='4px';el.style.borderRadius='4px'}updateCounter()}).catch(function(){pendingCount--;updateCounter()})}function scan(){var posts=extractPosts();if(posts.length===0)noNewCount++;else noNewCount=0;posts.forEach(function(p){if(scannedCount>=500)return;sendPost(p.text,p.element)});if(scannedCount>=500||noNewCount>=10){autoScrolling=false;clearInterval(scrollInterval);updateCounter()}}scan();var si=setInterval(scan,2000);var scrollInterval=setInterval(function(){if(!autoScrolling)return;scrollsDone++;if(scrollsDone>=maxScrolls){autoScrolling=false;clearInterval(scrollInterval);updateCounter();return}window.scrollBy({top:600,behavior:'smooth'})},1500)})())`;
  return code;
}

export function getAppBaseUrl(): string {
  const replitDevDomain = process.env.REPLIT_DEV_DOMAIN;
  if (replitDevDomain) return `https://${replitDevDomain}`;
  const replSlug = process.env.REPL_SLUG;
  const replOwner = process.env.REPL_OWNER;
  if (replSlug && replOwner) return `https://${replSlug}.${replOwner}.repl.co`;
  return "https://gemin-eye.com";
}
