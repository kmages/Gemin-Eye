{"file_contents":{"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":711,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3895,"size_tokens":null},"client/src/hooks/use-auth.ts":{"content":"import { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport type { User } from \"@shared/models/auth\";\n\nasync function fetchUser(): Promise<User | null> {\n  const response = await fetch(\"/api/auth/user\", {\n    credentials: \"include\",\n  });\n\n  if (response.status === 401) {\n    return null;\n  }\n\n  if (!response.ok) {\n    throw new Error(`${response.status}: ${response.statusText}`);\n  }\n\n  return response.json();\n}\n\nasync function logout(): Promise<void> {\n  window.location.href = \"/api/logout\";\n}\n\nexport function useAuth() {\n  const queryClient = useQueryClient();\n  const { data: user, isLoading } = useQuery<User | null>({\n    queryKey: [\"/api/auth/user\"],\n    queryFn: fetchUser,\n    retry: false,\n    staleTime: 1000 * 60 * 5, // 5 minutes\n  });\n\n  const logoutMutation = useMutation({\n    mutationFn: logout,\n    onSuccess: () => {\n      queryClient.setQueryData([\"/api/auth/user\"], null);\n    },\n  });\n\n  return {\n    user,\n    isLoading,\n    isAuthenticated: !!user,\n    logout: logoutMutation.mutate,\n    isLoggingOut: logoutMutation.isPending,\n  };\n}\n","path":null,"size_bytes":1091,"size_tokens":null},"shared/models/auth.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { index, jsonb, pgTable, timestamp, varchar } from \"drizzle-orm/pg-core\";\n\n// Session storage table.\n// (IMPORTANT) This table is mandatory for Replit Auth, don't drop it.\nexport const sessions = pgTable(\n  \"sessions\",\n  {\n    sid: varchar(\"sid\").primaryKey(),\n    sess: jsonb(\"sess\").notNull(),\n    expire: timestamp(\"expire\").notNull(),\n  },\n  (table) => [index(\"IDX_session_expire\").on(table.expire)]\n);\n\n// User storage table.\n// (IMPORTANT) This table is mandatory for Replit Auth, don't drop it.\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  email: varchar(\"email\").unique(),\n  firstName: varchar(\"first_name\"),\n  lastName: varchar(\"last_name\"),\n  profileImageUrl: varchar(\"profile_image_url\"),\n  role: varchar(\"role\").notNull().default(\"user\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport type UpsertUser = typeof users.$inferInsert;\nexport type User = typeof users.$inferSelect;\n","path":null,"size_bytes":1061,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5741,"size_tokens":null},"server/replit_integrations/batch/utils.ts":{"content":"import pLimit from \"p-limit\";\nimport pRetry from \"p-retry\";\n\n/**\n * Batch Processing Utilities for Gemini\n *\n * Supported models: gemini-2.5-flash (fast), gemini-2.5-pro (advanced reasoning), gemini-2.5-flash-image (image generation)\n *\n * USAGE:\n * ```typescript\n * import { batchProcess } from \"./replit_integrations/batch\";\n * import { GoogleGenAI } from \"@google/genai\";\n *\n * const ai = new GoogleGenAI({\n *   apiKey: process.env.AI_INTEGRATIONS_GEMINI_API_KEY,\n *   httpOptions: {\n *     apiVersion: \"\",\n *     baseUrl: process.env.AI_INTEGRATIONS_GEMINI_BASE_URL,\n *   },\n * });\n *\n * const results = await batchProcess(\n *   items,\n *   async (item) => {\n *     const response = await ai.models.generateContent({\n *       model: \"gemini-2.5-flash\",\n *       contents: `Process: ${item.name}`,\n *     });\n *     return response.text || \"\";\n *   }\n * );\n * ```\n */\n\nexport interface BatchOptions {\n  /** Max concurrent requests (default: 2) */\n  concurrency?: number;\n  /** Max retry attempts for rate limit errors (default: 7) */\n  retries?: number;\n  /** Initial retry delay in ms (default: 2000) */\n  minTimeout?: number;\n  /** Max retry delay in ms (default: 128000) */\n  maxTimeout?: number;\n  /** Callback for progress updates */\n  onProgress?: (completed: number, total: number, item: unknown) => void;\n}\n\n/**\n * Check if an error is a rate limit or quota violation.\n */\nexport function isRateLimitError(error: unknown): boolean {\n  const errorMsg = error instanceof Error ? error.message : String(error);\n  return (\n    errorMsg.includes(\"429\") ||\n    errorMsg.includes(\"RATELIMIT_EXCEEDED\") ||\n    errorMsg.toLowerCase().includes(\"quota\") ||\n    errorMsg.toLowerCase().includes(\"rate limit\")\n  );\n}\n\n/**\n * Process items in batches with rate limiting and automatic retries.\n *\n * @param items - Array of items to process\n * @param processor - Async function to process each item (write your LLM logic here)\n * @param options - Concurrency and retry settings\n * @returns Promise resolving to array of results in the same order as input\n */\nexport async function batchProcess<T, R>(\n  items: T[],\n  processor: (item: T, index: number) => Promise<R>,\n  options: BatchOptions = {}\n): Promise<R[]> {\n  const {\n    concurrency = 2,\n    retries = 7,\n    minTimeout = 2000,\n    maxTimeout = 128000,\n    onProgress,\n  } = options;\n\n  const limit = pLimit(concurrency);\n  let completed = 0;\n\n  const promises = items.map((item, index) =>\n    limit(() =>\n      pRetry(\n        async () => {\n          try {\n            const result = await processor(item, index);\n            completed++;\n            onProgress?.(completed, items.length, item);\n            return result;\n          } catch (error: unknown) {\n            if (isRateLimitError(error)) {\n              throw error;\n            }\n            throw new pRetry.AbortError(\n              error instanceof Error ? error : new Error(String(error))\n            );\n          }\n        },\n        { retries, minTimeout, maxTimeout, factor: 2 }\n      )\n    )\n  );\n\n  return Promise.all(promises);\n}\n\n/**\n * Process items sequentially with SSE progress streaming.\n */\nexport async function batchProcessWithSSE<T, R>(\n  items: T[],\n  processor: (item: T, index: number) => Promise<R>,\n  sendEvent: (event: { type: string; [key: string]: unknown }) => void,\n  options: Omit<BatchOptions, \"concurrency\" | \"onProgress\"> = {}\n): Promise<R[]> {\n  const { retries = 5, minTimeout = 1000, maxTimeout = 15000 } = options;\n\n  sendEvent({ type: \"started\", total: items.length });\n\n  const results: R[] = [];\n  let errors = 0;\n\n  for (let index = 0; index < items.length; index++) {\n    const item = items[index];\n    sendEvent({ type: \"processing\", index, item });\n\n    try {\n      const result = await pRetry(() => processor(item, index), {\n        retries,\n        minTimeout,\n        maxTimeout,\n        factor: 2,\n        onFailedAttempt: (error) => {\n          if (!isRateLimitError(error)) {\n            throw new pRetry.AbortError(\n              error instanceof Error ? error : new Error(String(error))\n            );\n          }\n        },\n      });\n      results.push(result);\n      sendEvent({ type: \"progress\", index, result });\n    } catch (error) {\n      errors++;\n      results.push(undefined as R);\n      sendEvent({\n        type: \"progress\",\n        index,\n        error: error instanceof Error ? error.message : \"Processing failed\",\n      });\n    }\n  }\n\n  sendEvent({ type: \"complete\", processed: items.length, errors });\n  return results;\n}\n","path":null,"size_bytes":4507,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n  \" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground border border-destructive-border\",\n        outline:\n          // Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color.\n          \" border [border-color:var(--button-outline)]  shadow-xs active:shadow-none \",\n        secondary: \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // Add a transparent border so that when someone toggles a border on later, it doesn't shift layout/size.\n        ghost: \"border border-transparent\",\n      },\n      // Heights are set as \"min\" heights, because sometimes Ai will place large amount of content\n      // inside buttons. With a min-height they will look appropriate with small amounts of content,\n      // but will expand to fit large amounts of content.\n      size: {\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  },\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  },\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":2359,"size_tokens":null},"client/src/pages/dashboard.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { useLocation } from \"wouter\";\nimport { Card } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport {\n  Eye, Target, MessageCircle, TrendingUp, Copy, ExternalLink,\n  CheckCircle, Clock, AlertCircle, Zap, ArrowRight, LogOut, Plus, Users, Send, Settings,\n  Search, Monitor, Check\n} from \"lucide-react\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { SiFacebook, SiLinkedin } from \"react-icons/si\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { Business, Campaign, Lead, AiResponse } from \"@shared/schema\";\n\nfunction StatCard({ title, value, icon: Icon, trend, color }: {\n  title: string; value: string | number; icon: any; trend?: string; color: string;\n}) {\n  return (\n    <Card className=\"p-5 space-y-3\" data-testid={`stat-${title.toLowerCase().replace(/\\s+/g, \"-\")}`}>\n      <div className=\"flex items-center justify-between gap-4\">\n        <span className=\"text-sm text-muted-foreground\">{title}</span>\n        <div className={`w-9 h-9 rounded-md ${color} flex items-center justify-center`}>\n          <Icon className=\"w-4 h-4\" />\n        </div>\n      </div>\n      <div className=\"flex items-end justify-between gap-4\">\n        <span className=\"text-2xl font-bold\">{value}</span>\n        {trend && (\n          <span className=\"text-xs text-chart-2 flex items-center gap-1\">\n            <TrendingUp className=\"w-3 h-3\" /> {trend}\n          </span>\n        )}\n      </div>\n    </Card>\n  );\n}\n\nfunction LeadCard({ lead, response }: { lead: Lead; response?: AiResponse }) {\n  const { toast } = useToast();\n\n  const statusConfig: Record<string, { label: string; variant: \"default\" | \"secondary\" | \"destructive\"; icon: any }> = {\n    new: { label: \"New\", variant: \"default\", icon: AlertCircle },\n    responded: { label: \"Responded\", variant: \"secondary\", icon: CheckCircle },\n    pending: { label: \"Pending\", variant: \"secondary\", icon: Clock },\n  };\n\n  const config = statusConfig[lead.status] || statusConfig.new;\n\n  const handleCopy = () => {\n    if (response) {\n      navigator.clipboard.writeText(response.content);\n      toast({ title: \"Copied!\", description: \"Response copied to clipboard.\" });\n    }\n  };\n\n  const sendToTelegram = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest(\"POST\", \"/api/telegram/notify-lead\", { leadId: lead.id });\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Sent to Telegram\", description: \"Lead notification sent to your Telegram.\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed\", description: \"Could not send to Telegram.\", variant: \"destructive\" });\n    },\n  });\n\n  return (\n    <Card className=\"p-5 space-y-4\" data-testid={`card-lead-${lead.id}`}>\n      <div className=\"flex items-start justify-between gap-3\">\n        <div className=\"flex items-center gap-3 min-w-0\">\n          <div className=\"w-9 h-9 rounded-full bg-primary/10 flex-shrink-0 flex items-center justify-center\">\n            <MessageCircle className=\"w-4 h-4 text-primary\" />\n          </div>\n          <div className=\"min-w-0\">\n            <p className=\"text-sm font-medium truncate\">{lead.authorName}</p>\n            <p className=\"text-xs text-muted-foreground truncate\">{lead.groupName} &middot; {lead.platform}</p>\n          </div>\n        </div>\n        <div className=\"flex items-center gap-2 flex-shrink-0\">\n          <Badge variant={config.variant} className=\"text-xs\">\n            <config.icon className=\"w-3 h-3 mr-1\" />\n            {config.label}\n          </Badge>\n          <Badge variant=\"secondary\" className=\"text-xs\">\n            {lead.intentScore}/10\n          </Badge>\n        </div>\n      </div>\n\n      <p className=\"text-sm leading-relaxed bg-muted/50 p-3 rounded-md\" data-testid={`text-lead-post-${lead.id}`}>\n        \"{lead.originalPost}\"\n      </p>\n\n      {response && (\n        <div className=\"space-y-2\">\n          <div className=\"flex items-center gap-2\">\n            <Zap className=\"w-3 h-3 text-chart-2\" />\n            <span className=\"text-xs font-medium text-chart-2\">AI Response</span>\n          </div>\n          <p className=\"text-sm leading-relaxed text-muted-foreground\" data-testid={`text-response-${lead.id}`}>\n            {response.content}\n          </p>\n          <div className=\"flex flex-wrap items-center gap-2 pt-1\">\n            <Button variant=\"outline\" size=\"sm\" onClick={handleCopy} data-testid={`button-copy-${lead.id}`}>\n              <Copy className=\"w-3 h-3 mr-1\" /> Copy\n            </Button>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => sendToTelegram.mutate()}\n              disabled={sendToTelegram.isPending}\n              data-testid={`button-telegram-${lead.id}`}\n            >\n              <Send className=\"w-3 h-3 mr-1\" /> {sendToTelegram.isPending ? \"Sending...\" : \"Send to Telegram\"}\n            </Button>\n            {lead.postUrl && (\n              <Button variant=\"outline\" size=\"sm\" asChild data-testid={`button-link-${lead.id}`}>\n                <a href={lead.postUrl} target=\"_blank\" rel=\"noopener noreferrer\">\n                  <ExternalLink className=\"w-3 h-3 mr-1\" /> Open Post\n                </a>\n              </Button>\n            )}\n          </div>\n        </div>\n      )}\n    </Card>\n  );\n}\n\nfunction CampaignCard({ campaign }: { campaign: Campaign }) {\n  return (\n    <Card className=\"p-5 space-y-3 hover-elevate\" data-testid={`card-campaign-${campaign.id}`}>\n      <div className=\"flex items-center justify-between gap-3\">\n        <h3 className=\"font-semibold truncate\">{campaign.name}</h3>\n        <Badge variant={campaign.status === \"active\" ? \"default\" : \"secondary\"} className=\"text-xs flex-shrink-0\">\n          {campaign.status}\n        </Badge>\n      </div>\n      <div className=\"flex items-center gap-3\">\n        <Badge variant=\"secondary\" className=\"text-xs\">{campaign.platform}</Badge>\n        <span className=\"text-xs text-muted-foreground\">\n          {(campaign.targetGroups as string[])?.length || 0} groups\n        </span>\n      </div>\n      {campaign.keywords && (campaign.keywords as string[]).length > 0 && (\n        <div className=\"flex flex-wrap gap-1.5\">\n          {(campaign.keywords as string[]).slice(0, 4).map((kw, i) => (\n            <span key={i} className=\"text-xs bg-muted px-2 py-0.5 rounded-md text-muted-foreground\">\n              {kw}\n            </span>\n          ))}\n          {(campaign.keywords as string[]).length > 4 && (\n            <span className=\"text-xs text-muted-foreground\">+{(campaign.keywords as string[]).length - 4} more</span>\n          )}\n        </div>\n      )}\n    </Card>\n  );\n}\n\ninterface BookmarkletInfo {\n  businessId: number;\n  businessName: string;\n  bookmarkletPageUrl: string;\n  facebookCode: string;\n  linkedinCode: string;\n}\n\nfunction SpyGlassCopyButton({ code, label, icon: Icon, testId }: { code: string; label: string; icon: any; testId: string }) {\n  const [copied, setCopied] = useState(false);\n  const { toast } = useToast();\n\n  const handleCopy = async () => {\n    try {\n      await navigator.clipboard.writeText(code);\n      setCopied(true);\n      toast({ title: \"Copied!\", description: `${label} bookmarklet code copied to clipboard.` });\n      setTimeout(() => setCopied(false), 2000);\n    } catch {\n      toast({ title: \"Copy failed\", description: \"Please try selecting and copying manually.\", variant: \"destructive\" });\n    }\n  };\n\n  return (\n    <Button variant=\"outline\" onClick={handleCopy} data-testid={testId}>\n      <Icon className=\"w-4 h-4 mr-2\" />\n      {copied ? <><Check className=\"w-3 h-3 mr-1\" /> Copied!</> : `Copy ${label}`}\n    </Button>\n  );\n}\n\nfunction SpyGlassSection({ bookmarklets }: { bookmarklets: BookmarkletInfo[] }) {\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex items-center gap-2\">\n        <h2 className=\"text-lg font-semibold\" data-testid=\"text-spyglass-title\">Spy Glass Tools</h2>\n        <Badge variant=\"secondary\" className=\"text-xs\">Desktop</Badge>\n      </div>\n      <p className=\"text-sm text-muted-foreground\">\n        Scan Facebook groups and LinkedIn from your desktop browser. Copy a bookmarklet code, save it as a browser bookmark, then click it while on Facebook or LinkedIn to scan for leads.\n      </p>\n      <div className=\"grid gap-4\">\n        {bookmarklets.map((bm) => (\n          <Card key={bm.businessId} className=\"p-5 space-y-4\" data-testid={`card-spyglass-${bm.businessId}`}>\n            <div className=\"flex items-center justify-between gap-3 flex-wrap\">\n              <h3 className=\"font-medium\" data-testid={`text-spyglass-biz-${bm.businessId}`}>{bm.businessName}</h3>\n              <Button variant=\"ghost\" size=\"sm\" onClick={() => window.open(bm.bookmarkletPageUrl, '_blank')} data-testid={`button-spyglass-page-${bm.businessId}`}>\n                <ExternalLink className=\"w-3 h-3 mr-1\" /> Full Setup Guide\n              </Button>\n            </div>\n            <div className=\"flex items-center gap-3 flex-wrap\">\n              <SpyGlassCopyButton\n                code={bm.facebookCode}\n                label=\"Facebook\"\n                icon={SiFacebook}\n                testId={`button-copy-fb-${bm.businessId}`}\n              />\n              <SpyGlassCopyButton\n                code={bm.linkedinCode}\n                label=\"LinkedIn\"\n                icon={SiLinkedin}\n                testId={`button-copy-li-${bm.businessId}`}\n              />\n            </div>\n          </Card>\n        ))}\n      </div>\n    </div>\n  );\n}\n\nexport default function Dashboard() {\n  const { user, isLoading: authLoading, logout } = useAuth();\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n\n  const { data: adminCheck } = useQuery<{ isAdmin: boolean }>({\n    queryKey: [\"/api/admin/check\"],\n    enabled: !!user,\n  });\n\n  useEffect(() => {\n    if (!authLoading && !user) {\n      window.location.href = \"/\";\n    }\n  }, [authLoading, user]);\n\n  const { data: businesses, isLoading: bizLoading } = useQuery<Business[]>({\n    queryKey: [\"/api/businesses\"],\n    enabled: !!user,\n  });\n\n  const { data: campaigns, isLoading: campLoading } = useQuery<Campaign[]>({\n    queryKey: [\"/api/campaigns\"],\n    enabled: !!user,\n  });\n\n  const { data: leadsData, isLoading: leadsLoading } = useQuery<{ leads: Lead[]; responses: AiResponse[] }>({\n    queryKey: [\"/api/leads\"],\n    enabled: !!user,\n  });\n\n  const { data: bookmarklets } = useQuery<BookmarkletInfo[]>({\n    queryKey: [\"/api/my-bookmarklets\"],\n    enabled: !!user,\n  });\n\n  if (authLoading) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center\">\n        <div className=\"space-y-4 text-center\">\n          <Eye className=\"w-8 h-8 text-primary mx-auto animate-pulse\" />\n          <p className=\"text-sm text-muted-foreground\">Loading...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!user) return null;\n\n  const leads = leadsData?.leads || [];\n  const responses = leadsData?.responses || [];\n  const hasBusiness = businesses && businesses.length > 0;\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <header className=\"sticky top-0 z-50 backdrop-blur-xl bg-background/80 border-b\">\n        <div className=\"max-w-6xl mx-auto px-4 sm:px-6 h-16 flex items-center justify-between gap-4\">\n          <div className=\"flex items-center gap-2\">\n            <img src=\"/images/logo.png\" alt=\"Gemin-Eye\" className=\"w-6 h-6\" />\n            <span className=\"font-semibold text-lg tracking-tight\">Gemin-Eye</span>\n          </div>\n          <div className=\"flex items-center gap-3\">\n            {adminCheck?.isAdmin && (\n              <Button variant=\"ghost\" size=\"icon\" onClick={() => setLocation(\"/admin\")} data-testid=\"button-admin\">\n                <Settings className=\"w-4 h-4\" />\n              </Button>\n            )}\n            <Avatar className=\"w-8 h-8\">\n              <AvatarImage src={user.profileImageUrl || \"\"} />\n              <AvatarFallback className=\"text-xs\">{user.firstName?.[0] || user.email?.[0] || \"U\"}</AvatarFallback>\n            </Avatar>\n            <span className=\"text-sm hidden sm:block\">{user.firstName || user.email}</span>\n            <Button variant=\"ghost\" size=\"icon\" onClick={() => logout()} data-testid=\"button-logout\">\n              <LogOut className=\"w-4 h-4\" />\n            </Button>\n          </div>\n        </div>\n      </header>\n\n      <main className=\"max-w-6xl mx-auto px-4 sm:px-6 py-8 space-y-8\">\n        {!hasBusiness ? (\n          <div className=\"text-center py-20 space-y-6\">\n            <div className=\"w-16 h-16 mx-auto rounded-full bg-primary/10 flex items-center justify-center\">\n              <Eye className=\"w-8 h-8 text-primary\" />\n            </div>\n            <div className=\"space-y-2\">\n              <h2 className=\"text-2xl font-serif font-bold\">Welcome to Gemin-Eye</h2>\n              <p className=\"text-muted-foreground max-w-md mx-auto\">\n                Set up your business profile and let AI generate your customer acquisition strategy.\n              </p>\n            </div>\n            <Button size=\"lg\" onClick={() => setLocation(\"/onboarding\")} data-testid=\"button-setup-business\">\n              Set Up Your Business <ArrowRight className=\"w-4 h-4 ml-2\" />\n            </Button>\n          </div>\n        ) : (\n          <>\n            <div className=\"flex items-center justify-between gap-4\">\n              <div>\n                <h1 className=\"text-2xl font-bold\" data-testid=\"text-dashboard-title\">Dashboard</h1>\n                <p className=\"text-sm text-muted-foreground\">{businesses?.[0]?.name}</p>\n              </div>\n              <Button onClick={() => setLocation(\"/onboarding\")} data-testid=\"button-new-campaign\">\n                <Plus className=\"w-4 h-4 mr-1\" /> New Campaign\n              </Button>\n            </div>\n\n            <div className=\"grid grid-cols-2 lg:grid-cols-4 gap-4\">\n              <StatCard\n                title=\"Active Campaigns\"\n                value={campaigns?.filter((c) => c.status === \"active\").length || 0}\n                icon={Target}\n                color=\"bg-primary/10 text-primary\"\n              />\n              <StatCard\n                title=\"Leads Found\"\n                value={leads.length}\n                icon={Users}\n                color=\"bg-chart-2/10 text-chart-2\"\n              />\n              <StatCard\n                title=\"Responses Sent\"\n                value={responses.filter((r) => r.status === \"approved\").length}\n                icon={MessageCircle}\n                color=\"bg-chart-3/10 text-chart-3\"\n              />\n              <StatCard\n                title=\"Avg. Intent Score\"\n                value={leads.length > 0 ? (leads.reduce((s, l) => s + l.intentScore, 0) / leads.length).toFixed(1) : \"0\"}\n                icon={Zap}\n                color=\"bg-chart-4/10 text-chart-4\"\n              />\n            </div>\n\n            {bookmarklets && bookmarklets.length > 0 && (\n              <SpyGlassSection bookmarklets={bookmarklets} />\n            )}\n\n            {campaigns && campaigns.length > 0 && (\n              <div className=\"space-y-4\">\n                <h2 className=\"text-lg font-semibold\" data-testid=\"text-campaigns-title\">Active Campaigns</h2>\n                <div className=\"grid md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                  {campaigns.map((c) => (\n                    <CampaignCard key={c.id} campaign={c} />\n                  ))}\n                </div>\n              </div>\n            )}\n\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center justify-between gap-4\">\n                <h2 className=\"text-lg font-semibold\" data-testid=\"text-leads-title\">Recent Leads</h2>\n                {leads.length > 0 && (\n                  <Badge variant=\"secondary\" className=\"text-xs\">{leads.length} total</Badge>\n                )}\n              </div>\n              {leadsLoading ? (\n                <div className=\"space-y-4\">\n                  {[1, 2, 3].map((i) => (\n                    <Skeleton key={i} className=\"h-40 w-full rounded-md\" />\n                  ))}\n                </div>\n              ) : leads.length === 0 ? (\n                <Card className=\"p-8 text-center space-y-3\">\n                  <Target className=\"w-8 h-8 mx-auto text-muted-foreground\" />\n                  <p className=\"text-sm text-muted-foreground\">No leads yet. Your AI agent is monitoring target groups.</p>\n                </Card>\n              ) : (\n                <div className=\"space-y-4\">\n                  {leads.map((lead) => {\n                    const resp = responses.find((r) => r.leadId === lead.id);\n                    return <LeadCard key={lead.id} lead={lead} response={resp} />;\n                  })}\n                </div>\n              )}\n            </div>\n          </>\n        )}\n      </main>\n    </div>\n  );\n}\n","path":null,"size_bytes":17132,"size_tokens":null},"server/replit_integrations/auth/replitAuth.ts":{"content":"import * as client from \"openid-client\";\nimport { Strategy, type VerifyFunction } from \"openid-client/passport\";\n\nimport passport from \"passport\";\nimport session from \"express-session\";\nimport type { Express, RequestHandler } from \"express\";\nimport memoize from \"memoizee\";\nimport connectPg from \"connect-pg-simple\";\nimport { authStorage } from \"./storage\";\n\nconst getOidcConfig = memoize(\n  async () => {\n    return await client.discovery(\n      new URL(process.env.ISSUER_URL ?? \"https://replit.com/oidc\"),\n      process.env.REPL_ID!\n    );\n  },\n  { maxAge: 3600 * 1000 }\n);\n\nexport function getSession() {\n  const sessionTtl = 7 * 24 * 60 * 60 * 1000; // 1 week\n  const pgStore = connectPg(session);\n  const sessionStore = new pgStore({\n    conString: process.env.DATABASE_URL,\n    createTableIfMissing: false,\n    ttl: sessionTtl,\n    tableName: \"sessions\",\n  });\n  return session({\n    secret: process.env.SESSION_SECRET!,\n    store: sessionStore,\n    resave: false,\n    saveUninitialized: false,\n    cookie: {\n      httpOnly: true,\n      secure: true,\n      maxAge: sessionTtl,\n    },\n  });\n}\n\nfunction updateUserSession(\n  user: any,\n  tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers\n) {\n  user.claims = tokens.claims();\n  user.access_token = tokens.access_token;\n  user.refresh_token = tokens.refresh_token;\n  user.expires_at = user.claims?.exp;\n}\n\nasync function upsertUser(claims: any) {\n  await authStorage.upsertUser({\n    id: claims[\"sub\"],\n    email: claims[\"email\"],\n    firstName: claims[\"first_name\"],\n    lastName: claims[\"last_name\"],\n    profileImageUrl: claims[\"profile_image_url\"],\n  });\n}\n\nexport async function setupAuth(app: Express) {\n  app.set(\"trust proxy\", 1);\n  app.use(getSession());\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  const config = await getOidcConfig();\n\n  const verify: VerifyFunction = async (\n    tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers,\n    verified: passport.AuthenticateCallback\n  ) => {\n    const user = {};\n    updateUserSession(user, tokens);\n    await upsertUser(tokens.claims());\n    verified(null, user);\n  };\n\n  // Keep track of registered strategies\n  const registeredStrategies = new Set<string>();\n\n  // Helper function to ensure strategy exists for a domain\n  const ensureStrategy = (domain: string) => {\n    const strategyName = `replitauth:${domain}`;\n    if (!registeredStrategies.has(strategyName)) {\n      const strategy = new Strategy(\n        {\n          name: strategyName,\n          config,\n          scope: \"openid email profile offline_access\",\n          callbackURL: `https://${domain}/api/callback`,\n        },\n        verify\n      );\n      passport.use(strategy);\n      registeredStrategies.add(strategyName);\n    }\n  };\n\n  passport.serializeUser((user: Express.User, cb) => cb(null, user));\n  passport.deserializeUser((user: Express.User, cb) => cb(null, user));\n\n  app.get(\"/api/login\", (req, res, next) => {\n    ensureStrategy(req.hostname);\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      prompt: \"login consent\",\n      scope: [\"openid\", \"email\", \"profile\", \"offline_access\"],\n    })(req, res, next);\n  });\n\n  app.get(\"/api/callback\", (req, res, next) => {\n    ensureStrategy(req.hostname);\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      successReturnToOrRedirect: \"/dashboard\",\n      failureRedirect: \"/api/login\",\n    })(req, res, next);\n  });\n\n  app.get(\"/api/logout\", (req, res) => {\n    req.logout(() => {\n      res.redirect(\n        client.buildEndSessionUrl(config, {\n          client_id: process.env.REPL_ID!,\n          post_logout_redirect_uri: `${req.protocol}://${req.hostname}`,\n        }).href\n      );\n    });\n  });\n}\n\nexport const isAuthenticated: RequestHandler = async (req, res, next) => {\n  const user = req.user as any;\n\n  if (!req.isAuthenticated() || !user.expires_at) {\n    return res.status(401).json({ message: \"Unauthorized\" });\n  }\n\n  const now = Math.floor(Date.now() / 1000);\n  if (now <= user.expires_at) {\n    return next();\n  }\n\n  const refreshToken = user.refresh_token;\n  if (!refreshToken) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n\n  try {\n    const config = await getOidcConfig();\n    const tokenResponse = await client.refreshTokenGrant(config, refreshToken);\n    updateUserSession(user, tokenResponse);\n    return next();\n  } catch (error) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n};\n","path":null,"size_bytes":4483,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4845,"size_tokens":null},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* LIGHT MODE */\n:root {\n  --button-outline: rgba(0,0,0, .10);\n  --badge-outline: rgba(0,0,0, .05);\n  --opaque-button-border-intensity: -8;\n  --elevate-1: rgba(0,0,0, .03);\n  --elevate-2: rgba(0,0,0, .08);\n  --background: 0 0% 100%;\n  --foreground: 240 10% 10%;\n  --border: 240 6% 90%;\n  --card: 240 6% 97%;\n  --card-foreground: 240 10% 10%;\n  --card-border: 240 6% 92%;\n  --sidebar: 250 20% 96%;\n  --sidebar-foreground: 240 10% 10%;\n  --sidebar-border: 250 10% 90%;\n  --sidebar-primary: 258 70% 55%;\n  --sidebar-primary-foreground: 0 0% 100%;\n  --sidebar-accent: 250 15% 91%;\n  --sidebar-accent-foreground: 240 10% 10%;\n  --sidebar-ring: 258 70% 55%;\n  --popover: 240 6% 96%;\n  --popover-foreground: 240 10% 10%;\n  --popover-border: 240 6% 89%;\n  --primary: 258 70% 55%;\n  --primary-foreground: 0 0% 100%;\n  --secondary: 240 5% 92%;\n  --secondary-foreground: 240 10% 10%;\n  --muted: 240 5% 93%;\n  --muted-foreground: 240 4% 46%;\n  --accent: 250 15% 93%;\n  --accent-foreground: 240 10% 10%;\n  --destructive: 0 84% 60%;\n  --destructive-foreground: 0 0% 98%;\n  --input: 240 6% 75%;\n  --ring: 258 70% 55%;\n  --chart-1: 258 70% 55%;\n  --chart-2: 160 60% 45%;\n  --chart-3: 200 80% 50%;\n  --chart-4: 35 91% 51%;\n  --chart-5: 340 82% 52%;\n  --font-sans: Inter, sans-serif;\n  --font-serif: Playfair Display, serif;\n  --font-mono: JetBrains Mono, monospace;\n  --radius: .5rem;\n  --shadow-2xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --shadow-xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --shadow-sm: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 1px 2px -1px hsl(0 0% 0% / 0.00);\n  --shadow: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 1px 2px -1px hsl(0 0% 0% / 0.00);\n  --shadow-md: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 2px 4px -1px hsl(0 0% 0% / 0.00);\n  --shadow-lg: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 4px 6px -1px hsl(0 0% 0% / 0.00);\n  --shadow-xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 8px 10px -1px hsl(0 0% 0% / 0.00);\n  --shadow-2xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --tracking-normal: 0em;\n  --spacing: 0.25rem;\n\n/* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n.dark {\n  --button-outline: rgba(255,255,255, .10);\n  --badge-outline: rgba(255,255,255, .05);\n  --opaque-button-border-intensity: 9;\n  --elevate-1: rgba(255,255,255, .04);\n  --elevate-2: rgba(255,255,255, .09);\n  --background: 250 15% 6%;\n  --foreground: 240 5% 95%;\n  --border: 250 10% 16%;\n  --card: 250 15% 9%;\n  --card-foreground: 240 5% 95%;\n  --card-border: 250 10% 13%;\n  --sidebar: 250 18% 10%;\n  --sidebar-foreground: 240 5% 95%;\n  --sidebar-border: 250 10% 14%;\n  --sidebar-primary: 258 70% 60%;\n  --sidebar-primary-foreground: 0 0% 100%;\n  --sidebar-accent: 250 15% 16%;\n  --sidebar-accent-foreground: 240 5% 95%;\n  --sidebar-ring: 258 70% 60%;\n  --popover: 250 15% 12%;\n  --popover-foreground: 240 5% 95%;\n  --popover-border: 250 10% 16%;\n  --primary: 258 70% 60%;\n  --primary-foreground: 0 0% 100%;\n  --secondary: 250 10% 17%;\n  --secondary-foreground: 240 5% 95%;\n  --muted: 250 10% 16%;\n  --muted-foreground: 240 5% 60%;\n  --accent: 250 15% 18%;\n  --accent-foreground: 240 5% 95%;\n  --destructive: 0 62% 30%;\n  --destructive-foreground: 0 0% 98%;\n  --input: 250 10% 30%;\n  --ring: 258 70% 60%;\n  --chart-1: 258 65% 65%;\n  --chart-2: 160 55% 55%;\n  --chart-3: 200 70% 60%;\n  --chart-4: 35 85% 62%;\n  --chart-5: 340 75% 65%;\n  --shadow-2xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --shadow-xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --shadow-sm: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 1px 2px -1px hsl(0 0% 0% / 0.00);\n  --shadow: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 1px 2px -1px hsl(0 0% 0% / 0.00);\n  --shadow-md: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 2px 4px -1px hsl(0 0% 0% / 0.00);\n  --shadow-lg: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 4px 6px -1px hsl(0 0% 0% / 0.00);\n  --shadow-xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 8px 10px -1px hsl(0 0% 0% / 0.00);\n  --shadow-2xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n\n/* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n}\n\n/**\n * Using the elevate system.\n * Automatic contrast adjustment.\n *\n * <element className=\"hover-elevate\" />\n * <element className=\"active-elevate-2\" />\n *\n * // Using the tailwind utility when a data attribute is \"on\"\n * <element className=\"toggle-elevate data-[state=on]:toggle-elevated\" />\n * // Or manually controlling the toggle state\n * <element className=\"toggle-elevate toggle-elevated\" />\n *\n * Elevation systems have to handle many states.\n * - not-hovered, vs. hovered vs. active  (three mutually exclusive states)\n * - toggled or not\n * - focused or not (this is not handled with these utilities)\n *\n * Even without handling focused or not, this is six possible combinations that\n * need to be distinguished from eachother visually.\n */\n@layer utilities {\n\n  /* Hide ugly search cancel button in Chrome until we can style it properly */\n  input[type=\"search\"]::-webkit-search-cancel-button {\n    @apply hidden;\n  }\n\n  /* Placeholder styling for contentEditable div */\n  [contenteditable][data-placeholder]:empty::before {\n    content: attr(data-placeholder);\n    color: hsl(var(--muted-foreground));\n    pointer-events: none;\n  }\n\n  /* .no-default-hover-elevate/no-default-active-elevate is an escape hatch so consumers of\n   * buttons/badges can remove the automatic brightness adjustment on interactions\n   * and program their own. */\n  .no-default-hover-elevate {}\n\n  .no-default-active-elevate {}\n\n\n  /**\n   * Toggleable backgrounds go behind the content. Hoverable/active goes on top.\n   * This way they can stack/compound. Both will overlap the parent's borders!\n   * So borders will be automatically adjusted both on toggle, and hover/active,\n   * and they will be compounded.\n   */\n  .toggle-elevate::before,\n  .toggle-elevate-2::before {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: -1;\n    /* sits behind content but above backdrop */\n  }\n\n  .toggle-elevate.toggle-elevated::before {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.toggle-elevate::before {\n    inset: -1px;\n  }\n\n  /* Does not work on elements with overflow:hidden! */\n  .hover-elevate:not(.no-default-hover-elevate),\n  .active-elevate:not(.no-default-active-elevate),\n  .hover-elevate-2:not(.no-default-hover-elevate),\n  .active-elevate-2:not(.no-default-active-elevate) {\n    position: relative;\n    z-index: 0;\n  }\n\n  .hover-elevate:not(.no-default-hover-elevate)::after,\n  .active-elevate:not(.no-default-active-elevate)::after,\n  .hover-elevate-2:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:not(.no-default-active-elevate)::after {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: 999;\n    /* sits in front of content */\n  }\n\n  .hover-elevate:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-1);\n  }\n\n  .hover-elevate-2:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate-2:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate-2:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after {\n    inset: -1px;\n  }\n}\n","path":null,"size_bytes":10656,"size_tokens":null},"server/vite.ts":{"content":"import { type Express } from \"express\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport async function setupVite(server: Server, app: Express) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server, path: \"/vite-hmr\" },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n\n  app.use(\"/{*path}\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n","path":null,"size_bytes":1541,"size_tokens":null},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \".5625rem\", /* 9px */\n        md: \".375rem\", /* 6px */\n        sm: \".1875rem\", /* 3px */\n      },\n      colors: {\n        // Flat / base colors (regular buttons)\n        background: \"hsl(var(--background) / <alpha-value>)\",\n        foreground: \"hsl(var(--foreground) / <alpha-value>)\",\n        border: \"hsl(var(--border) / <alpha-value>)\",\n        input: \"hsl(var(--input) / <alpha-value>)\",\n        card: {\n          DEFAULT: \"hsl(var(--card) / <alpha-value>)\",\n          foreground: \"hsl(var(--card-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--card-border) / <alpha-value>)\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover) / <alpha-value>)\",\n          foreground: \"hsl(var(--popover-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--popover-border) / <alpha-value>)\",\n        },\n        primary: {\n          DEFAULT: \"hsl(var(--primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--primary-foreground) / <alpha-value>)\",\n          border: \"var(--primary-border)\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary) / <alpha-value>)\",\n          foreground: \"hsl(var(--secondary-foreground) / <alpha-value>)\",\n          border: \"var(--secondary-border)\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted) / <alpha-value>)\",\n          foreground: \"hsl(var(--muted-foreground) / <alpha-value>)\",\n          border: \"var(--muted-border)\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--accent-foreground) / <alpha-value>)\",\n          border: \"var(--accent-border)\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive) / <alpha-value>)\",\n          foreground: \"hsl(var(--destructive-foreground) / <alpha-value>)\",\n          border: \"var(--destructive-border)\",\n        },\n        ring: \"hsl(var(--ring) / <alpha-value>)\",\n        chart: {\n          \"1\": \"hsl(var(--chart-1) / <alpha-value>)\",\n          \"2\": \"hsl(var(--chart-2) / <alpha-value>)\",\n          \"3\": \"hsl(var(--chart-3) / <alpha-value>)\",\n          \"4\": \"hsl(var(--chart-4) / <alpha-value>)\",\n          \"5\": \"hsl(var(--chart-5) / <alpha-value>)\",\n        },\n        sidebar: {\n          ring: \"hsl(var(--sidebar-ring) / <alpha-value>)\",\n          DEFAULT: \"hsl(var(--sidebar) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--sidebar-border) / <alpha-value>)\",\n        },\n        \"sidebar-primary\": {\n          DEFAULT: \"hsl(var(--sidebar-primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-primary-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-primary-border)\",\n        },\n        \"sidebar-accent\": {\n          DEFAULT: \"hsl(var(--sidebar-accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-accent-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-accent-border)\"\n        },\n        status: {\n          online: \"rgb(34 197 94)\",\n          away: \"rgb(245 158 11)\",\n          busy: \"rgb(239 68 68)\",\n          offline: \"rgb(156 163 175)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: { height: \"0\" },\n          to: { height: \"var(--radix-accordion-content-height)\" },\n        },\n        \"accordion-up\": {\n          from: { height: \"var(--radix-accordion-content-height)\" },\n          to: { height: \"0\" },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","path":null,"size_bytes":4050,"size_tokens":null},"server/replit_integrations/image/routes.ts":{"content":"import type { Express, Request, Response } from \"express\";\nimport { Modality } from \"@google/genai\";\nimport { ai } from \"./client\";\n\nexport function registerImageRoutes(app: Express): void {\n  app.post(\"/api/generate-image\", async (req: Request, res: Response) => {\n    try {\n      const { prompt } = req.body;\n\n      if (!prompt) {\n        return res.status(400).json({ error: \"Prompt is required\" });\n      }\n\n      const response = await ai.models.generateContent({\n        model: \"gemini-2.5-flash-image\",\n        contents: [{ role: \"user\", parts: [{ text: prompt }] }],\n        config: {\n          responseModalities: [Modality.TEXT, Modality.IMAGE],\n        },\n      });\n\n      const candidate = response.candidates?.[0];\n      const imagePart = candidate?.content?.parts?.find((part: any) => part.inlineData);\n\n      if (!imagePart?.inlineData?.data) {\n        return res.status(500).json({ error: \"No image data in response\" });\n      }\n\n      const mimeType = imagePart.inlineData.mimeType || \"image/png\";\n      res.json({\n        b64_json: imagePart.inlineData.data,\n        mimeType,\n      });\n    } catch (error) {\n      console.error(\"Error generating image:\", error);\n      res.status(500).json({ error: \"Failed to generate image\" });\n    }\n  });\n}\n\n","path":null,"size_bytes":1264,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"replit.md":{"content":"# Gemin-Eye - AI-Powered Customer Acquisition Platform\n\n## Overview\n\nGemin-Eye is an AI-powered customer acquisition platform designed to revolutionize customer acquisition by leveraging AI to monitor niche online communities (Facebook groups, Reddit, etc.) for high-intent questions. It generates helpful, human-sounding responses that subtly promote client businesses, offering an organic alternative to traditional advertising. The platform features a landing page, an onboarding wizard for business setup, a dashboard for campaign and lead management, and an admin panel for overall client and campaign oversight.\n\n## User Preferences\n\nPreferred communication style: Simple, everyday language.\nAlways push code to GitHub after every commit (requires GitHub remote to be connected).\nAlways derive keywords from a new client's website  scrape their actual site to understand what they offer before setting up campaigns.\nBusiness data (type, core_offering, target_audience) must accurately reflect what the business actually is, based on their website.\n\n## System Architecture\n\n### Frontend\n- **Framework**: React 18 with TypeScript\n- **Routing**: Wouter\n- **State/Data fetching**: TanStack React Query\n- **Styling**: Tailwind CSS with CSS variables (light/dark mode)\n- **UI Components**: shadcn/ui built on Radix UI\n- **Forms**: React Hook Form with Zod validation\n- **Build tool**: Vite\n- **Branding**: Indigo/violet color scheme, Inter sans-serif font\n\n### Backend\n- **Framework**: Express.js on Node with TypeScript\n- **API pattern**: RESTful JSON APIs under `/api/`\n- **AI Integration**: Google Gemini via `@google/genai` SDK\n  - `gemini-2.5-pro`: Strategy generation and response crafting\n  - `gemini-2.5-flash`: Lead scoring\n- **Build**: esbuild for server, Vite for client\n\n### Authentication\n- **Method**: Replit OpenID Connect (OIDC) via Passport.js\n- **Sessions**: Express sessions stored in PostgreSQL using `connect-pg-simple`\n- **Middleware**: `isAuthenticated` for route protection\n\n### Database\n- **Database**: PostgreSQL\n- **ORM**: Drizzle ORM with `drizzle-zod`\n- **Schema**: `shared/schema.ts`\n- **Migration**: Drizzle Kit\n- **Key tables**: `users`, `sessions`, `businesses`, `campaigns`, `response_feedback`, `leads`, `ai_responses`, `conversations`, `messages`\n\n### Storage Layer\n- **Pattern**: Interface-based storage (`IStorage`, `IAuthStorage`, `IChatStorage`)\n\n### Replit Integrations\n- Pre-built modules for OIDC authentication, batch processing (rate limiting, retries), chat functionality (CRUD), and image generation.\n\n### Core Features\n- **AI-Powered Monitoring**: Scans platforms like Reddit, Facebook groups, and Google Alerts for high-intent questions.\n- **Smart Keyword Matching**: Utilizes a sophisticated keyword matching algorithm that includes multi-word and stop-word filtering for more accurate lead detection.\n- **AI-Generated Responses**: Crafts helpful, community-compliant responses tailored to the platform (e.g., Reddit responses exclude promotional content).\n- **Lead Scoring**: Employs Gemini Flash for unbiased lead scoring across various monitoring channels.\n- **Client Onboarding**: Multi-step wizard (web or Telegram-based) for business description and AI-generated monitoring strategy.\n- **Admin Panel**: Comprehensive management of clients, businesses, campaigns, keywords, and groups. Includes a monitoring kill switch.\n- **Bookmarklets**: Facebook and LinkedIn \"Spy Glass\" bookmarklets for clients to manually scan groups.\n- **Telegram Bot**: Facilitates client onboarding, lead alerts, feedback, and admin commands.\n- **Robustness**: Includes AI call timeout protection, rate limiting, Zod validation for AI JSON parsing, and modularized code.\n- **Performance**: Optimized dashboard data fetching and modularized Telegram bot for better maintainability and scalability.\n\n## External Dependencies\n\n- **PostgreSQL**: Primary database.\n- **Replit AI Integrations (Gemini)**: For AI text and image generation.\n- **Replit OIDC**: For user authentication.\n- **Google Fonts**: Inter, Playfair Display, JetBrains Mono.\n- **react-icons**: For social media icons.","path":null,"size_bytes":4114,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":166,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3848,"size_tokens":null},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport type { Server } from \"http\";\nimport { setupAuth, registerAuthRoutes, isAuthenticated } from \"./replit_integrations/auth\";\nimport { storage } from \"./storage\";\nimport { z } from \"zod\";\nimport { insertBusinessSchema } from \"@shared/schema\";\nimport { sendTelegramMessage, formatLeadNotification, formatResponseNotification } from \"./telegram\";\nimport { registerTelegramWebhook } from \"./telegram-bot\";\nimport { startRedditMonitor } from \"./reddit-monitor\";\nimport { startGoogleAlertsMonitor } from \"./google-alerts-monitor\";\nimport { generateContent, safeParseJsonFromAI, parseAIJsonWithRetry, strategySchema, TONE_MAP } from \"./utils/ai\";\nimport { createRateLimiter } from \"./utils/rate-limit\";\nimport { registerAdminRoutes } from \"./routes/admin\";\nimport { registerScanRoutes } from \"./routes/scan\";\n\nconst aiRateLimit = createRateLimiter({\n  name: \"ai-endpoints\",\n  maxRequests: 10,\n  windowMs: 60 * 1000,\n  keyFn: (req: any) => req.user?.claims?.sub || req.ip || \"unknown\",\n});\n\nexport async function registerRoutes(\n  httpServer: Server,\n  app: Express\n): Promise<Server> {\n  await setupAuth(app);\n  registerAuthRoutes(app);\n\n  app.get(\"/api/health\", (_req, res) => {\n    res.json({\n      status: \"ok\",\n      uptime: process.uptime(),\n      timestamp: new Date().toISOString(),\n    });\n  });\n\n  app.get(\"/api/businesses\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const biz = await storage.getBusinessesByUser(userId);\n      res.json(biz);\n    } catch (error) {\n      console.error(\"Error fetching businesses:\", error);\n      res.status(500).json({ error: \"Failed to fetch businesses\" });\n    }\n  });\n\n  app.post(\"/api/businesses\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const bodySchema = insertBusinessSchema.omit({ userId: true }).extend({\n        strategy: z.object({\n          platforms: z.array(z.object({ name: z.string() })),\n          groups: z.array(z.string()),\n          keywords: z.array(z.string()),\n          sampleResponse: z.string(),\n          rationale: z.string(),\n        }).optional(),\n      });\n\n      const parsed = bodySchema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"Invalid request\", details: parsed.error.issues });\n      }\n\n      const { name, type, contactEmail, contactPhone, website, targetAudience, coreOffering, preferredTone, strategy } = parsed.data;\n\n      const biz = await storage.createBusiness({\n        userId,\n        name,\n        type,\n        contactEmail: contactEmail || null,\n        contactPhone: contactPhone || null,\n        website: website || null,\n        targetAudience,\n        coreOffering,\n        preferredTone,\n      });\n\n      if (strategy && strategy.platforms) {\n        for (const platform of strategy.platforms) {\n          await storage.createCampaign({\n            businessId: biz.id,\n            name: `${platform.name} Campaign`,\n            platform: platform.name,\n            status: \"active\",\n            strategy: strategy.rationale,\n            targetGroups: strategy.groups.filter((_: string, i: number) => i < 5),\n            keywords: strategy.keywords,\n          });\n        }\n      }\n\n      const { generateConnectToken } = await import(\"./telegram/bookmarklets\");\n      const connectToken = generateConnectToken(biz.id, userId);\n      res.json({ ...biz, connectToken });\n    } catch (error) {\n      console.error(\"Error creating business:\", error);\n      res.status(500).json({ error: \"Failed to create business\" });\n    }\n  });\n\n  app.post(\"/api/strategy/generate\", isAuthenticated, aiRateLimit, async (req: any, res) => {\n    try {\n      const strategyInputSchema = z.object({\n        name: z.string().min(1),\n        type: z.string().min(1),\n        contactEmail: z.string().optional().default(\"\"),\n        contactPhone: z.string().optional().default(\"\"),\n        website: z.string().optional().default(\"\"),\n        location: z.string().optional().default(\"\"),\n        targetAudience: z.string().min(1),\n        coreOffering: z.string().min(10),\n        preferredTone: z.string().min(1),\n      });\n\n      const parsed = strategyInputSchema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"Invalid request\", details: parsed.error.issues });\n      }\n\n      const { name, type, location, targetAudience, coreOffering, preferredTone } = parsed.data;\n      const locationLine = location ? `\\n- Location: ${location}` : \"\";\n\n      const prompt = `You are a marketing strategist specializing in social media community engagement.\n\nA business wants to find customers by monitoring social media groups for high-intent questions and responding helpfully.\n\nBusiness Details:\n- Name: ${name}\n- Type/Niche: ${type}${locationLine}\n- Target Audience: ${targetAudience}\n- Core Offering: ${coreOffering}\n- Preferred Tone: ${preferredTone}\n\nGenerate a customer acquisition strategy. Return ONLY valid JSON with this exact structure:\n{\n  \"platforms\": [{\"name\": \"Facebook\"}, {\"name\": \"Reddit\"}],\n  \"groups\": [\"Group Name 1\", \"Group Name 2\", \"r/subreddit1\", \"r/subreddit2\", \"r/subreddit3\"],\n  \"keywords\": [\"keyword1\", \"keyword2\", \"keyword3\", \"keyword4\", \"keyword5\", \"keyword6\", \"keyword7\", \"keyword8\"],\n  \"sampleResponse\": \"A sample response that the AI would post in one of these groups when someone asks a relevant question. Make it sound natural and helpful, not like an ad. About 2-3 sentences.\",\n  \"rationale\": \"2-3 sentences explaining why these platforms and groups were chosen and how this strategy will help the business find customers.\"\n}\n\nCRITICAL RULES FOR GROUPS:\n- Include at least 3-5 REAL Reddit subreddits that actually exist, prefixed with \"r/\" (e.g., r/chicago, r/woodworking, r/fitness).\n- NEVER use placeholder names like \"r/[yourcity]\" or \"[Your City Name]\". Use REAL specific subreddit names.\n- If the business has a specific local area, ALWAYS include the local city/region subreddit (e.g., r/chicago, r/austin, r/nyc).\n- If the business is national or global/web-based, focus on industry and topic subreddits instead of geographic ones.\n- Pick subreddits where the target audience is likely to ask questions or seek recommendations.\n- Also include 2-3 real Facebook group names if applicable.\n- Make the sample response sound genuinely human and helpful with a subtle recommendation. Match the preferred tone.`;\n\n      const strategyData = await parseAIJsonWithRetry(\n        async () => {\n          const response = await generateContent({\n            model: \"gemini-2.5-pro\",\n            contents: prompt,\n            config: { maxOutputTokens: 8192 },\n          });\n          return response.text;\n        },\n        strategySchema\n      );\n\n      if (!strategyData) {\n        throw new Error(\"Failed to generate strategy after retries\");\n      }\n      res.json(strategyData);\n    } catch (error) {\n      console.error(\"Error generating strategy:\", error);\n      res.status(500).json({ error: \"Failed to generate strategy\" });\n    }\n  });\n\n  app.get(\"/api/campaigns\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const camps = await storage.getCampaignsByUser(userId);\n      res.json(camps);\n    } catch (error) {\n      console.error(\"Error fetching campaigns:\", error);\n      res.status(500).json({ error: \"Failed to fetch campaigns\" });\n    }\n  });\n\n  app.get(\"/api/leads\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const data = await storage.getDashboardData(userId);\n      res.json({ leads: data.leads, responses: data.responses });\n    } catch (error) {\n      console.error(\"Error fetching leads:\", error);\n      res.status(500).json({ error: \"Failed to fetch leads\" });\n    }\n  });\n\n  app.post(\"/api/leads/:id/generate-response\", isAuthenticated, aiRateLimit, async (req: any, res) => {\n    try {\n      const leadId = parseInt(req.params.id);\n      const userId = req.user.claims.sub;\n\n      const camps = await storage.getCampaignsByUser(userId);\n      const campaignIds = camps.map((c) => c.id);\n      const allLeads = await storage.getLeadsByCampaigns(campaignIds);\n      const lead = allLeads.find((l) => l.id === leadId);\n\n      if (!lead) {\n        return res.status(404).json({ error: \"Lead not found\" });\n      }\n\n      const campaign = camps.find((c) => c.id === lead.campaignId);\n      const bizList = await storage.getBusinessesByUser(userId);\n      const business = bizList.find((b) => b.id === campaign?.businessId);\n\n      if (!business) {\n        return res.status(404).json({ error: \"Business not found\" });\n      }\n\n      const prompt = `You are writing a response to a social media post in a community group. Your goal is to be genuinely helpful while subtly recommending a business.\n\nThe post was in the group \"${lead.groupName}\" on ${lead.platform}.\nThe original post: \"${lead.originalPost}\"\nPosted by: ${lead.authorName}\n\nBusiness to recommend: ${business.name}\nWhat they do: ${business.coreOffering}\nTone: ${TONE_MAP[business.preferredTone] || \"friendly and helpful\"}\n\nWrite a natural, human-sounding response (2-3 sentences). Do NOT make it sound like an ad. Sound like a real person sharing a helpful recommendation based on personal experience or knowledge. Include the business name naturally.\n\nReturn ONLY the response text, no quotes or formatting.`;\n\n      const response = await generateContent({\n        model: \"gemini-2.5-pro\",\n        contents: prompt,\n        config: { maxOutputTokens: 8192 },\n      });\n\n      const responseText = response.text;\n\n      const aiResp = await storage.createResponse({\n        leadId,\n        content: responseText.trim(),\n        status: \"pending\",\n      });\n\n      sendTelegramMessage(formatResponseNotification(\n        lead, business.name, responseText.trim()\n      )).catch((e) => console.error(\"Telegram notification failed:\", e));\n\n      res.json(aiResp);\n    } catch (error) {\n      console.error(\"Error generating response:\", error);\n      res.status(500).json({ error: \"Failed to generate response\" });\n    }\n  });\n\n  app.post(\"/api/leads/score\", isAuthenticated, aiRateLimit, async (req: any, res) => {\n    try {\n      const { post, businessType, targetAudience } = req.body;\n      if (!post || !businessType) {\n        return res.status(400).json({ error: \"Missing required fields: post, businessType\" });\n      }\n\n      const prompt = `You are a lead scoring AI. Analyze this social media post and rate how likely this person is to become a customer for the described business.\n\nPost: \"${post}\"\nBusiness Type: ${businessType}\nTarget Audience: ${targetAudience || \"general\"}\n\nReturn ONLY valid JSON with this structure:\n{\n  \"score\": <number 1-10>,\n  \"reasoning\": \"<one sentence explaining the score>\",\n  \"keywords_matched\": [\"keyword1\", \"keyword2\"]\n}`;\n\n      const response = await generateContent({\n        model: \"gemini-2.5-flash\",\n        contents: prompt,\n        config: { maxOutputTokens: 1024 },\n      });\n\n      const text = response.text;\n      const scored = safeParseJsonFromAI(text);\n      if (!scored) {\n        throw new Error(\"No JSON found in response\");\n      }\n      res.json(scored);\n    } catch (error) {\n      console.error(\"Error scoring lead:\", error);\n      res.status(500).json({ error: \"Failed to score lead\" });\n    }\n  });\n\n  app.post(\"/api/responses/:id/approve\", isAuthenticated, async (req: any, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const userId = req.user.claims.sub;\n\n      const camps = await storage.getCampaignsByUser(userId);\n      const campaignIds = camps.map((c) => c.id);\n      const allLeads = await storage.getLeadsByCampaigns(campaignIds);\n      const leadIds = allLeads.map((l) => l.id);\n      const allResponses = await storage.getResponsesByLeads(leadIds);\n      const owned = allResponses.find((r) => r.id === id);\n\n      if (!owned) {\n        return res.status(404).json({ error: \"Response not found\" });\n      }\n\n      const resp = await storage.updateResponseStatus(id, \"approved\");\n      res.json(resp);\n    } catch (error) {\n      console.error(\"Error approving response:\", error);\n      res.status(500).json({ error: \"Failed to approve response\" });\n    }\n  });\n\n  app.get(\"/api/my-bookmarklets\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = (req.user as any)?.claims?.sub;\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n\n      const businesses = await storage.getBusinessesByUser(userId);\n      const { generateScanToken, generateBookmarkletCode, generateLinkedInBookmarkletCode, getAppBaseUrl } = await import(\"./telegram/bookmarklets\");\n      const baseUrl = getAppBaseUrl();\n\n      const results = businesses\n        .filter(b => b.telegramChatId)\n        .map(b => {\n          const chatId = b.telegramChatId!;\n          const token = generateScanToken(chatId, b.id);\n          return {\n            businessId: b.id,\n            businessName: b.name,\n            facebookCode: generateBookmarkletCode(baseUrl, chatId, b.id, token),\n            linkedinCode: generateLinkedInBookmarkletCode(baseUrl, chatId, b.id, token),\n            bookmarkletPageUrl: `${baseUrl}/bookmarklets/${b.id}/${chatId}/${token}`,\n          };\n        });\n\n      res.json(results);\n    } catch (error) {\n      console.error(\"Error generating user bookmarklets:\", error);\n      res.status(500).json({ error: \"Failed to generate bookmarklets\" });\n    }\n  });\n\n  app.get(\"/api/bookmarklets/:businessId/:chatId/:token\", async (req, res) => {\n    try {\n      const { businessId, chatId, token } = req.params;\n      const bizId = parseInt(businessId);\n      if (isNaN(bizId)) {\n        return res.status(400).json({ error: \"Invalid business ID\" });\n      }\n\n      const { validateScanToken, generateBookmarkletCode, generateLinkedInBookmarkletCode, getAppBaseUrl } = await import(\"./telegram/bookmarklets\");\n\n      if (!validateScanToken(chatId, bizId, token)) {\n        return res.status(403).json({ error: \"Invalid or expired token\" });\n      }\n\n      const business = await storage.getBusinessById(bizId);\n      if (!business) {\n        return res.status(404).json({ error: \"Business not found\" });\n      }\n\n      const baseUrl = getAppBaseUrl();\n      const facebookCode = generateBookmarkletCode(baseUrl, chatId, bizId, token);\n      const linkedinCode = generateLinkedInBookmarkletCode(baseUrl, chatId, bizId, token);\n\n      res.json({\n        businessName: business.name,\n        facebookCode,\n        linkedinCode,\n      });\n    } catch (error) {\n      console.error(\"Error generating bookmarklets:\", error);\n      res.status(500).json({ error: \"Failed to generate bookmarklets\" });\n    }\n  });\n\n  registerAdminRoutes(app);\n  registerScanRoutes(app);\n\n  registerTelegramWebhook(app);\n  startRedditMonitor();\n  startGoogleAlertsMonitor();\n\n  app.post(\"/api/telegram/test\", isAuthenticated, async (_req: any, res) => {\n    try {\n      const success = await sendTelegramMessage(\n        \"<b>Gemin-Eye Connected!</b>\\n\\nYour Telegram notifications are working. You'll receive alerts here when new leads are found and AI responses are ready to copy & paste.\"\n      );\n      if (success) {\n        res.json({ success: true, message: \"Test message sent!\" });\n      } else {\n        res.status(500).json({ error: \"Failed to send. Check bot token and chat ID.\" });\n      }\n    } catch (error) {\n      console.error(\"Telegram test error:\", error);\n      res.status(500).json({ error: \"Failed to send test message\" });\n    }\n  });\n\n  app.post(\"/api/telegram/notify-lead\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { leadId } = req.body;\n      if (!leadId) return res.status(400).json({ error: \"leadId required\" });\n\n      const userId = req.user.claims.sub;\n      const camps = await storage.getCampaignsByUser(userId);\n      const campaignIds = camps.map((c) => c.id);\n      const allLeads = await storage.getLeadsByCampaigns(campaignIds);\n      const lead = allLeads.find((l) => l.id === leadId);\n\n      if (!lead) return res.status(404).json({ error: \"Lead not found\" });\n\n      const bizList = await storage.getBusinessesByUser(userId);\n      const campaign = camps.find((c) => c.id === lead.campaignId);\n      const business = bizList.find((b) => b.id === campaign?.businessId);\n\n      const leadResponses = await storage.getResponsesByLeads([lead.id]);\n      const latestResponse = leadResponses[0];\n\n      const msg = formatLeadNotification(\n        lead,\n        business?.name || \"Unknown\",\n        latestResponse?.content\n      );\n\n      const success = await sendTelegramMessage(msg);\n      res.json({ success });\n    } catch (error) {\n      console.error(\"Telegram notify error:\", error);\n      res.status(500).json({ error: \"Failed to send notification\" });\n    }\n  });\n\n  return httpServer;\n}\n","path":null,"size_bytes":16909,"size_tokens":null},"server/telegram-bot.ts":{"content":"import { sendTelegramMessage, sendTelegramMessageToChat, type TelegramMessageOptions } from \"./telegram\";\nimport { isRedditConfigured } from \"./reddit-poster\";\nimport { escapeHtml } from \"./utils/html\";\nimport { createRateLimiter } from \"./utils/rate-limit\";\nimport { storage } from \"./storage\";\nimport type { Business } from \"@shared/schema\";\nimport {\n  handlePost, extractPostUrl, stripUrls, downloadTelegramPhotoWithMime, extractTextFromImage,\n  getAllBusinessesWithCampaigns, type PostAnalysis,\n} from \"./telegram/analysis\";\nimport { handleClientWizard } from \"./telegram/client-wizard\";\nimport { handleAdminCommand } from \"./telegram/admin-commands\";\nimport { handleCallbackQuery } from \"./telegram/callbacks\";\nimport { pendingContextRequests, pendingRedditPosts, clientWizards, CONTEXT_TTL } from \"./telegram/state\";\n\nexport { generateScanToken, generateBookmarkletCode, generateLinkedInBookmarkletCode } from \"./telegram/bookmarklets\";\n\nconst webhookRateLimit = createRateLimiter({\n  name: \"telegram-webhook\",\n  maxRequests: 60,\n  windowMs: 60 * 1000,\n  keyFn: (req) => req.ip || \"unknown\",\n});\n\nconst ALLOWED_CHAT_ID = process.env.TELEGRAM_CHAT_ID;\n\nasync function sendResultWithButtons(result: PostAnalysis, chatId?: string) {\n  const send = chatId\n    ? (text: string, opts?: TelegramMessageOptions) => sendTelegramMessageToChat(chatId, text, opts)\n    : (text: string, opts?: TelegramMessageOptions) => sendTelegramMessage(text, opts);\n\n  const buttons: Array<Array<{ text: string; url?: string; callback_data?: string }>> = [];\n\n  if (result.postUrl) {\n    const label = result.platform === \"reddit\" ? \"Open Reddit Post\" : result.platform === \"facebook\" ? \"Open Facebook Post\" : \"Open Post\";\n    buttons.push([{ text: label, url: result.postUrl }]);\n  }\n\n  if (result.responseId && result.platform === \"reddit\" && result.postUrl && result.responseText && isRedditConfigured()) {\n    pendingRedditPosts.set(result.responseId, {\n      responseText: result.responseText,\n      postUrl: result.postUrl,\n      timestamp: Date.now(),\n    });\n    buttons.push([{ text: \"Post to Reddit\", callback_data: `reddit_post_${result.responseId}` }]);\n  }\n\n  if (result.responseId) {\n    buttons.push([\n      { text: \"Used It\", callback_data: `fb_good_${result.responseId}` },\n      { text: \"Bad Match\", callback_data: `fb_bad_${result.responseId}` },\n      { text: \"Too Salesy\", callback_data: `fb_salesy_${result.responseId}` },\n      { text: \"Wrong Client\", callback_data: `fb_wrong_${result.responseId}` },\n    ]);\n  }\n\n  await send(result.message, buttons.length > 0 ? { buttons } : undefined);\n\n  if (result.responseText) {\n    await send(result.responseText);\n  }\n}\n\nexport function registerTelegramWebhook(app: any) {\n  const token = process.env.TELEGRAM_BOT_TOKEN;\n  if (!token) {\n    console.warn(\"TELEGRAM_BOT_TOKEN not set, skipping bot webhook setup\");\n    return;\n  }\n\n  app.post(`/api/telegram/webhook/${token}`, webhookRateLimit, async (req: any, res: any) => {\n    try {\n      res.sendStatus(200);\n\n      const update = req.body;\n\n      if (update?.callback_query) {\n        await handleCallbackQuery(update.callback_query);\n        return;\n      }\n\n      const message = update?.message;\n      if (!message) return;\n\n      const chatId = String(message.chat.id);\n      const messageText = (message.text || \"\").trim();\n      const fromUser = message.from;\n      console.log(`Telegram message from chatId=${chatId} user=${fromUser?.first_name || ''} ${fromUser?.last_name || ''} (${fromUser?.username || 'no-username'}): ${messageText.slice(0, 50)}`);\n\n      const connectMatch = messageText.match(/^\\/start connect_(\\d+)_([a-f0-9]+)$/);\n      if (connectMatch) {\n        const businessId = parseInt(connectMatch[1], 10);\n        const connectToken = connectMatch[2];\n        const { db } = await import(\"./db\");\n        const { businesses } = await import(\"@shared/schema\");\n        const { eq } = await import(\"drizzle-orm\");\n        const rows = await db.select().from(businesses).where(eq(businesses.id, businessId)).limit(1);\n        const biz = rows[0] || null;\n        if (!biz) {\n          await sendTelegramMessageToChat(chatId,\n            `Something went wrong  that business wasn't found. Please go back to the website and try again.`\n          );\n          return;\n        }\n        const { validateConnectTokenForOwner } = await import(\"./telegram/bookmarklets\");\n        if (!validateConnectTokenForOwner(businessId, biz.userId, connectToken)) {\n          await sendTelegramMessageToChat(chatId,\n            `That connect link is invalid or expired. Please go back to the website and try again.`\n          );\n          return;\n        }\n        if (biz) {\n          await storage.updateBusiness(businessId, { telegramChatId: chatId });\n          await sendTelegramMessageToChat(chatId,\n            `<b>Connected!</b>\\n\\n` +\n            `You'll receive leads for <b>${escapeHtml(biz.name)}</b> right here in Telegram.\\n\\n` +\n            `<b>What happens now:</b>\\n` +\n            `- Reddit is being scanned for leads every 5 minutes\\n` +\n            `- When a lead is found, you'll get a message with an AI-written response\\n` +\n            `- You can rate responses to teach the AI your style\\n\\n` +\n            `Head to your <a href=\"https://gemin-eye.com/dashboard\">dashboard</a> to access all your tools.`,\n            { disable_web_page_preview: true }\n          );\n        }\n        return;\n      }\n\n      if (messageText === \"/start setup\" || messageText === \"/setup\") {\n        clientWizards.set(chatId, { step: \"name\", chatId, timestamp: Date.now() });\n        await sendTelegramMessageToChat(chatId,\n          `<b>Welcome to Gemin-Eye!</b>\\n\\n` +\n          `I'm going to set up your business monitor in 5 quick steps.\\n\\n` +\n          `<b>Step 1:</b> What is the name of your business?\\n<i>(e.g., Mario's Tacos)</i>`\n        );\n        return;\n      }\n\n      const wizardHandled = await handleClientWizard(chatId, messageText);\n      if (wizardHandled) return;\n\n      const isAdmin = ALLOWED_CHAT_ID && chatId === ALLOWED_CHAT_ID;\n\n      if (messageText === \"/start\") {\n        if (isAdmin) {\n          pendingContextRequests.delete(chatId);\n          await sendTelegramMessage(\n            `<b>Welcome to Gemin-Eye Bot!</b>\\n\\nI help you find and respond to leads across social media.\\n\\n<b>Send me a post:</b>\\n- Paste text + URL\\n- Or just screenshot the post!\\n\\n<b>I'll automatically:</b>\\n1. Match it to your businesses\\n2. Score the lead intent\\n3. Craft a human-sounding response\\n4. Let you rate the response or post it directly\\n\\n<b>Reddit Commander:</b>\\n/post r/subreddit Title | Body text\\n\\n<b>Managing Clients:</b>\\n/newclient - Add a new business\\n/removeclient - Remove a business\\n/keywords - Update keywords for a business\\n/groups - Update target groups\\n/businesses - List all businesses\\n\\n<b>Google Alerts (Web-Wide Monitoring):</b>\\n/addalert - Add a Google Alert RSS feed\\n/alerts - View all alert feeds\\n/removealert - Remove an alert feed\\n\\n<b>Quick tip:</b> Include the post URL and I'll add an \"Open Post\" button. For Reddit leads, tap \"Post to Reddit\" to comment directly!`\n          );\n        } else {\n          const existingBiz: Business[] = await storage.getBusinessesByTelegramChatId(chatId);\n          if (existingBiz.length > 0) {\n            const bizNames = existingBiz.map(b => `- <b>${escapeHtml(b.name)}</b>`).join(\"\\n\");\n            await sendTelegramMessageToChat(chatId,\n              `<b>Welcome back!</b>\\n\\n` +\n              `Your businesses:\\n${bizNames}\\n\\n` +\n              `<b>What you can do:</b>\\n` +\n              `- Send me a post URL + text to analyze\\n` +\n              `- Screenshot a post and send the image\\n\\n` +\n              `Visit your <a href=\"https://gemin-eye.com/dashboard\">dashboard</a> for all tools including Spy Glass scanners.\\n\\n` +\n              `<b>Commands:</b>\\n` +\n              `/setup - Add another business\\n` +\n              `/help - Full usage guide`\n            );\n          } else {\n            await sendTelegramMessageToChat(chatId,\n              `<b>Welcome to Gemin-Eye!</b>\\n\\n` +\n              `To get started, set up your business on our website first. It takes about 2 minutes:\\n\\n` +\n              `<a href=\"https://gemin-eye.com/onboarding\">gemin-eye.com/onboarding</a>\\n\\n` +\n              `Once your business is set up, you'll get a link to connect Telegram  and leads will start flowing right here.`\n            );\n          }\n        }\n        return;\n      }\n\n      if (messageText === \"/help\" && !isAdmin) {\n        await sendTelegramMessageToChat(chatId,\n          `<b>Gemin-Eye - Your Lead Finder</b>\\n\\n` +\n          `<b>How it works:</b>\\n` +\n          `- I automatically scan Reddit for posts matching your keywords\\n` +\n          `- When I find a lead, I'll message you with an AI-written response\\n\\n` +\n          `<b>Manual scanning:</b>\\n` +\n          `- Send me any post text + URL and I'll analyze it\\n` +\n          `- Or screenshot a post and send the image\\n\\n` +\n          `Visit your <a href=\"https://gemin-eye.com/dashboard\">dashboard</a> for Spy Glass tools to scan Facebook and LinkedIn.\\n\\n` +\n          `<b>Commands:</b>\\n` +\n          `/setup - Add a new business\\n` +\n          `/help - This guide`\n        );\n        return;\n      }\n\n      const isClient = !isAdmin && (await storage.getBusinessesByTelegramChatId(chatId)).length > 0;\n      const isAuthorized = isAdmin || isClient;\n\n      if (!isAuthorized) {\n        if (messageText && !messageText.startsWith(\"/\")) {\n          await sendTelegramMessageToChat(chatId,\n            `You don't have a business connected yet.\\n\\n` +\n            `Set up your business at <a href=\"https://gemin-eye.com/onboarding\">gemin-eye.com/onboarding</a>  you'll get a link to connect Telegram at the end.`\n          );\n        }\n        return;\n      }\n\n      const send = isAdmin\n        ? (text: string, opts?: TelegramMessageOptions) => sendTelegramMessage(text, opts)\n        : (text: string, opts?: TelegramMessageOptions) => sendTelegramMessageToChat(chatId, text, opts);\n\n      if (message.photo && message.photo.length > 0) {\n        pendingContextRequests.delete(chatId);\n        await send(\"Reading screenshot...\");\n\n        const largestPhoto = message.photo[message.photo.length - 1];\n        const photoData = await downloadTelegramPhotoWithMime(largestPhoto.file_id);\n\n        if (!photoData) {\n          await send(\"Couldn't download that image. Please try again.\");\n          return;\n        }\n\n        const extracted = await extractTextFromImage(photoData.buffer, photoData.mimeType);\n        if (!extracted || extracted.text.length < 5) {\n          await send(\"Couldn't read any text from that screenshot. Make sure the post text is clearly visible and try again.\");\n          return;\n        }\n\n        const caption = message.caption || \"\";\n        const captionUrl = extractPostUrl(caption);\n        const postUrl = captionUrl || extracted.postUrl;\n        const groupName = extracted.groupName || undefined;\n\n        await send(`Read from screenshot. Analyzing...\\n\\n<i>\"${escapeHtml(extracted.text.length > 150 ? extracted.text.slice(0, 150) + \"...\" : extracted.text)}\"</i>`);\n\n        const result = await handlePost(extracted.text, groupName, postUrl, extracted.platform);\n\n        if (result.needsGroupContext) {\n          pendingContextRequests.set(chatId, {\n            postText: extracted.text,\n            postUrl: postUrl || null,\n            platform: extracted.platform,\n            timestamp: Date.now(),\n          });\n          await send(\n            `I can see the post, but I'm not sure which group it's from. This helps me pick the right business.\\n\\n<b>Which group/subreddit is this from?</b>\\n<i>(e.g., \"Chicago Foodies\" or \"r/mentalhealth\")</i>\\n\\nOr type <b>skip</b> to analyze without group context.`\n          );\n          return;\n        }\n\n        await sendResultWithButtons(result, isClient ? chatId : undefined);\n        return;\n      }\n\n      if (!message.text) return;\n\n      const text = message.text.trim();\n\n      if (text === \"/businesses\" && isAdmin) {\n        pendingContextRequests.delete(chatId);\n        const allBiz = await getAllBusinessesWithCampaigns();\n        if (allBiz.length === 0) {\n          await sendTelegramMessage(\"No businesses set up yet. Use /newclient to add one!\");\n          return;\n        }\n\n        let msg = `<b>Your Businesses:</b>\\n\\n`;\n        for (const b of allBiz) {\n          const kws = b.campaigns.flatMap((c) => c.keywords).slice(0, 5);\n          const groups = b.campaigns.flatMap((c) => c.targetGroups).slice(0, 3);\n          msg += `<b>${escapeHtml(b.name)}</b> (${escapeHtml(b.type)})\\n`;\n          msg += `Groups: ${groups.map((g) => escapeHtml(g)).join(\", \")}\\n`;\n          msg += `Keywords: ${kws.map((k) => escapeHtml(k)).join(\", \")}\\n\\n`;\n        }\n        msg += `<b>Commands:</b> /newclient | /removeclient | /keywords | /groups`;\n        await sendTelegramMessage(msg);\n        return;\n      }\n\n      const pendingContext = pendingContextRequests.get(chatId);\n      if (pendingContext && (Date.now() - pendingContext.timestamp) >= CONTEXT_TTL) {\n        pendingContextRequests.delete(chatId);\n      }\n      if (pendingContext && !text.startsWith(\"/\") && (Date.now() - pendingContext.timestamp) < CONTEXT_TTL) {\n        pendingContextRequests.delete(chatId);\n\n        const groupName = text.toLowerCase() === \"skip\" ? undefined : text.trim();\n\n        await send(groupName ? `Got it - analyzing for <b>${escapeHtml(groupName)}</b>...` : \"Analyzing without group context...\");\n\n        const result = await handlePost(pendingContext.postText, groupName, pendingContext.postUrl, pendingContext.platform);\n        await sendResultWithButtons(result, isClient ? chatId : undefined);\n        return;\n      }\n\n      if (text.startsWith(\"/\")) {\n        pendingContextRequests.delete(chatId);\n      }\n\n      if (isAdmin) {\n        const handled = await handleAdminCommand(chatId, text);\n        if (handled) return;\n      }\n\n      if (text.startsWith(\"/\")) {\n        if (isClient) {\n          await sendTelegramMessageToChat(chatId,\n            `That command isn't available. You can:\\n- Send me a post URL + text to analyze\\n- Screenshot a post and send the image\\n- /setup to add another business\\n- /help for more info`\n          );\n        }\n        return;\n      }\n\n      pendingContextRequests.delete(chatId);\n      await send(\"Analyzing post...\");\n\n      const postUrl = extractPostUrl(text);\n      let postText = postUrl ? stripUrls(text) : text;\n\n      let groupName: string | undefined;\n      const colonMatch = postText.match(/^([^:]{3,50}):\\s+([\\s\\S]+)/);\n      if (colonMatch) {\n        groupName = colonMatch[1].trim();\n        postText = colonMatch[2].trim();\n      }\n\n      if (!postText || postText.length < 5) {\n        await send(\n          \"I need more text to analyze. Please paste the post content along with the URL.\\n\\n<b>Or just screenshot the post!</b>\\n\\n<b>Example:</b>\\n<code>https://reddit.com/r/pizza/comments/abc123\\nDoes anyone know a good pizza place near Brookfield?</code>\"\n        );\n        return;\n      }\n\n      const result = await handlePost(postText, groupName, postUrl);\n\n      if (result.needsGroupContext) {\n        pendingContextRequests.set(chatId, {\n          postText,\n          postUrl: postUrl || null,\n          platform: result.platform,\n          timestamp: Date.now(),\n        });\n        await send(\n          `I can see the post, but I'm not sure which group it's from. This helps me pick the right business.\\n\\n<b>Which group/subreddit is this from?</b>\\n<i>(e.g., \"Chicago Foodies\" or \"r/mentalhealth\")</i>\\n\\nOr type <b>skip</b> to analyze without group context.`\n        );\n        return;\n      }\n\n      await sendResultWithButtons(result, isClient ? chatId : undefined);\n    } catch (error) {\n      console.error(\"Telegram webhook error:\", error);\n      await sendTelegramMessage(\"Something went wrong analyzing that post. Please try again.\").catch(() => {});\n    }\n  });\n\n  registerWebhook(token).catch((e) => console.error(\"Failed to register Telegram webhook:\", e));\n}\n\nasync function registerWebhook(token: string) {\n  const replitDomains = process.env.REPLIT_DOMAINS;\n  const replitDevDomain = process.env.REPLIT_DEV_DOMAIN;\n  const replSlug = process.env.REPL_SLUG;\n  const replOwner = process.env.REPL_OWNER;\n\n  let webhookUrl: string;\n  if (replitDomains) {\n    const primaryDomain = replitDomains.split(\",\")[0].trim();\n    webhookUrl = `https://${primaryDomain}/api/telegram/webhook/${token}`;\n  } else if (replitDevDomain) {\n    webhookUrl = `https://${replitDevDomain}/api/telegram/webhook/${token}`;\n  } else if (replSlug && replOwner) {\n    webhookUrl = `https://${replSlug}.${replOwner}.repl.co/api/telegram/webhook/${token}`;\n  } else {\n    console.warn(\"Could not determine public URL for Telegram webhook\");\n    return;\n  }\n\n  try {\n    const res = await fetch(`https://api.telegram.org/bot${token}/setWebhook`, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify({ url: webhookUrl }),\n    });\n\n    const data = await res.json();\n    if (data.ok) {\n      console.log(\"Telegram webhook registered successfully\");\n    } else {\n      console.error(\"Telegram webhook registration failed:\", data.description || \"unknown error\");\n    }\n  } catch (error) {\n    console.error(\"Error registering Telegram webhook:\", error);\n  }\n}\n","path":null,"size_bytes":17465,"size_tokens":null},"server/replit_integrations/auth/routes.ts":{"content":"import type { Express } from \"express\";\nimport { authStorage } from \"./storage\";\nimport { isAuthenticated } from \"./replitAuth\";\n\n// Register auth-specific routes\nexport function registerAuthRoutes(app: Express): void {\n  // Get current authenticated user\n  app.get(\"/api/auth/user\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await authStorage.getUser(userId);\n      res.json(user);\n    } catch (error) {\n      console.error(\"Error fetching user:\", error);\n      res.status(500).json({ message: \"Failed to fetch user\" });\n    }\n  });\n}\n","path":null,"size_bytes":609,"size_tokens":null},"server/replit_integrations/chat/routes.ts":{"content":"import type { Express, Request, Response } from \"express\";\nimport { GoogleGenAI } from \"@google/genai\";\nimport { chatStorage } from \"./storage\";\n\n/*\nSupported models: gemini-2.5-flash (fast), gemini-2.5-pro (advanced reasoning)\nUsage: Include httpOptions with baseUrl and empty apiVersion when using AI Integrations (required)\n*/\n\n// This is using Replit's AI Integrations service, which provides Gemini-compatible API access without requiring your own Gemini API key.\nconst ai = new GoogleGenAI({\n  apiKey: process.env.AI_INTEGRATIONS_GEMINI_API_KEY,\n  httpOptions: {\n    apiVersion: \"\",\n    baseUrl: process.env.AI_INTEGRATIONS_GEMINI_BASE_URL,\n  },\n});\n\nexport function registerChatRoutes(app: Express): void {\n  // Get all conversations\n  app.get(\"/api/conversations\", async (req: Request, res: Response) => {\n    try {\n      const conversations = await chatStorage.getAllConversations();\n      res.json(conversations);\n    } catch (error) {\n      console.error(\"Error fetching conversations:\", error);\n      res.status(500).json({ error: \"Failed to fetch conversations\" });\n    }\n  });\n\n  // Get single conversation with messages\n  app.get(\"/api/conversations/:id\", async (req: Request, res: Response) => {\n    try {\n      const id = parseInt(req.params.id);\n      const conversation = await chatStorage.getConversation(id);\n      if (!conversation) {\n        return res.status(404).json({ error: \"Conversation not found\" });\n      }\n      const messages = await chatStorage.getMessagesByConversation(id);\n      res.json({ ...conversation, messages });\n    } catch (error) {\n      console.error(\"Error fetching conversation:\", error);\n      res.status(500).json({ error: \"Failed to fetch conversation\" });\n    }\n  });\n\n  // Create new conversation\n  app.post(\"/api/conversations\", async (req: Request, res: Response) => {\n    try {\n      const { title } = req.body;\n      const conversation = await chatStorage.createConversation(title || \"New Chat\");\n      res.status(201).json(conversation);\n    } catch (error) {\n      console.error(\"Error creating conversation:\", error);\n      res.status(500).json({ error: \"Failed to create conversation\" });\n    }\n  });\n\n  // Delete conversation\n  app.delete(\"/api/conversations/:id\", async (req: Request, res: Response) => {\n    try {\n      const id = parseInt(req.params.id);\n      await chatStorage.deleteConversation(id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting conversation:\", error);\n      res.status(500).json({ error: \"Failed to delete conversation\" });\n    }\n  });\n\n  // Send message and get AI response (streaming)\n  app.post(\"/api/conversations/:id/messages\", async (req: Request, res: Response) => {\n    try {\n      const conversationId = parseInt(req.params.id);\n      const { content } = req.body;\n\n      // Save user message\n      await chatStorage.createMessage(conversationId, \"user\", content);\n\n      // Get conversation history for context\n      const messages = await chatStorage.getMessagesByConversation(conversationId);\n      const chatMessages = messages.map((m) => ({\n        role: m.role as \"user\" | \"model\",\n        parts: [{ text: m.content }],\n      }));\n\n      // Set up SSE\n      res.setHeader(\"Content-Type\", \"text/event-stream\");\n      res.setHeader(\"Cache-Control\", \"no-cache\");\n      res.setHeader(\"Connection\", \"keep-alive\");\n\n      // Stream response from Gemini\n      const stream = await ai.models.generateContentStream({\n        model: \"gemini-2.5-flash\",\n        contents: chatMessages,\n        config: { maxOutputTokens: 8192 },\n      });\n\n      let fullResponse = \"\";\n\n      for await (const chunk of stream) {\n        const content = chunk.text || \"\";\n        if (content) {\n          fullResponse += content;\n          res.write(`data: ${JSON.stringify({ content })}\\n\\n`);\n        }\n      }\n\n      // Save assistant message\n      await chatStorage.createMessage(conversationId, \"assistant\", fullResponse);\n\n      res.write(`data: ${JSON.stringify({ done: true })}\\n\\n`);\n      res.end();\n    } catch (error) {\n      console.error(\"Error sending message:\", error);\n      // Check if headers already sent (SSE streaming started)\n      if (res.headersSent) {\n        res.write(`data: ${JSON.stringify({ error: \"Failed to send message\" })}\\n\\n`);\n        res.end();\n      } else {\n        res.status(500).json({ error: \"Failed to send message\" });\n      }\n    }\n  });\n}\n\n","path":null,"size_bytes":4406,"size_tokens":null},"client/src/pages/landing.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Eye, Target, MessageCircle, Shield, ArrowRight, Zap, Users, Bot, Send, Quote, Globe, Utensils, Brain, Dog, Dumbbell, ExternalLink, LayoutDashboard } from \"lucide-react\";\nimport { SiFacebook, SiReddit, SiLinkedin, SiGoogle } from \"react-icons/si\";\nimport { useTheme } from \"@/components/theme-provider\";\nimport { useAuth } from \"@/hooks/use-auth\";\n\nconst demoPost = {\n  author: \"Sarah M.\",\n  group: \"West Suburbs Community\",\n  text: \"Hey everyone, looking for a reliable estate planning lawyer in the West Suburbs. Any recommendations?\",\n};\n\nconst demoResponse = \"Hi Sarah! A friend of mine recently worked with Mitchell & Associates on their estate plan and had a wonderful experience. They're based right in Brookfield and really take the time to explain everything. Might be worth giving them a call!\";\n\nfunction TypingAnimation({ text, onComplete }: { text: string; onComplete?: () => void }) {\n  const [displayed, setDisplayed] = useState(\"\");\n  const [index, setIndex] = useState(0);\n\n  useEffect(() => {\n    if (index < text.length) {\n      const timer = setTimeout(() => {\n        setDisplayed((prev) => prev + text[index]);\n        setIndex((prev) => prev + 1);\n      }, 18);\n      return () => clearTimeout(timer);\n    } else {\n      onComplete?.();\n    }\n  }, [index, text, onComplete]);\n\n  return (\n    <span>\n      {displayed}\n      {index < text.length && (\n        <span className=\"inline-block w-0.5 h-4 bg-primary ml-0.5 animate-pulse\" />\n      )}\n    </span>\n  );\n}\n\nfunction DemoPreview() {\n  const [stage, setStage] = useState<\"post\" | \"thinking\" | \"response\">(\"post\");\n\n  useEffect(() => {\n    const t1 = setTimeout(() => setStage(\"thinking\"), 2500);\n    const t2 = setTimeout(() => setStage(\"response\"), 4500);\n    return () => {\n      clearTimeout(t1);\n      clearTimeout(t2);\n    };\n  }, []);\n\n  return (\n    <div className=\"relative\">\n      <Card className=\"p-5 space-y-4\">\n        <div className=\"flex items-center gap-3\">\n          <div className=\"w-9 h-9 rounded-full bg-primary/20 flex items-center justify-center\">\n            <Users className=\"w-4 h-4 text-primary\" />\n          </div>\n          <div>\n            <p className=\"text-sm font-medium\" data-testid=\"text-demo-author\">{demoPost.author}</p>\n            <p className=\"text-xs text-muted-foreground\">{demoPost.group}</p>\n          </div>\n        </div>\n        <p className=\"text-sm leading-relaxed text-foreground/90\" data-testid=\"text-demo-post\">\n          \"{demoPost.text}\"\n        </p>\n\n        {stage === \"thinking\" && (\n          <div className=\"flex items-center gap-2 pt-2\">\n            <Bot className=\"w-4 h-4 text-primary animate-pulse\" />\n            <span className=\"text-xs text-primary font-medium\">AI Agent Thinking...</span>\n            <div className=\"flex gap-1\">\n              <span className=\"w-1.5 h-1.5 rounded-full bg-primary animate-bounce\" style={{ animationDelay: \"0ms\" }} />\n              <span className=\"w-1.5 h-1.5 rounded-full bg-primary animate-bounce\" style={{ animationDelay: \"150ms\" }} />\n              <span className=\"w-1.5 h-1.5 rounded-full bg-primary animate-bounce\" style={{ animationDelay: \"300ms\" }} />\n            </div>\n          </div>\n        )}\n\n        {stage === \"response\" && (\n          <div className=\"border-t pt-4 space-y-2\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-7 h-7 rounded-full bg-chart-2/20 flex items-center justify-center\">\n                <Send className=\"w-3 h-3 text-chart-2\" />\n              </div>\n              <span className=\"text-xs font-medium text-chart-2\">Gemin-Eye Response</span>\n            </div>\n            <p className=\"text-sm leading-relaxed text-foreground/80\" data-testid=\"text-demo-response\">\n              <TypingAnimation text={demoResponse} />\n            </p>\n          </div>\n        )}\n      </Card>\n      <div className=\"absolute -top-3 -right-3\">\n        <Badge variant=\"secondary\" className=\"text-xs\">Live Demo</Badge>\n      </div>\n    </div>\n  );\n}\n\nexport default function LandingPage() {\n  const { theme, toggleTheme } = useTheme();\n  const { user } = useAuth();\n\n  const features = [\n    {\n      icon: Target,\n      title: \"Hyper-Targeted\",\n      description: \"We find the exact people asking for your service right now. No wasted impressions.\",\n      color: \"text-primary\",\n      bg: \"bg-primary/10\",\n    },\n    {\n      icon: MessageCircle,\n      title: \"Subtle & Human\",\n      description: \"Our AI crafts responses that look like friendly advice, not disruptive ads.\",\n      color: \"text-chart-2\",\n      bg: \"bg-chart-2/10\",\n    },\n    {\n      icon: Shield,\n      title: \"Trusted Channels\",\n      description: \"By participating in niche groups, your brand leverages built-in community trust.\",\n      color: \"text-chart-3\",\n      bg: \"bg-chart-3/10\",\n    },\n  ];\n\n  const howItWorks = [\n    {\n      step: \"01\",\n      title: \"Describe Your Business\",\n      description: \"Tell us who you are, what you offer, and who your ideal customer is.\",\n      icon: Users,\n    },\n    {\n      step: \"02\",\n      title: \"AI Generates Your Strategy\",\n      description: \"Our top-tier AI analyzes your business and identifies the best groups, keywords, and platforms to target.\",\n      icon: Bot,\n    },\n    {\n      step: \"03\",\n      title: \"Monitor & Respond\",\n      description: \"Gemin-Eye watches for high-intent posts and crafts human-like responses. You approve and post in seconds via Telegram alerts.\",\n      icon: Zap,\n    },\n  ];\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <nav className=\"fixed top-0 left-0 right-0 z-50 backdrop-blur-xl bg-background/80 border-b\">\n        <div className=\"max-w-6xl mx-auto px-4 sm:px-6 h-16 flex items-center justify-between gap-4\">\n          <div className=\"flex items-center gap-2\">\n            <img src=\"/images/logo.png\" alt=\"Gemin-Eye\" className=\"w-7 h-7\" />\n            <span className=\"font-semibold text-lg tracking-tight\" data-testid=\"text-brand-name\">Gemin-Eye</span>\n          </div>\n          <div className=\"hidden md:flex items-center gap-6\">\n            <a href=\"#features\" className=\"text-sm text-muted-foreground hover:text-foreground transition-colors\">Features</a>\n            <a href=\"#how-it-works\" className=\"text-sm text-muted-foreground hover:text-foreground transition-colors\">How It Works</a>\n            <a href=\"#clients\" className=\"text-sm text-muted-foreground hover:text-foreground transition-colors\" data-testid=\"link-nav-clients\">Clients</a>\n          </div>\n          <div className=\"flex items-center gap-3\">\n            {user ? (\n              <Button size=\"sm\" asChild data-testid=\"button-go-dashboard\">\n                <a href=\"/dashboard\"><LayoutDashboard className=\"w-4 h-4 mr-1\" /> Dashboard</a>\n              </Button>\n            ) : (\n              <>\n                <Button variant=\"ghost\" size=\"sm\" asChild data-testid=\"button-login\">\n                  <a href=\"/api/login\">Log In</a>\n                </Button>\n                <Button size=\"sm\" asChild data-testid=\"button-get-started\">\n                  <a href=\"/api/login\">Get Started <ArrowRight className=\"w-4 h-4 ml-1\" /></a>\n                </Button>\n              </>\n            )}\n          </div>\n        </div>\n      </nav>\n\n      <section className=\"pt-32 pb-20 px-4 sm:px-6\">\n        <div className=\"max-w-6xl mx-auto grid lg:grid-cols-2 gap-12 lg:gap-16 items-center\">\n          <div className=\"space-y-6\">\n            <Badge variant=\"secondary\" className=\"text-xs\" data-testid=\"badge-tagline\">\n              <Zap className=\"w-3 h-3 mr-1\" /> AI-Powered Customer Acquisition\n            </Badge>\n            <h1 className=\"text-4xl sm:text-5xl lg:text-6xl font-serif font-bold leading-tight tracking-tight\" data-testid=\"text-hero-title\">\n              Customer Acquisition,{\" \"}\n              <span className=\"text-primary\">Reimagined.</span>\n            </h1>\n            <p className=\"text-lg text-muted-foreground max-w-lg leading-relaxed\" data-testid=\"text-hero-subtitle\">\n              Stop blasting ads to millions. Gemin-Eye monitors specific interest groups and responds to high-intent questions as a helpful human.\n            </p>\n            <div className=\"flex flex-wrap items-center gap-3\">\n              <Button size=\"lg\" asChild data-testid=\"button-hero-cta\">\n                <a href=\"/api/login\">\n                  Get Started Free <ArrowRight className=\"w-4 h-4 ml-2\" />\n                </a>\n              </Button>\n              <Button variant=\"outline\" size=\"lg\" asChild data-testid=\"button-hero-demo\">\n                <a href=\"#how-it-works\">View Demo</a>\n              </Button>\n            </div>\n            <div className=\"flex items-center gap-4 pt-2\">\n              <div className=\"flex items-center gap-2.5\">\n                <SiFacebook className=\"w-4 h-4 text-muted-foreground\" />\n                <SiReddit className=\"w-4 h-4 text-muted-foreground\" />\n                <SiLinkedin className=\"w-4 h-4 text-muted-foreground\" />\n                <SiGoogle className=\"w-4 h-4 text-muted-foreground\" />\n              </div>\n              <span className=\"text-xs text-muted-foreground\">Monitors the internet for your next customer</span>\n            </div>\n          </div>\n\n          <div className=\"lg:pl-8\">\n            <DemoPreview />\n          </div>\n        </div>\n      </section>\n\n      <section id=\"features\" className=\"py-20 px-4 sm:px-6 bg-card/50\">\n        <div className=\"max-w-6xl mx-auto\">\n          <div className=\"text-center mb-14\">\n            <h2 className=\"text-3xl font-serif font-bold mb-3\" data-testid=\"text-features-title\">The Smartest Way to Sell</h2>\n            <p className=\"text-muted-foreground max-w-md mx-auto\">\n              Direct, intentional response advertising that finds your customers where they're already asking.\n            </p>\n          </div>\n          <div className=\"grid md:grid-cols-3 gap-6\">\n            {features.map((f) => (\n              <Card key={f.title} className=\"p-6 space-y-4 hover-elevate\" data-testid={`card-feature-${f.title.toLowerCase().replace(/\\s+/g, \"-\")}`}>\n                <div className={`w-10 h-10 rounded-md ${f.bg} flex items-center justify-center`}>\n                  <f.icon className={`w-5 h-5 ${f.color}`} />\n                </div>\n                <h3 className=\"font-semibold text-lg\">{f.title}</h3>\n                <p className=\"text-sm text-muted-foreground leading-relaxed\">{f.description}</p>\n              </Card>\n            ))}\n          </div>\n        </div>\n      </section>\n\n      <section id=\"how-it-works\" className=\"py-20 px-4 sm:px-6\">\n        <div className=\"max-w-6xl mx-auto\">\n          <div className=\"text-center mb-14\">\n            <h2 className=\"text-3xl font-serif font-bold mb-3\" data-testid=\"text-how-title\">How It Works</h2>\n            <p className=\"text-muted-foreground max-w-md mx-auto\">\n              From setup to your first lead in minutes, not months.\n            </p>\n          </div>\n          <div className=\"grid md:grid-cols-3 gap-8\">\n            {howItWorks.map((step) => (\n              <div key={step.step} className=\"text-center space-y-4\" data-testid={`step-${step.step}`}>\n                <div className=\"w-14 h-14 mx-auto rounded-full bg-primary/10 flex items-center justify-center\">\n                  <step.icon className=\"w-6 h-6 text-primary\" />\n                </div>\n                <div className=\"text-xs font-mono text-primary font-semibold\">STEP {step.step}</div>\n                <h3 className=\"font-semibold text-lg\">{step.title}</h3>\n                <p className=\"text-sm text-muted-foreground leading-relaxed\">{step.description}</p>\n              </div>\n            ))}\n          </div>\n        </div>\n      </section>\n\n      <section id=\"clients\" className=\"py-20 px-4 sm:px-6 bg-card/50\">\n        <div className=\"max-w-6xl mx-auto\">\n          <div className=\"text-center mb-14\">\n            <h2 className=\"text-3xl font-serif font-bold mb-3\" data-testid=\"text-clients-title\">Trusted by Growing Businesses</h2>\n            <p className=\"text-muted-foreground max-w-md mx-auto\">\n              From local restaurants to national breeders, businesses across industries use Gemin-Eye to find customers organically.\n            </p>\n          </div>\n          <div className=\"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4\">\n            {[\n              { name: \"Doro Mind\", type: \"Mental Health\", icon: Brain, url: \"https://doromind.com\" },\n              { name: \"Chicago Bocce\", type: \"Recreation\", icon: Dumbbell, url: \"https://www.chicagobocceclub.com/\" },\n              { name: \"LMAITFY.ai\", type: \"AI Tool\", icon: Globe, url: \"https://lmaitfy.ai\" },\n              { name: \"Tony's\", type: \"Diner\", icon: Utensils, url: \"https://tonysofbrookfield.com/\" },\n              { name: \"Heart of America Whoodles\", type: \"Dog Breeder\", icon: Dog, url: \"https://heartofamericawhoodles.com\" },\n              { name: \"Gemin-Eye\", type: \"AI SaaS\", icon: Eye, url: \"https://gemin-eye.com\" },\n            ].map((client) => (\n              <a key={client.name} href={client.url} target=\"_blank\" rel=\"noopener noreferrer\" data-testid={`link-client-${client.name.toLowerCase().replace(/\\s+/g, \"-\")}`}>\n                <Card className=\"p-4 flex flex-col items-center text-center gap-2 hover-elevate h-full\" data-testid={`card-client-${client.name.toLowerCase().replace(/\\s+/g, \"-\")}`}>\n                  <div className=\"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center\">\n                    <client.icon className=\"w-5 h-5 text-primary\" />\n                  </div>\n                  <p className=\"text-sm font-medium leading-tight\" data-testid={`text-client-name-${client.name.toLowerCase().replace(/\\s+/g, \"-\")}`}>{client.name}</p>\n                  <p className=\"text-xs text-muted-foreground\" data-testid={`text-client-type-${client.name.toLowerCase().replace(/\\s+/g, \"-\")}`}>{client.type}</p>\n                  <ExternalLink className=\"w-3 h-3 text-muted-foreground/50\" />\n                </Card>\n              </a>\n            ))}\n          </div>\n        </div>\n      </section>\n\n      <section className=\"py-20 px-4 sm:px-6\">\n        <div className=\"max-w-3xl mx-auto\">\n          <div className=\"text-center mb-10\">\n            <h2 className=\"text-3xl font-serif font-bold mb-3\" data-testid=\"text-testimonial-title\">We Eat Our Own Cooking</h2>\n            <p className=\"text-muted-foreground max-w-md mx-auto\">\n              Gemin-Eye uses its own platform to find new clients. If that's not confidence in your product, what is?\n            </p>\n          </div>\n          <Card className=\"p-8 relative\" data-testid=\"card-testimonial\">\n            <Quote className=\"w-10 h-10 text-primary/20 absolute top-6 left-6\" />\n            <div className=\"relative space-y-4 pl-4\">\n              <p className=\"text-lg leading-relaxed text-foreground/90 italic\" data-testid=\"text-testimonial-quote\">\n                \"We built Gemin-Eye to help businesses find customers without ads or cold outreach. So naturally, we asked ourselves: why not use it to find our own clients? We set up Gemin-Eye as its own client  monitoring Reddit, Facebook Groups, and Google Alerts for entrepreneurs and marketers asking about lead generation, customer acquisition, and organic growth. It works. The same AI that finds dog-breed seekers and bocce enthusiasts also finds SaaS founders who need exactly what we built. We're client number seven, and we're our own best case study.\"\n              </p>\n              <div className=\"flex items-center gap-3 pt-2\">\n                <div className=\"w-10 h-10 rounded-full bg-primary flex items-center justify-center\">\n                  <Eye className=\"w-5 h-5 text-primary-foreground\" />\n                </div>\n                <div>\n                  <p className=\"font-semibold text-sm\" data-testid=\"text-testimonial-author\">Gemin-Eye Team</p>\n                  <p className=\"text-xs text-muted-foreground\" data-testid=\"text-testimonial-subtitle\">Client #7  Yes, we monitor ourselves</p>\n                </div>\n                <Badge variant=\"secondary\" className=\"ml-auto text-xs\" data-testid=\"badge-active-client\">\n                  <Zap className=\"w-3 h-3 mr-1\" /> Active Client\n                </Badge>\n              </div>\n            </div>\n          </Card>\n        </div>\n      </section>\n\n      <section className=\"py-20 px-4 sm:px-6 bg-card/50\">\n        <div className=\"max-w-2xl mx-auto text-center space-y-6\">\n          <h2 className=\"text-3xl font-serif font-bold\" data-testid=\"text-cta-title\">Ready to Find Your Next Customer?</h2>\n          <p className=\"text-muted-foreground\">\n            Join businesses that are already using AI to turn community conversations into qualified leads.\n          </p>\n          <Button size=\"lg\" asChild data-testid=\"button-cta-final\">\n            <a href=\"/api/login\">\n              Start For Free <ArrowRight className=\"w-4 h-4 ml-2\" />\n            </a>\n          </Button>\n        </div>\n      </section>\n\n      <footer className=\"border-t py-8 px-4 sm:px-6\">\n        <div className=\"max-w-6xl mx-auto flex flex-wrap items-center justify-between gap-4\">\n          <div className=\"flex items-center gap-2\">\n            <img src=\"/images/logo.png\" alt=\"Gemin-Eye\" className=\"w-5 h-5\" />\n            <span className=\"text-sm font-medium\">Gemin-Eye</span>\n          </div>\n          <p className=\"text-xs text-muted-foreground\">&copy; 2026 Gemin-Eye. All rights reserved.</p>\n        </div>\n      </footer>\n    </div>\n  );\n}\n","path":null,"size_bytes":17667,"size_tokens":null},"server/replit_integrations/auth/storage.ts":{"content":"import { users, type User, type UpsertUser } from \"@shared/models/auth\";\nimport { db } from \"../../db\";\nimport { eq } from \"drizzle-orm\";\n\n// Interface for auth storage operations\n// (IMPORTANT) These user operations are mandatory for Replit Auth.\nexport interface IAuthStorage {\n  getUser(id: string): Promise<User | undefined>;\n  upsertUser(user: UpsertUser): Promise<User>;\n}\n\nclass AuthStorage implements IAuthStorage {\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user;\n  }\n\n  async upsertUser(userData: UpsertUser): Promise<User> {\n    const [user] = await db\n      .insert(users)\n      .values(userData)\n      .onConflictDoUpdate({\n        target: users.id,\n        set: {\n          ...userData,\n          updatedAt: new Date(),\n        },\n      })\n      .returning();\n    return user;\n  }\n}\n\nexport const authStorage = new AuthStorage();\n","path":null,"size_bytes":943,"size_tokens":null},"server/telegram.ts":{"content":"import { escapeHtml, truncate } from \"./utils/html\";\n\nconst TELEGRAM_API = \"https://api.telegram.org/bot\";\n\nfunction getBotToken(): string | undefined {\n  return process.env.TELEGRAM_BOT_TOKEN;\n}\n\nfunction getChatId(): string | undefined {\n  return process.env.TELEGRAM_CHAT_ID;\n}\n\nexport interface InlineButton {\n  text: string;\n  url?: string;\n  callback_data?: string;\n}\n\nexport interface TelegramMessageOptions {\n  buttons?: InlineButton[][];\n  disable_web_page_preview?: boolean;\n}\n\nexport async function sendTelegramMessageToChat(\n  chatId: string,\n  text: string,\n  options?: TelegramMessageOptions\n): Promise<boolean> {\n  const token = getBotToken();\n\n  if (!token) {\n    console.warn(\"Telegram not configured: missing TELEGRAM_BOT_TOKEN\");\n    return false;\n  }\n\n  try {\n    const body: Record<string, any> = {\n      chat_id: chatId,\n      text,\n      parse_mode: \"HTML\",\n      disable_web_page_preview: options?.disable_web_page_preview !== false,\n    };\n\n    if (options?.buttons && options.buttons.length > 0) {\n      body.reply_markup = {\n        inline_keyboard: options.buttons,\n      };\n    }\n\n    const res = await fetch(`${TELEGRAM_API}${token}/sendMessage`, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify(body),\n    });\n\n    if (!res.ok) {\n      const err = await res.text();\n      console.error(\"Telegram API error:\", err);\n      return false;\n    }\n\n    return true;\n  } catch (error) {\n    console.error(\"Telegram send error:\", error);\n    return false;\n  }\n}\n\nexport async function sendTelegramMessage(\n  text: string,\n  options?: TelegramMessageOptions\n): Promise<boolean> {\n  const chatId = getChatId();\n\n  if (!chatId) {\n    console.warn(\"Telegram not configured: missing TELEGRAM_CHAT_ID\");\n    return false;\n  }\n\n  return sendTelegramMessageToChat(chatId, text, options);\n}\n\nexport function formatLeadNotification(lead: {\n  authorName: string;\n  groupName: string;\n  platform: string;\n  originalPost: string;\n  intentScore: number;\n}, businessName: string, aiResponse?: string): string {\n  const scoreBar = \"\".repeat(lead.intentScore) + \"\".repeat(10 - lead.intentScore);\n\n  let msg = `<b>New Lead Found</b>\\n`;\n  msg += `<b>Business:</b> ${escapeHtml(businessName)}\\n`;\n  msg += `<b>Platform:</b> ${escapeHtml(lead.platform)} / ${escapeHtml(lead.groupName)}\\n`;\n  msg += `<b>Author:</b> ${escapeHtml(lead.authorName)}\\n`;\n  msg += `<b>Intent:</b> ${scoreBar} ${lead.intentScore}/10\\n\\n`;\n  msg += `<b>Post:</b>\\n<i>\"${escapeHtml(lead.originalPost)}\"</i>\\n`;\n\n  if (aiResponse) {\n    msg += `\\n<b>Suggested Response (copy & paste):</b>\\n<code>${escapeHtml(aiResponse)}</code>`;\n  }\n\n  return msg;\n}\n\nexport function formatResponseNotification(lead: {\n  authorName: string;\n  groupName: string;\n  platform: string;\n  originalPost: string;\n}, businessName: string, aiResponse: string): string {\n  let msg = `<b>AI Response Ready</b>\\n`;\n  msg += `<b>Business:</b> ${escapeHtml(businessName)}\\n`;\n  msg += `<b>For:</b> ${escapeHtml(lead.authorName)} in ${escapeHtml(lead.groupName)}\\n\\n`;\n  msg += `<b>Original post:</b>\\n<i>\"${escapeHtml(truncate(lead.originalPost, 200))}\"</i>\\n\\n`;\n  msg += `<b>Copy & paste this response:</b>\\n<code>${escapeHtml(aiResponse)}</code>`;\n\n  return msg;\n}\n\nexport async function answerCallbackQuery(\n  callbackQueryId: string,\n  text?: string\n): Promise<boolean> {\n  const token = getBotToken();\n  if (!token) return false;\n\n  try {\n    const body: Record<string, any> = { callback_query_id: callbackQueryId };\n    if (text) body.text = text;\n\n    const res = await fetch(`${TELEGRAM_API}${token}/answerCallbackQuery`, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify(body),\n    });\n    return res.ok;\n  } catch (error) {\n    console.error(\"Telegram answerCallbackQuery error:\", error);\n    return false;\n  }\n}\n\nexport async function editMessageReplyMarkup(\n  chatId: string,\n  messageId: number,\n  replyMarkup?: { inline_keyboard: InlineButton[][] }\n): Promise<boolean> {\n  const token = getBotToken();\n  if (!token) return false;\n\n  try {\n    const body: Record<string, any> = {\n      chat_id: chatId,\n      message_id: messageId,\n    };\n    if (replyMarkup) {\n      body.reply_markup = replyMarkup;\n    } else {\n      body.reply_markup = { inline_keyboard: [] };\n    }\n\n    const res = await fetch(`${TELEGRAM_API}${token}/editMessageReplyMarkup`, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify(body),\n    });\n    return res.ok;\n  } catch (error) {\n    console.error(\"Telegram editMessageReplyMarkup error:\", error);\n    return false;\n  }\n}\n\n","path":null,"size_bytes":4683,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4120,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":261,"size_tokens":null},"server/replit_integrations/image/client.ts":{"content":"import { GoogleGenAI, Modality } from \"@google/genai\";\n\n// This is using Replit's AI Integrations service, which provides Gemini-compatible API access without requiring your own Gemini API key.\nexport const ai = new GoogleGenAI({\n  apiKey: process.env.AI_INTEGRATIONS_GEMINI_API_KEY,\n  httpOptions: {\n    apiVersion: \"\",\n    baseUrl: process.env.AI_INTEGRATIONS_GEMINI_BASE_URL,\n  },\n});\n\n/**\n * Generate an image and return as base64 data URL.\n * Uses gemini-2.5-flash-image model via Replit AI Integrations.\n */\nexport async function generateImage(prompt: string): Promise<string> {\n  const response = await ai.models.generateContent({\n    model: \"gemini-2.5-flash-image\",\n    contents: [{ role: \"user\", parts: [{ text: prompt }] }],\n    config: {\n      responseModalities: [Modality.TEXT, Modality.IMAGE],\n    },\n  });\n\n  const candidate = response.candidates?.[0];\n  const imagePart = candidate?.content?.parts?.find(\n    (part: { inlineData?: { data?: string; mimeType?: string } }) => part.inlineData\n  );\n\n  if (!imagePart?.inlineData?.data) {\n    throw new Error(\"No image data in response\");\n  }\n\n  const mimeType = imagePart.inlineData.mimeType || \"image/png\";\n  return `data:${mimeType};base64,${imagePart.inlineData.data}`;\n}\n\n","path":null,"size_bytes":1239,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4281,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \" ,\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary: \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n\n        outline: \" border [border-color:var(--badge-outline)] shadow-xs\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  },\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  );\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1202,"size_tokens":null},"shared/schema.ts":{"content":"import { sql, relations } from \"drizzle-orm\";\nimport { pgTable, text, varchar, serial, integer, timestamp, boolean, jsonb, index, uniqueIndex } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\nexport * from \"./models/auth\";\nexport * from \"./models/chat\";\n\nexport const businesses = pgTable(\"businesses\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull(),\n  telegramChatId: varchar(\"telegram_chat_id\"),\n  name: text(\"name\").notNull(),\n  type: text(\"type\").notNull(),\n  contactEmail: text(\"contact_email\"),\n  contactPhone: text(\"contact_phone\"),\n  website: text(\"website\"),\n  targetAudience: text(\"target_audience\").notNull(),\n  coreOffering: text(\"core_offering\").notNull(),\n  preferredTone: text(\"preferred_tone\").notNull().default(\"empathetic\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"idx_businesses_user_id\").on(table.userId),\n]);\n\nexport const businessesRelations = relations(businesses, ({ many }) => ({\n  campaigns: many(campaigns),\n}));\n\nexport const campaigns = pgTable(\"campaigns\", {\n  id: serial(\"id\").primaryKey(),\n  businessId: integer(\"business_id\").notNull().references(() => businesses.id, { onDelete: \"cascade\" }),\n  name: text(\"name\").notNull(),\n  platform: text(\"platform\").notNull(),\n  status: text(\"status\").notNull().default(\"active\"),\n  strategy: text(\"strategy\"),\n  targetGroups: jsonb(\"target_groups\").$type<string[]>().default([]),\n  keywords: jsonb(\"keywords\").$type<string[]>().default([]),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"idx_campaigns_business_id\").on(table.businessId),\n  index(\"idx_campaigns_platform_status\").on(table.platform, table.status),\n]);\n\nexport const campaignsRelations = relations(campaigns, ({ one, many }) => ({\n  business: one(businesses, {\n    fields: [campaigns.businessId],\n    references: [businesses.id],\n  }),\n  leads: many(leads),\n}));\n\nexport const leads = pgTable(\"leads\", {\n  id: serial(\"id\").primaryKey(),\n  campaignId: integer(\"campaign_id\").notNull().references(() => campaigns.id, { onDelete: \"cascade\" }),\n  platform: text(\"platform\").notNull(),\n  groupName: text(\"group_name\").notNull(),\n  authorName: text(\"author_name\").notNull(),\n  originalPost: text(\"original_post\").notNull(),\n  postUrl: text(\"post_url\"),\n  intentScore: integer(\"intent_score\").notNull().default(0),\n  status: text(\"status\").notNull().default(\"new\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"idx_leads_campaign_id\").on(table.campaignId),\n  index(\"idx_leads_created_at\").on(table.createdAt),\n]);\n\nexport const leadsRelations = relations(leads, ({ one, many }) => ({\n  campaign: one(campaigns, {\n    fields: [leads.campaignId],\n    references: [campaigns.id],\n  }),\n  responses: many(aiResponses),\n}));\n\nexport const aiResponses = pgTable(\"ai_responses\", {\n  id: serial(\"id\").primaryKey(),\n  leadId: integer(\"lead_id\").notNull().references(() => leads.id, { onDelete: \"cascade\" }),\n  content: text(\"content\").notNull(),\n  status: text(\"status\").notNull().default(\"pending\"),\n  approvedAt: timestamp(\"approved_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"idx_ai_responses_lead_id\").on(table.leadId),\n  index(\"idx_ai_responses_status\").on(table.status),\n]);\n\nexport const aiResponsesRelations = relations(aiResponses, ({ one }) => ({\n  lead: one(leads, {\n    fields: [aiResponses.leadId],\n    references: [leads.id],\n  }),\n}));\n\nexport const insertBusinessSchema = createInsertSchema(businesses).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertCampaignSchema = createInsertSchema(campaigns).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertLeadSchema = createInsertSchema(leads).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const responseFeedback = pgTable(\"response_feedback\", {\n  id: serial(\"id\").primaryKey(),\n  responseId: integer(\"response_id\").notNull().references(() => aiResponses.id, { onDelete: \"cascade\" }),\n  feedback: text(\"feedback\").notNull(),\n  reason: text(\"reason\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"idx_response_feedback_response_id\").on(table.responseId),\n]);\n\nexport const responseFeedbackRelations = relations(responseFeedback, ({ one }) => ({\n  response: one(aiResponses, {\n    fields: [responseFeedback.responseId],\n    references: [aiResponses.id],\n  }),\n}));\n\nexport const insertAiResponseSchema = createInsertSchema(aiResponses).omit({\n  id: true,\n  createdAt: true,\n  approvedAt: true,\n});\n\nexport const insertResponseFeedbackSchema = createInsertSchema(responseFeedback).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const seenItems = pgTable(\"seen_items\", {\n  id: serial(\"id\").primaryKey(),\n  dedupKey: text(\"dedup_key\").notNull().unique(),\n  source: text(\"source\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"idx_seen_items_created_at\").on(table.createdAt),\n]);\n\nexport const rateLimitBuckets = pgTable(\"rate_limit_buckets\", {\n  id: serial(\"id\").primaryKey(),\n  limiterName: text(\"limiter_name\").notNull(),\n  key: text(\"key\").notNull(),\n  count: integer(\"count\").notNull().default(1),\n  resetAt: timestamp(\"reset_at\").notNull(),\n}, (table) => [\n  uniqueIndex(\"idx_rate_limit_name_key\").on(table.limiterName, table.key),\n  index(\"idx_rate_limit_reset_at\").on(table.resetAt),\n]);\n\nexport type Business = typeof businesses.$inferSelect;\nexport type InsertBusiness = z.infer<typeof insertBusinessSchema>;\nexport type Campaign = typeof campaigns.$inferSelect;\nexport type InsertCampaign = z.infer<typeof insertCampaignSchema>;\nexport type Lead = typeof leads.$inferSelect;\nexport type InsertLead = z.infer<typeof insertLeadSchema>;\nexport type AiResponse = typeof aiResponses.$inferSelect;\nexport type InsertAiResponse = z.infer<typeof insertAiResponseSchema>;\nexport type ResponseFeedback = typeof responseFeedback.$inferSelect;\nexport type InsertResponseFeedback = z.infer<typeof insertResponseFeedbackSchema>;\n","path":null,"size_bytes":6082,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-4 w-4 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1148,"size_tokens":null},"client/src/App.tsx":{"content":"import { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { ThemeProvider } from \"@/components/theme-provider\";\nimport LandingPage from \"@/pages/landing\";\nimport Dashboard from \"@/pages/dashboard\";\nimport OnboardingPage from \"@/pages/onboarding\";\nimport NotFound from \"@/pages/not-found\";\nimport ClientGuidePage from \"@/pages/client-guide\";\nimport AdminPage from \"@/pages/admin\";\nimport BookmarkletsPage from \"@/pages/bookmarklets\";\n\nfunction AuthRouter() {\n  return (\n    <Switch>\n      <Route path=\"/\" component={LandingPage} />\n      <Route path=\"/dashboard\" component={Dashboard} />\n      <Route path=\"/onboarding\" component={OnboardingPage} />\n      <Route path=\"/guide\" component={ClientGuidePage} />\n      <Route path=\"/admin\" component={AdminPage} />\n      <Route path=\"/bookmarklets/:businessId/:chatId/:token\" component={BookmarkletsPage} />\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <ThemeProvider>\n        <TooltipProvider>\n          <Toaster />\n          <AuthRouter />\n        </TooltipProvider>\n      </ThemeProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":1395,"size_tokens":null},"server/replit_integrations/chat/index.ts":{"content":"export { registerChatRoutes } from \"./routes\";\nexport { chatStorage, type IChatStorage } from \"./storage\";\n\n","path":null,"size_bytes":108,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":1080,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(`\n      after:content-[''] after:block after:absolute after:inset-0 after:rounded-full after:pointer-events-none after:border after:border-black/10 dark:after:border-white/10\n      relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full`,\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1592,"size_tokens":null},"server/storage.ts":{"content":"import {\n  businesses, campaigns, leads, aiResponses, users,\n  type Business, type InsertBusiness,\n  type Campaign, type InsertCampaign,\n  type Lead, type InsertLead,\n  type AiResponse, type InsertAiResponse,\n  type User,\n} from \"@shared/schema\";\nimport { db } from \"./db\";\nimport { eq, desc, inArray, ne } from \"drizzle-orm\";\n\nexport interface DashboardData {\n  businesses: Business[];\n  campaigns: Campaign[];\n  leads: Lead[];\n  responses: AiResponse[];\n}\n\nexport interface IStorage {\n  getBusinessesByUser(userId: string): Promise<Business[]>;\n  getBusinessesByTelegramChatId(chatId: string): Promise<Business[]>;\n  createBusiness(data: InsertBusiness): Promise<Business>;\n  getCampaignsByBusiness(businessId: number): Promise<Campaign[]>;\n  getCampaignsByUser(userId: string): Promise<Campaign[]>;\n  createCampaign(data: InsertCampaign): Promise<Campaign>;\n  getLeadsByCampaigns(campaignIds: number[]): Promise<Lead[]>;\n  createLead(data: InsertLead): Promise<Lead>;\n  getResponsesByLeads(leadIds: number[]): Promise<AiResponse[]>;\n  createResponse(data: InsertAiResponse): Promise<AiResponse>;\n  updateResponseStatus(id: number, status: string): Promise<AiResponse>;\n  getAllBusinesses(): Promise<Business[]>;\n  getBusinessById(id: number): Promise<Business | undefined>;\n  updateBusiness(id: number, data: Partial<InsertBusiness>): Promise<Business>;\n  updateCampaign(id: number, data: Partial<InsertCampaign>): Promise<Campaign>;\n  deleteCampaign(id: number): Promise<void>;\n  deleteBusiness(id: number): Promise<void>;\n  getDashboardData(userId: string): Promise<DashboardData>;\n  getUserById(id: string): Promise<User | undefined>;\n  getAllUsers(): Promise<User[]>;\n  updateUserRole(id: string, role: string): Promise<User>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  async getBusinessesByUser(userId: string): Promise<Business[]> {\n    return db.select().from(businesses).where(eq(businesses.userId, userId)).orderBy(desc(businesses.createdAt));\n  }\n\n  async getBusinessesByTelegramChatId(chatId: string): Promise<Business[]> {\n    return db.select().from(businesses).where(eq(businesses.telegramChatId, chatId)).orderBy(desc(businesses.createdAt));\n  }\n\n  async createBusiness(data: InsertBusiness): Promise<Business> {\n    const [biz] = await db.insert(businesses).values(data).returning();\n    return biz;\n  }\n\n  async getCampaignsByBusiness(businessId: number): Promise<Campaign[]> {\n    return db.select().from(campaigns).where(eq(campaigns.businessId, businessId)).orderBy(desc(campaigns.createdAt));\n  }\n\n  async getCampaignsByUser(userId: string): Promise<Campaign[]> {\n    const userBiz = await this.getBusinessesByUser(userId);\n    if (userBiz.length === 0) return [];\n    const bizIds = userBiz.map((b) => b.id);\n    return db.select().from(campaigns).where(inArray(campaigns.businessId, bizIds)).orderBy(desc(campaigns.createdAt));\n  }\n\n  async createCampaign(data: InsertCampaign): Promise<Campaign> {\n    const [camp] = await db.insert(campaigns).values(data).returning();\n    return camp;\n  }\n\n  async getLeadsByCampaigns(campaignIds: number[]): Promise<Lead[]> {\n    if (campaignIds.length === 0) return [];\n    return db.select().from(leads).where(inArray(leads.campaignId, campaignIds)).orderBy(desc(leads.createdAt));\n  }\n\n  async createLead(data: InsertLead): Promise<Lead> {\n    const [lead] = await db.insert(leads).values(data).returning();\n    return lead;\n  }\n\n  async getResponsesByLeads(leadIds: number[]): Promise<AiResponse[]> {\n    if (leadIds.length === 0) return [];\n    return db.select().from(aiResponses).where(inArray(aiResponses.leadId, leadIds)).orderBy(desc(aiResponses.createdAt));\n  }\n\n  async createResponse(data: InsertAiResponse): Promise<AiResponse> {\n    const [resp] = await db.insert(aiResponses).values(data).returning();\n    return resp;\n  }\n\n  async updateResponseStatus(id: number, status: string): Promise<AiResponse> {\n    const [resp] = await db.update(aiResponses).set({ status, approvedAt: status === \"approved\" ? new Date() : null }).where(eq(aiResponses.id, id)).returning();\n    return resp;\n  }\n\n  async getAllBusinesses(): Promise<Business[]> {\n    return db.select().from(businesses).orderBy(desc(businesses.createdAt));\n  }\n\n  async getBusinessById(id: number): Promise<Business | undefined> {\n    const [biz] = await db.select().from(businesses).where(eq(businesses.id, id)).limit(1);\n    return biz;\n  }\n\n  async updateBusiness(id: number, data: Partial<InsertBusiness>): Promise<Business> {\n    const [biz] = await db.update(businesses).set(data).where(eq(businesses.id, id)).returning();\n    return biz;\n  }\n\n  async updateCampaign(id: number, data: Partial<InsertCampaign>): Promise<Campaign> {\n    const [camp] = await db.update(campaigns).set(data).where(eq(campaigns.id, id)).returning();\n    return camp;\n  }\n\n  async deleteCampaign(id: number): Promise<void> {\n    await db.delete(campaigns).where(eq(campaigns.id, id));\n  }\n\n  async deleteBusiness(id: number): Promise<void> {\n    await db.delete(businesses).where(eq(businesses.id, id));\n  }\n\n  async getDashboardData(userId: string): Promise<DashboardData> {\n    const userBiz = await db.select().from(businesses).where(eq(businesses.userId, userId)).orderBy(desc(businesses.createdAt));\n    if (userBiz.length === 0) return { businesses: userBiz, campaigns: [], leads: [], responses: [] };\n\n    const bizIds = userBiz.map((b) => b.id);\n    const userCamps = await db.select().from(campaigns).where(inArray(campaigns.businessId, bizIds)).orderBy(desc(campaigns.createdAt));\n    if (userCamps.length === 0) return { businesses: userBiz, campaigns: userCamps, leads: [], responses: [] };\n\n    const campIds = userCamps.map((c) => c.id);\n    const userLeads = await db.select().from(leads).where(inArray(leads.campaignId, campIds)).orderBy(desc(leads.createdAt));\n    if (userLeads.length === 0) return { businesses: userBiz, campaigns: userCamps, leads: userLeads, responses: [] };\n\n    const leadIds = userLeads.map((l) => l.id);\n    const userResponses = await db.select().from(aiResponses).where(inArray(aiResponses.leadId, leadIds)).orderBy(desc(aiResponses.createdAt));\n\n    return { businesses: userBiz, campaigns: userCamps, leads: userLeads, responses: userResponses };\n  }\n\n  async getUserById(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id)).limit(1);\n    return user;\n  }\n\n  async getAllUsers(): Promise<User[]> {\n    return db.select().from(users).orderBy(desc(users.createdAt));\n  }\n\n  async updateUserRole(id: string, role: string): Promise<User> {\n    const [user] = await db.update(users).set({ role }).where(eq(users.id, id)).returning();\n    return user;\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","path":null,"size_bytes":6739,"size_tokens":null},"client/src/lib/auth-utils.ts":{"content":"export function isUnauthorizedError(error: Error): boolean {\n  return /^401: .*Unauthorized/.test(error.message);\n}\n\n// Redirect to login with a toast notification\nexport function redirectToLogin(toast?: (options: { title: string; description: string; variant: string }) => void) {\n  if (toast) {\n    toast({\n      title: \"Unauthorized\",\n      description: \"You are logged out. Logging in again...\",\n      variant: \"destructive\",\n    });\n  }\n  setTimeout(() => {\n    window.location.href = \"/api/login\";\n  }, 500);\n}\n","path":null,"size_bytes":517,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"shadcn-card rounded-xl border bg-card border-card-border text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n));\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n));\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardDescription,\n  CardContent,\n}\n","path":null,"size_bytes":1904,"size_tokens":null},"server/static.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(__dirname, \"public\");\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"/{*path}\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":554,"size_tokens":null},"server/replit_integrations/batch/index.ts":{"content":"export {\n  batchProcess,\n  batchProcessWithSSE,\n  isRateLimitError,\n  type BatchOptions,\n} from \"./utils\";\n\n","path":null,"size_bytes":108,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":157,"size_tokens":null},"server/replit_integrations/chat/storage.ts":{"content":"import { db } from \"../../db\";\nimport { conversations, messages } from \"@shared/schema\";\nimport { eq, desc } from \"drizzle-orm\";\n\nexport interface IChatStorage {\n  getConversation(id: number): Promise<typeof conversations.$inferSelect | undefined>;\n  getAllConversations(): Promise<(typeof conversations.$inferSelect)[]>;\n  createConversation(title: string): Promise<typeof conversations.$inferSelect>;\n  deleteConversation(id: number): Promise<void>;\n  getMessagesByConversation(conversationId: number): Promise<(typeof messages.$inferSelect)[]>;\n  createMessage(conversationId: number, role: string, content: string): Promise<typeof messages.$inferSelect>;\n}\n\nexport const chatStorage: IChatStorage = {\n  async getConversation(id: number) {\n    const [conversation] = await db.select().from(conversations).where(eq(conversations.id, id));\n    return conversation;\n  },\n\n  async getAllConversations() {\n    return db.select().from(conversations).orderBy(desc(conversations.createdAt));\n  },\n\n  async createConversation(title: string) {\n    const [conversation] = await db.insert(conversations).values({ title }).returning();\n    return conversation;\n  },\n\n  async deleteConversation(id: number) {\n    await db.delete(messages).where(eq(messages.conversationId, id));\n    await db.delete(conversations).where(eq(conversations.id, id));\n  },\n\n  async getMessagesByConversation(conversationId: number) {\n    return db.select().from(messages).where(eq(messages.conversationId, conversationId)).orderBy(messages.createdAt);\n  },\n\n  async createMessage(conversationId: number, role: string, content: string) {\n    const [message] = await db.insert(messages).values({ conversationId, role, content }).returning();\n    return message;\n  },\n};\n\n","path":null,"size_bytes":1737,"size_tokens":null},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes\";\nimport { serveStatic } from \"./static\";\nimport { createServer } from \"http\";\n\nconst requiredEnvVars = [\"DATABASE_URL\", \"SESSION_SECRET\"];\nconst optionalEnvVars = [\"TELEGRAM_BOT_TOKEN\", \"AI_INTEGRATIONS_GEMINI_API_KEY\"];\n\nfor (const envVar of requiredEnvVars) {\n  if (!process.env[envVar]) {\n    console.error(`FATAL: Missing required environment variable: ${envVar}`);\n    process.exit(1);\n  }\n}\n\nfor (const envVar of optionalEnvVars) {\n  if (!process.env[envVar]) {\n    console.warn(`WARNING: Missing optional environment variable: ${envVar}  some features will be disabled`);\n  }\n}\n\nconst app = express();\nconst httpServer = createServer(app);\n\ndeclare module \"http\" {\n  interface IncomingMessage {\n    rawBody: unknown;\n  }\n}\n\napp.use(\n  express.json({\n    verify: (req, _res, buf) => {\n      req.rawBody = buf;\n    },\n  }),\n);\n\napp.use(express.urlencoded({ extended: false }));\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  await registerRoutes(httpServer, app);\n\n  const { seedDatabase } = await import(\"./seed\");\n  await seedDatabase().catch((e) => console.error(\"Seed error:\", e));\n\n  const { syncKeywords } = await import(\"./sync-keywords\");\n  await syncKeywords().catch((e) => console.error(\"Keyword sync error:\", e));\n\n  app.use((err: any, _req: Request, res: Response, next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    console.error(\"Internal Server Error:\", err);\n\n    if (res.headersSent) {\n      return next(err);\n    }\n\n    return res.status(status).json({ message });\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (process.env.NODE_ENV === \"production\") {\n    serveStatic(app);\n  } else {\n    const { setupVite } = await import(\"./vite\");\n    await setupVite(httpServer, app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || \"5000\", 10);\n  httpServer.listen(\n    {\n      port,\n      host: \"0.0.0.0\",\n      reusePort: true,\n    },\n    () => {\n      log(`serving on port ${port}`);\n    },\n  );\n})();\n","path":null,"size_bytes":3431,"size_tokens":null},"script/build.ts":{"content":"import { build as esbuild } from \"esbuild\";\nimport { build as viteBuild } from \"vite\";\nimport { rm, readFile } from \"fs/promises\";\nimport { execSync } from \"child_process\";\n\n// server deps to bundle to reduce openat(2) syscalls\n// which helps cold start times\nconst allowlist = [\n  \"@google/generative-ai\",\n  \"axios\",\n  \"connect-pg-simple\",\n  \"cors\",\n  \"date-fns\",\n  \"drizzle-orm\",\n  \"drizzle-zod\",\n  \"express\",\n  \"express-rate-limit\",\n  \"express-session\",\n  \"jsonwebtoken\",\n  \"memorystore\",\n  \"multer\",\n  \"nanoid\",\n  \"nodemailer\",\n  \"openai\",\n  \"passport\",\n  \"passport-local\",\n  \"pg\",\n  \"stripe\",\n  \"uuid\",\n  \"ws\",\n  \"xlsx\",\n  \"zod\",\n  \"zod-validation-error\",\n];\n\nasync function buildAll() {\n  await rm(\"dist\", { recursive: true, force: true });\n\n  console.log(\"building client...\");\n  await viteBuild();\n\n  console.log(\"building server...\");\n  const pkg = JSON.parse(await readFile(\"package.json\", \"utf-8\"));\n  const allDeps = [\n    ...Object.keys(pkg.dependencies || {}),\n    ...Object.keys(pkg.devDependencies || {}),\n  ];\n  const externals = allDeps.filter((dep) => !allowlist.includes(dep));\n\n  await esbuild({\n    entryPoints: [\"server/index.ts\"],\n    platform: \"node\",\n    bundle: true,\n    format: \"cjs\",\n    outfile: \"dist/index.cjs\",\n    define: {\n      \"process.env.NODE_ENV\": '\"production\"',\n    },\n    minify: true,\n    external: externals,\n    logLevel: \"info\",\n  });\n\n  console.log(\"creating source archive...\");\n  execSync(\n    `tar -czf dist/public/gemin-eye-source.tar.gz --exclude='node_modules' --exclude='dist' --exclude='.cache' --exclude='.local' --exclude='attached_assets' --exclude='.git' --exclude='*.log' shared/ server/ client/src/ client/index.html tailwind.config.ts vite.config.ts drizzle.config.ts package.json tsconfig.json replit.md`\n  );\n}\n\nbuildAll().catch((err) => {\n  console.error(err);\n  process.exit(1);\n});\n","path":null,"size_bytes":1851,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","path":null,"size_bytes":1383,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1209,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":710,"size_tokens":null},"server/replit_integrations/image/index.ts":{"content":"export { registerImageRoutes } from \"./routes\";\nexport { ai, generateImage } from \"./client\";\n\n","path":null,"size_bytes":95,"size_tokens":null},"server/seed.ts":{"content":"import { db } from \"./db\";\nimport { businesses, campaigns, leads, aiResponses } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\n\nexport async function seedDatabase() {\n  const existing = await db.select().from(businesses);\n  if (existing.length > 0) return;\n\n  console.log(\"Seeding database with demo data...\");\n\n  const demoBiz = [\n    {\n      userId: \"demo\",\n      name: \"Doro Mind\",\n      type: \"Psychiatric care for serious mental illness\",\n      targetAudience: \"Caregivers of patients with schizophrenia, bipolar disorder, and schizoaffective disorder\",\n      coreOffering: \"Comprehensive psychiatric care and support network for individuals and families dealing with serious mental illness. We provide personalized treatment plans, caregiver support groups, and access to a network of specialized mental health professionals.\",\n      preferredTone: \"empathetic\",\n    },\n    {\n      userId: \"demo\",\n      name: \"Chicago Bocce\",\n      type: \"Recreational bocce ball club\",\n      targetAudience: \"Adults in the Chicago area looking for social recreational activities, Italian-American community members, corporate team building groups\",\n      coreOffering: \"Chicago's premier bocce ball club offering leagues, tournaments, private events, and drop-in play. Located in the heart of the city with indoor and outdoor courts, great food, and a welcoming community atmosphere.\",\n      preferredTone: \"casual\",\n    },\n    {\n      userId: \"demo\",\n      name: \"Tony's\",\n      type: \"Diner in Brookfield, IL\",\n      targetAudience: \"Families and food lovers in the Western Suburbs of Chicago looking for a great local diner, comfort food, breakfast spots, and casual dining\",\n      coreOffering: \"Classic American diner in Brookfield, IL serving hearty breakfasts, comfort food favorites, and homestyle cooking. Family-owned with a warm, welcoming atmosphere. Known for generous portions, fresh ingredients, and friendly service.\",\n      preferredTone: \"casual\",\n    },\n    {\n      userId: \"demo\",\n      name: \"LMAITFY.ai\",\n      type: \"AI productivity tool\",\n      targetAudience: \"Tech-savvy individuals, productivity enthusiasts, people who frequently share AI prompts with colleagues\",\n      coreOffering: \"Let Me AI That For You - a shareable link tool that lets you create links encoding questions for specific AI assistants. Perfect for sharing complex prompts with colleagues or playfully redirecting friends to ask AI themselves.\",\n      preferredTone: \"casual\",\n    },\n  ];\n\n  for (const biz of demoBiz) {\n    const [b] = await db.insert(businesses).values(biz).returning();\n\n    if (biz.name === \"Doro Mind\") {\n      const [camp1] = await db.insert(campaigns).values({\n        businessId: b.id,\n        name: \"Facebook SMI Groups\",\n        platform: \"Facebook\",\n        status: \"active\",\n        strategy: \"Monitor schizophrenia, bipolar, and schizoaffective support groups on Facebook where caregivers actively seek help and recommendations.\",\n        targetGroups: [\n          \"Schizophrenia Support Group\",\n          \"Bipolar Disorder & Family Support\",\n          \"Schizoaffective Disorder Awareness\",\n          \"Mental Health Caregivers Network\",\n          \"NAMI Family Support\"\n        ],\n        keywords: [\"looking for help\", \"recommendations\", \"good psychiatrist\", \"treatment options\", \"caregiver support\", \"new diagnosis\", \"where to find\", \"anyone know\"],\n      }).returning();\n\n      const [camp2] = await db.insert(campaigns).values({\n        businessId: b.id,\n        name: \"Reddit Mental Health\",\n        platform: \"Reddit\",\n        status: \"active\",\n        strategy: \"Monitor Reddit communities focused on schizophrenia and mental health where people openly discuss treatment options and seek advice.\",\n        targetGroups: [\n          \"r/schizophrenia\",\n          \"r/bipolar\",\n          \"r/mentalhealth\",\n          \"r/AskPsychiatry\"\n        ],\n        keywords: [\"treatment center\", \"help for my\", \"care facility\", \"support group\", \"new diagnosis\", \"looking for doctor\"],\n      }).returning();\n\n      const demoLeads = [\n        {\n          campaignId: camp1.id,\n          platform: \"Facebook\",\n          groupName: \"Schizophrenia Support Group\",\n          authorName: \"Maria G.\",\n          originalPost: \"Hi everyone, my son was recently diagnosed with schizophrenia and we're struggling to find a good care team. We're in the Midwest area. Does anyone have recommendations for comprehensive psychiatric care that also supports families?\",\n          postUrl: \"https://facebook.com/groups/example/post/1\",\n          intentScore: 9,\n          status: \"responded\",\n        },\n        {\n          campaignId: camp1.id,\n          platform: \"Facebook\",\n          groupName: \"Mental Health Caregivers Network\",\n          authorName: \"David R.\",\n          originalPost: \"I've been caring for my sister with schizoaffective disorder for 3 years now and I'm completely burned out. Are there any organizations that help caregivers directly? I need support too.\",\n          postUrl: \"https://facebook.com/groups/example/post/2\",\n          intentScore: 8,\n          status: \"new\",\n        },\n        {\n          campaignId: camp2.id,\n          platform: \"Reddit\",\n          groupName: \"r/schizophrenia\",\n          authorName: \"u/hopeful_parent_23\",\n          originalPost: \"My daughter just turned 18 and was diagnosed last month. We're looking for a place that treats young adults with schizophrenia and also has family therapy. Cost is a concern but we'll figure it out. Any suggestions?\",\n          postUrl: \"https://reddit.com/r/schizophrenia/example\",\n          intentScore: 10,\n          status: \"new\",\n        },\n      ];\n\n      for (const leadData of demoLeads) {\n        const [lead] = await db.insert(leads).values(leadData).returning();\n\n        if (leadData.status === \"responded\") {\n          await db.insert(aiResponses).values({\n            leadId: lead.id,\n            content: \"Hi Maria, I'm so sorry to hear about your son's diagnosis -- I know how overwhelming that can be for the whole family. A friend of mine connected with Doro Mind when her family was going through something similar, and she said their approach of supporting both the patient and the family really made a difference. They have a network of specialized professionals and even caregiver support groups. Might be worth reaching out to them.\",\n            status: \"approved\",\n          });\n        }\n      }\n    }\n\n    if (biz.name === \"Chicago Bocce\") {\n      const [camp] = await db.insert(campaigns).values({\n        businessId: b.id,\n        name: \"Chicago Social Groups\",\n        platform: \"Facebook\",\n        status: \"active\",\n        strategy: \"Target Chicago-area social and recreational groups where people look for fun group activities, date ideas, and team building events.\",\n        targetGroups: [\n          \"Things to Do in Chicago\",\n          \"Chicago Social Club\",\n          \"Italian Americans of Chicago\",\n          \"Chicago Corporate Events\",\n          \"Brookfield & Western Suburbs Social\"\n        ],\n        keywords: [\"fun things to do\", \"team building\", \"date night\", \"group activity\", \"social sports\", \"where to play\", \"bocce\"],\n      }).returning();\n\n      const [lead] = await db.insert(leads).values({\n        campaignId: camp.id,\n        platform: \"Facebook\",\n        groupName: \"Things to Do in Chicago\",\n        authorName: \"Jake T.\",\n        originalPost: \"Looking for something different for our office team building event next month. We're tired of escape rooms. Any unique ideas in the Chicago area? About 20 people, would love something active but not too intense.\",\n        postUrl: \"https://facebook.com/groups/example/post/3\",\n        intentScore: 8,\n        status: \"responded\",\n      }).returning();\n\n      await db.insert(aiResponses).values({\n        leadId: lead.id,\n        content: \"Hey Jake! Have you considered bocce? Chicago Bocce is a blast for team events -- they have indoor and outdoor courts, and it's the kind of thing where everyone can play regardless of skill level. Plus they do food and drinks which makes it feel more like a party than a forced team activity. A few of us from my office went last month and people are still talking about it.\",\n        status: \"approved\",\n      });\n    }\n\n    if (biz.name === \"Tony's\") {\n      const [camp1] = await db.insert(campaigns).values({\n        businessId: b.id,\n        name: \"Western Suburbs Facebook Groups\",\n        platform: \"Facebook\",\n        status: \"active\",\n        strategy: \"Monitor Western Suburbs and Brookfield community groups where people ask for restaurant recommendations, date night ideas, and catering services.\",\n        targetGroups: [\n          \"Brookfield IL Community\",\n          \"Western Suburbs Foodies\",\n          \"La Grange & Brookfield Moms\",\n          \"Best Restaurants in the Western Suburbs\",\n          \"Brookfield & Riverside Neighbors\"\n        ],\n        keywords: [\"restaurant recommendation\", \"Italian food\", \"date night\", \"catering\", \"best pizza\", \"good pasta\", \"where to eat\", \"Brookfield restaurant\", \"private dining\"],\n      }).returning();\n\n      const [camp2] = await db.insert(campaigns).values({\n        businessId: b.id,\n        name: \"Reddit Chicago Food\",\n        platform: \"Reddit\",\n        status: \"active\",\n        strategy: \"Monitor Chicago-area food subreddits where people seek restaurant recommendations in the suburbs.\",\n        targetGroups: [\n          \"r/chicagofood\",\n          \"r/chicago\",\n          \"r/ChicagoSuburbs\"\n        ],\n        keywords: [\"Italian restaurant\", \"suburbs restaurant\", \"Brookfield\", \"pasta\", \"pizza\", \"date night suburbs\"],\n      }).returning();\n\n      const demoLeads = [\n        {\n          campaignId: camp1.id,\n          platform: \"Facebook\",\n          groupName: \"Western Suburbs Foodies\",\n          authorName: \"Lisa M.\",\n          originalPost: \"Looking for a really good Italian restaurant near Brookfield for our anniversary dinner. We want somewhere with great pasta and a cozy atmosphere, not a chain. Any suggestions?\",\n          postUrl: \"https://facebook.com/groups/example/post/10\",\n          intentScore: 9,\n          status: \"responded\",\n        },\n        {\n          campaignId: camp1.id,\n          platform: \"Facebook\",\n          groupName: \"La Grange & Brookfield Moms\",\n          authorName: \"Karen W.\",\n          originalPost: \"Need a restaurant that can do catering for my daughter's communion party -- about 40 people. Preferably Italian. Anyone have a good experience with a local place?\",\n          postUrl: \"https://facebook.com/groups/example/post/11\",\n          intentScore: 10,\n          status: \"new\",\n        },\n        {\n          campaignId: camp2.id,\n          platform: \"Reddit\",\n          groupName: \"r/chicagofood\",\n          authorName: \"u/suburb_foodie\",\n          originalPost: \"Any hidden gem Italian spots in the western suburbs? Tired of the same old chains. Looking for somewhere with handmade pasta and a good wine list. Bonus if it's family-friendly.\",\n          postUrl: \"https://reddit.com/r/chicagofood/example\",\n          intentScore: 8,\n          status: \"new\",\n        },\n      ];\n\n      for (const leadData of demoLeads) {\n        const [lead] = await db.insert(leads).values(leadData).returning();\n\n        if (leadData.status === \"responded\") {\n          await db.insert(aiResponses).values({\n            leadId: lead.id,\n            content: \"Happy anniversary! You should check out Tony's in Brookfield -- my family goes there all the time. The breakfast is unreal, and it has that cozy, old-school diner vibe that just feels right. Portions are huge and the staff treats you like family. You won't be disappointed!\",\n            status: \"approved\",\n          });\n        }\n      }\n    }\n\n    if (biz.name === \"LMAITFY.ai\") {\n      const [camp] = await db.insert(campaigns).values({\n        businessId: b.id,\n        name: \"Reddit AI & Productivity\",\n        platform: \"Reddit\",\n        status: \"active\",\n        strategy: \"Monitor tech and productivity subreddits where people discuss AI tools, share prompts, and look for ways to improve their workflow.\",\n        targetGroups: [\n          \"r/ChatGPT\",\n          \"r/artificial\",\n          \"r/productivity\",\n          \"r/LifeProTips\",\n          \"r/cooltools\"\n        ],\n        keywords: [\"share prompts\", \"AI tool\", \"chatgpt link\", \"productivity hack\", \"share question\", \"ask AI\"],\n      }).returning();\n\n      const [lead] = await db.insert(leads).values({\n        campaignId: camp.id,\n        platform: \"Reddit\",\n        groupName: \"r/ChatGPT\",\n        authorName: \"u/techbro_42\",\n        originalPost: \"Is there an easy way to share a ChatGPT prompt with someone? Like I want to send my coworker a link that automatically loads a specific question into ChatGPT. Copy-paste is getting old.\",\n        postUrl: \"https://reddit.com/r/ChatGPT/example\",\n        intentScore: 9,\n        status: \"responded\",\n      }).returning();\n\n      await db.insert(aiResponses).values({\n        leadId: lead.id,\n        content: \"Oh yeah, check out LMAITFY.ai -- it does exactly this. You type in your prompt, pick which AI (ChatGPT, Gemini, Copilot), and it generates a shareable link. When someone opens it, the question auto-copies to their clipboard and redirects them. It's like the old LMGTFY but for AI. Super handy for sharing complex prompts.\",\n        status: \"approved\",\n      });\n    }\n  }\n\n  console.log(\"Seed data created successfully.\");\n}\n","path":null,"size_bytes":13446,"size_tokens":null},"client/src/components/theme-provider.tsx":{"content":"import { createContext, useContext, useEffect, useState } from \"react\";\n\ntype Theme = \"light\" | \"dark\";\n\ninterface ThemeContextType {\n  theme: Theme;\n  toggleTheme: () => void;\n}\n\nconst ThemeContext = createContext<ThemeContextType>({\n  theme: \"dark\",\n  toggleTheme: () => {},\n});\n\nexport function ThemeProvider({ children }: { children: React.ReactNode }) {\n  const [theme, setTheme] = useState<Theme>(() => {\n    if (typeof window !== \"undefined\") {\n      return (localStorage.getItem(\"gemin-eye-theme\") as Theme) || \"dark\";\n    }\n    return \"dark\";\n  });\n\n  useEffect(() => {\n    const root = document.documentElement;\n    root.classList.remove(\"light\", \"dark\");\n    root.classList.add(theme);\n    localStorage.setItem(\"gemin-eye-theme\", theme);\n  }, [theme]);\n\n  const toggleTheme = () => {\n    setTheme((prev) => (prev === \"light\" ? \"dark\" : \"light\"));\n  };\n\n  return (\n    <ThemeContext.Provider value={{ theme, toggleTheme }}>\n      {children}\n    </ThemeContext.Provider>\n  );\n}\n\nexport function useTheme() {\n  return useContext(ThemeContext);\n}\n","path":null,"size_bytes":1054,"size_tokens":null},"server/db.ts":{"content":"import { drizzle } from \"drizzle-orm/node-postgres\";\nimport pg from \"pg\";\nimport * as schema from \"@shared/schema\";\n\nconst { Pool } = pg;\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle(pool, { schema });\n","path":null,"size_bytes":395,"size_tokens":null},"shared/models/chat.ts":{"content":"import { pgTable, serial, integer, text, timestamp } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\nimport { sql } from \"drizzle-orm\";\n\nexport const conversations = pgTable(\"conversations\", {\n  id: serial(\"id\").primaryKey(),\n  title: text(\"title\").notNull(),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n});\n\nexport const messages = pgTable(\"messages\", {\n  id: serial(\"id\").primaryKey(),\n  conversationId: integer(\"conversation_id\").notNull().references(() => conversations.id, { onDelete: \"cascade\" }),\n  role: text(\"role\").notNull(),\n  content: text(\"content\").notNull(),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n});\n\nexport const insertConversationSchema = createInsertSchema(conversations).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertMessageSchema = createInsertSchema(messages).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type Conversation = typeof conversations.$inferSelect;\nexport type InsertConversation = z.infer<typeof insertConversationSchema>;\nexport type Message = typeof messages.$inferSelect;\nexport type InsertMessage = z.infer<typeof insertMessageSchema>;\n\n","path":null,"size_bytes":1229,"size_tokens":null},"server/replit_integrations/auth/index.ts":{"content":"export { setupAuth, isAuthenticated, getSession } from \"./replitAuth\";\nexport { authStorage, type IAuthStorage } from \"./storage\";\nexport { registerAuthRoutes } from \"./routes\";\n","path":null,"size_bytes":178,"size_tokens":null},"client/src/pages/onboarding.tsx":{"content":"import { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Form, FormControl, FormField, FormItem, FormLabel, FormMessage\n} from \"@/components/ui/form\";\nimport {\n  Select, SelectContent, SelectItem, SelectTrigger, SelectValue\n} from \"@/components/ui/select\";\nimport {\n  Eye, ArrowRight, ArrowLeft, Loader2, Sparkles, Target,\n  CheckCircle, Bot, Zap, MapPin, MessageCircle, Copy, ExternalLink\n} from \"lucide-react\";\nimport { SiFacebook, SiReddit } from \"react-icons/si\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nconst businessFormSchema = z.object({\n  name: z.string().min(1, \"Business name is required\"),\n  type: z.string().min(1, \"Business type is required\"),\n  contactEmail: z.string().email(\"Please enter a valid email address\"),\n  contactPhone: z.string().min(1, \"Phone number is required\"),\n  website: z.string().optional().default(\"\"),\n  location: z.string().optional().default(\"\"),\n  targetAudience: z.string().min(1, \"Target audience is required\"),\n  coreOffering: z.string().min(10, \"Please describe your core offering in more detail\"),\n  preferredTone: z.string().min(1, \"Please select a tone\"),\n});\n\ntype BusinessFormData = z.infer<typeof businessFormSchema>;\n\ninterface StrategyResult {\n  platforms: Array<{ name: string; icon: string }>;\n  groups: string[];\n  keywords: string[];\n  sampleResponse: string;\n  rationale: string;\n}\n\nexport default function OnboardingPage() {\n  const { user, isLoading: authLoading } = useAuth();\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const [step, setStep] = useState<\"profile\" | \"strategy\" | \"complete\">(\"profile\");\n  const [strategy, setStrategy] = useState<StrategyResult | null>(null);\n  const [createdBusinessId, setCreatedBusinessId] = useState<number | null>(null);\n  const [connectToken, setConnectToken] = useState<string | null>(null);\n\n  const form = useForm<BusinessFormData>({\n    resolver: zodResolver(businessFormSchema),\n    defaultValues: {\n      name: \"\",\n      type: \"\",\n      contactEmail: \"\",\n      contactPhone: \"\",\n      website: \"\",\n      location: \"\",\n      targetAudience: \"\",\n      coreOffering: \"\",\n      preferredTone: \"empathetic\",\n    },\n  });\n\n  const generateStrategy = useMutation({\n    mutationFn: async (data: BusinessFormData) => {\n      const res = await apiRequest(\"POST\", \"/api/strategy/generate\", data);\n      return res.json();\n    },\n    onSuccess: (data) => {\n      setStrategy(data);\n      setStep(\"strategy\");\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to generate strategy. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const createBusiness = useMutation({\n    mutationFn: async (data: BusinessFormData & { strategy: StrategyResult }) => {\n      const res = await apiRequest(\"POST\", \"/api/businesses\", data);\n      return res.json();\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/businesses\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/campaigns\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/leads\"] });\n      if (data?.id) setCreatedBusinessId(data.id);\n      if (data?.connectToken) setConnectToken(data.connectToken);\n      setStep(\"complete\");\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to save your business. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmitProfile = (data: BusinessFormData) => {\n    generateStrategy.mutate(data);\n  };\n\n  const onApproveStrategy = () => {\n    if (!strategy) return;\n    const formData = form.getValues();\n    createBusiness.mutate({ ...formData, strategy });\n  };\n\n  if (authLoading) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center\">\n        <Eye className=\"w-8 h-8 text-primary animate-pulse\" />\n      </div>\n    );\n  }\n\n  if (!user) {\n    window.location.href = \"/api/login\";\n    return null;\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <nav className=\"border-b\">\n        <div className=\"max-w-4xl mx-auto px-4 sm:px-6 h-16 flex items-center justify-between gap-4\">\n          <div className=\"flex items-center gap-2 cursor-pointer\" onClick={() => setLocation(\"/dashboard\")}>\n            <Eye className=\"w-5 h-5 text-primary\" />\n            <span className=\"font-semibold text-lg tracking-tight\">Gemin-Eye</span>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <div className={`w-2 h-2 rounded-full ${step === \"profile\" ? \"bg-primary\" : \"bg-chart-2\"}`} />\n            <div className={`w-8 h-0.5 ${step !== \"profile\" ? \"bg-chart-2\" : \"bg-muted\"}`} />\n            <div className={`w-2 h-2 rounded-full ${step === \"strategy\" ? \"bg-primary\" : step === \"complete\" ? \"bg-chart-2\" : \"bg-muted\"}`} />\n            <div className={`w-8 h-0.5 ${step === \"complete\" ? \"bg-chart-2\" : \"bg-muted\"}`} />\n            <div className={`w-2 h-2 rounded-full ${step === \"complete\" ? \"bg-primary\" : \"bg-muted\"}`} />\n          </div>\n        </div>\n      </nav>\n\n      <main className=\"max-w-2xl mx-auto px-4 sm:px-6 py-12\">\n        {step === \"profile\" && (\n          <div className=\"space-y-8\">\n            <div className=\"space-y-2\">\n              <h1 className=\"text-3xl font-serif font-bold\" data-testid=\"text-onboarding-title\">Setup Your Agent</h1>\n              <p className=\"text-muted-foreground\">\n                Provide the intelligence Gemin-Eye needs to represent you.\n              </p>\n            </div>\n\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmitProfile)} className=\"space-y-6\">\n                <Card className=\"p-6 space-y-5\">\n                  <h2 className=\"font-semibold flex items-center gap-2\">\n                    <Target className=\"w-4 h-4 text-primary\" /> Business Profile\n                  </h2>\n\n                  <FormField\n                    control={form.control}\n                    name=\"name\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Business Name</FormLabel>\n                        <FormControl>\n                          <Input placeholder=\"e.g., Doro Mind\" {...field} data-testid=\"input-business-name\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"type\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Business Type / Niche</FormLabel>\n                        <FormControl>\n                          <Input placeholder=\"e.g., Psychiatric care for serious mental illness\" {...field} data-testid=\"input-business-type\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"contactEmail\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Email</FormLabel>\n                        <FormControl>\n                          <Input type=\"email\" placeholder=\"e.g., you@yourbusiness.com\" {...field} data-testid=\"input-email\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"contactPhone\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Phone Number</FormLabel>\n                        <FormControl>\n                          <Input type=\"tel\" placeholder=\"e.g., (312) 555-1234\" {...field} data-testid=\"input-phone\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"website\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Website <span className=\"text-muted-foreground font-normal\">(optional)</span></FormLabel>\n                        <FormControl>\n                          <Input placeholder=\"e.g., https://yourbusiness.com\" {...field} data-testid=\"input-website\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"location\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Location / Reach</FormLabel>\n                        <FormControl>\n                          <Input placeholder=\"e.g., Chicago IL, National, or Global / Web-based\" {...field} data-testid=\"input-location\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"targetAudience\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Target Audience</FormLabel>\n                        <FormControl>\n                          <Input placeholder=\"e.g., Caregivers of patients with schizophrenia\" {...field} data-testid=\"input-target-audience\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"coreOffering\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Core Offering & Unique Value</FormLabel>\n                        <FormControl>\n                          <Textarea\n                            placeholder=\"Describe what makes your business unique and what you offer...\"\n                            className=\"resize-none\"\n                            rows={4}\n                            {...field}\n                            data-testid=\"input-core-offering\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"preferredTone\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Preferred Tone</FormLabel>\n                        <Select onValueChange={field.onChange} defaultValue={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-tone\">\n                              <SelectValue placeholder=\"Select tone\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            <SelectItem value=\"empathetic\">Empathetic & Supportive</SelectItem>\n                            <SelectItem value=\"professional\">Professional & Authoritative</SelectItem>\n                            <SelectItem value=\"casual\">Casual & Friendly</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </Card>\n\n                <Button\n                  type=\"submit\"\n                  size=\"lg\"\n                  className=\"w-full\"\n                  disabled={generateStrategy.isPending}\n                  data-testid=\"button-generate-strategy\"\n                >\n                  {generateStrategy.isPending ? (\n                    <>\n                      <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                      AI is Analyzing Your Business...\n                    </>\n                  ) : (\n                    <>\n                      <Sparkles className=\"w-4 h-4 mr-2\" />\n                      Generate AI Strategy\n                    </>\n                  )}\n                </Button>\n              </form>\n            </Form>\n          </div>\n        )}\n\n        {step === \"strategy\" && strategy && (\n          <div className=\"space-y-8\">\n            <div className=\"space-y-2\">\n              <div className=\"flex items-center gap-2\">\n                <Button variant=\"ghost\" size=\"icon\" onClick={() => setStep(\"profile\")} data-testid=\"button-back\">\n                  <ArrowLeft className=\"w-4 h-4\" />\n                </Button>\n                <h1 className=\"text-3xl font-serif font-bold\" data-testid=\"text-strategy-title\">Your AI Strategy</h1>\n              </div>\n              <p className=\"text-muted-foreground pl-12\">\n                Review the strategy Gemin-Eye created for your business.\n              </p>\n            </div>\n\n            <Card className=\"p-6 space-y-5\">\n              <h2 className=\"font-semibold flex items-center gap-2\">\n                <Bot className=\"w-4 h-4 text-primary\" /> Strategy Rationale\n              </h2>\n              <p className=\"text-sm leading-relaxed text-muted-foreground\" data-testid=\"text-strategy-rationale\">\n                {strategy.rationale}\n              </p>\n            </Card>\n\n            <Card className=\"p-6 space-y-5\">\n              <h2 className=\"font-semibold flex items-center gap-2\">\n                <Target className=\"w-4 h-4 text-primary\" /> Recommended Platforms & Groups\n              </h2>\n              <div className=\"flex flex-wrap gap-2\">\n                {strategy.platforms.map((p) => (\n                  <Badge key={p.name} variant=\"secondary\" className=\"text-xs\">\n                    {p.name === \"Facebook\" && <SiFacebook className=\"w-3 h-3 mr-1\" />}\n                    {p.name === \"Reddit\" && <SiReddit className=\"w-3 h-3 mr-1\" />}\n                    {p.name}\n                  </Badge>\n                ))}\n              </div>\n              <div className=\"space-y-2\">\n                <span className=\"text-sm font-medium\">Target Groups</span>\n                <div className=\"grid gap-2\">\n                  {strategy.groups.map((g, i) => (\n                    <div key={i} className=\"flex items-center gap-2 text-sm text-muted-foreground bg-muted/50 px-3 py-2 rounded-md\">\n                      <CheckCircle className=\"w-3 h-3 text-chart-2 flex-shrink-0\" />\n                      {g}\n                    </div>\n                  ))}\n                </div>\n              </div>\n            </Card>\n\n            <Card className=\"p-6 space-y-5\">\n              <h2 className=\"font-semibold flex items-center gap-2\">\n                <Zap className=\"w-4 h-4 text-primary\" /> Keywords to Monitor\n              </h2>\n              <div className=\"flex flex-wrap gap-2\">\n                {strategy.keywords.map((kw, i) => (\n                  <Badge key={i} variant=\"secondary\" className=\"text-xs font-mono\">{kw}</Badge>\n                ))}\n              </div>\n            </Card>\n\n            <Card className=\"p-6 space-y-5\">\n              <h2 className=\"font-semibold flex items-center gap-2\">\n                <Sparkles className=\"w-4 h-4 text-primary\" /> Sample AI Response\n              </h2>\n              <div className=\"bg-muted/50 p-4 rounded-md\">\n                <p className=\"text-sm leading-relaxed italic text-muted-foreground\" data-testid=\"text-sample-response\">\n                  \"{strategy.sampleResponse}\"\n                </p>\n              </div>\n            </Card>\n\n            <Button\n              size=\"lg\"\n              className=\"w-full\"\n              onClick={onApproveStrategy}\n              disabled={createBusiness.isPending}\n              data-testid=\"button-approve-strategy\"\n            >\n              {createBusiness.isPending ? (\n                <>\n                  <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                  Setting Up Your Agent...\n                </>\n              ) : (\n                <>\n                  <CheckCircle className=\"w-4 h-4 mr-2\" />\n                  Approve & Launch Campaign\n                </>\n              )}\n            </Button>\n          </div>\n        )}\n\n        {step === \"complete\" && (\n          <div className=\"py-12 space-y-8\">\n            <div className=\"text-center space-y-2\">\n              <div className=\"w-20 h-20 mx-auto rounded-full bg-chart-2/10 flex items-center justify-center\">\n                <CheckCircle className=\"w-10 h-10 text-chart-2\" />\n              </div>\n              <h2 className=\"text-3xl font-serif font-bold\" data-testid=\"text-complete-title\">You're All Set!</h2>\n              <p className=\"text-muted-foreground max-w-md mx-auto\">\n                One last step  connect Telegram so we can send leads to your phone.\n              </p>\n            </div>\n\n            <Card className=\"p-6 space-y-6\">\n              <h2 className=\"font-semibold text-center\" data-testid=\"text-telegram-title\">Get Leads on Your Phone in 3 Steps</h2>\n\n              <div className=\"space-y-5\">\n                <div className=\"flex items-start gap-4\">\n                  <div className=\"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center shrink-0 mt-0.5\">\n                    <span className=\"text-sm font-bold text-primary\">1</span>\n                  </div>\n                  <div className=\"flex-1\">\n                    <p className=\"text-sm font-medium\">Download Telegram</p>\n                    <p className=\"text-xs text-muted-foreground mb-2\">Free messaging app  like WhatsApp or iMessage</p>\n                    <div className=\"flex flex-wrap gap-2\">\n                      <a href=\"https://apps.apple.com/app/telegram-messenger/id686449807\" target=\"_blank\" rel=\"noopener noreferrer\" data-testid=\"link-telegram-ios\">\n                        <Badge variant=\"outline\" className=\"text-xs\">iPhone</Badge>\n                      </a>\n                      <a href=\"https://play.google.com/store/apps/details?id=org.telegram.messenger\" target=\"_blank\" rel=\"noopener noreferrer\" data-testid=\"link-telegram-android\">\n                        <Badge variant=\"outline\" className=\"text-xs\">Android</Badge>\n                      </a>\n                      <a href=\"https://desktop.telegram.org/\" target=\"_blank\" rel=\"noopener noreferrer\" data-testid=\"link-telegram-desktop\">\n                        <Badge variant=\"outline\" className=\"text-xs\">Desktop</Badge>\n                      </a>\n                    </div>\n                  </div>\n                </div>\n\n                <div className=\"flex items-start gap-4\">\n                  <div className=\"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center shrink-0 mt-0.5\">\n                    <span className=\"text-sm font-bold text-primary\">2</span>\n                  </div>\n                  <div>\n                    <p className=\"text-sm font-medium\">Create your account</p>\n                    <p className=\"text-xs text-muted-foreground\">Just enter your phone number  takes 30 seconds</p>\n                  </div>\n                </div>\n\n                <div className=\"flex items-start gap-4\">\n                  <div className=\"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center shrink-0 mt-0.5\">\n                    <span className=\"text-sm font-bold text-primary\">3</span>\n                  </div>\n                  <div className=\"flex-1\">\n                    <p className=\"text-sm font-medium\">Tap \"Connect Telegram\" below</p>\n                    <p className=\"text-xs text-muted-foreground mb-3\">This links your account  leads go straight to your phone</p>\n                    <Button\n                      size=\"lg\"\n                      className=\"w-full\"\n                      onClick={() => window.open(`https://t.me/kmages_bot?start=connect_${createdBusinessId}_${connectToken}`, \"_blank\")}\n                      data-testid=\"button-open-telegram\"\n                      disabled={!createdBusinessId || !connectToken}\n                    >\n                      <MessageCircle className=\"w-4 h-4 mr-2\" />\n                      Connect Telegram\n                      <ExternalLink className=\"w-3 h-3 ml-2\" />\n                    </Button>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"flex items-start gap-3 pt-2 border-t\">\n                <CheckCircle className=\"w-4 h-4 text-chart-2 shrink-0 mt-0.5\" />\n                <p className=\"text-xs text-muted-foreground\">\n                  Already have Telegram? Skip to step 3  just tap Connect.\n                </p>\n              </div>\n            </Card>\n\n            <Button variant=\"outline\" className=\"w-full\" onClick={() => setLocation(\"/dashboard\")} data-testid=\"button-go-dashboard\">\n              Skip for now  Go to Dashboard\n            </Button>\n          </div>\n        )}\n      </main>\n    </div>\n  );\n}\n","path":null,"size_bytes":21963,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":689,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    // h-9 to match icon buttons and default buttons.\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":844,"size_tokens":null},"server/google-alerts-monitor.ts":{"content":"import Parser from \"rss-parser\";\nimport { db } from \"./db\";\nimport { businesses, campaigns, leads, aiResponses } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\nimport { sendTelegramMessage, sendTelegramMessageToChat } from \"./telegram\";\nimport { isRedditConfigured } from \"./reddit-poster\";\nimport { generateContent, parseAIJsonWithRetry, leadScoreSchema, TONE_MAP, MIN_MONITOR_INTENT_SCORE } from \"./utils/ai\";\nimport { escapeHtml, stripHtml, canonicalizeUrl } from \"./utils/html\";\nimport { hasBeenSeen, markSeen, markOwnResponse, isOwnResponse } from \"./utils/dedup\";\nimport { getFeedbackGuidance } from \"./utils/feedback\";\nimport { keywordMatch } from \"./utils/keywords\";\n\nconst parser = new Parser({\n  headers: {\n    \"User-Agent\": \"Mozilla/5.0 (compatible; Gemin-Eye/1.0; +https://gemin-eye.com)\",\n    \"Accept\": \"text/xml, application/rss+xml, application/xml, application/atom+xml\",\n  },\n  timeout: 15000,\n});\n\nconst SCAN_INTERVAL = 120 * 1000;\nlet monitorInterval: ReturnType<typeof setInterval> | null = null;\n\ninterface AlertTarget {\n  feedUrl: string;\n  businessId: number;\n  businessName: string;\n  businessType: string;\n  coreOffering: string;\n  preferredTone: string;\n  campaignId: number;\n  keywords: string[];\n  ownerUserId: string;\n  telegramChatId: string | null;\n}\n\nasync function getAlertTargets(): Promise<AlertTarget[]> {\n  const allBiz = await db.select().from(businesses);\n  const allCamps = await db.select().from(campaigns);\n\n  const targets: AlertTarget[] = [];\n\n  for (const biz of allBiz) {\n    const bizCamps = allCamps.filter(\n      (c) => c.businessId === biz.id && c.status === \"active\" && c.platform.toLowerCase() === \"google_alerts\"\n    );\n\n    for (const camp of bizCamps) {\n      const feedUrls = (camp.targetGroups || []) as string[];\n      const keywords = (camp.keywords || []) as string[];\n\n      for (const feedUrl of feedUrls) {\n        const trimmed = feedUrl.trim();\n        if (!trimmed) continue;\n        if (!trimmed.startsWith(\"http\")) continue;\n\n        targets.push({\n          feedUrl: trimmed,\n          businessId: biz.id,\n          businessName: biz.name,\n          businessType: biz.type,\n          coreOffering: biz.coreOffering,\n          preferredTone: biz.preferredTone,\n          campaignId: camp.id,\n          keywords,\n          ownerUserId: biz.userId,\n          telegramChatId: biz.telegramChatId || null,\n        });\n      }\n    }\n  }\n\n  return targets;\n}\n\nfunction extractSourceName(link: string): string {\n  try {\n    const url = new URL(link);\n    const host = url.hostname.replace(\"www.\", \"\");\n    if (host.includes(\"quora.com\")) return \"Quora\";\n    if (host.includes(\"reddit.com\")) return \"Reddit\";\n    if (host.includes(\"stackoverflow.com\")) return \"Stack Overflow\";\n    if (host.includes(\"youtube.com\")) return \"YouTube\";\n    if (host.includes(\"medium.com\")) return \"Medium\";\n    return host;\n  } catch {\n    return \"Web\";\n  }\n}\n\nasync function processAlertItem(\n  item: { title: string; content: string; link: string; source: string },\n  target: AlertTarget\n): Promise<void> {\n  const fullText = `${item.title}\\n${item.content}`;\n\n  if (await isOwnResponse(fullText)) return;\n\n  if (!keywordMatch(fullText, target.keywords)) return;\n\n  const match = await parseAIJsonWithRetry(\n    async () => {\n      const result = await generateContent({\n        model: \"gemini-2.5-flash\",\n        contents: `You are a lead scout for \"${target.businessName}\" (${target.businessType}).\nThey offer: ${target.coreOffering}\n\nAnalyze this web content found via Google Alerts:\nSource: ${item.source}\nTitle: \"${item.title}\"\nContent: \"${item.content.slice(0, 600)}\"\n\nIs this person asking a question or seeking help/recommendations that \"${target.businessName}\" could address?\n\nSCORING GUIDE (be strict and spread scores across the full range):\n1-2: Completely unrelated topic, no connection to business\n3-4: Loosely related topic but NOT asking for help or recommendations\n5-6: Related topic, asking a question, but not specifically looking for what this business offers\n7-8: Clearly seeking help/recommendations in this business's area\n9-10: Actively looking for EXACTLY what this business offers, urgent need, ready to buy/act\n\nIMPORTANT: Return ONLY a single JSON object with no other text, no explanation, no markdown:\n{\"is_lead\": true, \"intent_score\": 5, \"reasoning\": \"one sentence explanation\"}`,\n        config: { maxOutputTokens: 512, thinkingConfig: { thinkingBudget: 0 } },\n      });\n      return result.text;\n    },\n    leadScoreSchema\n  );\n\n  if (!match) return;\n\n  if (!match.is_lead || match.intent_score < MIN_MONITOR_INTENT_SCORE) return;\n\n  const feedbackGuidance = await getFeedbackGuidance(target.businessId);\n\n  const platformLabel = item.source === \"Quora\" ? \"Quora answer\" :\n    item.source === \"Reddit\" ? \"Reddit comment\" :\n    item.source === \"YouTube\" ? \"YouTube comment\" :\n    `${item.source} comment/reply`;\n\n  const responseResult = await generateContent({\n    model: \"gemini-2.5-pro\",\n    contents: `You are writing a ${platformLabel}. Your goal is to be genuinely helpful while subtly recommending a business.\n\nThe post/question: \"${item.title}\\n${item.content.slice(0, 600)}\"\n\nBusiness to recommend: ${target.businessName}\nWhat they do: ${target.coreOffering}\nTone: ${TONE_MAP[target.preferredTone] || \"friendly and helpful\"}\n${feedbackGuidance}\n\nWrite a natural, human-sounding response (2-3 sentences). Do NOT make it sound like an ad. Sound like a real person sharing a helpful recommendation. Include the business name naturally.\n\nReturn ONLY the response text, no quotes or formatting.`,\n    config: { maxOutputTokens: 8192 },\n  });\n\n  const responseText = responseResult.text.trim();\n  if (!responseText) return;\n\n  await markOwnResponse(responseText);\n\n  let savedResponseId: number | null = null;\n  try {\n    const [savedLead] = await db\n      .insert(leads)\n      .values({\n        campaignId: target.campaignId,\n        platform: \"google_alerts\",\n        groupName: item.source,\n        authorName: \"Web user\",\n        originalPost: fullText.slice(0, 2000),\n        postUrl: item.link || null,\n        intentScore: match.intent_score,\n        status: \"matched\",\n      })\n      .returning();\n\n    if (savedLead) {\n      const [savedResponse] = await db\n        .insert(aiResponses)\n        .values({\n          leadId: savedLead.id,\n          content: responseText,\n          status: \"pending\",\n        })\n        .returning();\n      savedResponseId = savedResponse?.id || null;\n    }\n  } catch (err) {\n    console.error(\"Error saving Google Alert lead to DB:\", err);\n  }\n\n  const scoreBar = \"*\".repeat(match.intent_score) + \"_\".repeat(10 - match.intent_score);\n\n  let msg = `<b>Google Alert Lead Found</b>\\n\\n`;\n  msg += `<b>Business:</b> ${escapeHtml(target.businessName)}\\n`;\n  msg += `<b>Source:</b> ${escapeHtml(item.source)}\\n`;\n  msg += `<b>Intent:</b> ${scoreBar} ${match.intent_score}/10\\n`;\n  msg += `<b>Why:</b> ${escapeHtml(match.reasoning || \"\")}\\n\\n`;\n  msg += `<b>Post:</b>\\n<i>\"${escapeHtml(item.title.slice(0, 200))}\"</i>`;\n\n  if (item.link) {\n    msg += `\\n\\nTap \"Open Page\" below, then paste the reply.`;\n  }\n\n  const buttons: Array<Array<{ text: string; url?: string; callback_data?: string }>> = [];\n  if (item.link) {\n    buttons.push([{ text: \"Open Page\", url: item.link }]);\n  }\n  const isRedditSource = item.link && /reddit\\.com\\/r\\/\\w+\\/comments\\//i.test(item.link);\n  if (savedResponseId && isRedditSource && isRedditConfigured()) {\n    buttons.push([{ text: \"Post to Reddit\", callback_data: `reddit_post_${savedResponseId}` }]);\n  }\n  if (savedResponseId) {\n    buttons.push([\n      { text: \"Used It\", callback_data: `fb_good_${savedResponseId}` },\n      { text: \"Bad Match\", callback_data: `fb_bad_${savedResponseId}` },\n      { text: \"Too Salesy\", callback_data: `fb_salesy_${savedResponseId}` },\n      { text: \"Wrong Client\", callback_data: `fb_wrong_${savedResponseId}` },\n    ]);\n  }\n\n  if (target.telegramChatId) {\n    await sendTelegramMessageToChat(target.telegramChatId, msg, buttons.length > 0 ? { buttons } : undefined);\n    await sendTelegramMessageToChat(target.telegramChatId, responseText);\n  } else {\n    await sendTelegramMessage(msg, buttons.length > 0 ? { buttons } : undefined);\n    await sendTelegramMessage(responseText);\n  }\n}\n\nasync function scanFeedForTargets(feedUrl: string, targets: AlertTarget[]): Promise<void> {\n  try {\n    const res = await fetch(feedUrl, {\n      headers: {\n        \"User-Agent\": \"Gemin-Eye/1.0 (RSS Reader)\",\n        \"Accept\": \"text/xml, application/rss+xml, application/xml, application/atom+xml\",\n      },\n    });\n\n    if (!res.ok) {\n      throw new Error(`HTTP ${res.status}`);\n    }\n\n    const xml = await res.text();\n    const feed = await parser.parseString(xml);\n    const items = feed.items.slice(0, 8).map((item) => ({\n      title: item.title ? stripHtml(item.title) : \"\",\n      content: stripHtml(item.contentSnippet || item.content || item.summary || \"\"),\n      link: item.link || \"\",\n      source: item.link ? extractSourceName(item.link) : \"Web\",\n    }));\n\n    for (const item of items) {\n      const itemId = item.link ? canonicalizeUrl(item.link) : (item.title || \"\");\n      if (!itemId) continue;\n\n      for (const target of targets) {\n        const seenKey = `ga::${itemId}::${target.businessId}`;\n        if (await hasBeenSeen(seenKey)) continue;\n        await markSeen(seenKey, \"google_alerts\");\n\n        try {\n          await processAlertItem(item, target);\n        } catch (err: any) {\n          console.error(`Error processing alert for ${target.businessName}: ${err?.message || err}`);\n        }\n      }\n    }\n  } catch (err: any) {\n    const errMsg = err?.message || String(err);\n    if (errMsg.includes(\"403\") || errMsg.includes(\"429\")) {\n      console.log(`Google Alerts rate-limited for feed, will retry next cycle`);\n    } else {\n      console.error(`Error scanning Google Alert feed: ${errMsg}`);\n    }\n  }\n}\n\nasync function runScan(): Promise<void> {\n  const targets = await getAlertTargets();\n\n  if (targets.length === 0) {\n    return;\n  }\n\n  const feedMap = new Map<string, AlertTarget[]>();\n  for (const t of targets) {\n    const key = t.feedUrl;\n    if (!feedMap.has(key)) feedMap.set(key, []);\n    feedMap.get(key)!.push(t);\n  }\n\n  console.log(`Google Alerts monitor: scanning ${feedMap.size} feeds for ${targets.length} business targets...`);\n\n  const entries = Array.from(feedMap.values());\n  for (const feedTargets of entries) {\n    await scanFeedForTargets(feedTargets[0].feedUrl, feedTargets);\n    await new Promise((r) => setTimeout(r, 3000));\n  }\n}\n\nexport function startGoogleAlertsMonitor(): void {\n  if (monitorInterval) return;\n  if (process.env.MONITORING_DISABLED === \"true\") {\n    console.log(\"Google Alerts monitor: DISABLED via MONITORING_DISABLED env var\");\n    return;\n  }\n\n  console.log(\"Google Alerts monitor: starting (scans every 2 minutes)\");\n\n  setTimeout(() => {\n    runScan().catch((err) => console.error(\"Google Alerts monitor scan error:\", err));\n  }, 15000);\n\n  monitorInterval = setInterval(() => {\n    runScan().catch((err) => console.error(\"Google Alerts monitor scan error:\", err));\n  }, SCAN_INTERVAL);\n}\n\nexport function stopGoogleAlertsMonitor(): void {\n  if (monitorInterval) {\n    clearInterval(monitorInterval);\n    monitorInterval = null;\n    console.log(\"Google Alerts monitor: stopped\");\n  }\n}\n","path":null,"size_bytes":11349,"size_tokens":null},"server/reddit-monitor.ts":{"content":"import Parser from \"rss-parser\";\nimport { db } from \"./db\";\nimport { businesses, campaigns, leads, aiResponses } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\nimport { sendTelegramMessage, sendTelegramMessageToChat } from \"./telegram\";\nimport { isRedditConfigured } from \"./reddit-poster\";\nimport { generateContent, parseAIJsonWithRetry, leadScoreSchema, TONE_MAP, MIN_MONITOR_INTENT_SCORE } from \"./utils/ai\";\nimport { escapeHtml } from \"./utils/html\";\nimport { hasBeenSeen, markSeen, markOwnResponse, isOwnResponse } from \"./utils/dedup\";\nimport { getFeedbackGuidance } from \"./utils/feedback\";\nimport { keywordMatch } from \"./utils/keywords\";\n\nconst parser = new Parser({\n  headers: {\n    \"User-Agent\": \"Mozilla/5.0 (compatible; Gemin-Eye/1.0; +https://gemin-eye.com)\",\n    \"Accept\": \"text/xml, application/rss+xml, application/xml\",\n  },\n  timeout: 10000,\n});\nconst SCAN_INTERVAL = 5 * 60 * 1000;\nlet monitorInterval: ReturnType<typeof setInterval> | null = null;\n\ninterface SubredditTarget {\n  subreddit: string;\n  businessId: number;\n  businessName: string;\n  businessType: string;\n  coreOffering: string;\n  preferredTone: string;\n  campaignId: number;\n  keywords: string[];\n  ownerUserId: string;\n  telegramChatId: string | null;\n}\n\nasync function getRedditTargets(): Promise<SubredditTarget[]> {\n  const allBiz = await db.select().from(businesses);\n  const allCamps = await db.select().from(campaigns);\n\n  const targets: SubredditTarget[] = [];\n\n  for (const biz of allBiz) {\n    const bizCamps = allCamps.filter(\n      (c) => c.businessId === biz.id && c.status === \"active\"\n    );\n\n    for (const camp of bizCamps) {\n      const groups = (camp.targetGroups || []) as string[];\n      const keywords = (camp.keywords || []) as string[];\n\n      for (const group of groups) {\n        const cleaned = group\n          .replace(/^r\\//, \"\")\n          .replace(/^\\/r\\//, \"\")\n          .trim();\n        if (!cleaned) continue;\n        if (/\\s/.test(cleaned)) continue;\n        if (cleaned.length > 50) continue;\n\n        targets.push({\n          subreddit: cleaned,\n          businessId: biz.id,\n          businessName: biz.name,\n          businessType: biz.type,\n          coreOffering: biz.coreOffering,\n          preferredTone: biz.preferredTone,\n          campaignId: camp.id,\n          keywords,\n          ownerUserId: biz.userId,\n          telegramChatId: biz.telegramChatId || null,\n        });\n      }\n    }\n  }\n\n  return targets;\n}\n\nasync function processPostForTarget(\n  post: { title: string; content: string; link: string },\n  target: SubredditTarget\n): Promise<void> {\n  const title = post.title;\n  const content = post.content;\n  const fullText = `${title}\\n${content}`;\n\n  if (await isOwnResponse(fullText)) return;\n\n  if (target.keywords.length > 0 && !keywordMatch(fullText, target.keywords)) return;\n\n  const match = await parseAIJsonWithRetry(\n    async () => {\n      const result = await generateContent({\n        model: \"gemini-2.5-flash\",\n        contents: `You are a lead scout for \"${target.businessName}\" (${target.businessType}).\nThey offer: ${target.coreOffering}\n\nAnalyze this Reddit post from r/${target.subreddit}:\nTitle: \"${title}\"\nContent: \"${content.slice(0, 400)}\"\n\nIs this person asking a question or seeking help/recommendations that \"${target.businessName}\" could address?\n\nSCORING GUIDE (be strict and spread scores across the full range):\n1-2: Completely unrelated topic, no connection to business\n3-4: Loosely related topic but NOT asking for help or recommendations\n5-6: Related topic, asking a question, but not specifically looking for what this business offers\n7-8: Clearly seeking help/recommendations in this business's area\n9-10: Actively looking for EXACTLY what this business offers, urgent need, ready to buy/act\n\nIMPORTANT: Return ONLY a single JSON object with no other text, no explanation, no markdown:\n{\"is_lead\": true, \"intent_score\": 5, \"reasoning\": \"one sentence explanation\"}`,\n        config: { maxOutputTokens: 512, thinkingConfig: { thinkingBudget: 0 } },\n      });\n      return result.text;\n    },\n    leadScoreSchema\n  );\n\n  if (!match) return;\n\n  if (!match.is_lead || match.intent_score < MIN_MONITOR_INTENT_SCORE) return;\n\n  const feedbackGuidance = await getFeedbackGuidance(target.businessId);\n\n  const responseResult = await generateContent({\n    model: \"gemini-2.5-pro\",\n    contents: `You are writing a Reddit comment in r/${target.subreddit}. Your ONLY goal is to be genuinely helpful. This must comply with Reddit's rules against self-promotion and spam.\n\nThe post: \"${title}\\n${content.slice(0, 400)}\"\n\nYour expertise area: ${target.coreOffering}\nTone: ${TONE_MAP[target.preferredTone] || \"friendly and helpful\"}\n${feedbackGuidance}\n\nSTRICT RULES FOR REDDIT COMPLIANCE:\n- Do NOT mention any business name, brand, website, or link\n- Do NOT say \"I recommend\" or \"check out\" or \"you should try\"\n- Do NOT hint that you represent or work for any company\n- Write as a knowledgeable community member sharing genuine advice\n- Answer their question directly with useful, specific information\n- Sound like a real Redditor  casual, helpful, maybe slightly opinionated\n- Keep it 2-4 sentences, natural and conversational\n\nThe response should be PURELY helpful advice based on your expertise. The value is in demonstrating knowledge, not promoting anything.\n\nReturn ONLY the response text, no quotes or formatting.`,\n    config: { maxOutputTokens: 8192 },\n  });\n\n  const responseText = responseResult.text.trim();\n  if (!responseText) return;\n\n  await markOwnResponse(responseText);\n\n  let savedResponseId: number | null = null;\n  try {\n    const [savedLead] = await db\n      .insert(leads)\n      .values({\n        campaignId: target.campaignId,\n        platform: \"reddit\",\n        groupName: `r/${target.subreddit}`,\n        authorName: \"Reddit user\",\n        originalPost: fullText.slice(0, 2000),\n        postUrl: post.link || null,\n        intentScore: match.intent_score,\n        status: \"matched\",\n      })\n      .returning();\n\n    if (savedLead) {\n      const [savedResponse] = await db\n        .insert(aiResponses)\n        .values({\n          leadId: savedLead.id,\n          content: responseText,\n          status: \"pending\",\n        })\n        .returning();\n      savedResponseId = savedResponse?.id || null;\n    }\n  } catch (err) {\n    console.error(\"Error saving Reddit lead to DB:\", err);\n  }\n\n  const scoreBar = \"*\".repeat(match.intent_score) + \"_\".repeat(10 - match.intent_score);\n\n  let msg = `<b>Reddit Lead Found</b>\\n\\n`;\n  msg += `<b>Business:</b> ${escapeHtml(target.businessName)}\\n`;\n  msg += `<b>Subreddit:</b> r/${escapeHtml(target.subreddit)}\\n`;\n  msg += `<b>Intent:</b> ${scoreBar} ${match.intent_score}/10\\n`;\n  msg += `<b>Why:</b> ${escapeHtml(match.reasoning || \"\")}\\n\\n`;\n  msg += `<b>Post:</b>\\n<i>\"${escapeHtml(title.slice(0, 200))}\"</i>`;\n\n  const buttons = [];\n  if (post.link) {\n    buttons.push([{ text: \"Open Post\", url: post.link }]);\n  }\n  if (savedResponseId && post.link && isRedditConfigured()) {\n    buttons.push([{ text: \"Post to Reddit\", callback_data: `reddit_post_${savedResponseId}` }]);\n  }\n  if (savedResponseId) {\n    buttons.push([\n      { text: \"Used It\", callback_data: `fb_good_${savedResponseId}` },\n      { text: \"Bad Match\", callback_data: `fb_bad_${savedResponseId}` },\n      { text: \"Too Salesy\", callback_data: `fb_salesy_${savedResponseId}` },\n      { text: \"Wrong Client\", callback_data: `fb_wrong_${savedResponseId}` },\n    ]);\n  }\n\n  if (target.telegramChatId) {\n    await sendTelegramMessageToChat(target.telegramChatId, msg, { buttons });\n    await sendTelegramMessageToChat(target.telegramChatId, responseText);\n  } else {\n    await sendTelegramMessage(msg, { buttons });\n    await sendTelegramMessage(responseText);\n  }\n}\n\nasync function scanSubredditForTargets(subreddit: string, targets: SubredditTarget[]): Promise<void> {\n  const url = `https://www.reddit.com/r/${subreddit}/new.rss`;\n\n  try {\n    const res = await fetch(url, {\n      headers: {\n        \"User-Agent\": \"Gemin-Eye/1.0 (RSS Reader)\",\n        \"Accept\": \"text/xml, application/rss+xml, application/xml\",\n      },\n    });\n\n    if (!res.ok) {\n      throw new Error(`HTTP ${res.status}`);\n    }\n\n    const xml = await res.text();\n    const feed = await parser.parseString(xml);\n    const posts = feed.items.slice(0, 5).map((item) => ({\n      title: item.title || \"\",\n      content: item.contentSnippet || item.content || \"\",\n      link: item.link || \"\",\n    }));\n\n    let newPosts = 0;\n    let kwMatches = 0;\n    for (const post of posts) {\n      const postId = post.link || post.title || \"\";\n      if (!postId) continue;\n\n      for (const target of targets) {\n        const seenKey = `rd::${postId}::${target.businessId}`;\n        if (await hasBeenSeen(seenKey)) continue;\n        await markSeen(seenKey, \"reddit\");\n        newPosts++;\n\n        try {\n          await processPostForTarget(post, target);\n        } catch (err: any) {\n          console.error(`Error processing post for ${target.businessName}: ${err?.message || err}`);\n        }\n      }\n    }\n    if (newPosts > 0) {\n      console.log(`Reddit monitor: r/${subreddit} - ${posts.length} posts, ${newPosts} new evaluations`);\n    }\n  } catch (err: any) {\n    const errMsg = err?.message || String(err);\n    if (errMsg.includes(\"403\") || errMsg.includes(\"429\") || errMsg.includes(\"Forbidden\")) {\n      console.log(`Reddit rate-limited on r/${subreddit}, will retry next cycle`);\n    } else if (errMsg.includes(\"404\") || errMsg.includes(\"Not Found\")) {\n      console.log(`r/${subreddit} not found (invalid subreddit name), skipping`);\n    } else {\n      console.error(`Error scanning r/${subreddit}: ${errMsg}`);\n    }\n  }\n}\n\nasync function runScan(): Promise<void> {\n  const targets = await getRedditTargets();\n\n  if (targets.length === 0) {\n    return;\n  }\n\n  const subMap = new Map<string, SubredditTarget[]>();\n  for (const t of targets) {\n    const key = t.subreddit.toLowerCase();\n    if (!subMap.has(key)) subMap.set(key, []);\n    subMap.get(key)!.push(t);\n  }\n\n  console.log(`Reddit monitor: scanning ${subMap.size} subreddits for ${targets.length} business targets...`);\n\n  const entries = Array.from(subMap.values());\n  let scannedCount = 0;\n  for (const subTargets of entries) {\n    await scanSubredditForTargets(subTargets[0].subreddit, subTargets);\n    scannedCount++;\n    await new Promise((r) => setTimeout(r, 5000));\n  }\n  console.log(`Reddit monitor: scan complete (${scannedCount}/${subMap.size} subreddits)`);\n}\n\nexport function startRedditMonitor(): void {\n  if (monitorInterval) return;\n  if (process.env.MONITORING_DISABLED === \"true\") {\n    console.log(\"Reddit monitor: DISABLED via MONITORING_DISABLED env var\");\n    return;\n  }\n\n  console.log(\"Reddit monitor: starting (scans every 5 minutes)\");\n\n  setTimeout(() => {\n    runScan().catch((err) => console.error(\"Reddit monitor scan error:\", err));\n  }, 10000);\n\n  monitorInterval = setInterval(() => {\n    runScan().catch((err) => console.error(\"Reddit monitor scan error:\", err));\n  }, SCAN_INTERVAL);\n}\n\nexport function stopRedditMonitor(): void {\n  if (monitorInterval) {\n    clearInterval(monitorInterval);\n    monitorInterval = null;\n    console.log(\"Reddit monitor: stopped\");\n  }\n}\n","path":null,"size_bytes":11234,"size_tokens":null},"client/public/spy-glass.js":{"content":"(function() {\n  if (window.__geminEyeActive) return;\n  window.__geminEyeActive = true;\n\n  var MAX_POSTS = 500;\n  var SCROLL_DELAY_MS = 1500;\n  var SCAN_INTERVAL_MS = 2000;\n\n  var params = {};\n  var scripts = document.getElementsByTagName('script');\n  for (var i = 0; i < scripts.length; i++) {\n    var src = scripts[i].src || '';\n    if (src.indexOf('spy-glass.js') !== -1) {\n      var url = new URL(src);\n      params.cid = url.searchParams.get('cid') || '';\n      params.bid = url.searchParams.get('bid') || '';\n      params.tok = url.searchParams.get('tok') || '';\n      break;\n    }\n  }\n\n  if (!params.cid || !params.bid || !params.tok) {\n    alert('Gemin-Eye: Missing configuration. Please re-run setup with /setup in the bot.');\n    return;\n  }\n\n  var API_URL = (function() {\n    for (var i = 0; i < scripts.length; i++) {\n      var src = scripts[i].src || '';\n      if (src.indexOf('spy-glass.js') !== -1) {\n        var u = new URL(src);\n        return u.origin + '/api/fb-scan';\n      }\n    }\n    return '/api/fb-scan';\n  })();\n\n  var banner = document.createElement('div');\n  banner.id = 'gemin-eye-banner';\n  banner.style.cssText = 'position:fixed;top:0;left:0;width:100%;background:linear-gradient(135deg,#4338ca,#6d28d9);color:white;text-align:center;padding:10px 20px;z-index:99999;font-family:system-ui,sans-serif;font-size:14px;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.2);display:flex;align-items:center;justify-content:center;gap:12px;';\n\n  var counter = document.createElement('span');\n  counter.id = 'gemin-eye-count';\n  counter.textContent = '0 scanned';\n  counter.style.cssText = 'font-weight:normal;opacity:0.85;font-size:13px;';\n\n  var stopBtn = document.createElement('span');\n  stopBtn.textContent = 'Stop';\n  stopBtn.style.cssText = 'cursor:pointer;background:rgba(255,255,255,0.2);padding:3px 12px;border-radius:4px;font-size:12px;font-weight:600;';\n\n  var closeBtn = document.createElement('span');\n  closeBtn.textContent = 'X';\n  closeBtn.style.cssText = 'position:absolute;right:16px;cursor:pointer;font-size:16px;opacity:0.7;';\n\n  var seenPosts = {};\n  var scannedCount = 0;\n  var sentCount = 0;\n  var pendingCount = 0;\n  var running = true;\n  var scrollTimer = null;\n  var scanInterval = null;\n  var noNewPostsCount = 0;\n\n  function cleanup() {\n    running = false;\n    window.__geminEyeActive = false;\n    if (scanInterval) clearInterval(scanInterval);\n    if (scrollTimer) clearTimeout(scrollTimer);\n    banner.remove();\n  }\n\n  function stopScanning() {\n    running = false;\n    if (scanInterval) clearInterval(scanInterval);\n    if (scrollTimer) clearTimeout(scrollTimer);\n    stopBtn.textContent = 'Stopped';\n    stopBtn.style.opacity = '0.5';\n    stopBtn.style.cursor = 'default';\n    updateCounter();\n  }\n\n  function updateCounter() {\n    var text = scannedCount + ' scanned, ' + sentCount + ' leads';\n    if (pendingCount > 0) text += ' (' + pendingCount + ' checking...)';\n    if (!running) text += ' - Done';\n    counter.textContent = text;\n  }\n\n  closeBtn.onclick = cleanup;\n  stopBtn.onclick = function() {\n    if (running) stopScanning();\n  };\n\n  banner.innerHTML = '';\n  var label = document.createElement('span');\n  label.textContent = 'Gemin-Eye: Auto-scanning...';\n  banner.appendChild(label);\n  banner.appendChild(counter);\n  banner.appendChild(stopBtn);\n  banner.appendChild(closeBtn);\n  document.body.appendChild(banner);\n\n  function extractPosts() {\n    var found = [];\n    var candidates = document.querySelectorAll('div[dir=\"auto\"]');\n    candidates.forEach(function(el) {\n      var text = (el.innerText || '').trim();\n      if (text.length < 25) return;\n      if (text.length > 5000) return;\n      if (seenPosts[text]) return;\n\n      var parentLink = el.closest('a');\n      if (parentLink && parentLink.href && parentLink.href.indexOf('/comment') === -1) return;\n\n      found.push({ text: text, element: el });\n    });\n    return found;\n  }\n\n  function sendPost(postText, element) {\n    seenPosts[postText] = true;\n    scannedCount++;\n    pendingCount++;\n    updateCounter();\n\n    var groupName = '';\n    var h1 = document.querySelector('h1');\n    if (h1) groupName = h1.innerText || '';\n    if (!groupName) {\n      var titleEl = document.querySelector('[role=\"banner\"] a[href*=\"/groups/\"]');\n      if (titleEl) groupName = titleEl.innerText || '';\n    }\n\n    fetch(API_URL, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        chatId: params.cid,\n        businessId: parseInt(params.bid, 10),\n        token: params.tok,\n        postText: postText,\n        groupName: groupName || document.title || 'Facebook Group',\n        pageUrl: window.location.href\n      })\n    }).then(function(res) {\n      return res.json();\n    }).then(function(data) {\n      pendingCount--;\n      if (data.matched) {\n        sentCount++;\n        element.style.outline = '3px solid #6d28d9';\n        element.style.outlineOffset = '4px';\n        element.style.borderRadius = '4px';\n      }\n      updateCounter();\n    }).catch(function() {\n      pendingCount--;\n      updateCounter();\n    });\n  }\n\n  function scan() {\n    if (!running) return;\n    var posts = extractPosts();\n\n    if (posts.length === 0) {\n      noNewPostsCount++;\n    } else {\n      noNewPostsCount = 0;\n    }\n\n    posts.forEach(function(p) {\n      if (scannedCount >= MAX_POSTS) return;\n      sendPost(p.text, p.element);\n    });\n\n    if (scannedCount >= MAX_POSTS) {\n      stopScanning();\n      return;\n    }\n\n    if (noNewPostsCount >= 10) {\n      stopScanning();\n      return;\n    }\n  }\n\n  function autoScroll() {\n    if (!running) return;\n    window.scrollBy({ top: 600, behavior: 'smooth' });\n    scrollTimer = setTimeout(autoScroll, SCROLL_DELAY_MS);\n  }\n\n  scan();\n  scanInterval = setInterval(scan, SCAN_INTERVAL_MS);\n  scrollTimer = setTimeout(autoScroll, SCROLL_DELAY_MS);\n})();\n","path":null,"size_bytes":5858,"size_tokens":null},"generate-source-dump.sh":{"content":"#!/bin/bash\nOUTPUT=\"client/public/source.txt\"\necho \"# GEMIN-EYE  FULL SOURCE CODE\" > \"$OUTPUT\"\necho \"# AI-Powered Customer Acquisition Platform\" >> \"$OUTPUT\"\necho \"# https://gemin-eye.com\" >> \"$OUTPUT\"\necho \"# Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)\" >> \"$OUTPUT\"\necho \"# Paste this URL into any AI (Claude, ChatGPT, etc.) for code review.\" >> \"$OUTPUT\"\necho \"# URL: https://gemin-eye.com/source.txt\" >> \"$OUTPUT\"\necho \"############################################################\" >> \"$OUTPUT\"\necho \"\" >> \"$OUTPUT\"\n\nFILES=(\n  \"shared/schema.ts\"\n  \"shared/models/auth.ts\"\n  \"shared/models/chat.ts\"\n  \"server/index.ts\"\n  \"server/routes.ts\"\n  \"server/routes/admin.ts\"\n  \"server/routes/scan.ts\"\n  \"server/storage.ts\"\n  \"server/db.ts\"\n  \"server/telegram.ts\"\n  \"server/telegram-bot.ts\"\n  \"server/telegram/state.ts\"\n  \"server/telegram/analysis.ts\"\n  \"server/telegram/bookmarklets.ts\"\n  \"server/telegram/client-wizard.ts\"\n  \"server/telegram/admin-commands.ts\"\n  \"server/telegram/callbacks.ts\"\n  \"server/telegram/index.ts\"\n  \"server/utils/ai.ts\"\n  \"server/utils/html.ts\"\n  \"server/utils/feedback.ts\"\n  \"server/utils/dedup.ts\"\n  \"server/utils/rate-limit.ts\"\n  \"server/reddit-monitor.ts\"\n  \"server/reddit-poster.ts\"\n  \"server/google-alerts-monitor.ts\"\n  \"client/src/App.tsx\"\n  \"client/src/pages/landing.tsx\"\n  \"client/src/pages/dashboard.tsx\"\n  \"client/src/pages/onboarding.tsx\"\n  \"client/src/pages/admin.tsx\"\n  \"client/src/pages/client-guide.tsx\"\n  \"client/src/hooks/use-auth.ts\"\n  \"client/src/lib/queryClient.ts\"\n  \"client/src/components/theme-provider.tsx\"\n  \"client/public/spy-glass.js\"\n  \"client/public/li-spy-glass.js\"\n  \"replit.md\"\n)\n\nfor f in \"${FILES[@]}\"; do\n  if [ -f \"$f\" ]; then\n    LINES=$(wc -l < \"$f\")\n    echo \"============================================================\" >> \"$OUTPUT\"\n    echo \"FILE: $f ($LINES lines)\" >> \"$OUTPUT\"\n    echo \"============================================================\" >> \"$OUTPUT\"\n    cat \"$f\" >> \"$OUTPUT\"\n    echo \"\" >> \"$OUTPUT\"\n    echo \"\" >> \"$OUTPUT\"\n  fi\ndone\n\necho \"Generated source.txt ($(wc -c < \"$OUTPUT\") bytes)\"\n","path":null,"size_bytes":2075,"size_tokens":null},"client/src/pages/client-guide.tsx":{"content":"import { useRef } from \"react\";\nimport { Card } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Download, ArrowLeft, MessageCircle, Globe, Facebook, BookOpen, Zap } from \"lucide-react\";\nimport { SiReddit, SiFacebook, SiTelegram, SiLinkedin } from \"react-icons/si\";\nimport { useLocation } from \"wouter\";\n\nfunction Section({ number, title, icon, children }: { number: number; title: string; icon: React.ReactNode; children: React.ReactNode }) {\n  return (\n    <Card className=\"p-6\">\n      <div className=\"flex items-start gap-4\">\n        <div className=\"flex-shrink-0 w-10 h-10 rounded-full bg-primary text-primary-foreground flex items-center justify-center font-bold text-lg\">\n          {number}\n        </div>\n        <div className=\"flex-1 min-w-0\">\n          <div className=\"flex items-center gap-2 mb-3 flex-wrap\">\n            {icon}\n            <h2 className=\"text-xl font-semibold\">{title}</h2>\n          </div>\n          <div className=\"space-y-2 text-muted-foreground\">{children}</div>\n        </div>\n      </div>\n    </Card>\n  );\n}\n\nexport default function ClientGuidePage() {\n  const [, navigate] = useLocation();\n  const printRef = useRef<HTMLDivElement>(null);\n\n  function handleDownloadPDF() {\n    const content = printRef.current;\n    if (!content) return;\n    const printWindow = window.open(\"\", \"_blank\");\n    if (!printWindow) return;\n    printWindow.document.write(`<!DOCTYPE html><html><head><title>Gemin-Eye Client Setup Guide</title><style>\n      * { margin: 0; padding: 0; box-sizing: border-box; }\n      body { font-family: system-ui, -apple-system, sans-serif; color: #1a1a2e; padding: 40px; line-height: 1.6; }\n      h1 { font-size: 28px; margin-bottom: 8px; color: #4338ca; }\n      .subtitle { font-size: 14px; color: #666; margin-bottom: 32px; }\n      .section { margin-bottom: 28px; page-break-inside: avoid; }\n      .section-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }\n      .section-number { width: 32px; height: 32px; border-radius: 50%; background: #4338ca; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; flex-shrink: 0; }\n      .section-title { font-size: 20px; font-weight: 600; }\n      .section-badge { font-size: 11px; background: #e0e7ff; color: #4338ca; padding: 2px 8px; border-radius: 10px; font-weight: 600; }\n      ul { padding-left: 24px; margin-top: 8px; }\n      li { margin-bottom: 6px; }\n      .note { background: #f5f3ff; border-left: 3px solid #6d28d9; padding: 12px 16px; margin-top: 12px; border-radius: 0 6px 6px 0; font-size: 13px; }\n      .code-block { background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 6px; padding: 12px 16px; font-family: monospace; font-size: 12px; word-break: break-all; margin-top: 8px; }\n      .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e2e8f0; font-size: 12px; color: #999; text-align: center; }\n      .platform-label { font-weight: 600; color: #1a1a2e; }\n      @media print { body { padding: 20px; } .section { page-break-inside: avoid; } }\n    </style></head><body>\n      <h1>Gemin-Eye Setup Guide</h1>\n      <p class=\"subtitle\">Your AI-powered customer acquisition system &mdash; step-by-step onboarding</p>\n\n      <div class=\"section\">\n        <div class=\"section-header\">\n          <div class=\"section-number\">1</div>\n          <div class=\"section-title\">Install Telegram</div>\n          <span class=\"section-badge\">REQUIRED</span>\n        </div>\n        <p>All alerts and AI-generated responses are delivered through Telegram.</p>\n        <ul>\n          <li>Download Telegram from <strong>telegram.org</strong> (available on phone, tablet, and desktop)</li>\n          <li>Create an account if you don't have one</li>\n          <li>This is where you'll receive lead notifications with suggested responses you can copy-paste</li>\n        </ul>\n      </div>\n\n      <div class=\"section\">\n        <div class=\"section-header\">\n          <div class=\"section-number\">2</div>\n          <div class=\"section-title\">Set Up Your Business Profile</div>\n          <span class=\"section-badge\">REQUIRED</span>\n        </div>\n        <p>Tell the bot about your business so it knows what to look for.</p>\n        <ul>\n          <li>Open the Gemin-Eye bot in Telegram (your admin will send you the link)</li>\n          <li>Send the command: <strong>/setup</strong></li>\n          <li>Answer 3 quick questions:\n            <ul>\n              <li><strong>Business name</strong> &mdash; e.g., \"Heart of America Whoodles\"</li>\n              <li><strong>What you do/sell</strong> &mdash; e.g., \"We breed Whoodle puppies, a Wheaten Terrier and Poodle mix\"</li>\n              <li><strong>Keywords</strong> &mdash; comma-separated words people might use when looking for you, e.g., \"whoodle, whoodle puppy, hypoallergenic dog, wheaten poodle mix\"</li>\n            </ul>\n          </li>\n          <li>The bot will confirm your setup and give you a bookmark code (see Step 3)</li>\n        </ul>\n      </div>\n\n      <div class=\"section\">\n        <div class=\"section-header\">\n          <div class=\"section-number\">3</div>\n          <div class=\"section-title\">Set Up the Facebook Spy Glass</div>\n          <span class=\"section-badge\">RECOMMENDED</span>\n        </div>\n        <p>The Spy Glass is a browser bookmark that scans Facebook Groups for potential customers.</p>\n        <ul>\n          <li>After completing Step 2, the bot sends you a long code starting with <strong>javascript:void(...</strong></li>\n          <li>In Chrome (or your browser), right-click the bookmarks bar</li>\n          <li>Click <strong>\"Add bookmark\"</strong> (or \"Add page\")</li>\n          <li>Name it: <strong>Gemin-Eye</strong></li>\n          <li>Paste the code the bot gave you as the <strong>URL</strong></li>\n          <li>Save the bookmark</li>\n        </ul>\n        <div class=\"note\">\n          <strong>How to use it:</strong> Go to any Facebook Group, click your \"Gemin-Eye\" bookmark, and the page will automatically scroll and scan posts. Matching leads are sent to your Telegram instantly. You'll see a purple banner showing progress. Click X to stop, or it will stop automatically after about 5 minutes.\n        </div>\n      </div>\n\n      <div class=\"section\">\n        <div class=\"section-header\">\n          <div class=\"section-number\">4</div>\n          <div class=\"section-title\">Join Relevant Facebook Groups</div>\n          <span class=\"section-badge\">RECOMMENDED</span>\n        </div>\n        <p>The Spy Glass works inside Facebook Groups. Join groups where your potential customers hang out.</p>\n        <ul>\n          <li>Search Facebook for groups related to your industry, location, or niche</li>\n          <li>Request to join 5-10 active groups</li>\n          <li>Once approved, open each group and click your Gemin-Eye bookmark to scan</li>\n          <li>Scan your groups daily or a few times per week for best results</li>\n        </ul>\n      </div>\n\n      <div class=\"section\">\n        <div class=\"section-header\">\n          <div class=\"section-number\">5</div>\n          <div class=\"section-title\">Set Up the LinkedIn Spy Glass</div>\n          <span class=\"section-badge\">RECOMMENDED</span>\n        </div>\n        <p>The LinkedIn Spy Glass works just like the Facebook one, but for your LinkedIn feed and search results.</p>\n        <ul>\n          <li>After setup, the bot also sends a second bookmarklet code for LinkedIn</li>\n          <li>Create another bookmark the same way (name it <strong>Scan LinkedIn</strong>)</li>\n          <li>Paste the LinkedIn code as the URL</li>\n        </ul>\n        <div class=\"note\">\n          <strong>Where to use it:</strong> Open your LinkedIn feed, search results, or any LinkedIn page with posts. Click the \"Scan LinkedIn\" bookmark and it will auto-scroll and scan for leads matching your keywords. Matched posts get highlighted in blue.\n        </div>\n      </div>\n\n      <div class=\"section\">\n        <div class=\"section-header\">\n          <div class=\"section-number\">6</div>\n          <div class=\"section-title\">Reddit Monitoring</div>\n          <span class=\"section-badge\">AUTOMATIC</span>\n        </div>\n        <p>Reddit is monitored automatically &mdash; no action needed from you.</p>\n        <ul>\n          <li>The system scans relevant subreddits every 90 seconds</li>\n          <li>When someone posts a question matching your keywords, you get a Telegram alert</li>\n          <li>Each alert includes a suggested response and a direct link to the post</li>\n          <li>Your admin sets up which subreddits to monitor based on your business</li>\n        </ul>\n      </div>\n\n      <div class=\"section\">\n        <div class=\"section-header\">\n          <div class=\"section-number\">7</div>\n          <div class=\"section-title\">Google Alerts &mdash; Web-Wide Monitoring</div>\n          <span class=\"section-badge\">OPTIONAL</span>\n        </div>\n        <p>Monitor the entire web (Quora, forums, blogs, news) for people talking about your topic.</p>\n        <ul>\n          <li>Go to <strong>google.com/alerts</strong></li>\n          <li>Type a keyword (e.g., \"whoodle breeder\" or \"best hypoallergenic dogs\")</li>\n          <li>Click <strong>\"Show options\"</strong></li>\n          <li>Change <strong>\"Deliver to\"</strong> from \"Email\" to <strong>\"RSS feed\"</strong></li>\n          <li>Click <strong>\"Create Alert\"</strong></li>\n          <li>Copy the RSS feed URL (right-click the RSS icon, click \"Copy link address\")</li>\n          <li>In Telegram, send: <strong>/addalert</strong> and paste the RSS URL when prompted</li>\n        </ul>\n        <div class=\"note\">\n          <strong>Tip:</strong> Create 3-5 alerts for different keyword variations. The system checks each feed every 2 minutes automatically.\n        </div>\n      </div>\n\n      <div class=\"section\">\n        <div class=\"section-header\">\n          <div class=\"section-number\">8</div>\n          <div class=\"section-title\">Manual Post Scanning via Telegram</div>\n          <span class=\"section-badge\">ANYTIME</span>\n        </div>\n        <p>You can also manually send posts to the bot for analysis at any time.</p>\n        <ul>\n          <li><strong>Text posts:</strong> Paste the URL and the post text into Telegram</li>\n          <li><strong>Screenshots:</strong> Take a screenshot of any post and send the image to the bot &mdash; it reads images automatically</li>\n          <li>The bot will score the lead and generate a suggested response</li>\n        </ul>\n      </div>\n\n      <div class=\"section\">\n        <div class=\"section-header\">\n          <div class=\"section-number\">9</div>\n          <div class=\"section-title\">Responding to Leads</div>\n          <span class=\"section-badge\">IMPORTANT</span>\n        </div>\n        <p>When you get a lead alert on Telegram, here's what to do:</p>\n        <ul>\n          <li>Read the suggested response &mdash; it's written to sound natural, not salesy</li>\n          <li>Click <strong>\"Open Post\"</strong> to go directly to the original post</li>\n          <li>Copy the suggested response, personalize it if you want, and post it as a comment/reply</li>\n          <li>Use the feedback buttons on the Telegram alert:\n            <ul>\n              <li><strong>Used It</strong> &mdash; you posted the response (helps the AI learn what works)</li>\n              <li><strong>Bad Match</strong> &mdash; the post wasn't relevant to your business</li>\n              <li><strong>Too Salesy</strong> &mdash; the response sounded too much like an ad</li>\n              <li><strong>Wrong Client</strong> &mdash; matched to the wrong business</li>\n            </ul>\n          </li>\n        </ul>\n        <div class=\"note\">\n          <strong>Pro tip:</strong> The more feedback you give, the better the AI gets at finding the right leads and writing the right responses for your business.\n        </div>\n      </div>\n\n      <div class=\"section\">\n        <div class=\"section-header\">\n          <div class=\"section-number\">10</div>\n          <div class=\"section-title\">Telegram Bot Commands Reference</div>\n        </div>\n        <ul>\n          <li><strong>/setup</strong> &mdash; Start the onboarding wizard (first time only)</li>\n          <li><strong>/keywords</strong> &mdash; Update your monitoring keywords</li>\n          <li><strong>/groups</strong> &mdash; Update target groups/subreddits</li>\n          <li><strong>/addalert</strong> &mdash; Add a Google Alerts RSS feed</li>\n          <li><strong>/alerts</strong> &mdash; View all your alert feeds</li>\n          <li><strong>/removealert</strong> &mdash; Remove an alert feed</li>\n          <li><strong>/businesses</strong> &mdash; See all your business profiles</li>\n          <li><strong>/help</strong> &mdash; Full guide with all commands</li>\n        </ul>\n      </div>\n\n      <div class=\"note\" style=\"background:#ede9fe;border-left-color:#4338ca;margin-top:32px;padding:16px 20px;\">\n        <strong>Remember: The harder you work, the harder we work for you.</strong> Every Facebook Group you join, every LinkedIn search you scan, every Google Alert you create &mdash; that's another stream of leads flowing into your pipeline. The AI does the heavy lifting (scoring, writing responses, sending alerts), but <em>you</em> control how wide the net is. Clients who actively add groups and scan regularly see 3&ndash;5x more leads than those who set it and forget it. Put in the time, and Gemin-Eye will multiply your effort.\n      </div>\n\n      <div class=\"footer\">\n        Gemin-Eye &mdash; AI-Powered Customer Acquisition &mdash; Gemin-Eye.com\n      </div>\n    </body></html>`);\n    printWindow.document.close();\n    setTimeout(() => { printWindow.print(); }, 500);\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <div className=\"max-w-3xl mx-auto px-4 py-8\">\n        <div className=\"flex items-center justify-between mb-8 flex-wrap gap-4\">\n          <div className=\"flex items-center gap-3\">\n            <Button variant=\"ghost\" size=\"icon\" onClick={() => navigate(\"/\")} data-testid=\"button-back\">\n              <ArrowLeft />\n            </Button>\n            <div>\n              <h1 className=\"text-2xl font-bold\">Client Setup Guide</h1>\n              <p className=\"text-muted-foreground text-sm\">Everything you need to get your campaign running</p>\n            </div>\n          </div>\n          <Button onClick={handleDownloadPDF} data-testid=\"button-download-pdf\">\n            <Download className=\"w-4 h-4 mr-2\" />\n            Download PDF\n          </Button>\n        </div>\n\n        <div ref={printRef} className=\"space-y-4\">\n          <Section number={1} title=\"Install Telegram\" icon={<SiTelegram className=\"w-5 h-5 text-[#229ED9]\" />}>\n            <p>All alerts and AI-generated responses are delivered through Telegram.</p>\n            <ul className=\"list-disc pl-5 space-y-1 mt-2\">\n              <li>Download Telegram from <a href=\"https://telegram.org\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-primary underline\">telegram.org</a> (available on phone, tablet, and desktop)</li>\n              <li>Create an account if you don't have one</li>\n              <li>This is where you'll receive lead notifications with suggested responses you can copy-paste</li>\n            </ul>\n          </Section>\n\n          <Section number={2} title=\"Set Up Your Business Profile\" icon={<MessageCircle className=\"w-5 h-5 text-primary\" />}>\n            <p>Tell the bot about your business so it knows what to look for.</p>\n            <ul className=\"list-disc pl-5 space-y-1 mt-2\">\n              <li>Open the Gemin-Eye bot in Telegram (your admin will send you the link)</li>\n              <li>Send the command: <code className=\"bg-muted px-1.5 py-0.5 rounded text-sm font-mono\">/setup</code></li>\n              <li>Answer 3 quick questions:\n                <ul className=\"list-disc pl-5 mt-1 space-y-1\">\n                  <li><strong>Business name</strong>  e.g., \"Heart of America Whoodles\"</li>\n                  <li><strong>What you do/sell</strong>  e.g., \"We breed Whoodle puppies\"</li>\n                  <li><strong>Keywords</strong>  comma-separated words people might use, e.g., \"whoodle, whoodle puppy, hypoallergenic dog\"</li>\n                </ul>\n              </li>\n              <li>The bot confirms your setup and gives you a bookmark code (Step 3)</li>\n            </ul>\n          </Section>\n\n          <Section number={3} title=\"Set Up the Facebook Spy Glass\" icon={<SiFacebook className=\"w-5 h-5 text-[#1877F2]\" />}>\n            <p>The Spy Glass is a browser bookmark that scans Facebook Groups for potential customers.</p>\n            <ul className=\"list-disc pl-5 space-y-1 mt-2\">\n              <li>After Step 2, the bot sends you a long code starting with <code className=\"bg-muted px-1.5 py-0.5 rounded text-sm font-mono\">javascript:void(...</code></li>\n              <li>In Chrome, right-click the bookmarks bar</li>\n              <li>Click <strong>\"Add bookmark\"</strong></li>\n              <li>Name it: <strong>Gemin-Eye</strong></li>\n              <li>Paste the code as the <strong>URL</strong></li>\n              <li>Save the bookmark</li>\n            </ul>\n            <div className=\"bg-muted/50 border-l-2 border-primary p-3 rounded-r-md mt-3 text-sm\">\n              <strong>How to use it:</strong> Go to any Facebook Group, click your \"Gemin-Eye\" bookmark, and the page will automatically scroll and scan posts. Matching leads are sent to your Telegram instantly. Click X to stop, or it stops automatically after ~5 minutes.\n            </div>\n          </Section>\n\n          <Section number={4} title=\"Join Relevant Facebook Groups\" icon={<Facebook className=\"w-5 h-5 text-[#1877F2]\" />}>\n            <p>The Spy Glass works inside Facebook Groups. Join groups where your potential customers hang out.</p>\n            <ul className=\"list-disc pl-5 space-y-1 mt-2\">\n              <li>Search Facebook for groups related to your industry, location, or niche</li>\n              <li>Request to join 5-10 active groups</li>\n              <li>Once approved, open each group and click your Gemin-Eye bookmark</li>\n              <li>Scan your groups daily or a few times per week for best results</li>\n            </ul>\n          </Section>\n\n          <Section number={5} title=\"Set Up the LinkedIn Spy Glass\" icon={<SiLinkedin className=\"w-5 h-5 text-[#0077B5]\" />}>\n            <p>The LinkedIn Spy Glass works just like the Facebook one, but for your LinkedIn feed and search results.</p>\n            <ul className=\"list-disc pl-5 space-y-1 mt-2\">\n              <li>After setup, the bot also sends a second bookmarklet code for LinkedIn</li>\n              <li>Create another bookmark the same way (name it <strong>\"Scan LinkedIn\"</strong>)</li>\n              <li>Paste the LinkedIn code as the URL</li>\n            </ul>\n            <div className=\"bg-muted/50 border-l-2 border-primary p-3 rounded-r-md mt-3 text-sm\">\n              <strong>Where to use it:</strong> Open your LinkedIn feed, search results, or any LinkedIn page with posts. Click the \"Scan LinkedIn\" bookmark and it will auto-scroll and scan for leads matching your keywords. Matched posts get highlighted in blue.\n            </div>\n          </Section>\n\n          <Section number={6} title=\"Reddit Monitoring\" icon={<SiReddit className=\"w-5 h-5 text-[#FF4500]\" />}>\n            <p className=\"font-medium text-green-600 dark:text-green-400\">Fully automatic  no action needed from you.</p>\n            <ul className=\"list-disc pl-5 space-y-1 mt-2\">\n              <li>The system scans relevant subreddits every 90 seconds</li>\n              <li>When someone posts a question matching your keywords, you get a Telegram alert</li>\n              <li>Each alert includes a suggested response and a direct link to the post</li>\n              <li>Your admin sets up which subreddits to monitor</li>\n            </ul>\n          </Section>\n\n          <Section number={7} title=\"Google Alerts  Web-Wide Monitoring\" icon={<Globe className=\"w-5 h-5 text-primary\" />}>\n            <p>Monitor the entire web (Quora, forums, blogs, news) for people talking about your topic.</p>\n            <ul className=\"list-disc pl-5 space-y-1 mt-2\">\n              <li>Go to <a href=\"https://google.com/alerts\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-primary underline\">google.com/alerts</a></li>\n              <li>Type a keyword (e.g., \"whoodle breeder\")</li>\n              <li>Click <strong>\"Show options\"</strong></li>\n              <li>Change <strong>\"Deliver to\"</strong> to <strong>\"RSS feed\"</strong></li>\n              <li>Click <strong>\"Create Alert\"</strong></li>\n              <li>Copy the RSS feed URL (right-click the RSS icon, \"Copy link address\")</li>\n              <li>In Telegram, send <code className=\"bg-muted px-1.5 py-0.5 rounded text-sm font-mono\">/addalert</code> and paste the RSS URL</li>\n            </ul>\n            <div className=\"bg-muted/50 border-l-2 border-primary p-3 rounded-r-md mt-3 text-sm\">\n              <strong>Tip:</strong> Create 3-5 alerts for different keyword variations. The system checks each feed every 2 minutes automatically.\n            </div>\n          </Section>\n\n          <Section number={8} title=\"Manual Post Scanning via Telegram\" icon={<MessageCircle className=\"w-5 h-5 text-primary\" />}>\n            <p>You can manually send any post to the bot for instant analysis.</p>\n            <ul className=\"list-disc pl-5 space-y-1 mt-2\">\n              <li><strong>Text posts:</strong> Paste the URL + post text into Telegram</li>\n              <li><strong>Screenshots:</strong> Send a screenshot of any post  the bot reads images automatically</li>\n              <li>The bot scores the lead and generates a suggested response</li>\n            </ul>\n          </Section>\n\n          <Section number={9} title=\"Responding to Leads\" icon={<BookOpen className=\"w-5 h-5 text-primary\" />}>\n            <p>When you get a lead alert on Telegram:</p>\n            <ul className=\"list-disc pl-5 space-y-1 mt-2\">\n              <li>Read the suggested response  it's written to sound natural, not salesy</li>\n              <li>Click <strong>\"Open Post\"</strong> to go directly to the original post</li>\n              <li>Copy the response, personalize it if you want, and post it as a reply</li>\n              <li>Use the feedback buttons on the alert:\n                <ul className=\"list-disc pl-5 mt-1 space-y-1\">\n                  <li><strong>Used It</strong>  you posted the response (helps the AI learn)</li>\n                  <li><strong>Bad Match</strong>  the post wasn't relevant</li>\n                  <li><strong>Too Salesy</strong>  response sounded too much like an ad</li>\n                  <li><strong>Wrong Client</strong>  matched to the wrong business</li>\n                </ul>\n              </li>\n            </ul>\n            <div className=\"bg-muted/50 border-l-2 border-primary p-3 rounded-r-md mt-3 text-sm\">\n              <strong>Pro tip:</strong> The more feedback you give, the better the AI gets at finding the right leads and writing the right responses.\n            </div>\n          </Section>\n\n          <Section number={10} title=\"Telegram Bot Commands\" icon={<SiTelegram className=\"w-5 h-5 text-[#229ED9]\" />}>\n            <ul className=\"list-disc pl-5 space-y-1\">\n              <li><code className=\"bg-muted px-1.5 py-0.5 rounded text-sm font-mono\">/setup</code>  Start the onboarding wizard</li>\n              <li><code className=\"bg-muted px-1.5 py-0.5 rounded text-sm font-mono\">/keywords</code>  Update your monitoring keywords</li>\n              <li><code className=\"bg-muted px-1.5 py-0.5 rounded text-sm font-mono\">/groups</code>  Update target groups/subreddits</li>\n              <li><code className=\"bg-muted px-1.5 py-0.5 rounded text-sm font-mono\">/addalert</code>  Add a Google Alerts RSS feed</li>\n              <li><code className=\"bg-muted px-1.5 py-0.5 rounded text-sm font-mono\">/alerts</code>  View all your alert feeds</li>\n              <li><code className=\"bg-muted px-1.5 py-0.5 rounded text-sm font-mono\">/removealert</code>  Remove an alert feed</li>\n              <li><code className=\"bg-muted px-1.5 py-0.5 rounded text-sm font-mono\">/businesses</code>  See all your business profiles</li>\n              <li><code className=\"bg-muted px-1.5 py-0.5 rounded text-sm font-mono\">/help</code>  Full guide with all commands</li>\n            </ul>\n          </Section>\n\n          <Card className=\"p-6 bg-primary/5 border-primary/20\" data-testid=\"card-motivation\">\n            <div className=\"flex items-start gap-4\">\n              <div className=\"flex-shrink-0 w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center\">\n                <Zap className=\"w-5 h-5 text-primary\" />\n              </div>\n              <div>\n                <p className=\"font-semibold text-base mb-2\">The harder you work, the harder we work for you.</p>\n                <p className=\"text-sm text-muted-foreground leading-relaxed\">\n                  Every Facebook Group you join, every LinkedIn search you scan, every Google Alert you create  that's another stream of leads flowing into your pipeline. The AI does the heavy lifting (scoring posts, writing responses, sending alerts), but <strong>you</strong> control how wide the net is. Clients who actively add groups and scan regularly see 3-5x more leads than those who set it and forget it. Put in the time, and Gemin-Eye will multiply your effort.\n                </p>\n              </div>\n            </div>\n          </Card>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":25617,"size_tokens":null},"server/reddit-poster.ts":{"content":"import Snoowrap from \"snoowrap\";\n\nlet redditClient: Snoowrap | null = null;\n\nfunction getRedditClient(): Snoowrap | null {\n  if (redditClient) return redditClient;\n\n  const clientId = process.env.REDDIT_CLIENT_ID;\n  const clientSecret = process.env.REDDIT_CLIENT_SECRET;\n  const username = process.env.REDDIT_USERNAME;\n  const password = process.env.REDDIT_PASSWORD;\n\n  if (!clientId || !clientSecret || !username || !password) {\n    return null;\n  }\n\n  redditClient = new Snoowrap({\n    userAgent: \"Gemin-Eye/1.0 (by /u/\" + username + \")\",\n    clientId,\n    clientSecret,\n    username,\n    password,\n  });\n\n  redditClient.config({ requestDelay: 1000, continueAfterRatelimitError: true });\n\n  return redditClient;\n}\n\nexport function isRedditConfigured(): boolean {\n  return !!(\n    process.env.REDDIT_CLIENT_ID &&\n    process.env.REDDIT_CLIENT_SECRET &&\n    process.env.REDDIT_USERNAME &&\n    process.env.REDDIT_PASSWORD\n  );\n}\n\nexport async function postRedditComment(postUrl: string, commentText: string): Promise<{ success: boolean; commentUrl?: string; error?: string }> {\n  const client = getRedditClient();\n  if (!client) {\n    return { success: false, error: \"Reddit credentials not configured. Add REDDIT_CLIENT_ID, REDDIT_CLIENT_SECRET, REDDIT_USERNAME, and REDDIT_PASSWORD.\" };\n  }\n\n  try {\n    const postId = extractPostId(postUrl);\n    if (!postId) {\n      return { success: false, error: \"Could not extract Reddit post ID from URL: \" + postUrl };\n    }\n\n    const submission = client.getSubmission(postId);\n    const comment: any = await (submission as any).reply(commentText);\n    const commentUrl = `https://www.reddit.com${comment.permalink || \"\"}`;\n\n    return { success: true, commentUrl };\n  } catch (error: any) {\n    console.error(\"Reddit post error:\", error);\n    const msg = error?.message || String(error);\n    if (msg.includes(\"RATELIMIT\") || msg.includes(\"rate limit\")) {\n      return { success: false, error: \"Reddit rate limit hit. Wait a few minutes and try again.\" };\n    }\n    if (msg.includes(\"403\") || msg.includes(\"Forbidden\")) {\n      return { success: false, error: \"Reddit credentials invalid or account lacks permission.\" };\n    }\n    return { success: false, error: \"Reddit API error: \" + msg.slice(0, 200) };\n  }\n}\n\nexport async function postRedditSubmission(subreddit: string, title: string, body: string): Promise<{ success: boolean; postUrl?: string; error?: string }> {\n  const client = getRedditClient();\n  if (!client) {\n    return { success: false, error: \"Reddit credentials not configured. Add REDDIT_CLIENT_ID, REDDIT_CLIENT_SECRET, REDDIT_USERNAME, and REDDIT_PASSWORD.\" };\n  }\n\n  try {\n    const sub = subreddit.replace(/^r\\//, \"\");\n    const submission: any = await (client.getSubreddit(sub) as any).submitSelfpost({ title, text: body });\n    const postUrl = `https://www.reddit.com${submission.permalink || \"\"}`;\n\n    return { success: true, postUrl };\n  } catch (error: any) {\n    console.error(\"Reddit submission error:\", error);\n    const msg = error?.message || String(error);\n    if (msg.includes(\"RATELIMIT\") || msg.includes(\"rate limit\")) {\n      return { success: false, error: \"Reddit rate limit hit. Wait a few minutes and try again.\" };\n    }\n    if (msg.includes(\"SUBREDDIT_NOEXIST\")) {\n      return { success: false, error: \"That subreddit doesn't exist.\" };\n    }\n    return { success: false, error: \"Reddit API error: \" + msg.slice(0, 200) };\n  }\n}\n\nfunction extractPostId(url: string): string | null {\n  const patterns = [\n    /reddit\\.com\\/r\\/\\w+\\/comments\\/([a-z0-9]+)/i,\n    /redd\\.it\\/([a-z0-9]+)/i,\n    /reddit\\.com\\/comments\\/([a-z0-9]+)/i,\n  ];\n\n  for (const pattern of patterns) {\n    const match = url.match(pattern);\n    if (match) return match[1];\n  }\n\n  return null;\n}\n","path":null,"size_bytes":3751,"size_tokens":null},"README.md":{"content":"# Gemin-Eye\n\nAI-powered customer acquisition platform that monitors niche online communities for high-intent questions, then generates helpful, human-sounding responses that subtly promote your business.\n\nInstead of traditional advertising, Gemin-Eye finds people actively seeking recommendations and engages them organically.\n\n## How It Works\n\n1. **Monitor** - Scans Reddit, Facebook groups, LinkedIn, and Google Alerts RSS feeds for posts matching your business keywords\n2. **Score** - Uses Gemini 2.5 Flash to rate each post's purchase intent (1-10)\n3. **Respond** - Uses Gemini 2.5 Pro to craft natural, human-sounding replies that subtly recommend your business\n4. **Alert** - Sends leads and suggested responses to your Telegram with one-tap feedback buttons\n\n## Features\n\n- **Automated Reddit RSS Monitoring** - Scans target subreddits every 5 minutes\n- **Google Alerts RSS Monitoring** - Monitors web mentions via Google Alerts feeds every 2 minutes\n- **Facebook Spy Glass Bookmarklet** - Browser bookmarklet that scans Facebook group posts as you scroll\n- **LinkedIn Spy Glass Bookmarklet** - Browser bookmarklet for scanning LinkedIn feed posts\n- **Telegram Bot** - Command center for managing businesses, keywords, groups, and alerts\n- **Telegram Self-Onboarding** - New clients onboard via `t.me/your_bot?start=setup`\n- **Web Dashboard** - View businesses, campaigns, leads, and AI responses\n- **Admin Panel** - Manage all clients, businesses, campaigns, keywords, and groups at `/admin`\n- **Feedback Loop** - Inline Telegram buttons for rating responses; feedback improves future generations\n- **Lead Scoring** - AI-powered intent scoring with configurable thresholds\n- **Multi-Business Support** - Each post is evaluated against all relevant businesses\n\n## Tech Stack\n\n- **Frontend**: React 18, TypeScript, Vite, Tailwind CSS, shadcn/ui, TanStack Query\n- **Backend**: Express.js, TypeScript (tsx)\n- **Database**: PostgreSQL (Drizzle ORM)\n- **AI**: Google Gemini 2.5 Pro + Flash via `@google/genai`\n- **Auth**: Replit OIDC (OpenID Connect) via Passport.js\n- **Bot**: Telegram Bot API with webhook mode\n\n## Getting Started\n\n### Prerequisites\n\n- Node.js 20+\n- PostgreSQL database\n- Telegram Bot Token (from [@BotFather](https://t.me/BotFather))\n- Google Gemini API access\n\n### Setup\n\n1. Clone the repository:\n   ```bash\n   git clone https://github.com/kmages/Gemin-Eye.git\n   cd Gemin-Eye\n   ```\n\n2. Install dependencies:\n   ```bash\n   npm install\n   ```\n\n3. Copy the environment template and fill in your values:\n   ```bash\n   cp .env.example .env\n   ```\n\n4. Push the database schema:\n   ```bash\n   npm run db:push\n   ```\n\n5. Start the development server:\n   ```bash\n   npm run dev\n   ```\n\nThe app will be available at `http://localhost:5000`.\n\n### Production Build\n\n```bash\nnpm run build\nnpm start\n```\n\n## Project Structure\n\n```\nclient/                  # React frontend\n  src/\n    pages/               # Landing, Dashboard, Onboarding, Admin\n    components/ui/       # shadcn/ui components\n    lib/                 # Query client, utilities\n  public/\n    spy-glass.js         # Facebook bookmarklet script\n    li-spy-glass.js      # LinkedIn bookmarklet script\n\nserver/                  # Express backend\n  routes.ts              # Main API routes\n  routes/\n    admin.ts             # Admin CRUD routes\n    scan.ts              # Facebook/LinkedIn scan endpoints\n  telegram-bot.ts        # Telegram bot commands and webhooks\n  telegram.ts            # Telegram messaging utilities\n  reddit-monitor.ts      # Reddit RSS monitor\n  google-alerts-monitor.ts # Google Alerts RSS monitor\n  reddit-poster.ts       # Reddit reply posting (optional)\n  storage.ts             # Database storage interface\n  utils/\n    ai.ts                # Gemini AI client, schemas, parsing\n    html.ts              # HTML escaping, stripping, URL utils\n    dedup.ts             # Deduplication helpers\n    feedback.ts          # Response feedback aggregation\n    rate-limit.ts        # Rate limiter factory\n\nshared/\n  schema.ts              # Drizzle ORM schema definitions\n```\n\n## Telegram Bot Commands\n\n| Command | Description |\n|---------|-------------|\n| `/newclient` | Create a new business profile |\n| `/removeclient` | Delete a business and all its data |\n| `/keywords` | View/edit keywords for a business |\n| `/groups` | View/edit target subreddits |\n| `/addalert` | Add a Google Alerts RSS feed |\n| `/alerts` | List active Google Alerts feeds |\n| `/removealert` | Remove a Google Alerts feed |\n\n## License\n\nMIT\n","path":null,"size_bytes":4510,"size_tokens":null},"server/telegram/admin-commands.ts":{"content":"import { db } from \"../db\";\nimport { businesses, campaigns, leads, aiResponses } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\nimport { sendTelegramMessage } from \"../telegram\";\nimport { storage } from \"../storage\";\nimport { generateContent, safeParseJsonFromAI } from \"../utils/ai\";\nimport { escapeHtml } from \"../utils/html\";\nimport { postRedditSubmission, isRedditConfigured } from \"../reddit-poster\";\nimport { pendingClientSetups, type AdminSetupState } from \"./state\";\nimport { getAllBusinessesWithCampaigns } from \"./analysis\";\n\nexport async function handleAdminCommand(chatId: string, text: string): Promise<boolean> {\n  const pending = pendingClientSetups.get(chatId);\n\n  if (pending && !text.startsWith(\"/\")) {\n    return await handleClientSetupFlow(chatId, text, pending);\n  }\n\n  if (pending && text.startsWith(\"/\")) {\n    pendingClientSetups.delete(chatId);\n  }\n\n  if (text === \"/newclient\") {\n    pendingClientSetups.set(chatId, { step: \"name\", timestamp: Date.now() });\n    await sendTelegramMessage(\"<b>New Client Setup</b>\\n\\nWhat's the business name?\");\n    return true;\n  }\n\n  if (text === \"/removeclient\") {\n    const allBiz = await getAllBusinessesWithCampaigns();\n    if (allBiz.length === 0) {\n      await sendTelegramMessage(\"No businesses to remove.\");\n      return true;\n    }\n\n    let msg = `<b>Remove a Client</b>\\n\\nReply with the number of the business to remove:\\n\\n`;\n    allBiz.forEach((b, i) => {\n      msg += `<b>${i + 1}.</b> ${escapeHtml(b.name)} (${escapeHtml(b.type)})\\n`;\n    });\n    msg += `\\nOr type /cancel to go back.`;\n\n    pendingClientSetups.set(chatId, { step: \"remove_select\", timestamp: Date.now() });\n    await sendTelegramMessage(msg);\n    return true;\n  }\n\n  if (text === \"/keywords\") {\n    const allBiz = await getAllBusinessesWithCampaigns();\n    if (allBiz.length === 0) {\n      await sendTelegramMessage(\"No businesses set up. Use /newclient first.\");\n      return true;\n    }\n\n    let msg = `<b>Update Keywords</b>\\n\\nWhich business? Reply with the number:\\n\\n`;\n    allBiz.forEach((b, i) => {\n      const kws = b.campaigns.flatMap((c) => c.keywords).slice(0, 8);\n      msg += `<b>${i + 1}.</b> ${escapeHtml(b.name)}\\n    Current: ${kws.map(k => escapeHtml(k)).join(\", \")}\\n\\n`;\n    });\n    msg += `Or type /cancel to go back.`;\n\n    pendingClientSetups.set(chatId, { step: \"keywords_select\", timestamp: Date.now() });\n    await sendTelegramMessage(msg);\n    return true;\n  }\n\n  if (text === \"/groups\") {\n    const allBiz = await getAllBusinessesWithCampaigns();\n    if (allBiz.length === 0) {\n      await sendTelegramMessage(\"No businesses set up. Use /newclient first.\");\n      return true;\n    }\n\n    let msg = `<b>Update Target Groups</b>\\n\\nWhich business? Reply with the number:\\n\\n`;\n    allBiz.forEach((b, i) => {\n      const grps = b.campaigns.flatMap((c) => c.targetGroups).slice(0, 5);\n      msg += `<b>${i + 1}.</b> ${escapeHtml(b.name)}\\n    Current: ${grps.map(g => escapeHtml(g)).join(\", \")}\\n\\n`;\n    });\n    msg += `Or type /cancel to go back.`;\n\n    pendingClientSetups.set(chatId, { step: \"groups_select\", timestamp: Date.now() });\n    await sendTelegramMessage(msg);\n    return true;\n  }\n\n  if (text === \"/cancel\") {\n    pendingClientSetups.delete(chatId);\n    await sendTelegramMessage(\"Cancelled.\");\n    return true;\n  }\n\n  if (text === \"/addalert\") {\n    const allBiz = await getAllBusinessesWithCampaigns();\n    if (allBiz.length === 0) {\n      await sendTelegramMessage(\"No businesses set up. Use /newclient first.\");\n      return true;\n    }\n\n    let msg = `<b>Add Google Alert Feed</b>\\n\\nWhich business should this alert feed be attached to?\\n\\n`;\n    allBiz.forEach((b, i) => {\n      msg += `<b>${i + 1}.</b> ${escapeHtml(b.name)}\\n`;\n    });\n    msg += `\\nReply with the number, or /cancel.`;\n\n    pendingClientSetups.set(chatId, { step: \"alert_select\", timestamp: Date.now() });\n    await sendTelegramMessage(msg);\n    return true;\n  }\n\n  if (text === \"/alerts\") {\n    const allBiz = await getAllBusinessesWithCampaigns();\n    const allCamps = await db.select().from(campaigns);\n\n    const alertCamps = allCamps.filter(c => c.platform.toLowerCase() === \"google_alerts\" && c.status === \"active\");\n    if (alertCamps.length === 0) {\n      await sendTelegramMessage(\n        `<b>No Google Alert feeds configured.</b>\\n\\n` +\n        `To add one:\\n` +\n        `1. Go to <a href=\"https://google.com/alerts\">google.com/alerts</a>\\n` +\n        `2. Enter your search query (e.g., <code>site:quora.com \"best pizza\"</code>)\\n` +\n        `3. Click \"Show Options\" and set Deliver to: <b>RSS Feed</b>\\n` +\n        `4. Copy the RSS feed URL\\n` +\n        `5. Use /addalert to add it here`\n      );\n      return true;\n    }\n\n    let msg = `<b>Your Google Alert Feeds:</b>\\n\\n`;\n    for (const camp of alertCamps) {\n      const biz = allBiz.find(b => b.id === camp.businessId);\n      const feeds = (camp.targetGroups as string[]) || [];\n      msg += `<b>${escapeHtml(biz?.name || \"Unknown\")}</b>\\n`;\n      feeds.forEach((f, i) => {\n        const shortUrl = f.length > 60 ? f.slice(0, 57) + \"...\" : f;\n        msg += `  ${i + 1}. ${escapeHtml(shortUrl)}\\n`;\n      });\n      msg += `\\n`;\n    }\n    msg += `Use /addalert to add more feeds.\\nUse /removealert to remove a feed.`;\n    await sendTelegramMessage(msg);\n    return true;\n  }\n\n  if (text === \"/removealert\") {\n    const allCamps = await db.select().from(campaigns);\n    const allBiz = await db.select().from(businesses);\n    const alertCamps = allCamps.filter(c => c.platform.toLowerCase() === \"google_alerts\" && c.status === \"active\");\n\n    if (alertCamps.length === 0) {\n      await sendTelegramMessage(\"No Google Alert feeds to remove.\");\n      return true;\n    }\n\n    let msg = `<b>Remove a Google Alert Feed</b>\\n\\nReply with the number:\\n\\n`;\n    let idx = 1;\n    const feedIndex: Array<{ campaignId: number; feedUrl: string }> = [];\n    for (const camp of alertCamps) {\n      const biz = allBiz.find(b => b.id === camp.businessId);\n      const feeds = (camp.targetGroups as string[]) || [];\n      for (const f of feeds) {\n        const shortUrl = f.length > 60 ? f.slice(0, 57) + \"...\" : f;\n        msg += `<b>${idx}.</b> ${escapeHtml(biz?.name || \"?\")} - ${escapeHtml(shortUrl)}\\n`;\n        feedIndex.push({ campaignId: camp.id, feedUrl: f });\n        idx++;\n      }\n    }\n    msg += `\\nOr /cancel.`;\n\n    pendingClientSetups.set(chatId, { step: \"alert_remove\", timestamp: Date.now(), groups: feedIndex.map(fi => `${fi.campaignId}::${fi.feedUrl}`) });\n    await sendTelegramMessage(msg);\n    return true;\n  }\n\n  if (text.startsWith(\"/post \")) {\n    if (!isRedditConfigured()) {\n      await sendTelegramMessage(\"Reddit credentials not configured. Add REDDIT_CLIENT_ID, REDDIT_CLIENT_SECRET, REDDIT_USERNAME, and REDDIT_PASSWORD to your secrets.\");\n      return true;\n    }\n\n    const postArgs = text.slice(6).trim();\n    const subredditMatch = postArgs.match(/^(r\\/\\w+)\\s+([\\s\\S]+)/);\n\n    if (!subredditMatch) {\n      await sendTelegramMessage(\n        `<b>Usage:</b>\\n\\n` +\n        `<b>New post:</b>\\n<code>/post r/subreddit Title here | Body text here</code>\\n\\n` +\n        `<b>Reply to a post:</b>\\nPaste a Reddit URL into the chat and I'll generate a response. Then tap \"Post to Reddit\" to comment.\\n\\n` +\n        `<b>Example:</b>\\n<code>/post r/startups Check out my AI tool | We built an AI that monitors communities for leads.</code>`\n      );\n      return true;\n    }\n\n    const subreddit = subredditMatch[1];\n    const rest = subredditMatch[2].trim();\n\n    const pipeIndex = rest.indexOf(\"|\");\n    let title: string;\n    let body: string;\n\n    if (pipeIndex > 0) {\n      title = rest.slice(0, pipeIndex).trim();\n      body = rest.slice(pipeIndex + 1).trim();\n    } else {\n      title = rest;\n      body = \"\";\n    }\n\n    await sendTelegramMessage(`Posting to <b>${escapeHtml(subreddit)}</b>...\\n\\nTitle: <i>${escapeHtml(title)}</i>`);\n\n    const result = await postRedditSubmission(subreddit, title, body);\n\n    if (result.success) {\n      let msg = \"Posted to Reddit!\";\n      if (result.postUrl) {\n        msg += `\\n\\n<a href=\"${result.postUrl}\">View your post</a>`;\n      }\n      await sendTelegramMessage(msg);\n    } else {\n      await sendTelegramMessage(`Failed to post: ${result.error}`);\n    }\n\n    return true;\n  }\n\n  return false;\n}\n\nexport async function handleClientSetupFlow(chatId: string, text: string, pending: AdminSetupState): Promise<boolean> {\n  if (text === \"/cancel\") {\n    pendingClientSetups.delete(chatId);\n    await sendTelegramMessage(\"Client setup cancelled.\");\n    return true;\n  }\n\n  pending.timestamp = Date.now();\n\n  switch (pending.step) {\n    case \"name\":\n      pending.name = text;\n      pending.step = \"type\";\n      await sendTelegramMessage(`Got it: <b>${escapeHtml(text)}</b>\\n\\nWhat type of business is this?\\n<i>(e.g., \"Diner in Brookfield, IL\", \"AI productivity tool\", \"Bocce ball club\")</i>`);\n      break;\n\n    case \"type\":\n      pending.type = text;\n      pending.step = \"audience\";\n      await sendTelegramMessage(`Business type: <b>${escapeHtml(text)}</b>\\n\\nWho is the target audience?\\n<i>(e.g., \"Families in the Western Suburbs looking for casual dining\")</i>`);\n      break;\n\n    case \"audience\":\n      pending.audience = text;\n      pending.step = \"offering\";\n      await sendTelegramMessage(`Target audience set.\\n\\nDescribe what this business offers in 1-2 sentences:\\n<i>(e.g., \"Classic American diner serving hearty breakfasts and comfort food. Family-owned with generous portions.\")</i>`);\n      break;\n\n    case \"offering\":\n      pending.offering = text;\n      pending.step = \"tone\";\n      await sendTelegramMessage(`Got the offering.\\n\\nWhat tone should AI responses use?\\n\\n<b>1.</b> Casual (friendly, approachable)\\n<b>2.</b> Empathetic (warm, supportive)\\n<b>3.</b> Professional (authoritative, informative)\\n\\nReply with 1, 2, or 3.`);\n      break;\n\n    case \"tone\": {\n      const toneChoice = text.trim();\n      if (toneChoice === \"1\") pending.tone = \"casual\";\n      else if (toneChoice === \"2\") pending.tone = \"empathetic\";\n      else if (toneChoice === \"3\") pending.tone = \"professional\";\n      else pending.tone = \"casual\";\n\n      pending.step = \"keywords\";\n      await sendTelegramMessage(`Tone: <b>${pending.tone}</b>\\n\\nNow list the keywords to watch for, separated by commas:\\n<i>(e.g., \"restaurant recommendation, best pizza, where to eat, Brookfield food\")</i>`);\n      break;\n    }\n\n    case \"keywords\": {\n      pending.keywords = text.split(\",\").map(k => k.trim()).filter(k => k.length > 0);\n\n      await sendTelegramMessage(`Keywords: ${pending.keywords.map(k => `<b>${escapeHtml(k)}</b>`).join(\", \")}\\n\\nGenerating target communities with AI...`);\n\n      let aiGroups: string[] = [];\n      try {\n        const groupResult = await generateContent({\n          model: \"gemini-2.5-flash\",\n          contents: `You are a social media expert. A business needs REAL Reddit subreddits and Facebook groups to monitor for customer acquisition leads.\n\nBusiness: ${pending.name} (${pending.type})\nTarget audience: ${pending.audience}\nOffering: ${pending.offering}\nKeywords: ${(pending.keywords || []).join(\", \")}\n\nReturn ONLY valid JSON with this structure:\n{\"subreddits\": [\"r/example1\", \"r/example2\"], \"facebook_groups\": [\"Example Group Name\"]}\n\nRULES:\n- List 5-8 REAL Reddit subreddits that actually exist where the target audience asks questions or seeks recommendations.\n- NEVER use placeholders like \"r/[yourcity]\". Use REAL specific names like \"r/chicago\", \"r/fitness\", \"r/smallbusiness\".\n- List 2-3 relevant Facebook group names.\n- Focus on communities where people actively ask for recommendations related to this business.`,\n          config: { maxOutputTokens: 512 },\n        });\n        const groupJson = safeParseJsonFromAI(groupResult.text);\n        if (groupJson) {\n          aiGroups = [\n            ...(groupJson.subreddits || []),\n            ...(groupJson.facebook_groups || []),\n          ];\n        }\n      } catch (e) {\n        console.error(\"AI group generation failed:\", e);\n      }\n\n      if (aiGroups.length === 0) {\n        aiGroups = [\"r/smallbusiness\", \"r/Entrepreneur\"];\n      }\n\n      pending.groups = aiGroups;\n\n      const biz = await storage.createBusiness({\n        userId: \"telegram-admin\",\n        name: pending.name!,\n        type: pending.type!,\n        targetAudience: pending.audience!,\n        coreOffering: pending.offering!,\n        preferredTone: pending.tone!,\n      });\n\n      const redditGroups = pending.groups.filter(g => g.toLowerCase().startsWith(\"r/\"));\n      const facebookGroups = pending.groups.filter(g => !g.toLowerCase().startsWith(\"r/\"));\n\n      if (facebookGroups.length > 0) {\n        await storage.createCampaign({\n          businessId: biz.id,\n          name: `${pending.name} - Facebook`,\n          platform: \"Facebook\",\n          status: \"active\",\n          strategy: `Monitor Facebook groups for ${pending.type} leads`,\n          targetGroups: facebookGroups,\n          keywords: pending.keywords || [],\n        });\n      }\n\n      if (redditGroups.length > 0) {\n        await storage.createCampaign({\n          businessId: biz.id,\n          name: `${pending.name} - Reddit`,\n          platform: \"Reddit\",\n          status: \"active\",\n          strategy: `Monitor Reddit communities for ${pending.type} leads`,\n          targetGroups: redditGroups,\n          keywords: pending.keywords || [],\n        });\n      }\n\n      if (facebookGroups.length === 0 && redditGroups.length === 0) {\n        await storage.createCampaign({\n          businessId: biz.id,\n          name: `${pending.name} - General`,\n          platform: \"Reddit\",\n          status: \"active\",\n          strategy: `Monitor communities for ${pending.type} leads`,\n          targetGroups: pending.groups,\n          keywords: pending.keywords || [],\n        });\n      }\n\n      pendingClientSetups.delete(chatId);\n\n      let msg = `<b>Client Created!</b>\\n\\n`;\n      msg += `<b>Name:</b> ${escapeHtml(biz.name)}\\n`;\n      msg += `<b>Type:</b> ${escapeHtml(biz.type)}\\n`;\n      msg += `<b>Tone:</b> ${escapeHtml(pending.tone!)}\\n`;\n      msg += `<b>Keywords:</b> ${(pending.keywords || []).map(k => escapeHtml(k)).join(\", \")}\\n`;\n      msg += `<b>Auto-Generated Groups:</b> ${(pending.groups || []).map(g => escapeHtml(g)).join(\", \")}\\n\\n`;\n      msg += `I'm now watching for leads for <b>${escapeHtml(biz.name)}</b>. Send me posts to analyze!\\n`;\n      msg += `\\n<i>Use /groups to view or change target communities.</i>`;\n\n      await sendTelegramMessage(msg);\n      break;\n    }\n\n    case \"remove_select\": {\n      const allBiz = await getAllBusinessesWithCampaigns();\n      const idx = parseInt(text) - 1;\n      if (isNaN(idx) || idx < 0 || idx >= allBiz.length) {\n        await sendTelegramMessage(\"Invalid number. Try again or /cancel.\");\n        return true;\n      }\n\n      const bizToRemove = allBiz[idx];\n      const allCampsToRemove = bizToRemove.campaigns;\n\n      for (const camp of allCampsToRemove) {\n        const campLeads = await db.select().from(leads).where(eq(leads.campaignId, camp.id));\n        for (const lead of campLeads) {\n          await db.delete(aiResponses).where(eq(aiResponses.leadId, lead.id));\n        }\n        await db.delete(leads).where(eq(leads.campaignId, camp.id));\n        await db.delete(campaigns).where(eq(campaigns.id, camp.id));\n      }\n      await db.delete(businesses).where(eq(businesses.id, bizToRemove.id));\n\n      pendingClientSetups.delete(chatId);\n      await sendTelegramMessage(`<b>${escapeHtml(bizToRemove.name)}</b> has been removed along with all its campaigns, leads, and responses.`);\n      break;\n    }\n\n    case \"keywords_select\": {\n      const allBiz = await getAllBusinessesWithCampaigns();\n      const idx = parseInt(text) - 1;\n      if (isNaN(idx) || idx < 0 || idx >= allBiz.length) {\n        await sendTelegramMessage(\"Invalid number. Try again or /cancel.\");\n        return true;\n      }\n\n      pending.name = allBiz[idx].name;\n      pending.step = \"keywords_update\";\n      const currentKws = allBiz[idx].campaigns.flatMap(c => c.keywords);\n      await sendTelegramMessage(`<b>Updating keywords for ${escapeHtml(allBiz[idx].name)}</b>\\n\\nCurrent keywords: ${currentKws.map(k => escapeHtml(k)).join(\", \")}\\n\\nSend the new complete list of keywords, separated by commas:\\n<i>(This will replace all current keywords)</i>`);\n      break;\n    }\n\n    case \"keywords_update\": {\n      const newKeywords = text.split(\",\").map(k => k.trim()).filter(k => k.length > 0);\n      const allBiz = await getAllBusinessesWithCampaigns();\n      const biz = allBiz.find(b => b.name === pending.name);\n      if (biz) {\n        for (const camp of biz.campaigns) {\n          await db.update(campaigns).set({ keywords: newKeywords }).where(eq(campaigns.id, camp.id));\n        }\n      }\n\n      pendingClientSetups.delete(chatId);\n      await sendTelegramMessage(`<b>Keywords updated for ${escapeHtml(pending.name!)}</b>\\n\\nNew keywords: ${newKeywords.map(k => escapeHtml(k)).join(\", \")}`);\n      break;\n    }\n\n    case \"groups_select\": {\n      const allBiz = await getAllBusinessesWithCampaigns();\n      const idx = parseInt(text) - 1;\n      if (isNaN(idx) || idx < 0 || idx >= allBiz.length) {\n        await sendTelegramMessage(\"Invalid number. Try again or /cancel.\");\n        return true;\n      }\n\n      pending.name = allBiz[idx].name;\n      pending.step = \"groups_update\";\n      const currentGroups = allBiz[idx].campaigns.flatMap(c => c.targetGroups);\n      await sendTelegramMessage(`<b>Updating groups for ${escapeHtml(allBiz[idx].name)}</b>\\n\\nCurrent groups: ${currentGroups.map(g => escapeHtml(g)).join(\", \")}\\n\\nSend the new complete list of groups/subreddits, separated by commas:\\n<i>(This will replace all current groups)</i>`);\n      break;\n    }\n\n    case \"groups_update\": {\n      const newGroups = text.split(\",\").map(g => g.trim()).filter(g => g.length > 0);\n      const allBiz = await getAllBusinessesWithCampaigns();\n      const biz = allBiz.find(b => b.name === pending.name);\n      if (biz) {\n        for (const camp of biz.campaigns) {\n          await db.update(campaigns).set({ targetGroups: newGroups }).where(eq(campaigns.id, camp.id));\n        }\n      }\n\n      pendingClientSetups.delete(chatId);\n      await sendTelegramMessage(`<b>Groups updated for ${escapeHtml(pending.name!)}</b>\\n\\nNew groups: ${newGroups.map(g => escapeHtml(g)).join(\", \")}`);\n      break;\n    }\n\n    case \"alert_select\": {\n      const allBiz = await getAllBusinessesWithCampaigns();\n      const idx = parseInt(text) - 1;\n      if (isNaN(idx) || idx < 0 || idx >= allBiz.length) {\n        await sendTelegramMessage(\"Invalid number. Try again or /cancel.\");\n        return true;\n      }\n\n      pending.name = allBiz[idx].name;\n      pending.step = \"alert_url\";\n      await sendTelegramMessage(\n        `<b>Adding alert feed for ${escapeHtml(allBiz[idx].name)}</b>\\n\\n` +\n        `Paste the Google Alert RSS feed URL:\\n\\n` +\n        `<i>How to get it:</i>\\n` +\n        `1. Go to <a href=\"https://google.com/alerts\">google.com/alerts</a>\\n` +\n        `2. Enter your search (e.g., <code>site:quora.com \"best pizza\"</code>)\\n` +\n        `3. Click \"Show Options\" and set Deliver to: <b>RSS Feed</b>\\n` +\n        `4. Copy the RSS URL and paste it here`,\n        { disable_web_page_preview: true }\n      );\n      break;\n    }\n\n    case \"alert_url\": {\n      const feedUrl = text.trim();\n      if (!feedUrl.startsWith(\"http\")) {\n        await sendTelegramMessage(\"That doesn't look like a URL. Please paste the RSS feed URL starting with http:// or https://\");\n        return true;\n      }\n\n      const allBiz = await getAllBusinessesWithCampaigns();\n      const biz = allBiz.find(b => b.name === pending.name);\n      if (!biz) {\n        pendingClientSetups.delete(chatId);\n        await sendTelegramMessage(\"Business not found. Try again with /addalert.\");\n        return true;\n      }\n\n      const allCamps = await db.select().from(campaigns);\n      let alertCamp = allCamps.find(c => c.businessId === biz.id && c.platform.toLowerCase() === \"google_alerts\" && c.status === \"active\");\n\n      if (alertCamp) {\n        const existingFeeds = (alertCamp.targetGroups as string[]) || [];\n        if (existingFeeds.includes(feedUrl)) {\n          pendingClientSetups.delete(chatId);\n          await sendTelegramMessage(\"This feed URL is already added for this business.\");\n          return true;\n        }\n        await db.update(campaigns).set({ targetGroups: [...existingFeeds, feedUrl] }).where(eq(campaigns.id, alertCamp.id));\n      } else {\n        const bizKeywords = biz.campaigns.flatMap(c => c.keywords);\n        await storage.createCampaign({\n          businessId: biz.id,\n          name: `${biz.name} - Google Alerts`,\n          platform: \"google_alerts\",\n          status: \"active\",\n          strategy: `Monitor Google Alerts RSS feeds for ${biz.type} leads`,\n          targetGroups: [feedUrl],\n          keywords: bizKeywords,\n        });\n      }\n\n      pendingClientSetups.delete(chatId);\n      await sendTelegramMessage(\n        `<b>Google Alert feed added!</b>\\n\\n` +\n        `<b>Business:</b> ${escapeHtml(biz.name)}\\n` +\n        `<b>Feed:</b> ${escapeHtml(feedUrl.length > 60 ? feedUrl.slice(0, 57) + \"...\" : feedUrl)}\\n\\n` +\n        `The monitor will check this feed every 2 minutes and alert you when it finds leads.\\n\\n` +\n        `Use /alerts to see all feeds, or /addalert to add more.`\n      );\n      break;\n    }\n\n    case \"alert_remove\": {\n      const idx = parseInt(text) - 1;\n      const feedEntries = (pending.groups || []);\n      if (isNaN(idx) || idx < 0 || idx >= feedEntries.length) {\n        await sendTelegramMessage(\"Invalid number. Try again or /cancel.\");\n        return true;\n      }\n\n      const entry = feedEntries[idx];\n      const [campId, ...feedUrlParts] = entry.split(\"::\");\n      const feedUrl = feedUrlParts.join(\"::\");\n      const campaignId = parseInt(campId);\n\n      const camp = await db.select().from(campaigns).where(eq(campaigns.id, campaignId)).limit(1);\n      if (camp.length > 0) {\n        const existingFeeds = (camp[0].targetGroups as string[]) || [];\n        const newFeeds = existingFeeds.filter(f => f !== feedUrl);\n        if (newFeeds.length === 0) {\n          await db.update(campaigns).set({ status: \"inactive\" }).where(eq(campaigns.id, campaignId));\n        } else {\n          await db.update(campaigns).set({ targetGroups: newFeeds }).where(eq(campaigns.id, campaignId));\n        }\n      }\n\n      pendingClientSetups.delete(chatId);\n      await sendTelegramMessage(`<b>Alert feed removed.</b>\\n\\nUse /alerts to see remaining feeds.`);\n      break;\n    }\n  }\n\n  return true;\n}\n","path":null,"size_bytes":22609,"size_tokens":null},"server/telegram/state.ts":{"content":"export interface PendingContextRequest {\n  postText: string;\n  postUrl: string | null;\n  platform: \"reddit\" | \"facebook\" | null;\n  timestamp: number;\n}\n\nexport interface ClientWizardState {\n  step: \"name\" | \"offering\" | \"contact\" | \"location\" | \"keywords\" | \"done\";\n  chatId: string;\n  timestamp: number;\n  name?: string;\n  keywords?: string[];\n  offering?: string;\n  contactEmail?: string;\n  contactPhone?: string;\n  website?: string;\n  location?: string;\n}\n\nexport interface AdminSetupState {\n  step: string;\n  timestamp: number;\n  name?: string;\n  type?: string;\n  audience?: string;\n  offering?: string;\n  tone?: string;\n  keywords?: string[];\n  groups?: string[];\n}\n\nexport const pendingContextRequests = new Map<string, PendingContextRequest>();\nexport const pendingRedditPosts = new Map<number, { responseText: string; postUrl: string; timestamp: number }>();\nexport const pendingClientSetups = new Map<string, AdminSetupState>();\nexport const clientWizards = new Map<string, ClientWizardState>();\n\nexport const REDDIT_POST_TTL = 30 * 60 * 1000;\nexport const CONTEXT_TTL = 5 * 60 * 1000;\nconst WIZARD_TTL = 60 * 60 * 1000;\nconst ADMIN_SETUP_TTL = 60 * 60 * 1000;\nconst CLEANUP_INTERVAL = 10 * 60 * 1000;\n\nexport function cleanupStaleState(): void {\n  const now = Date.now();\n  let cleaned = 0;\n\n  pendingContextRequests.forEach((val, key) => {\n    if (now - val.timestamp > CONTEXT_TTL) {\n      pendingContextRequests.delete(key);\n      cleaned++;\n    }\n  });\n\n  pendingRedditPosts.forEach((val, key) => {\n    if (now - val.timestamp > REDDIT_POST_TTL) {\n      pendingRedditPosts.delete(key);\n      cleaned++;\n    }\n  });\n\n  clientWizards.forEach((val, key) => {\n    if (now - val.timestamp > WIZARD_TTL) {\n      clientWizards.delete(key);\n      cleaned++;\n    }\n  });\n\n  pendingClientSetups.forEach((val, key) => {\n    if (now - val.timestamp > ADMIN_SETUP_TTL) {\n      pendingClientSetups.delete(key);\n      cleaned++;\n    }\n  });\n\n  if (cleaned > 0) {\n    console.log(`State cleanup: removed ${cleaned} stale entries`);\n  }\n}\n\nsetInterval(cleanupStaleState, CLEANUP_INTERVAL).unref();\n","path":null,"size_bytes":2095,"size_tokens":null},"client/src/pages/admin.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { useLocation } from \"wouter\";\nimport { Card } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n  DialogDescription,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Switch } from \"@/components/ui/switch\";\nimport {\n  Eye, Settings, ChevronLeft, ChevronDown, ChevronRight, Pencil, Trash2,\n  Plus, Save, X, Users, Target, Hash, Globe, Mail, Phone, Link2, Power,\n  MessageCircle, ExternalLink, Copy, Zap, AlertCircle, CheckCircle, Clock,\n  Shield, UserCog\n} from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { Business, Campaign, Lead, AiResponse, User } from \"@shared/schema\";\n\ntype AdminBusiness = Business & { campaigns: Campaign[]; leadCount: number };\n\nfunction TagEditor({ tags, onChange, placeholder }: { tags: string[]; onChange: (t: string[]) => void; placeholder: string }) {\n  const [input, setInput] = useState(\"\");\n\n  const addTag = () => {\n    const trimmed = input.trim();\n    if (trimmed && !tags.includes(trimmed)) {\n      onChange([...tags, trimmed]);\n      setInput(\"\");\n    }\n  };\n\n  const removeTag = (idx: number) => {\n    onChange(tags.filter((_, i) => i !== idx));\n  };\n\n  return (\n    <div className=\"space-y-2\">\n      <div className=\"flex flex-wrap gap-1.5\">\n        {tags.map((tag, i) => (\n          <Badge key={i} variant=\"secondary\" className=\"text-xs gap-1\">\n            {tag}\n            <button onClick={() => removeTag(i)} className=\"ml-0.5 opacity-60 hover:opacity-100\">\n              <X className=\"w-3 h-3\" />\n            </button>\n          </Badge>\n        ))}\n      </div>\n      <div className=\"flex gap-2\">\n        <Input\n          value={input}\n          onChange={(e) => setInput(e.target.value)}\n          placeholder={placeholder}\n          onKeyDown={(e) => { if (e.key === \"Enter\") { e.preventDefault(); addTag(); } }}\n          className=\"flex-1\"\n          data-testid=\"input-tag-add\"\n        />\n        <Button variant=\"outline\" size=\"sm\" onClick={addTag} data-testid=\"button-add-tag\">\n          <Plus className=\"w-3 h-3\" />\n        </Button>\n      </div>\n    </div>\n  );\n}\n\nfunction CampaignEditor({ campaign, onSave, onDelete }: {\n  campaign: Campaign;\n  onSave: (data: Partial<Campaign>) => void;\n  onDelete: () => void;\n}) {\n  const [editing, setEditing] = useState(false);\n  const [name, setName] = useState(campaign.name);\n  const [status, setStatus] = useState(campaign.status);\n  const [keywords, setKeywords] = useState<string[]>((campaign.keywords as string[]) || []);\n  const [targetGroups, setTargetGroups] = useState<string[]>((campaign.targetGroups as string[]) || []);\n\n  const handleSave = () => {\n    onSave({ name, status, keywords, targetGroups });\n    setEditing(false);\n  };\n\n  const handleCancel = () => {\n    setName(campaign.name);\n    setStatus(campaign.status);\n    setKeywords((campaign.keywords as string[]) || []);\n    setTargetGroups((campaign.targetGroups as string[]) || []);\n    setEditing(false);\n  };\n\n  if (!editing) {\n    return (\n      <Card className=\"p-4 space-y-3\" data-testid={`card-admin-campaign-${campaign.id}`}>\n        <div className=\"flex items-center justify-between gap-3\">\n          <div className=\"flex items-center gap-2 min-w-0\">\n            <Badge variant=\"secondary\" className=\"text-xs flex-shrink-0\">{campaign.platform}</Badge>\n            <span className=\"font-medium text-sm truncate\">{campaign.name}</span>\n          </div>\n          <div className=\"flex items-center gap-1 flex-shrink-0\">\n            <Badge variant={campaign.status === \"active\" ? \"default\" : \"secondary\"} className=\"text-xs\">\n              {campaign.status}\n            </Badge>\n            <Button variant=\"ghost\" size=\"icon\" onClick={() => setEditing(true)} data-testid={`button-edit-campaign-${campaign.id}`}>\n              <Pencil className=\"w-3.5 h-3.5\" />\n            </Button>\n            <Button variant=\"ghost\" size=\"icon\" onClick={onDelete} data-testid={`button-delete-campaign-${campaign.id}`}>\n              <Trash2 className=\"w-3.5 h-3.5 text-destructive\" />\n            </Button>\n          </div>\n        </div>\n        <div className=\"space-y-1.5\">\n          <div className=\"flex items-center gap-1.5 text-xs text-muted-foreground\">\n            <Target className=\"w-3 h-3\" />\n            <span>{(campaign.targetGroups as string[])?.length || 0} groups</span>\n          </div>\n          {(campaign.targetGroups as string[])?.length > 0 && (\n            <div className=\"flex flex-wrap gap-1\">\n              {(campaign.targetGroups as string[]).map((g, i) => (\n                <span key={i} className=\"text-xs bg-muted px-1.5 py-0.5 rounded-md\">{g}</span>\n              ))}\n            </div>\n          )}\n        </div>\n        <div className=\"space-y-1.5\">\n          <div className=\"flex items-center gap-1.5 text-xs text-muted-foreground\">\n            <Hash className=\"w-3 h-3\" />\n            <span>{(campaign.keywords as string[])?.length || 0} keywords</span>\n          </div>\n          {(campaign.keywords as string[])?.length > 0 && (\n            <div className=\"flex flex-wrap gap-1\">\n              {(campaign.keywords as string[]).map((kw, i) => (\n                <span key={i} className=\"text-xs bg-muted px-1.5 py-0.5 rounded-md\">{kw}</span>\n              ))}\n            </div>\n          )}\n        </div>\n      </Card>\n    );\n  }\n\n  return (\n    <Card className=\"p-4 space-y-4 border-primary/30\" data-testid={`card-edit-campaign-${campaign.id}`}>\n      <div className=\"flex items-center justify-between gap-3\">\n        <span className=\"text-sm font-medium\">Editing Campaign</span>\n        <div className=\"flex gap-1\">\n          <Button variant=\"ghost\" size=\"icon\" onClick={handleCancel}>\n            <X className=\"w-3.5 h-3.5\" />\n          </Button>\n        </div>\n      </div>\n      <div className=\"space-y-3\">\n        <div>\n          <label className=\"text-xs text-muted-foreground mb-1 block\">Name</label>\n          <Input value={name} onChange={(e) => setName(e.target.value)} data-testid=\"input-campaign-name\" />\n        </div>\n        <div>\n          <label className=\"text-xs text-muted-foreground mb-1 block\">Status</label>\n          <Select value={status} onValueChange={setStatus}>\n            <SelectTrigger data-testid=\"select-campaign-status\">\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"active\">Active</SelectItem>\n              <SelectItem value=\"paused\">Paused</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n        <div>\n          <label className=\"text-xs text-muted-foreground mb-1 block\">Target Groups / Subreddits</label>\n          <TagEditor tags={targetGroups} onChange={setTargetGroups} placeholder=\"Add group (e.g. r/chicago)\" />\n        </div>\n        <div>\n          <label className=\"text-xs text-muted-foreground mb-1 block\">Keywords</label>\n          <TagEditor tags={keywords} onChange={setKeywords} placeholder=\"Add keyword\" />\n        </div>\n      </div>\n      <div className=\"flex justify-end gap-2\">\n        <Button variant=\"outline\" size=\"sm\" onClick={handleCancel}>Cancel</Button>\n        <Button size=\"sm\" onClick={handleSave} data-testid=\"button-save-campaign\">\n          <Save className=\"w-3 h-3 mr-1\" /> Save\n        </Button>\n      </div>\n    </Card>\n  );\n}\n\nfunction AdminLeadCard({ lead, response }: { lead: Lead; response?: AiResponse }) {\n  const { toast } = useToast();\n  const [expandedPost, setExpandedPost] = useState(false);\n  const [expandedResponse, setExpandedResponse] = useState(false);\n  const statusConfig: Record<string, { label: string; variant: \"default\" | \"secondary\" | \"destructive\"; icon: any }> = {\n    new: { label: \"New\", variant: \"default\", icon: AlertCircle },\n    matched: { label: \"Matched\", variant: \"default\", icon: Zap },\n    responded: { label: \"Responded\", variant: \"secondary\", icon: CheckCircle },\n    pending: { label: \"Pending\", variant: \"secondary\", icon: Clock },\n  };\n  const config = statusConfig[lead.status] || statusConfig.new;\n\n  const handleCopy = () => {\n    if (response) {\n      navigator.clipboard.writeText(response.content);\n      toast({ title: \"Copied!\", description: \"Response copied to clipboard.\" });\n    }\n  };\n\n  const postText = lead.originalPost;\n  const postIsLong = postText.length > 200;\n  const responseText = response?.content || \"\";\n  const responseIsLong = responseText.length > 250;\n\n  return (\n    <Card className=\"p-4 space-y-3\" data-testid={`card-admin-lead-${lead.id}`}>\n      <div className=\"flex items-start justify-between gap-3\">\n        <div className=\"flex items-center gap-2 min-w-0\">\n          <Badge variant=\"secondary\" className=\"text-xs flex-shrink-0\">{lead.platform}</Badge>\n          <span className=\"text-xs text-muted-foreground truncate\">{lead.groupName}</span>\n        </div>\n        <div className=\"flex items-center gap-2 flex-shrink-0\">\n          <Badge variant={config.variant} className=\"text-xs\">\n            <config.icon className=\"w-3 h-3 mr-1\" />\n            {config.label}\n          </Badge>\n          <Badge variant=\"secondary\" className=\"text-xs\">{lead.intentScore}/10</Badge>\n        </div>\n      </div>\n      <div className=\"space-y-1\">\n        <p className=\"text-xs text-muted-foreground\">{lead.authorName} &middot; {new Date(lead.createdAt).toLocaleDateString()}</p>\n        <div\n          className=\"text-sm bg-muted/50 p-2.5 rounded-md leading-relaxed cursor-pointer\"\n          onClick={() => postIsLong && setExpandedPost(!expandedPost)}\n          data-testid={`text-admin-lead-post-${lead.id}`}\n        >\n          <p className=\"whitespace-pre-wrap\">{expandedPost || !postIsLong ? postText : postText.slice(0, 200) + \"...\"}</p>\n          {postIsLong && (\n            <span className=\"text-xs text-primary mt-1 inline-block\">{expandedPost ? \"Show less\" : \"Show more\"}</span>\n          )}\n        </div>\n      </div>\n      {response && (\n        <div className=\"space-y-1.5\">\n          <div className=\"flex items-center gap-1.5\">\n            <Zap className=\"w-3 h-3 text-chart-2\" />\n            <span className=\"text-xs font-medium text-chart-2\">AI Response</span>\n            {response.status && (\n              <Badge variant=\"secondary\" className=\"text-xs ml-1\">{response.status}</Badge>\n            )}\n          </div>\n          <div\n            className=\"text-sm text-muted-foreground leading-relaxed cursor-pointer\"\n            onClick={() => responseIsLong && setExpandedResponse(!expandedResponse)}\n            data-testid={`text-admin-response-${lead.id}`}\n          >\n            <p className=\"whitespace-pre-wrap\">{expandedResponse || !responseIsLong ? responseText : responseText.slice(0, 250) + \"...\"}</p>\n            {responseIsLong && (\n              <span className=\"text-xs text-primary mt-1 inline-block\">{expandedResponse ? \"Show less\" : \"Show more\"}</span>\n            )}\n          </div>\n        </div>\n      )}\n      <div className=\"flex flex-wrap items-center gap-2\">\n        {response && (\n          <Button variant=\"outline\" size=\"sm\" onClick={handleCopy} data-testid={`button-admin-copy-${lead.id}`}>\n            <Copy className=\"w-3 h-3 mr-1\" /> Copy\n          </Button>\n        )}\n        {lead.postUrl && (\n          <Button variant=\"outline\" size=\"sm\" asChild data-testid={`button-admin-open-${lead.id}`}>\n            <a href={lead.postUrl} target=\"_blank\" rel=\"noopener noreferrer\">\n              <ExternalLink className=\"w-3 h-3 mr-1\" /> Open Post\n            </a>\n          </Button>\n        )}\n      </div>\n    </Card>\n  );\n}\n\nfunction BookmarkletSection({ businessId }: { businessId: number }) {\n  const [showBookmarklets, setShowBookmarklets] = useState(false);\n  const { toast } = useToast();\n\n  const { data, isLoading, refetch } = useQuery<{ facebook?: string; linkedin?: string; businessName?: string; error?: string; message?: string }>({\n    queryKey: [\"/api/admin/businesses\", businessId, \"bookmarklets\"],\n    queryFn: async () => {\n      const res = await fetch(`/api/admin/businesses/${businessId}/bookmarklets`, { credentials: \"include\" });\n      return res.json();\n    },\n    enabled: showBookmarklets,\n  });\n\n  const copyToClipboard = async (text: string, label: string) => {\n    try {\n      await navigator.clipboard.writeText(text);\n      toast({ title: `${label} bookmarklet copied` });\n    } catch {\n      toast({ title: \"Failed to copy\", variant: \"destructive\" });\n    }\n  };\n\n  return (\n    <div className=\"space-y-3\">\n      <div className=\"flex items-center justify-between gap-3\">\n        <h4 className=\"text-sm font-medium\">Bookmarklets</h4>\n        <Button\n          variant=\"outline\"\n          size=\"sm\"\n          onClick={() => { setShowBookmarklets(!showBookmarklets); if (!showBookmarklets) refetch(); }}\n          data-testid={`button-toggle-bookmarklets-${businessId}`}\n        >\n          <Zap className=\"w-3 h-3 mr-1\" /> {showBookmarklets ? \"Hide\" : \"Show Bookmarklets\"}\n        </Button>\n      </div>\n\n      {showBookmarklets && (\n        <div className=\"space-y-3\">\n          {isLoading ? (\n            <Skeleton className=\"h-20 w-full rounded-md\" />\n          ) : data?.error === \"no_telegram\" ? (\n            <Card className=\"p-4 text-center\">\n              <AlertCircle className=\"w-5 h-5 mx-auto text-muted-foreground mb-2\" />\n              <p className=\"text-sm text-muted-foreground\">{data.message}</p>\n            </Card>\n          ) : data?.facebook ? (\n            <div className=\"space-y-3\">\n              <Card className=\"p-4 space-y-2\">\n                <div className=\"flex items-center justify-between gap-3\">\n                  <span className=\"text-sm font-medium flex items-center gap-1\">\n                    <Globe className=\"w-3.5 h-3.5\" /> Facebook Spy Glass\n                  </span>\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => copyToClipboard(data.facebook!, \"Facebook\")}\n                    data-testid={`button-copy-fb-bookmarklet-${businessId}`}\n                  >\n                    <Copy className=\"w-3 h-3 mr-1\" /> Copy\n                  </Button>\n                </div>\n                <p className=\"text-xs text-muted-foreground break-all line-clamp-2 font-mono\">{data.facebook?.slice(0, 120)}...</p>\n              </Card>\n              <Card className=\"p-4 space-y-2\">\n                <div className=\"flex items-center justify-between gap-3\">\n                  <span className=\"text-sm font-medium flex items-center gap-1\">\n                    <Globe className=\"w-3.5 h-3.5\" /> LinkedIn Spy Glass\n                  </span>\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => copyToClipboard(data.linkedin!, \"LinkedIn\")}\n                    data-testid={`button-copy-li-bookmarklet-${businessId}`}\n                  >\n                    <Copy className=\"w-3 h-3 mr-1\" /> Copy\n                  </Button>\n                </div>\n                <p className=\"text-xs text-muted-foreground break-all line-clamp-2 font-mono\">{data.linkedin?.slice(0, 120)}...</p>\n              </Card>\n            </div>\n          ) : (\n            <Card className=\"p-4 text-center\">\n              <AlertCircle className=\"w-5 h-5 mx-auto text-muted-foreground mb-2\" />\n              <p className=\"text-sm text-muted-foreground\">Failed to generate bookmarklets.</p>\n            </Card>\n          )}\n        </div>\n      )}\n    </div>\n  );\n}\n\nfunction BusinessPanel({ business, onRefresh }: { business: AdminBusiness; onRefresh: () => void }) {\n  const [expanded, setExpanded] = useState(false);\n  const [editingBiz, setEditingBiz] = useState(false);\n  const [showNewCampaign, setShowNewCampaign] = useState(false);\n  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);\n  const [showLeads, setShowLeads] = useState(false);\n  const { toast } = useToast();\n\n  const [bizName, setBizName] = useState(business.name);\n  const [bizType, setBizType] = useState(business.type);\n  const [bizEmail, setBizEmail] = useState(business.contactEmail || \"\");\n  const [bizPhone, setBizPhone] = useState(business.contactPhone || \"\");\n  const [bizWebsite, setBizWebsite] = useState(business.website || \"\");\n  const [bizAudience, setBizAudience] = useState(business.targetAudience);\n  const [bizOffering, setBizOffering] = useState(business.coreOffering);\n  const [bizTone, setBizTone] = useState(business.preferredTone);\n  const [bizTelegramChatId, setBizTelegramChatId] = useState(business.telegramChatId || \"\");\n\n  const [newCampName, setNewCampName] = useState(\"\");\n  const [newCampPlatform, setNewCampPlatform] = useState(\"Reddit\");\n\n  const { data: allUsers } = useQuery<User[]>({\n    queryKey: [\"/api/admin/users\"],\n    enabled: expanded,\n  });\n\n  const { data: leadsData, isLoading: leadsLoading } = useQuery<{ leads: Lead[]; responses: AiResponse[]; campaigns: { id: number; name: string; platform: string }[] }>({\n    queryKey: [\"/api/admin/leads\", business.id],\n    enabled: expanded && showLeads,\n  });\n\n  const assignOwner = useMutation({\n    mutationFn: async (userId: string) => {\n      const res = await apiRequest(\"PATCH\", `/api/admin/businesses/${business.id}/owner`, { userId });\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Owner assigned\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/businesses\"] });\n    },\n    onError: () => toast({ title: \"Failed to assign owner\", variant: \"destructive\" }),\n  });\n\n  const updateBiz = useMutation({\n    mutationFn: async (data: any) => {\n      const res = await apiRequest(\"PATCH\", `/api/admin/businesses/${business.id}`, data);\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Business updated\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/businesses\"] });\n      setEditingBiz(false);\n    },\n    onError: () => toast({ title: \"Failed to update\", variant: \"destructive\" }),\n  });\n\n  const deleteBiz = useMutation({\n    mutationFn: async () => {\n      await apiRequest(\"DELETE\", `/api/admin/businesses/${business.id}`);\n    },\n    onSuccess: () => {\n      toast({ title: \"Business deleted\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/businesses\"] });\n    },\n    onError: () => toast({ title: \"Failed to delete\", variant: \"destructive\" }),\n  });\n\n  const updateCamp = useMutation({\n    mutationFn: async ({ id, data }: { id: number; data: any }) => {\n      const res = await apiRequest(\"PATCH\", `/api/admin/campaigns/${id}`, data);\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Campaign updated\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/businesses\"] });\n    },\n    onError: () => toast({ title: \"Failed to update campaign\", variant: \"destructive\" }),\n  });\n\n  const deleteCamp = useMutation({\n    mutationFn: async (id: number) => {\n      await apiRequest(\"DELETE\", `/api/admin/campaigns/${id}`);\n    },\n    onSuccess: () => {\n      toast({ title: \"Campaign deleted\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/businesses\"] });\n    },\n    onError: () => toast({ title: \"Failed to delete campaign\", variant: \"destructive\" }),\n  });\n\n  const createCamp = useMutation({\n    mutationFn: async (data: any) => {\n      const res = await apiRequest(\"POST\", \"/api/admin/campaigns\", data);\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Campaign created\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/businesses\"] });\n      setShowNewCampaign(false);\n      setNewCampName(\"\");\n      setNewCampPlatform(\"Reddit\");\n    },\n    onError: () => toast({ title: \"Failed to create campaign\", variant: \"destructive\" }),\n  });\n\n  return (\n    <Card className=\"overflow-visible\" data-testid={`card-admin-business-${business.id}`}>\n      <div\n        className=\"p-5 cursor-pointer hover-elevate\"\n        onClick={() => setExpanded(!expanded)}\n        data-testid={`button-expand-business-${business.id}`}\n      >\n        <div className=\"flex items-center justify-between gap-3\">\n          <div className=\"flex items-center gap-3 min-w-0\">\n            {expanded ? <ChevronDown className=\"w-4 h-4 flex-shrink-0\" /> : <ChevronRight className=\"w-4 h-4 flex-shrink-0\" />}\n            <div className=\"min-w-0\">\n              <h3 className=\"font-semibold truncate\">{business.name}</h3>\n              <p className=\"text-xs text-muted-foreground truncate\">{business.type}</p>\n            </div>\n          </div>\n          <div className=\"flex items-center gap-2 flex-shrink-0\">\n            <Badge variant=\"secondary\" className=\"text-xs\">\n              <Target className=\"w-3 h-3 mr-1\" />{business.campaigns.length} campaigns\n            </Badge>\n            <Badge variant=\"secondary\" className=\"text-xs\">\n              <Users className=\"w-3 h-3 mr-1\" />{business.leadCount} leads\n            </Badge>\n          </div>\n        </div>\n        {!expanded && (\n          <div className=\"flex flex-wrap items-center gap-2 mt-2 ml-7\">\n            {business.contactEmail && (\n              <span className=\"text-xs text-muted-foreground flex items-center gap-1\"><Mail className=\"w-3 h-3\" />{business.contactEmail}</span>\n            )}\n            {business.contactPhone && (\n              <span className=\"text-xs text-muted-foreground flex items-center gap-1\"><Phone className=\"w-3 h-3\" />{business.contactPhone}</span>\n            )}\n            {business.website && (\n              <span className=\"text-xs text-muted-foreground flex items-center gap-1\"><Link2 className=\"w-3 h-3\" />{business.website}</span>\n            )}\n          </div>\n        )}\n      </div>\n\n      {expanded && (\n        <div className=\"border-t px-5 pb-5 space-y-5\">\n          <div className=\"pt-4 flex items-center justify-between gap-3\">\n            <h4 className=\"text-sm font-medium\">Business Details</h4>\n            <div className=\"flex gap-1\">\n              <Button variant=\"outline\" size=\"sm\" onClick={(e) => { e.stopPropagation(); setEditingBiz(!editingBiz); }} data-testid={`button-edit-biz-${business.id}`}>\n                <Pencil className=\"w-3 h-3 mr-1\" /> {editingBiz ? \"Cancel\" : \"Edit\"}\n              </Button>\n              <Button variant=\"outline\" size=\"sm\" onClick={(e) => { e.stopPropagation(); setShowDeleteConfirm(true); }} data-testid={`button-delete-biz-${business.id}`}>\n                <Trash2 className=\"w-3 h-3 mr-1 text-destructive\" /> Delete\n              </Button>\n            </div>\n          </div>\n\n          {editingBiz ? (\n            <div className=\"space-y-3\">\n              <div className=\"grid grid-cols-2 gap-3\">\n                <div>\n                  <label className=\"text-xs text-muted-foreground mb-1 block\">Name</label>\n                  <Input value={bizName} onChange={(e) => setBizName(e.target.value)} data-testid=\"input-biz-name\" />\n                </div>\n                <div>\n                  <label className=\"text-xs text-muted-foreground mb-1 block\">Type</label>\n                  <Input value={bizType} onChange={(e) => setBizType(e.target.value)} data-testid=\"input-biz-type\" />\n                </div>\n              </div>\n              <div className=\"grid grid-cols-3 gap-3\">\n                <div>\n                  <label className=\"text-xs text-muted-foreground mb-1 block\">Email</label>\n                  <Input value={bizEmail} onChange={(e) => setBizEmail(e.target.value)} data-testid=\"input-biz-email\" />\n                </div>\n                <div>\n                  <label className=\"text-xs text-muted-foreground mb-1 block\">Phone</label>\n                  <Input value={bizPhone} onChange={(e) => setBizPhone(e.target.value)} data-testid=\"input-biz-phone\" />\n                </div>\n                <div>\n                  <label className=\"text-xs text-muted-foreground mb-1 block\">Website</label>\n                  <Input value={bizWebsite} onChange={(e) => setBizWebsite(e.target.value)} data-testid=\"input-biz-website\" />\n                </div>\n              </div>\n              <div>\n                <label className=\"text-xs text-muted-foreground mb-1 block\">Target Audience</label>\n                <Textarea value={bizAudience} onChange={(e) => setBizAudience(e.target.value)} className=\"resize-none\" data-testid=\"input-biz-audience\" />\n              </div>\n              <div>\n                <label className=\"text-xs text-muted-foreground mb-1 block\">Core Offering</label>\n                <Textarea value={bizOffering} onChange={(e) => setBizOffering(e.target.value)} className=\"resize-none\" data-testid=\"input-biz-offering\" />\n              </div>\n              <div>\n                <label className=\"text-xs text-muted-foreground mb-1 block\">Preferred Tone</label>\n                <Select value={bizTone} onValueChange={setBizTone}>\n                  <SelectTrigger data-testid=\"select-biz-tone\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"empathetic\">Empathetic</SelectItem>\n                    <SelectItem value=\"professional\">Professional</SelectItem>\n                    <SelectItem value=\"casual\">Casual</SelectItem>\n                    <SelectItem value=\"helpful\">Helpful</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <div>\n                <label className=\"text-xs text-muted-foreground mb-1 block\">Telegram Chat ID</label>\n                <Input value={bizTelegramChatId} onChange={(e) => setBizTelegramChatId(e.target.value)} placeholder=\"e.g. 8491725368\" data-testid=\"input-biz-telegram-chat-id\" />\n              </div>\n              <div className=\"flex justify-end\">\n                <Button\n                  size=\"sm\"\n                  onClick={() => updateBiz.mutate({\n                    name: bizName, type: bizType,\n                    contactEmail: bizEmail || null, contactPhone: bizPhone || null, website: bizWebsite || null,\n                    targetAudience: bizAudience, coreOffering: bizOffering, preferredTone: bizTone, telegramChatId: bizTelegramChatId || null,\n                  })}\n                  disabled={updateBiz.isPending}\n                  data-testid=\"button-save-biz\"\n                >\n                  <Save className=\"w-3 h-3 mr-1\" /> {updateBiz.isPending ? \"Saving...\" : \"Save Changes\"}\n                </Button>\n              </div>\n            </div>\n          ) : (\n            <div className=\"grid grid-cols-2 gap-x-6 gap-y-2 text-sm\">\n              <div><span className=\"text-muted-foreground\">Email:</span> {business.contactEmail || \"\"}</div>\n              <div><span className=\"text-muted-foreground\">Phone:</span> {business.contactPhone || \"\"}</div>\n              <div><span className=\"text-muted-foreground\">Website:</span> {business.website || \"\"}</div>\n              <div><span className=\"text-muted-foreground\">Tone:</span> {business.preferredTone}</div>\n              <div><span className=\"text-muted-foreground\">Telegram:</span> {business.telegramChatId || \"Not connected\"}</div>\n              <div className=\"col-span-2\"><span className=\"text-muted-foreground\">Audience:</span> {business.targetAudience}</div>\n              <div className=\"col-span-2\"><span className=\"text-muted-foreground\">Offering:</span> {business.coreOffering}</div>\n              <div className=\"col-span-2 flex items-center gap-2 pt-2 border-t\">\n                <span className=\"text-muted-foreground flex items-center gap-1\"><UserCog className=\"w-3 h-3\" /> Owner:</span>\n                <Select\n                  value={business.userId}\n                  onValueChange={(val) => assignOwner.mutate(val)}\n                >\n                  <SelectTrigger className=\"w-48\" data-testid={`select-owner-${business.id}`}>\n                    <SelectValue placeholder=\"Assign owner\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {allUsers?.map((u) => (\n                      <SelectItem key={u.id} value={u.id}>\n                        {u.firstName || u.email || u.id} {u.lastName || \"\"}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n                {assignOwner.isPending && <span className=\"text-xs text-muted-foreground\">Saving...</span>}\n              </div>\n            </div>\n          )}\n\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center justify-between gap-3\">\n              <h4 className=\"text-sm font-medium\">Campaigns ({business.campaigns.length})</h4>\n              <Button variant=\"outline\" size=\"sm\" onClick={() => setShowNewCampaign(true)} data-testid={`button-add-campaign-${business.id}`}>\n                <Plus className=\"w-3 h-3 mr-1\" /> Add Campaign\n              </Button>\n            </div>\n\n            {showNewCampaign && (\n              <Card className=\"p-4 space-y-3 border-primary/30\">\n                <span className=\"text-sm font-medium\">New Campaign</span>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <div>\n                    <label className=\"text-xs text-muted-foreground mb-1 block\">Name</label>\n                    <Input value={newCampName} onChange={(e) => setNewCampName(e.target.value)} placeholder=\"Campaign name\" data-testid=\"input-new-camp-name\" />\n                  </div>\n                  <div>\n                    <label className=\"text-xs text-muted-foreground mb-1 block\">Platform</label>\n                    <Select value={newCampPlatform} onValueChange={setNewCampPlatform}>\n                      <SelectTrigger data-testid=\"select-new-camp-platform\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"Reddit\">Reddit</SelectItem>\n                        <SelectItem value=\"Facebook\">Facebook</SelectItem>\n                        <SelectItem value=\"LinkedIn\">LinkedIn</SelectItem>\n                        <SelectItem value=\"google_alerts\">Google Alerts</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                </div>\n                <div className=\"flex justify-end gap-2\">\n                  <Button variant=\"outline\" size=\"sm\" onClick={() => setShowNewCampaign(false)}>Cancel</Button>\n                  <Button\n                    size=\"sm\"\n                    onClick={() => createCamp.mutate({ businessId: business.id, name: newCampName || `${newCampPlatform} Campaign`, platform: newCampPlatform, keywords: [], targetGroups: [] })}\n                    disabled={createCamp.isPending}\n                    data-testid=\"button-create-campaign\"\n                  >\n                    <Plus className=\"w-3 h-3 mr-1\" /> {createCamp.isPending ? \"Creating...\" : \"Create\"}\n                  </Button>\n                </div>\n              </Card>\n            )}\n\n            <div className=\"space-y-3\">\n              {business.campaigns.map((camp) => (\n                <CampaignEditor\n                  key={camp.id}\n                  campaign={camp}\n                  onSave={(data) => updateCamp.mutate({ id: camp.id, data })}\n                  onDelete={() => deleteCamp.mutate(camp.id)}\n                />\n              ))}\n              {business.campaigns.length === 0 && (\n                <p className=\"text-sm text-muted-foreground text-center py-4\">No campaigns yet</p>\n              )}\n            </div>\n          </div>\n\n          <BookmarkletSection businessId={business.id} />\n\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center justify-between gap-3\">\n              <h4 className=\"text-sm font-medium\">Leads ({business.leadCount})</h4>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => setShowLeads(!showLeads)}\n                data-testid={`button-toggle-leads-${business.id}`}\n              >\n                <MessageCircle className=\"w-3 h-3 mr-1\" /> {showLeads ? \"Hide Leads\" : \"Show Leads\"}\n              </Button>\n            </div>\n\n            {showLeads && (\n              <div className=\"space-y-4\">\n                {leadsLoading ? (\n                  <div className=\"space-y-3\">\n                    {[1, 2, 3].map((i) => (\n                      <Skeleton key={i} className=\"h-32 w-full rounded-md\" />\n                    ))}\n                  </div>\n                ) : leadsData && leadsData.leads.length > 0 ? (\n                  (leadsData.campaigns || []).map((camp) => {\n                    const campLeads = leadsData.leads.filter((l) => l.campaignId === camp.id);\n                    if (campLeads.length === 0) return null;\n                    return (\n                      <div key={camp.id} className=\"space-y-2\">\n                        <div className=\"flex items-center gap-2\">\n                          <Target className=\"w-3.5 h-3.5 text-muted-foreground\" />\n                          <span className=\"text-sm font-medium\">{camp.name}</span>\n                          <Badge variant=\"secondary\" className=\"text-xs\">{camp.platform}</Badge>\n                          <span className=\"text-xs text-muted-foreground\">({campLeads.length})</span>\n                        </div>\n                        <div className=\"space-y-3 pl-5 border-l-2 border-border ml-1.5\">\n                          {campLeads.map((lead) => {\n                            const resp = leadsData.responses.find((r) => r.leadId === lead.id);\n                            return <AdminLeadCard key={lead.id} lead={lead} response={resp} />;\n                          })}\n                        </div>\n                      </div>\n                    );\n                  })\n                ) : (\n                  <Card className=\"p-6 text-center\">\n                    <Target className=\"w-6 h-6 mx-auto text-muted-foreground mb-2\" />\n                    <p className=\"text-sm text-muted-foreground\">No leads found for this business yet.</p>\n                  </Card>\n                )}\n              </div>\n            )}\n          </div>\n        </div>\n      )}\n\n      <Dialog open={showDeleteConfirm} onOpenChange={setShowDeleteConfirm}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Delete {business.name}?</DialogTitle>\n            <DialogDescription>\n              This will permanently delete this business and all its campaigns. This cannot be undone.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowDeleteConfirm(false)}>Cancel</Button>\n            <Button\n              variant=\"destructive\"\n              onClick={() => { deleteBiz.mutate(); setShowDeleteConfirm(false); }}\n              disabled={deleteBiz.isPending}\n              data-testid=\"button-confirm-delete-biz\"\n            >\n              {deleteBiz.isPending ? \"Deleting...\" : \"Delete Business\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </Card>\n  );\n}\n\ntype AllLeadsBiz = {\n  business: { id: number; name: string };\n  campaigns: { id: number; name: string; platform: string }[];\n  leads: Lead[];\n  responses: AiResponse[];\n};\n\nfunction AllLeadsView() {\n  const { data, isLoading } = useQuery<AllLeadsBiz[]>({\n    queryKey: [\"/api/admin/all-leads\"],\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"space-y-4\">\n        {[1, 2, 3].map((i) => <Skeleton key={i} className=\"h-32 w-full rounded-md\" />)}\n      </div>\n    );\n  }\n\n  if (!data || data.length === 0) {\n    return (\n      <Card className=\"p-8 text-center space-y-3\">\n        <Target className=\"w-8 h-8 mx-auto text-muted-foreground\" />\n        <p className=\"text-sm text-muted-foreground\">No leads found across any business.</p>\n      </Card>\n    );\n  }\n\n  const totalLeads = data.reduce((sum, b) => sum + b.leads.length, 0);\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center gap-2\">\n        <MessageCircle className=\"w-4 h-4 text-primary\" />\n        <span className=\"text-sm font-medium\">{totalLeads} total leads across {data.length} businesses</span>\n      </div>\n      {data.map((entry) => (\n        <Card key={entry.business.id} className=\"overflow-visible\" data-testid={`card-allleads-biz-${entry.business.id}`}>\n          <div className=\"p-4 border-b\">\n            <div className=\"flex items-center justify-between gap-3\">\n              <div className=\"flex items-center gap-2\">\n                <Globe className=\"w-4 h-4 text-primary\" />\n                <span className=\"font-medium\">{entry.business.name}</span>\n              </div>\n              <Badge variant=\"secondary\" className=\"text-xs\">{entry.leads.length} leads</Badge>\n            </div>\n          </div>\n          <div className=\"p-4 space-y-4\">\n            {entry.campaigns.map((camp) => {\n              const campLeads = entry.leads.filter((l) => l.campaignId === camp.id);\n              if (campLeads.length === 0) return null;\n              return (\n                <div key={camp.id} className=\"space-y-2\">\n                  <div className=\"flex items-center gap-2\">\n                    <Target className=\"w-3.5 h-3.5 text-muted-foreground\" />\n                    <span className=\"text-sm font-medium\">{camp.name}</span>\n                    <Badge variant=\"secondary\" className=\"text-xs\">{camp.platform}</Badge>\n                    <span className=\"text-xs text-muted-foreground\">({campLeads.length})</span>\n                  </div>\n                  <div className=\"space-y-3 pl-5 border-l-2 border-border ml-1.5\">\n                    {campLeads.map((lead) => {\n                      const resp = entry.responses.find((r) => r.leadId === lead.id);\n                      return <AdminLeadCard key={lead.id} lead={lead} response={resp} />;\n                    })}\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n        </Card>\n      ))}\n    </div>\n  );\n}\n\nfunction UserManagement({ isSuperAdmin }: { isSuperAdmin: boolean }) {\n  const { toast } = useToast();\n  const { data: users, isLoading } = useQuery<User[]>({\n    queryKey: [\"/api/admin/users\"],\n  });\n\n  const updateRole = useMutation({\n    mutationFn: async ({ userId, role }: { userId: string; role: string }) => {\n      const res = await apiRequest(\"PATCH\", `/api/admin/users/${userId}/role`, { role });\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/users\"] });\n      toast({ title: \"User role updated\" });\n    },\n    onError: (err: any) => {\n      toast({ title: \"Failed to update role\", description: err?.message || \"Something went wrong\", variant: \"destructive\" });\n    },\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"space-y-3\">\n        {[1, 2, 3].map((i) => <Skeleton key={i} className=\"h-16 w-full rounded-md\" />)}\n      </div>\n    );\n  }\n\n  if (!users || users.length === 0) {\n    return (\n      <Card className=\"p-8 text-center space-y-3\">\n        <UserCog className=\"w-8 h-8 mx-auto text-muted-foreground\" />\n        <p className=\"text-sm text-muted-foreground\">No users have logged in yet.</p>\n      </Card>\n    );\n  }\n\n  return (\n    <div className=\"space-y-3\">\n      <p className=\"text-sm text-muted-foreground\">{users.length} registered users</p>\n      {users.map((u) => {\n        const isOwner = u.id === \"40011074\";\n        return (\n          <Card key={u.id} className=\"p-4\" data-testid={`card-user-${u.id}`}>\n            <div className=\"flex items-center justify-between gap-4\">\n              <div className=\"flex items-center gap-3 min-w-0\">\n                <div className=\"flex items-center justify-center w-9 h-9 rounded-full bg-muted flex-shrink-0\">\n                  <UserCog className=\"w-4 h-4 text-muted-foreground\" />\n                </div>\n                <div className=\"min-w-0\">\n                  <div className=\"flex items-center gap-2 flex-wrap\">\n                    <span className=\"font-medium text-sm truncate\">\n                      {u.firstName} {u.lastName}\n                    </span>\n                    {isOwner && (\n                      <Badge variant=\"default\" className=\"text-xs\">\n                        <Shield className=\"w-3 h-3 mr-1\" /> Owner\n                      </Badge>\n                    )}\n                    {!isOwner && u.role === \"admin\" && (\n                      <Badge variant=\"secondary\" className=\"text-xs\">\n                        <Shield className=\"w-3 h-3 mr-1\" /> Admin\n                      </Badge>\n                    )}\n                  </div>\n                  <p className=\"text-xs text-muted-foreground truncate\">{u.email || \"No email\"}</p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-2 flex-shrink-0\">\n                {isSuperAdmin && !isOwner && (\n                  <Select\n                    value={u.role || \"user\"}\n                    onValueChange={(role) => updateRole.mutate({ userId: u.id, role })}\n                  >\n                    <SelectTrigger className=\"w-28\" data-testid={`select-role-${u.id}`}>\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"user\">User</SelectItem>\n                      <SelectItem value=\"admin\">Admin</SelectItem>\n                    </SelectContent>\n                  </Select>\n                )}\n                {!isSuperAdmin && (\n                  <Badge variant={u.role === \"admin\" ? \"secondary\" : \"outline\"} className=\"text-xs\">\n                    {u.role || \"user\"}\n                  </Badge>\n                )}\n              </div>\n            </div>\n          </Card>\n        );\n      })}\n    </div>\n  );\n}\n\nexport default function AdminPage() {\n  const { user, isLoading: authLoading } = useAuth();\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [activeTab, setActiveTab] = useState<\"businesses\" | \"leads\" | \"users\">(\"businesses\");\n\n  const { data: adminCheck } = useQuery<{ isAdmin: boolean; isSuperAdmin: boolean }>({\n    queryKey: [\"/api/admin/check\"],\n    enabled: !!user,\n  });\n\n  const { data: businesses, isLoading } = useQuery<AdminBusiness[]>({\n    queryKey: [\"/api/admin/businesses\"],\n    enabled: !!user && adminCheck?.isAdmin === true,\n  });\n\n  const { data: monitoringStatus } = useQuery<{ enabled: boolean }>({\n    queryKey: [\"/api/admin/monitoring\"],\n    enabled: !!user && adminCheck?.isAdmin === true,\n  });\n\n  const toggleMonitoring = useMutation({\n    mutationFn: async (enabled: boolean) => {\n      const res = await apiRequest(\"POST\", \"/api/admin/monitoring\", { enabled });\n      return res.json();\n    },\n    onSuccess: (data: { enabled: boolean }) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/monitoring\"] });\n      toast({ title: data.enabled ? \"Monitoring enabled\" : \"Monitoring disabled\" });\n    },\n    onError: () => toast({ title: \"Failed to toggle monitoring\", variant: \"destructive\" }),\n  });\n\n  if (authLoading) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center\">\n        <Eye className=\"w-8 h-8 text-primary animate-pulse\" />\n      </div>\n    );\n  }\n\n  if (!user) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center\">\n        <Eye className=\"w-8 h-8 text-primary animate-pulse\" />\n      </div>\n    );\n  }\n\n  if (!adminCheck) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center\">\n        <Eye className=\"w-8 h-8 text-primary animate-pulse\" />\n      </div>\n    );\n  }\n\n  if (!adminCheck.isAdmin) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center\">\n        <Card className=\"p-8 text-center space-y-3 max-w-md\">\n          <Settings className=\"w-8 h-8 mx-auto text-muted-foreground\" />\n          <h2 className=\"text-lg font-semibold\">Admin Access Required</h2>\n          <p className=\"text-sm text-muted-foreground\">You don't have permission to view this page.</p>\n          <Button variant=\"outline\" onClick={() => setLocation(\"/dashboard\")} data-testid=\"button-back-home\">\n            <ChevronLeft className=\"w-3 h-3 mr-1\" /> Back to Dashboard\n          </Button>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <header className=\"sticky top-0 z-50 backdrop-blur-xl bg-background/80 border-b\">\n        <div className=\"max-w-5xl mx-auto px-4 sm:px-6 h-16 flex items-center justify-between gap-4\">\n          <div className=\"flex items-center gap-3\">\n            <Button variant=\"ghost\" size=\"icon\" onClick={() => setLocation(\"/dashboard\")} data-testid=\"button-admin-back\">\n              <ChevronLeft className=\"w-4 h-4\" />\n            </Button>\n            <div className=\"flex items-center gap-2\">\n              <Settings className=\"w-5 h-5 text-primary\" />\n              <span className=\"font-semibold text-lg\">Admin Panel</span>\n            </div>\n          </div>\n          <Badge variant=\"secondary\" className=\"text-xs\">\n            {businesses?.length || 0} clients\n          </Badge>\n        </div>\n      </header>\n\n      <main className=\"max-w-5xl mx-auto px-4 sm:px-6 py-6 space-y-4\">\n        <Card className=\"p-4\">\n          <div className=\"flex items-center justify-between gap-4\">\n            <div className=\"flex items-center gap-3\">\n              <Power className=\"w-5 h-5 text-primary\" />\n              <div>\n                <h3 className=\"font-medium text-sm\">Monitoring</h3>\n                <p className=\"text-xs text-muted-foreground\">\n                  {monitoringStatus?.enabled ? \"All monitors are running (Reddit, Google Alerts, bookmarklet scans)\" : \"All monitoring is paused  no new leads will be generated\"}\n                </p>\n              </div>\n            </div>\n            <Switch\n              checked={monitoringStatus?.enabled ?? false}\n              onCheckedChange={(checked) => toggleMonitoring.mutate(checked)}\n              disabled={toggleMonitoring.isPending}\n              data-testid=\"switch-monitoring-toggle\"\n            />\n          </div>\n        </Card>\n\n        <div className=\"flex items-center gap-2\">\n          <Button\n            variant={activeTab === \"businesses\" ? \"default\" : \"outline\"}\n            size=\"sm\"\n            onClick={() => setActiveTab(\"businesses\")}\n            data-testid=\"button-tab-businesses\"\n          >\n            <Users className=\"w-3 h-3 mr-1\" /> Businesses\n          </Button>\n          <Button\n            variant={activeTab === \"leads\" ? \"default\" : \"outline\"}\n            size=\"sm\"\n            onClick={() => setActiveTab(\"leads\")}\n            data-testid=\"button-tab-leads\"\n          >\n            <MessageCircle className=\"w-3 h-3 mr-1\" /> All Leads\n          </Button>\n          <Button\n            variant={activeTab === \"users\" ? \"default\" : \"outline\"}\n            size=\"sm\"\n            onClick={() => setActiveTab(\"users\")}\n            data-testid=\"button-tab-users\"\n          >\n            <UserCog className=\"w-3 h-3 mr-1\" /> Users\n          </Button>\n        </div>\n\n        {activeTab === \"businesses\" ? (\n          isLoading ? (\n            <div className=\"space-y-4\">\n              {[1, 2, 3].map((i) => (\n                <Skeleton key={i} className=\"h-24 w-full rounded-md\" />\n              ))}\n            </div>\n          ) : businesses && businesses.length > 0 ? (\n            businesses.map((biz) => (\n              <BusinessPanel key={biz.id} business={biz} onRefresh={() => queryClient.invalidateQueries({ queryKey: [\"/api/admin/businesses\"] })} />\n            ))\n          ) : (\n            <Card className=\"p-8 text-center space-y-3\">\n              <Users className=\"w-8 h-8 mx-auto text-muted-foreground\" />\n              <p className=\"text-sm text-muted-foreground\">No businesses yet.</p>\n            </Card>\n          )\n        ) : activeTab === \"leads\" ? (\n          <AllLeadsView />\n        ) : (\n          <UserManagement isSuperAdmin={adminCheck?.isSuperAdmin ?? false} />\n        )}\n      </main>\n    </div>\n  );\n}\n","path":null,"size_bytes":48653,"size_tokens":null},"server/utils/feedback.ts":{"content":"import { db } from \"../db\";\nimport { responseFeedback, aiResponses, leads, campaigns } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\nimport { SALESY_FEEDBACK_THRESHOLD } from \"./ai\";\n\nexport async function getFeedbackGuidance(businessId: number): Promise<string> {\n  try {\n    const recentFeedback = await db\n      .select({ feedback: responseFeedback.feedback })\n      .from(responseFeedback)\n      .innerJoin(aiResponses, eq(responseFeedback.responseId, aiResponses.id))\n      .innerJoin(leads, eq(aiResponses.leadId, leads.id))\n      .innerJoin(campaigns, eq(leads.campaignId, campaigns.id))\n      .where(eq(campaigns.businessId, businessId))\n      .orderBy(responseFeedback.id)\n      .limit(20);\n\n    const salesyCount = recentFeedback.filter((f) => f.feedback === \"too_salesy\").length;\n    const negCount = recentFeedback.filter((f) => f.feedback !== \"positive\").length;\n    const total = recentFeedback.length;\n\n    if (total > 0) {\n      if (salesyCount > total * SALESY_FEEDBACK_THRESHOLD) {\n        return \"\\nIMPORTANT: Previous responses were rated as too salesy. Be EXTRA subtle - barely mention the business. Focus 90% on being helpful.\";\n      } else if (negCount > total * 0.5) {\n        return \"\\nIMPORTANT: Previous responses had mixed reviews. Focus on being more genuine and less promotional.\";\n      }\n    }\n  } catch {}\n  return \"\";\n}\n","path":null,"size_bytes":1366,"size_tokens":null},"server/telegram/index.ts":{"content":"export { handlePost, extractPostUrl, stripUrls, downloadTelegramPhotoWithMime, extractTextFromImage, getAllBusinessesWithCampaigns, type PostAnalysis } from \"./analysis\";\nexport { generateScanToken, generateBookmarkletCode, generateLinkedInBookmarkletCode, getAppBaseUrl } from \"./bookmarklets\";\nexport { handleClientWizard } from \"./client-wizard\";\nexport { handleAdminCommand } from \"./admin-commands\";\nexport { handleCallbackQuery } from \"./callbacks\";\nexport { pendingContextRequests, pendingRedditPosts, clientWizards, CONTEXT_TTL, type PendingContextRequest } from \"./state\";\n","path":null,"size_bytes":582,"size_tokens":null},"server/sync-keywords.ts":{"content":"import { db } from \"./db\";\nimport { campaigns } from \"@shared/schema\";\nimport { eq, and } from \"drizzle-orm\";\n\nconst TONYS_KEYWORDS = [\n  \"breakfast spot\", \"all day breakfast\", \"24 hour restaurant\", \"late night food\",\n  \"diner\", \"pancakes\", \"family restaurant\", \"comfort food\",\n  \"where to eat breakfast\", \"brunch\", \"open late\", \"early breakfast\",\n  \"steak and eggs\", \"Brookfield\", \"western suburbs food\", \"best breakfast\",\n  \"late night diner\", \"24/7 food\", \"carry out food\", \"good diner\", \"where to eat late\",\n];\n\nconst DORO_MIND_KEYWORDS = [\n  \"schizophrenia\", \"schizoaffective\", \"psychosis\", \"hallucinations\",\n  \"voices\", \"delusions\", \"antipsychotic\", \"medication\", \"treatment options\",\n  \"psychiatrist\", \"therapist\", \"diagnosis\", \"caregiver support\",\n  \"looking for help\", \"recommendations\", \"anyone know\", \"new diagnosis\",\n  \"where to find\", \"mental health\", \"support group\", \"family member\",\n  \"loved one\", \"advice\", \"what helps\", \"coping\",\n  \"feel alone\", \"feeling alone\", \"lonely\", \"need someone to talk to\",\n  \"someone to talk\", \"overwhelmed\", \"struggling\", \"cant cope\",\n  \"need help\", \"reaching out\", \"desperate\", \"not okay\",\n  \"falling apart\", \"losing my mind\", \"universe in my head\",\n  \"cant take it\", \"breaking down\", \"feel lost\",\n  \"isolating\", \"isolation\", \"nobody understands\",\n  \"scared\", \"paranoid\", \"hearing things\", \"seeing things\", \"not real\",\n];\n\nexport async function syncKeywords() {\n  const doroFbCampaigns = await db.select().from(campaigns)\n    .where(and(eq(campaigns.businessId, 1), eq(campaigns.platform, \"Facebook\")));\n\n  for (const camp of doroFbCampaigns) {\n    const currentKeywords = (camp.keywords as string[]) || [];\n    if (currentKeywords.length < DORO_MIND_KEYWORDS.length) {\n      await db.update(campaigns)\n        .set({ keywords: DORO_MIND_KEYWORDS })\n        .where(eq(campaigns.id, camp.id));\n      console.log(`Synced keywords for campaign ${camp.id} (${camp.name}): ${currentKeywords.length}  ${DORO_MIND_KEYWORDS.length}`);\n    }\n  }\n\n  const doroRedditCampaigns = await db.select().from(campaigns)\n    .where(and(eq(campaigns.businessId, 1), eq(campaigns.platform, \"Reddit\")));\n\n  for (const camp of doroRedditCampaigns) {\n    const currentKeywords = (camp.keywords as string[]) || [];\n    if (currentKeywords.length < DORO_MIND_KEYWORDS.length) {\n      await db.update(campaigns)\n        .set({ keywords: DORO_MIND_KEYWORDS })\n        .where(eq(campaigns.id, camp.id));\n      console.log(`Synced keywords for campaign ${camp.id} (${camp.name}): ${currentKeywords.length}  ${DORO_MIND_KEYWORDS.length}`);\n    }\n  }\n\n  const tonysCampaigns = await db.select().from(campaigns)\n    .where(eq(campaigns.businessId, 5));\n\n  for (const camp of tonysCampaigns) {\n    const currentKeywords = (camp.keywords as string[]) || [];\n    const needsUpdate = currentKeywords.length !== TONYS_KEYWORDS.length ||\n      currentKeywords.some(k => k === \"Italian food\" || k === \"best pizza\" || k === \"good pasta\");\n    if (needsUpdate) {\n      await db.update(campaigns)\n        .set({ keywords: TONYS_KEYWORDS })\n        .where(eq(campaigns.id, camp.id));\n      console.log(`Synced keywords for campaign ${camp.id} (${camp.name}): ${currentKeywords.length}  ${TONYS_KEYWORDS.length}`);\n    }\n  }\n}\n","path":null,"size_bytes":3238,"size_tokens":null},"server/routes/scan.ts":{"content":"import type { Express, Request, Response, NextFunction } from \"express\";\nimport { eq } from \"drizzle-orm\";\nimport { db } from \"../db\";\nimport { businesses as businessesTable, campaigns as campaignsTable, leads as leadsTable, aiResponses as aiResponsesTable } from \"@shared/schema\";\nimport type { Business, Campaign } from \"@shared/schema\";\nimport { generateContent, parseAIJsonWithSchema, scanMatchSchema, TONE_MAP, MIN_POST_LENGTH, MIN_SCAN_INTENT_SCORE } from \"../utils/ai\";\nimport { escapeHtml } from \"../utils/html\";\nimport { getFeedbackGuidance } from \"../utils/feedback\";\nimport { keywordMatch } from \"../utils/keywords\";\nimport { createRateLimiter } from \"../utils/rate-limit\";\nimport { markOwnResponse, isOwnResponse } from \"../utils/dedup\";\nimport { validateScanToken } from \"../telegram/bookmarklets\";\nimport { sendTelegramMessageToChat } from \"../telegram\";\nimport { isMonitoringEnabled } from \"./admin\";\n\nconst scanRateLimit = createRateLimiter({\n  name: \"scan-endpoints\",\n  maxRequests: 120,\n  windowMs: 60 * 1000,\n  keyFn: (req) => String(req.body?.chatId || req.ip || \"unknown\"),\n});\n\nfunction setCorsHeaders(_req: Request, res: Response, next: NextFunction) {\n  res.setHeader(\"Access-Control-Allow-Origin\", \"*\");\n  res.setHeader(\"Access-Control-Allow-Methods\", \"POST, OPTIONS\");\n  res.setHeader(\"Access-Control-Allow-Headers\", \"Content-Type\");\n  next();\n}\n\nfunction corsOptions(_req: Request, res: Response) {\n  res.setHeader(\"Access-Control-Allow-Origin\", \"*\");\n  res.setHeader(\"Access-Control-Allow-Methods\", \"POST, OPTIONS\");\n  res.setHeader(\"Access-Control-Allow-Headers\", \"Content-Type\");\n  res.sendStatus(204);\n}\n\nasync function validateScanRequest(req: Request): Promise<\n  | { valid: true; chatId: string; businessId: number; postText: string; business: Business; bizCampaigns: Campaign[] }\n  | { valid: false; error: { matched: false; reason: string } }\n> {\n  const { chatId, businessId, token, postText } = req.body;\n\n  if (!isMonitoringEnabled()) {\n    return { valid: false, error: { matched: false, reason: \"monitoring_disabled\" } };\n  }\n\n  if (!chatId || !businessId || !postText || typeof postText !== \"string\" || !token) {\n    return { valid: false, error: { matched: false, reason: \"missing_fields\" } };\n  }\n\n  if (!validateScanToken(String(chatId), Number(businessId), token)) {\n    return { valid: false, error: { matched: false, reason: \"invalid_token\" } };\n  }\n\n  if (postText.length < MIN_POST_LENGTH) {\n    return { valid: false, error: { matched: false, reason: \"too_short\" } };\n  }\n\n  const biz = await db.select().from(businessesTable).where(eq(businessesTable.id, businessId)).limit(1);\n  if (biz.length === 0) {\n    return { valid: false, error: { matched: false, reason: \"business_not_found\" } };\n  }\n\n  const allBizCampaigns = await db.select().from(campaignsTable).where(eq(campaignsTable.businessId, businessId));\n  const bizCampaigns = allBizCampaigns.filter(c => c.status === \"active\");\n  if (bizCampaigns.length === 0) {\n    return { valid: false, error: { matched: false, reason: \"all_campaigns_paused\" } };\n  }\n  return { valid: true, chatId: String(chatId), businessId: Number(businessId), postText, business: biz[0], bizCampaigns };\n}\n\nconst TWO_WEEKS_HOURS = 14 * 24;\n\nfunction parsePostAgeHours(ageStr: string): number | null {\n  if (!ageStr || typeof ageStr !== \"string\") return null;\n  const s = ageStr.trim().toLowerCase();\n  let m = s.match(/^(\\d+)\\s*s$/);\n  if (m) return 0;\n  m = s.match(/^(\\d+)\\s*m$/);\n  if (m) return parseFloat(m[1]) / 60;\n  m = s.match(/^(\\d+)\\s*(h|hr|hrs)$/);\n  if (m) return parseFloat(m[1]);\n  m = s.match(/^(\\d+)\\s*d$/);\n  if (m) return parseFloat(m[1]) * 24;\n  m = s.match(/^(\\d+)\\s*w$/);\n  if (m) return parseFloat(m[1]) * 24 * 7;\n  m = s.match(/^(\\d+)\\s*(mo)$/);\n  if (m) return parseFloat(m[1]) * 24 * 30;\n  m = s.match(/^(\\d+)\\s*(y|yr|yrs)$/);\n  if (m) return parseFloat(m[1]) * 24 * 365;\n  if (s === \"just now\") return 0;\n  if (s === \"yesterday\") return 24;\n  m = s.match(/^(\\d+)\\s+(min|minute|mins)s?\\s+ago$/);\n  if (m) return parseFloat(m[1]) / 60;\n  m = s.match(/^(\\d+)\\s+(hour|hr|hours|hrs)\\s+ago$/);\n  if (m) return parseFloat(m[1]);\n  m = s.match(/^(\\d+)\\s+days?\\s+ago$/);\n  if (m) return parseFloat(m[1]) * 24;\n  m = s.match(/^(\\d+)\\s+weeks?\\s+ago$/);\n  if (m) return parseFloat(m[1]) * 24 * 7;\n  m = s.match(/^(\\d+)\\s+(month|months|mo)\\s+ago$/);\n  if (m) return parseFloat(m[1]) * 24 * 30;\n  m = s.match(/^(\\d+)\\s+(year|years|yr|yrs)\\s+ago$/);\n  if (m) return parseFloat(m[1]) * 24 * 365;\n\n  const months: Record<string, number> = {\n    january: 0, february: 1, march: 2, april: 3, may: 4, june: 5,\n    july: 6, august: 7, september: 8, october: 9, november: 10, december: 11,\n    jan: 0, feb: 1, mar: 2, apr: 3, jun: 5, jul: 6, aug: 7, sep: 8, oct: 9, nov: 10, dec: 11,\n  };\n  m = s.match(/^([a-z]+)\\s+(\\d{1,2})(?:,?\\s+(\\d{4}))?/);\n  if (m && months[m[1]] !== undefined) {\n    const year = m[3] ? parseInt(m[3]) : new Date().getFullYear();\n    const date = new Date(year, months[m[1]], parseInt(m[2]));\n    if (!isNaN(date.getTime())) {\n      const hours = (Date.now() - date.getTime()) / (1000 * 60 * 60);\n      return hours > 0 ? hours : null;\n    }\n  }\n  m = s.match(/^(\\d{1,2})\\/(\\d{1,2})\\/(\\d{2,4})$/);\n  if (m) {\n    const year = parseInt(m[3]) < 100 ? 2000 + parseInt(m[3]) : parseInt(m[3]);\n    const date = new Date(year, parseInt(m[1]) - 1, parseInt(m[2]));\n    if (!isNaN(date.getTime())) {\n      const hours = (Date.now() - date.getTime()) / (1000 * 60 * 60);\n      return hours > 0 ? hours : null;\n    }\n  }\n  return null;\n}\n\nasync function handleScanRequest(\n  platform: \"facebook\" | \"linkedin\",\n  business: Business,\n  bizCampaigns: Campaign[],\n  postText: string,\n  chatId: string,\n  meta: { groupName?: string; authorName?: string; pageUrl?: string; postAge?: string }\n) {\n  if (await isOwnResponse(postText)) {\n    return { matched: false, reason: \"own_response\" };\n  }\n\n  const allKeywords = bizCampaigns.flatMap(c => (c.keywords as string[]) || []);\n  if (!keywordMatch(postText, allKeywords)) {\n    return { matched: false, reason: \"no_keyword_match\" };\n  }\n\n  const platformLabel = platform === \"facebook\" ? \"Facebook\" : \"LinkedIn\";\n  const contextLabel = platform === \"facebook\"\n    ? `post from \"${meta.groupName || \"a Facebook group\"}\"`\n    : `post by \"${meta.authorName || \"someone\"}\"`;\n\n  const matchResult = await generateContent({\n    model: \"gemini-2.5-flash\",\n    contents: `You are a lead scout for \"${business.name}\" (${business.type}).\nThey offer: ${business.coreOffering}\n\nAnalyze this ${platformLabel} ${contextLabel}:\n\"${postText.slice(0, 500)}\"\n\nIs this person asking a question or seeking help/recommendations that \"${business.name}\" could address?\n\nSCORING GUIDE (be strict and spread scores across the full range):\n1-2: Completely unrelated topic, no connection to business\n3-4: Loosely related topic but NOT asking for help or recommendations\n5-6: Related topic, asking a question, but not specifically looking for what this business offers\n7-8: Clearly seeking help/recommendations in this business's area\n9-10: Actively looking for EXACTLY what this business offers, urgent need, ready to buy/act\n\nIMPORTANT: Return ONLY a single JSON object with no other text, no explanation, no markdown:\n{\"is_lead\": true, \"intent_score\": 5, \"reasoning\": \"one sentence explanation\"}`,\n    config: { maxOutputTokens: 512, thinkingConfig: { thinkingBudget: 0 } },\n  });\n\n  const match = parseAIJsonWithSchema(matchResult.text, scanMatchSchema);\n  if (!match) {\n    console.error(`${platform} scan: AI parse/validation error for \"${business.name}\"`);\n    return { matched: false, reason: \"ai_parse_error\" };\n  }\n\n  if (!match.is_lead || match.intent_score < MIN_SCAN_INTENT_SCORE) {\n    return { matched: false, reason: \"low_intent\", score: match.intent_score };\n  }\n\n  const feedbackGuidance = await getFeedbackGuidance(business.id);\n  const toneDesc = platform === \"linkedin\" ? \"professional and helpful\" : \"friendly and helpful\";\n  const responseStyle = platform === \"linkedin\"\n    ? \"a natural, professional LinkedIn comment (2-3 sentences). Sound like a real professional sharing knowledge or a recommendation. Keep it conversational but polished for LinkedIn.\"\n    : \"a natural, human-sounding comment (2-3 sentences). Do NOT make it sound like an ad. Sound like a real person sharing a helpful recommendation.\";\n\n  const responseResult = await generateContent({\n    model: \"gemini-2.5-pro\",\n    contents: `You are writing a ${platformLabel} comment${platform === \"facebook\" ? \" in a community group\" : \" on a professional post\"}. Your goal is to be genuinely helpful while subtly recommending a business.\n\nThe ${contextLabel}: \"${postText.slice(0, 500)}\"\n\nBusiness to recommend: ${business.name}\nWhat they do: ${business.coreOffering}\nTone: ${TONE_MAP[business.preferredTone] || toneDesc}\n${feedbackGuidance}\n\nWrite ${responseStyle} Include the business name naturally.\n\nReturn ONLY the response text, no quotes or formatting.`,\n    config: { maxOutputTokens: 8192 },\n  });\n\n  const responseText = responseResult.text.trim();\n  if (!responseText) {\n    return { matched: true, score: match.intent_score, reason: \"no_response_generated\" };\n  }\n\n  await markOwnResponse(responseText);\n\n  let savedResponseId: number | null = null;\n  const targetCampaign = platform === \"linkedin\"\n    ? (bizCampaigns.find(c => c.platform === \"LinkedIn\") || bizCampaigns[0])\n    : bizCampaigns[0];\n\n  if (targetCampaign) {\n    try {\n      const [savedLead] = await db.insert(leadsTable).values({\n        campaignId: targetCampaign.id,\n        platform,\n        groupName: meta.groupName || `${platformLabel} ${platform === \"linkedin\" ? \"Feed\" : \"Group\"}`,\n        authorName: meta.authorName || `${platformLabel} user`,\n        originalPost: postText.slice(0, 2000),\n        postUrl: meta.pageUrl || null,\n        intentScore: match.intent_score,\n        status: \"matched\",\n      }).returning();\n\n      if (savedLead) {\n        const [savedResponse] = await db.insert(aiResponsesTable).values({\n          leadId: savedLead.id,\n          content: responseText,\n          status: \"pending\",\n        }).returning();\n        savedResponseId = savedResponse?.id || null;\n      }\n    } catch (err) {\n      console.error(`Error saving ${platformLabel} scan lead:`, err);\n    }\n  }\n\n  const postAgeHours = parsePostAgeHours(meta.postAge || \"\");\n  const isTooOld = postAgeHours !== null && postAgeHours > TWO_WEEKS_HOURS;\n\n  if (isTooOld) {\n    console.log(`${platform} scan: lead saved but skipping Telegram (post age: ${meta.postAge})`);\n    return { matched: true, score: match.intent_score, notified: false, reason: \"post_too_old\" };\n  }\n\n  const scoreBar = \"*\".repeat(match.intent_score) + \"_\".repeat(10 - match.intent_score);\n  let msg = `<b>${platformLabel} Lead Found</b>\\n\\n`;\n  msg += `<b>Business:</b> ${escapeHtml(business.name)}\\n`;\n  if (platform === \"facebook\") {\n    msg += `<b>Group:</b> ${escapeHtml(meta.groupName || \"Facebook Group\")}\\n`;\n  } else {\n    msg += `<b>Author:</b> ${escapeHtml(meta.authorName || \"LinkedIn user\")}\\n`;\n  }\n  msg += `<b>Intent:</b> ${scoreBar} ${match.intent_score}/10\\n`;\n  if (meta.postAge) {\n    const ageText = meta.postAge.trim().toLowerCase();\n    const needsAgo = !ageText.includes(\"ago\") && ageText !== \"just now\" && ageText !== \"yesterday\";\n    msg += `<b>Posted:</b> ${escapeHtml(meta.postAge)}${needsAgo ? \" ago\" : \"\"}\\n`;\n  }\n  msg += `<b>Why:</b> ${escapeHtml(match.reasoning || \"\")}\\n\\n`;\n  msg += `<b>Post:</b>\\n<i>\"${escapeHtml(postText.slice(0, 200))}\"</i>`;\n\n  if (meta.pageUrl) {\n    msg += `\\n\\nTap \"Open ${platformLabel} Post\" below, then paste the reply.`;\n  }\n\n  const prefix = platform === \"facebook\" ? \"fb\" : \"li\";\n  const buttons: Array<Array<{ text: string; url?: string; callback_data?: string }>> = [];\n  if (meta.pageUrl) {\n    buttons.push([{ text: `Open ${platformLabel} Post`, url: meta.pageUrl }]);\n  }\n  if (savedResponseId) {\n    buttons.push([\n      { text: \"Used It\", callback_data: `${prefix}_good_${savedResponseId}` },\n      { text: \"Bad Match\", callback_data: `${prefix}_bad_${savedResponseId}` },\n      { text: \"Too Salesy\", callback_data: `${prefix}_salesy_${savedResponseId}` },\n      { text: \"Wrong Client\", callback_data: `${prefix}_wrong_${savedResponseId}` },\n    ]);\n  }\n\n  await sendTelegramMessageToChat(chatId, msg, buttons.length > 0 ? { buttons } : undefined);\n  await sendTelegramMessageToChat(chatId, responseText);\n\n  return { matched: true, score: match.intent_score, notified: true };\n}\n\nexport function registerScanRoutes(app: Express) {\n  app.options(\"/api/fb-scan\", corsOptions);\n  app.options(\"/api/li-scan\", corsOptions);\n\n  app.post(\"/api/fb-scan\", scanRateLimit, setCorsHeaders, async (req, res) => {\n    try {\n      const validation = await validateScanRequest(req);\n      if (!validation.valid) { res.json(validation.error); return; }\n\n      const { chatId, postText, business, bizCampaigns } = validation;\n      const { groupName, pageUrl, postAge } = req.body;\n      const result = await handleScanRequest(\"facebook\", business, bizCampaigns, postText, chatId, { groupName, pageUrl, postAge });\n      res.json(result);\n    } catch (error) {\n      console.error(\"FB scan error:\", error);\n      res.json({ matched: false, reason: \"server_error\" });\n    }\n  });\n\n  app.post(\"/api/li-scan\", scanRateLimit, setCorsHeaders, async (req, res) => {\n    try {\n      const validation = await validateScanRequest(req);\n      if (!validation.valid) { res.json(validation.error); return; }\n\n      const { chatId, postText, business, bizCampaigns } = validation;\n      const { authorName, pageUrl } = req.body;\n      const result = await handleScanRequest(\"linkedin\", business, bizCampaigns, postText, chatId, { authorName, pageUrl });\n      res.json(result);\n    } catch (error) {\n      console.error(\"LinkedIn scan error:\", error);\n      res.json({ matched: false, reason: \"server_error\" });\n    }\n  });\n}\n","path":null,"size_bytes":13919,"size_tokens":null},"server/telegram/bookmarklets.ts":{"content":"import crypto from \"crypto\";\n\nconst TOKEN_WINDOW_MS = 30 * 24 * 60 * 60 * 1000;\n\nfunction getCurrentWindow(): number {\n  return Math.floor(Date.now() / TOKEN_WINDOW_MS);\n}\n\nexport function generateScanToken(chatId: string, businessId: number): string {\n  const secret = process.env.SESSION_SECRET;\n  if (!secret) throw new Error(\"SESSION_SECRET environment variable is required for token generation\");\n  const window = getCurrentWindow();\n  return crypto.createHmac(\"sha256\", secret).update(`${chatId}:${businessId}:${window}`).digest(\"hex\").slice(0, 32);\n}\n\nexport function validateScanToken(chatId: string, businessId: number, token: string): boolean {\n  const secret = process.env.SESSION_SECRET;\n  if (!secret) return false;\n  const currentWindow = getCurrentWindow();\n  for (const w of [currentWindow, currentWindow - 1]) {\n    const expected = crypto.createHmac(\"sha256\", secret).update(`${chatId}:${businessId}:${w}`).digest(\"hex\").slice(0, 32);\n    if (token === expected) return true;\n  }\n  return false;\n}\n\nconst CONNECT_WINDOW_MS = 7 * 24 * 60 * 60 * 1000;\n\nfunction getConnectWindow(): number {\n  return Math.floor(Date.now() / CONNECT_WINDOW_MS);\n}\n\nexport function generateConnectToken(businessId: number, userId: string): string {\n  const secret = process.env.SESSION_SECRET;\n  if (!secret) throw new Error(\"SESSION_SECRET required\");\n  const w = getConnectWindow();\n  return crypto.createHmac(\"sha256\", secret).update(`connect:${businessId}:${userId}:${w}`).digest(\"hex\").slice(0, 16);\n}\n\nexport function validateConnectTokenForOwner(businessId: number, ownerUserId: string, token: string): boolean {\n  const secret = process.env.SESSION_SECRET;\n  if (!secret) return false;\n  const cw = getConnectWindow();\n  for (const w of [cw, cw - 1]) {\n    const expected = crypto.createHmac(\"sha256\", secret).update(`connect:${businessId}:${ownerUserId}:${w}`).digest(\"hex\").slice(0, 16);\n    if (token === expected) return true;\n  }\n  return false;\n}\n\nfunction buildRelaySetup(baseUrlVar: string, apiVar: string): string {\n  return `var relayId='ge_'+Math.random().toString(36).slice(2,8);` +\n    `var relayUrl=${baseUrlVar}+'/relay.html';` +\n    `var relay=window.open(relayUrl,relayId,'width=300,height=120,top=50,right=50');` +\n    `if(!relay||relay.closed){alert('Please allow popups for this page, then try again.');window.__geminEyeActive=false;window.__geminEyeLiActive=false;return}` +\n    `var msgCounter=0;var pendingCallbacks={};` +\n    `window.addEventListener('message',function(ev){if(!ev.data||ev.data.type!=='gemin-eye-result')return;var cb=pendingCallbacks[ev.data.msgId];if(cb){delete pendingCallbacks[ev.data.msgId];cb(ev.data.data)}});` +\n    `function sendToApi(payload,onSuccess,onFail){` +\n      `var id='m'+(++msgCounter);` +\n      `pendingCallbacks[id]=function(d){onSuccess(d)};` +\n      `setTimeout(function(){if(pendingCallbacks[id]){delete pendingCallbacks[id];onFail('timeout')}},30000);` +\n      `try{relay.postMessage({type:'gemin-eye-scan',apiUrl:${apiVar},payload:payload,msgId:id},'*')}catch(e){delete pendingCallbacks[id];onFail('relay_closed')}` +\n    `}`;\n}\n\nexport function generateLinkedInBookmarkletCode(baseUrl: string, chatId: string, businessId: number, token: string): string {\n  const apiUrl = `${baseUrl}/api/li-scan`;\n  const relaySetup = buildRelaySetup('BASE', 'API');\n  const code = `javascript:void((function(){` +\n    `if(window.__geminEyeLiActive){alert('Gemin-Eye is already scanning this page. Click X on the banner to stop first.');return}` +\n    `window.__geminEyeLiActive=true;` +\n    `var CID='${chatId}',BID=${businessId},TOK='${token}',API='${apiUrl}',BASE='${baseUrl}';` +\n    `var seenPosts={},scannedCount=0,sentCount=0,pendingCount=0,failCount=0,autoScrolling=true,scrollsDone=0,maxScrolls=150,noNewCount=0;` +\n    `${relaySetup}` +\n    `var banner=document.createElement('div');banner.id='gemin-eye-li-banner';` +\n    `banner.style.cssText='position:fixed;top:0;left:0;width:100%;background:linear-gradient(135deg,#0077B5,#00A0DC);color:white;padding:10px 20px;z-index:2147483647;font-family:system-ui,sans-serif;font-size:14px;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.2);display:flex;align-items:center;justify-content:center;gap:10px;';` +\n    `var counter=document.createElement('span');counter.style.cssText='font-weight:normal;opacity:0.85;font-size:13px;';counter.textContent='0 scanned';` +\n    `function updateCounter(){var t=scannedCount+' scanned, '+sentCount+' leads';if(failCount>0)t+=', '+failCount+' failed';if(pendingCount>0)t+=' ('+pendingCount+' checking...)';if(!autoScrolling&&scrollsDone>=maxScrolls)t+=' - Done';counter.textContent=t}` +\n    `var pauseBtn=document.createElement('span');pauseBtn.textContent='Pause';` +\n    `pauseBtn.style.cssText='cursor:pointer;background:rgba(255,255,255,0.25);padding:4px 14px;border-radius:4px;font-size:12px;font-weight:700;';` +\n    `pauseBtn.onclick=function(){autoScrolling=!autoScrolling;pauseBtn.textContent=autoScrolling?'Pause':'Resume'};` +\n    `var closeBtn=document.createElement('span');closeBtn.textContent='[X] Close';` +\n    `closeBtn.style.cssText='cursor:pointer;background:rgba(255,0,0,0.35);padding:4px 12px;border-radius:4px;font-size:12px;font-weight:700;margin-left:4px;';` +\n    `closeBtn.onclick=function(){banner.remove();window.__geminEyeLiActive=false;autoScrolling=false;clearInterval(si);clearInterval(scrollInterval);try{relay.close()}catch(e){}};` +\n    `banner.appendChild(document.createTextNode('Gemin-Eye LinkedIn '));banner.appendChild(counter);banner.appendChild(pauseBtn);banner.appendChild(closeBtn);` +\n    `document.body.appendChild(banner);` +\n    `function extractPosts(){var found=[];var els=document.querySelectorAll('.feed-shared-update-v2__description,.feed-shared-inline-show-more-text,.feed-shared-text,.update-components-text,span.break-words');` +\n    `els.forEach(function(el){var t=(el.innerText||'').trim();if(t.length<25||t.length>5000||seenPosts[t])return;found.push({text:t,element:el})});return found}` +\n    `function sendPost(text,el){seenPosts[text]=true;scannedCount++;pendingCount++;updateCounter();` +\n    `var authorName='';try{var card=el.closest('.feed-shared-update-v2');if(card){var nameEl=card.querySelector('.update-components-actor__name span[aria-hidden],.feed-shared-actor__name span');if(nameEl)authorName=nameEl.innerText||''}}catch(e){}` +\n    `var payload={chatId:CID,businessId:BID,token:TOK,postText:text,authorName:authorName||'LinkedIn user',pageUrl:window.location.href};` +\n    `sendToApi(payload,function(d){pendingCount--;if(d.matched){sentCount++;el.style.outline='3px solid #0077B5';el.style.outlineOffset='4px';el.style.borderRadius='4px'}updateCounter()},function(reason){pendingCount--;failCount++;updateCounter()})}` +\n    `function scan(){if(document.hidden)return;var posts=extractPosts();if(posts.length===0)noNewCount++;else noNewCount=0;posts.forEach(function(p){if(scannedCount>=500)return;sendPost(p.text,p.element)});if(scannedCount>=500){autoScrolling=false;updateCounter()}}` +\n    `document.addEventListener('visibilitychange',function(){if(!document.hidden){noNewCount=0;if(scrollsDone<maxScrolls&&scannedCount<500){autoScrolling=true;pauseBtn.textContent='Pause'}}});` +\n    `scan();var si=setInterval(scan,2000);` +\n    `var scrollInterval=setInterval(function(){if(!autoScrolling||document.hidden)return;scrollsDone++;if(scrollsDone>=maxScrolls){autoScrolling=false;updateCounter();return}window.scrollBy({top:600,behavior:'smooth'})},1500)` +\n    `})())`;\n  return code;\n}\n\nexport function generateBookmarkletCode(baseUrl: string, chatId: string, businessId: number, token: string): string {\n  const apiUrl = `${baseUrl}/api/fb-scan`;\n  const relaySetup = buildRelaySetup('BASE', 'API');\n  const code = `javascript:void((function(){` +\n    `if(window.__geminEyeActive){alert('Gemin-Eye is already scanning this page. Click X on the banner to stop first.');return}` +\n    `window.__geminEyeActive=true;` +\n    `var CID='${chatId}',BID=${businessId},TOK='${token}',API='${apiUrl}',BASE='${baseUrl}';` +\n    `var seenPosts={},scannedCount=0,sentCount=0,pendingCount=0,failCount=0,autoScrolling=true,scrollsDone=0,maxScrolls=150,noNewCount=0;` +\n    `${relaySetup}` +\n    `var banner=document.createElement('div');banner.id='gemin-eye-banner';` +\n    `banner.style.cssText='position:fixed;top:0;left:0;width:100%;background:linear-gradient(135deg,#4338ca,#6d28d9);color:white;padding:10px 20px;z-index:2147483647;font-family:system-ui,sans-serif;font-size:14px;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.2);display:flex;align-items:center;justify-content:center;gap:10px;';` +\n    `var counter=document.createElement('span');counter.style.cssText='font-weight:normal;opacity:0.85;font-size:13px;';counter.textContent='0 scanned';` +\n    `function updateCounter(){var t=scannedCount+' scanned, '+sentCount+' leads';if(failCount>0)t+=', '+failCount+' failed';if(pendingCount>0)t+=' ('+pendingCount+' checking...)';if(!autoScrolling&&scrollsDone>=maxScrolls)t+=' - Done';counter.textContent=t}` +\n    `var pauseBtn=document.createElement('span');pauseBtn.textContent='Pause';` +\n    `pauseBtn.style.cssText='cursor:pointer;background:rgba(255,255,255,0.25);padding:4px 14px;border-radius:4px;font-size:12px;font-weight:700;';` +\n    `pauseBtn.onclick=function(){autoScrolling=!autoScrolling;pauseBtn.textContent=autoScrolling?'Pause':'Resume'};` +\n    `var closeBtn=document.createElement('span');closeBtn.textContent='[X] Close';` +\n    `closeBtn.style.cssText='cursor:pointer;background:rgba(255,0,0,0.35);padding:4px 12px;border-radius:4px;font-size:12px;font-weight:700;margin-left:4px;';` +\n    `closeBtn.onclick=function(){banner.remove();window.__geminEyeActive=false;autoScrolling=false;clearInterval(si);clearInterval(scrollInterval);try{relay.close()}catch(e){}};` +\n    `banner.appendChild(document.createTextNode('Gemin-Eye '));banner.appendChild(counter);banner.appendChild(pauseBtn);banner.appendChild(closeBtn);` +\n    `document.body.appendChild(banner);` +\n    `function extractPosts(){var found=[];var els=document.querySelectorAll('div[dir=\"auto\"]');` +\n    `els.forEach(function(el){var t=(el.innerText||'').trim();if(t.length<25||t.length>5000||seenPosts[t])return;var a=el.closest('a');if(a&&a.href&&a.href.indexOf('/comment')===-1)return;found.push({text:t,element:el})});return found}` +\n    `function getPostAge(el){try{var container=el.closest('[role=\"article\"]')||el.closest('.x1yztbdb');if(!container)container=el.parentElement;var rp=/^\\\\d+[smhdwy]$/,rl=/^(just now|yesterday|\\\\d+\\\\s+(min|minute|hour|hr|day|week|month|mo|year|yr)s?\\\\s+ago)$/i,rd=/^[A-Z][a-z]+\\\\s+\\\\d{1,2}(,?\\\\s+\\\\d{4})?/,rn=/^\\\\d{1,2}\\\\/\\\\d{1,2}\\\\/\\\\d{2,4}$/;function isTs(t){t=t.trim();return rp.test(t)||rl.test(t)||rd.test(t)||rn.test(t)}for(var i=0;i<6&&container;i++){var links=container.querySelectorAll('a[href*=\"/posts/\"],a[href*=\"/permalink/\"],a[href*=\"comment_id\"],a[role=\"link\"]');for(var j=0;j<links.length;j++){var lt=(links[j].innerText||'').trim();if(isTs(lt))return lt;var al=links[j].getAttribute('aria-label')||'';if(isTs(al))return al.trim()}var els2=container.querySelectorAll('abbr,time,span[id]');for(var k=0;k<els2.length;k++){var at=(els2[k].innerText||'').trim();if(isTs(at))return at;var ti=els2[k].getAttribute('title')||'';if(isTs(ti))return ti.trim();var dt=els2[k].getAttribute('datetime')||'';if(dt){try{var dd=new Date(dt);if(!isNaN(dd.getTime())){var diff=Date.now()-dd.getTime();var hrs=Math.floor(diff/3600000);if(hrs<1)return'just now';if(hrs<24)return hrs+'h';var days=Math.floor(hrs/24);if(days<7)return days+'d';var wks=Math.floor(days/7);if(wks<5)return wks+'w';return Math.floor(days/30)+'mo'}}catch(e){}}}container=container.parentElement}}catch(e){}return''}` +\n    `function sendPost(text,el){seenPosts[text]=true;scannedCount++;pendingCount++;updateCounter();` +\n    `var postAge=getPostAge(el);` +\n    `var groupName='';var h1=document.querySelector('h1');if(h1)groupName=h1.innerText||'';if(!groupName){var titleEl=document.querySelector('[role=\"banner\"] a[href*=\"/groups/\"]');if(titleEl)groupName=titleEl.innerText||''}` +\n    `var payload={chatId:CID,businessId:BID,token:TOK,postText:text,postAge:postAge,groupName:groupName||document.title||'Facebook Group',pageUrl:window.location.href};` +\n    `sendToApi(payload,function(d){pendingCount--;if(d.matched){if(d.reason==='post_too_old'){el.style.outline='2px dashed #999';el.style.outlineOffset='4px';el.style.borderRadius='4px'}else{sentCount++;el.style.outline='3px solid #6d28d9';el.style.outlineOffset='4px';el.style.borderRadius='4px'}}updateCounter()},function(reason){pendingCount--;failCount++;updateCounter()})}` +\n    `function scan(){if(document.hidden)return;var posts=extractPosts();if(posts.length===0)noNewCount++;else noNewCount=0;posts.forEach(function(p){if(scannedCount>=500)return;sendPost(p.text,p.element)});if(scannedCount>=500){autoScrolling=false;updateCounter()}}` +\n    `document.addEventListener('visibilitychange',function(){if(!document.hidden){noNewCount=0;if(scrollsDone<maxScrolls&&scannedCount<500){autoScrolling=true;pauseBtn.textContent='Pause'}}});` +\n    `scan();var si=setInterval(scan,2000);` +\n    `var scrollInterval=setInterval(function(){if(!autoScrolling||document.hidden)return;scrollsDone++;if(scrollsDone>=maxScrolls){autoScrolling=false;updateCounter();return}window.scrollBy({top:600,behavior:'smooth'})},1500)` +\n    `})())`;\n  return code;\n}\n\nexport function getAppBaseUrl(): string {\n  return \"https://gemin-eye.com\";\n}\n","path":null,"size_bytes":13520,"size_tokens":null},"server/utils/dedup.ts":{"content":"import { db } from \"../db\";\nimport { seenItems } from \"@shared/schema\";\nimport { eq, inArray } from \"drizzle-orm\";\n\nexport async function hasBeenSeen(dedupKey: string): Promise<boolean> {\n  const existing = await db.select({ id: seenItems.id }).from(seenItems).where(eq(seenItems.dedupKey, dedupKey)).limit(1);\n  return existing.length > 0;\n}\n\nexport async function markSeen(dedupKey: string, source: string): Promise<void> {\n  try {\n    await db.insert(seenItems).values({ dedupKey, source }).onConflictDoNothing();\n  } catch {}\n}\n\nfunction normalize(text: string): string {\n  return text.toLowerCase().replace(/[^a-z0-9 ]/g, \"\").replace(/\\s+/g, \" \").trim();\n}\n\nfunction extractChunks(text: string, chunkLen: number = 40): string[] {\n  const norm = normalize(text);\n  const words = norm.split(\" \");\n  const chunks: string[] = [];\n  for (let i = 0; i <= words.length - 5; i += 3) {\n    chunks.push(words.slice(i, i + 5).join(\" \"));\n  }\n  if (norm.length >= chunkLen) {\n    chunks.push(norm.slice(0, chunkLen));\n    chunks.push(norm.slice(-chunkLen));\n  }\n  return chunks;\n}\n\nconst RESPONSE_FINGERPRINT_SOURCE = \"own_response\";\n\nexport async function markOwnResponse(responseText: string): Promise<void> {\n  const chunks = extractChunks(responseText);\n  for (const chunk of chunks) {\n    const key = `resp:${chunk}`;\n    try {\n      await db.insert(seenItems).values({ dedupKey: key, source: RESPONSE_FINGERPRINT_SOURCE }).onConflictDoNothing();\n    } catch {}\n  }\n}\n\nexport async function isOwnResponse(postText: string): Promise<boolean> {\n  const chunks = extractChunks(postText);\n  if (chunks.length === 0) return false;\n\n  const keys = chunks.map(c => `resp:${c}`);\n  try {\n    const matches = await db\n      .select({ id: seenItems.id })\n      .from(seenItems)\n      .where(inArray(seenItems.dedupKey, keys));\n    return matches.length >= 2;\n  } catch {\n    return false;\n  }\n}\n","path":null,"size_bytes":1883,"size_tokens":null},"server/utils/keywords.ts":{"content":"const STOP_WORDS = new Set([\n  \"a\", \"an\", \"the\", \"is\", \"are\", \"was\", \"were\", \"be\", \"been\", \"being\",\n  \"do\", \"does\", \"did\", \"have\", \"has\", \"had\", \"will\", \"would\", \"could\",\n  \"should\", \"may\", \"might\", \"shall\", \"can\", \"need\", \"dare\", \"ought\",\n  \"to\", \"of\", \"in\", \"for\", \"on\", \"with\", \"at\", \"by\", \"from\", \"as\",\n  \"into\", \"through\", \"during\", \"before\", \"after\", \"above\", \"below\",\n  \"between\", \"out\", \"off\", \"over\", \"under\", \"again\", \"further\", \"then\",\n  \"once\", \"and\", \"but\", \"or\", \"nor\", \"not\", \"so\", \"yet\", \"both\",\n  \"each\", \"few\", \"more\", \"most\", \"other\", \"some\", \"such\", \"no\",\n  \"only\", \"own\", \"same\", \"than\", \"too\", \"very\", \"just\", \"about\",\n  \"up\", \"it\", \"its\", \"i\", \"me\", \"my\", \"we\", \"our\", \"you\", \"your\",\n  \"he\", \"him\", \"his\", \"she\", \"her\", \"they\", \"them\", \"their\", \"this\",\n  \"that\", \"these\", \"those\", \"what\", \"which\", \"who\", \"whom\", \"how\",\n  \"all\", \"any\", \"if\", \"because\", \"when\", \"where\", \"while\",\n]);\n\nfunction getSignificantWords(phrase: string): string[] {\n  return phrase\n    .toLowerCase()\n    .split(/\\s+/)\n    .filter(w => w.length > 1 && !STOP_WORDS.has(w));\n}\n\nexport function keywordMatch(text: string, keywords: string[]): boolean {\n  if (keywords.length === 0) return false;\n  const lower = text.toLowerCase();\n\n  for (const kw of keywords) {\n    const kwLower = kw.toLowerCase().trim();\n    if (!kwLower) continue;\n\n    if (lower.includes(kwLower)) return true;\n\n    const significantWords = getSignificantWords(kwLower);\n    if (significantWords.length >= 2) {\n      const allPresent = significantWords.every(w => lower.includes(w));\n      if (allPresent) return true;\n    }\n  }\n\n  return false;\n}\n","path":null,"size_bytes":1616,"size_tokens":null},"server/telegram/client-wizard.ts":{"content":"import { sendTelegramMessage, sendTelegramMessageToChat } from \"../telegram\";\nimport { storage } from \"../storage\";\nimport { generateContent, safeParseJsonFromAI } from \"../utils/ai\";\nimport { escapeHtml } from \"../utils/html\";\nimport { clientWizards, type ClientWizardState } from \"./state\";\n\nexport async function handleClientWizard(chatId: string, text: string): Promise<boolean> {\n  const wizard = clientWizards.get(chatId);\n  if (!wizard) return false;\n\n  if (text.startsWith(\"/\")) {\n    clientWizards.delete(chatId);\n    return false;\n  }\n\n  wizard.timestamp = Date.now();\n\n  switch (wizard.step) {\n    case \"name\": {\n      const name = text.trim();\n      if (name.length < 2 || name.length > 100) {\n        await sendTelegramMessageToChat(chatId, \"Please enter a valid business name (2-100 characters).\");\n        return true;\n      }\n      wizard.name = name;\n      wizard.step = \"offering\";\n      await sendTelegramMessageToChat(chatId,\n        `Got it: <b>${escapeHtml(wizard.name)}</b>\\n\\nIn one sentence, what does ${escapeHtml(wizard.name)} do or sell?\\n<i>(e.g., \"Classic American diner with all-day breakfast and comfort food\")</i>`\n      );\n      return true;\n    }\n\n    case \"offering\": {\n      const offering = text.trim();\n      if (offering.length < 5) {\n        await sendTelegramMessageToChat(chatId, \"Please describe what the business does in at least a few words.\");\n        return true;\n      }\n      wizard.offering = offering;\n      wizard.step = \"contact\";\n      await sendTelegramMessageToChat(chatId,\n        `Got it.\\n\\nNow I need your contact info. Please send your <b>email</b>, <b>phone</b>, and <b>website</b> (one per line):\\n\\n<i>Example:\\njoe@mybusiness.com\\n(312) 555-1234\\nhttps://mybusiness.com</i>\\n\\n(If no website, just send email and phone on two lines)`\n      );\n      return true;\n    }\n\n    case \"contact\": {\n      const lines = text.split(\"\\n\").map(l => l.trim()).filter(l => l.length > 0);\n      if (lines.length < 2) {\n        await sendTelegramMessageToChat(chatId, \"Please send at least your email and phone number, one per line.\");\n        return true;\n      }\n      const emailLine = lines.find(l => l.includes(\"@\")) || lines[0];\n      const phoneLine = lines.find(l => /[\\d\\(\\)\\-\\+]/.test(l) && !l.includes(\"@\") && !l.includes(\".com\") && !l.includes(\"http\")) || lines[1];\n      const websiteLine = lines.find(l => l.includes(\".\") && !l.includes(\"@\") && l !== phoneLine) || \"\";\n\n      wizard.contactEmail = emailLine;\n      wizard.contactPhone = phoneLine;\n      wizard.website = websiteLine;\n      wizard.step = \"location\";\n      await sendTelegramMessageToChat(chatId,\n        `Got it.\\n\\nWhat's the reach of ${escapeHtml(wizard.name!)}? This helps me find the right communities to monitor.\\n<i>(e.g., \"Chicago IL\", \"National\", \"Global / web-based\")</i>`\n      );\n      return true;\n    }\n\n    case \"location\": {\n      const location = text.trim();\n      if (location.length < 2) {\n        await sendTelegramMessageToChat(chatId, \"Please enter a location (city/state, or 'online' if not location-specific).\");\n        return true;\n      }\n      wizard.location = location;\n      wizard.step = \"keywords\";\n      await sendTelegramMessageToChat(chatId,\n        `Perfect.\\n\\nNow give me 3-5 keywords to watch for, separated by commas.\\n<i>(e.g., estate planning, trust attorney, wills and trusts, probate lawyer)</i>`\n      );\n      return true;\n    }\n\n    case \"keywords\": {\n      wizard.keywords = text.split(\",\").map(k => k.trim()).filter(k => k.length > 0);\n      if (wizard.keywords.length < 1) {\n        await sendTelegramMessageToChat(chatId, \"Please enter at least one keyword, separated by commas.\");\n        return true;\n      }\n\n      await sendTelegramMessageToChat(chatId, `Got it! Setting up your monitor now...`);\n\n      const locationInfo = wizard.location || \"Online\";\n      const biz = await storage.createBusiness({\n        userId: `tg-${chatId}`,\n        telegramChatId: chatId,\n        name: wizard.name!,\n        type: wizard.offering || wizard.name!,\n        contactEmail: wizard.contactEmail || null,\n        contactPhone: wizard.contactPhone || null,\n        website: wizard.website || null,\n        targetAudience: locationInfo,\n        coreOffering: wizard.offering || wizard.name!,\n        preferredTone: \"casual\",\n      });\n\n      let redditSubs: string[] = [];\n      try {\n        const groupResult = await generateContent({\n          model: \"gemini-2.5-flash\",\n          contents: `A business needs REAL Reddit subreddits to monitor for customer leads.\n\nBusiness: ${wizard.name}\nOffering: ${wizard.offering}\nLocation: ${locationInfo}\nKeywords: ${wizard.keywords.join(\", \")}\n\nReturn ONLY valid JSON: {\"subreddits\": [\"r/example1\", \"r/example2\"]}\n\nRULES:\n- List 5-8 REAL Reddit subreddits that actually exist.\n- NEVER use placeholders like \"r/[yourcity]\". Use specific real names.\n- If the business has a specific local area, include the local city/region subreddit (e.g., r/chicago, r/austin, r/nyc).\n- If the business is national or global/web-based, focus on industry and topic subreddits instead of geographic ones.\n- Focus on communities where people ask for recommendations related to this business.`,\n          config: { maxOutputTokens: 256 },\n        });\n        const groupJson = safeParseJsonFromAI(groupResult.text);\n        if (groupJson?.subreddits?.length > 0) {\n          redditSubs = groupJson.subreddits;\n        }\n      } catch (e) {\n        console.error(\"Client wizard AI group gen failed:\", e);\n      }\n      if (redditSubs.length === 0) {\n        redditSubs = [\"r/smallbusiness\", \"r/Entrepreneur\"];\n      }\n\n      await storage.createCampaign({\n        businessId: biz.id,\n        name: `${wizard.name} - Facebook`,\n        platform: \"Facebook\",\n        status: \"active\",\n        strategy: `Monitor Facebook groups for leads matching ${wizard.name}`,\n        targetGroups: [],\n        keywords: wizard.keywords,\n      });\n\n      await storage.createCampaign({\n        businessId: biz.id,\n        name: `${wizard.name} - LinkedIn`,\n        platform: \"LinkedIn\",\n        status: \"active\",\n        strategy: `Monitor LinkedIn feed for leads matching ${wizard.name}`,\n        targetGroups: [],\n        keywords: wizard.keywords,\n      });\n\n      await storage.createCampaign({\n        businessId: biz.id,\n        name: `${wizard.name} - Reddit`,\n        platform: \"Reddit\",\n        status: \"active\",\n        strategy: `Monitor Reddit communities for leads matching ${wizard.name}`,\n        targetGroups: redditSubs,\n        keywords: wizard.keywords,\n      });\n\n      clientWizards.delete(chatId);\n\n      await sendTelegramMessageToChat(chatId,\n        `<b>Setup Complete!</b>\\n\\n` +\n        `<b>Location:</b> ${escapeHtml(locationInfo)}\\n` +\n        `I am now watching for: <b>${wizard.keywords.map(k => escapeHtml(k)).join(\", \")}</b>\\n\\n` +\n        `<b>Reddit Monitoring:</b> ${redditSubs.map(s => escapeHtml(s)).join(\", \")}`,\n        { disable_web_page_preview: true }\n      );\n\n      await sendTelegramMessageToChat(chatId,\n        `<b>What happens automatically:</b>\\n` +\n        `- Reddit is scanned every 5 minutes for posts matching your keywords\\n` +\n        `- When a lead is found, I'll send you an AI-written response here\\n` +\n        `- Tap the response buttons to give feedback and improve future responses\\n\\n` +\n        `<b>Manual scanning:</b>\\n` +\n        `- Send me any post URL + text and I'll analyze it instantly\\n` +\n        `- Or just screenshot a post and send the image - I can read it!\\n\\n` +\n        `<b>Commands:</b>\\n` +\n        `/help - Full usage guide\\n` +\n        `/setup - Run this wizard again\\n\\n` +\n        `You're all set! I'll message you the moment I find a lead.`\n      );\n\n      await sendTelegramMessage(\n        `<b>New Client Onboarded via Wizard</b>\\n\\n` +\n        `<b>Business:</b> ${escapeHtml(biz.name)}\\n` +\n        `<b>Email:</b> ${escapeHtml(wizard.contactEmail || \"N/A\")}\\n` +\n        `<b>Phone:</b> ${escapeHtml(wizard.contactPhone || \"N/A\")}\\n` +\n        `<b>Website:</b> ${escapeHtml(wizard.website || \"N/A\")}\\n` +\n        `<b>Location:</b> ${escapeHtml(locationInfo)}\\n` +\n        `<b>Telegram ID:</b> ${chatId}\\n` +\n        `<b>Keywords:</b> ${wizard.keywords.map(k => escapeHtml(k)).join(\", \")}\\n` +\n        `<b>Reddit:</b> ${redditSubs.map(s => escapeHtml(s)).join(\", \")}`\n      );\n\n      return true;\n    }\n  }\n\n  return false;\n}\n","path":null,"size_bytes":8394,"size_tokens":null},"server/utils/html.ts":{"content":"export function escapeHtml(text: string): string {\n  return text\n    .replace(/&/g, \"&amp;\")\n    .replace(/</g, \"&lt;\")\n    .replace(/>/g, \"&gt;\")\n    .replace(/\"/g, \"&quot;\")\n    .replace(/'/g, \"&#39;\");\n}\n\nexport function stripHtml(html: string): string {\n  return html\n    .replace(/<[^>]*>/g, \" \")\n    .replace(/&nbsp;/g, \" \")\n    .replace(/&amp;/g, \"&\")\n    .replace(/&lt;/g, \"<\")\n    .replace(/&gt;/g, \">\")\n    .replace(/&quot;/g, '\"')\n    .replace(/&#39;/g, \"'\")\n    .replace(/\\s+/g, \" \")\n    .trim();\n}\n\nexport function truncate(text: string, max: number): string {\n  if (text.length <= max) return text;\n  return text.slice(0, max) + \"...\";\n}\n\nexport function canonicalizeUrl(url: string): string {\n  try {\n    const u = new URL(url);\n    u.hash = \"\";\n    const paramsToStrip = [\"utm_source\", \"utm_medium\", \"utm_campaign\", \"utm_term\", \"utm_content\", \"ref\", \"fbclid\", \"gclid\"];\n    for (const p of paramsToStrip) {\n      u.searchParams.delete(p);\n    }\n    return u.toString();\n  } catch {\n    return url;\n  }\n}\n","path":null,"size_bytes":1020,"size_tokens":null},"server/utils/rate-limit.ts":{"content":"import type { Request, Response, NextFunction } from \"express\";\nimport { db } from \"../db\";\nimport { rateLimitBuckets } from \"@shared/schema\";\nimport { and, eq, gt, lt, sql } from \"drizzle-orm\";\n\nsetInterval(async () => {\n  try {\n    await db.delete(rateLimitBuckets).where(lt(rateLimitBuckets.resetAt, new Date()));\n  } catch {}\n}, 5 * 60 * 1000);\n\nexport function createRateLimiter(options: {\n  name: string;\n  maxRequests: number;\n  windowMs: number;\n  keyFn?: (req: Request) => string;\n}) {\n  const { name, maxRequests, windowMs } = options;\n  const keyFn = options.keyFn || ((req: Request) => req.ip || \"unknown\");\n\n  return async (req: Request, res: Response, next: NextFunction) => {\n    const key = keyFn(req);\n    const now = new Date();\n\n    try {\n      const existing = await db\n        .select()\n        .from(rateLimitBuckets)\n        .where(\n          and(\n            eq(rateLimitBuckets.limiterName, name),\n            eq(rateLimitBuckets.key, key),\n            gt(rateLimitBuckets.resetAt, now),\n          )\n        )\n        .limit(1);\n\n      if (existing.length > 0) {\n        const bucket = existing[0];\n        if (bucket.count >= maxRequests) {\n          res.status(429).json({ error: \"Too many requests. Please try again later.\" });\n          return;\n        }\n        await db\n          .update(rateLimitBuckets)\n          .set({ count: sql`${rateLimitBuckets.count} + 1` })\n          .where(eq(rateLimitBuckets.id, bucket.id));\n      } else {\n        const resetAt = new Date(now.getTime() + windowMs);\n        await db\n          .insert(rateLimitBuckets)\n          .values({ limiterName: name, key, count: 1, resetAt })\n          .onConflictDoUpdate({\n            target: [rateLimitBuckets.limiterName, rateLimitBuckets.key],\n            set: { count: sql`1`, resetAt },\n          });\n      }\n\n      next();\n    } catch (err) {\n      console.error(\"Rate limiter DB error, allowing request:\", err);\n      next();\n    }\n  };\n}\n","path":null,"size_bytes":1951,"size_tokens":null},"server/routes/admin.ts":{"content":"import type { Express, Request, Response, NextFunction } from \"express\";\nimport { z } from \"zod\";\nimport { isAuthenticated } from \"../replit_integrations/auth\";\nimport { storage } from \"../storage\";\nimport { startRedditMonitor, stopRedditMonitor } from \"../reddit-monitor\";\nimport { startGoogleAlertsMonitor, stopGoogleAlertsMonitor } from \"../google-alerts-monitor\";\nimport { generateScanToken, generateBookmarkletCode, generateLinkedInBookmarkletCode, getAppBaseUrl } from \"../telegram/bookmarklets\";\n\nlet monitoringEnabled = process.env.MONITORING_DISABLED !== \"true\"; // defaults to ON\n\nexport function isMonitoringEnabled() {\n  return monitoringEnabled;\n}\n\nconst SUPER_ADMIN_ID = \"40011074\";\n\nexport async function isAdmin(req: Request, res: Response, next: NextFunction) {\n  const user = req.user as { claims: { sub: string } } | undefined;\n  if (!user) {\n    return res.status(403).json({ error: \"Admin access required\" });\n  }\n  if (user.claims.sub === SUPER_ADMIN_ID) {\n    return next();\n  }\n  try {\n    const dbUser = await storage.getUserById(user.claims.sub);\n    if (dbUser && dbUser.role === \"admin\") {\n      return next();\n    }\n  } catch (e) {\n    console.error(\"Error checking admin role:\", e);\n  }\n  return res.status(403).json({ error: \"Admin access required\" });\n}\n\nexport function registerAdminRoutes(app: Express) {\n  app.get(\"/api/admin/businesses\", isAuthenticated, isAdmin, async (_req: any, res) => {\n    try {\n      const allBiz = await storage.getAllBusinesses();\n      const result = [];\n      for (const biz of allBiz) {\n        const camps = await storage.getCampaignsByBusiness(biz.id);\n        const campaignIds = camps.map(c => c.id);\n        const bizLeads = campaignIds.length > 0 ? await storage.getLeadsByCampaigns(campaignIds) : [];\n        result.push({ ...biz, campaigns: camps, leadCount: bizLeads.length });\n      }\n      res.json(result);\n    } catch (error) {\n      console.error(\"Admin: Error fetching businesses:\", error);\n      res.status(500).json({ error: \"Failed to fetch businesses\" });\n    }\n  });\n\n  app.patch(\"/api/admin/businesses/:id\", isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const updateSchema = z.object({\n        name: z.string().min(1).optional(),\n        type: z.string().optional(),\n        contactEmail: z.string().nullable().optional(),\n        contactPhone: z.string().nullable().optional(),\n        website: z.string().nullable().optional(),\n        targetAudience: z.string().optional(),\n        coreOffering: z.string().optional(),\n        preferredTone: z.string().optional(),\n        telegramChatId: z.string().nullable().optional(),\n      });\n      const parsed = updateSchema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"Invalid request\", details: parsed.error.issues });\n      }\n      const biz = await storage.updateBusiness(id, parsed.data);\n      res.json(biz);\n    } catch (error) {\n      console.error(\"Admin: Error updating business:\", error);\n      res.status(500).json({ error: \"Failed to update business\" });\n    }\n  });\n\n  app.delete(\"/api/admin/businesses/:id\", isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      await storage.deleteBusiness(id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Admin: Error deleting business:\", error);\n      res.status(500).json({ error: \"Failed to delete business\" });\n    }\n  });\n\n  app.patch(\"/api/admin/campaigns/:id\", isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const updateSchema = z.object({\n        name: z.string().min(1).optional(),\n        platform: z.string().optional(),\n        status: z.string().optional(),\n        targetGroups: z.array(z.string()).optional(),\n        keywords: z.array(z.string()).optional(),\n        strategy: z.string().nullable().optional(),\n      });\n      const parsed = updateSchema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"Invalid request\", details: parsed.error.issues });\n      }\n      const camp = await storage.updateCampaign(id, parsed.data);\n      res.json(camp);\n    } catch (error) {\n      console.error(\"Admin: Error updating campaign:\", error);\n      res.status(500).json({ error: \"Failed to update campaign\" });\n    }\n  });\n\n  app.post(\"/api/admin/campaigns\", isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const createSchema = z.object({\n        businessId: z.number(),\n        name: z.string().min(1),\n        platform: z.string().min(1),\n        status: z.string().default(\"active\"),\n        targetGroups: z.array(z.string()).default([]),\n        keywords: z.array(z.string()).default([]),\n        strategy: z.string().nullable().default(null),\n      });\n      const parsed = createSchema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"Invalid request\", details: parsed.error.issues });\n      }\n      const camp = await storage.createCampaign(parsed.data);\n      res.json(camp);\n    } catch (error) {\n      console.error(\"Admin: Error creating campaign:\", error);\n      res.status(500).json({ error: \"Failed to create campaign\" });\n    }\n  });\n\n  app.delete(\"/api/admin/campaigns/:id\", isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      await storage.deleteCampaign(id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Admin: Error deleting campaign:\", error);\n      res.status(500).json({ error: \"Failed to delete campaign\" });\n    }\n  });\n\n  app.get(\"/api/admin/leads/:businessId\", isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const businessId = parseInt(req.params.id || req.params.businessId);\n      const camps = await storage.getCampaignsByBusiness(businessId);\n      const campaignIds = camps.map(c => c.id);\n      if (campaignIds.length === 0) return res.json({ leads: [], responses: [], campaigns: [] });\n      const bizLeads = await storage.getLeadsByCampaigns(campaignIds);\n      const leadIds = bizLeads.map(l => l.id);\n      const responses = leadIds.length > 0 ? await storage.getResponsesByLeads(leadIds) : [];\n      res.json({ leads: bizLeads, responses, campaigns: camps.map(c => ({ id: c.id, name: c.name, platform: c.platform })) });\n    } catch (error) {\n      console.error(\"Admin: Error fetching leads:\", error);\n      res.status(500).json({ error: \"Failed to fetch leads\" });\n    }\n  });\n\n  app.get(\"/api/admin/all-leads\", isAuthenticated, isAdmin, async (_req: any, res) => {\n    try {\n      const allBiz = await storage.getAllBusinesses();\n      const result = [];\n      for (const biz of allBiz) {\n        const camps = await storage.getCampaignsByBusiness(biz.id);\n        const campaignIds = camps.map(c => c.id);\n        if (campaignIds.length === 0) continue;\n        const bizLeads = await storage.getLeadsByCampaigns(campaignIds);\n        if (bizLeads.length === 0) continue;\n        const leadIds = bizLeads.map(l => l.id);\n        const responses = leadIds.length > 0 ? await storage.getResponsesByLeads(leadIds) : [];\n        result.push({\n          business: { id: biz.id, name: biz.name },\n          campaigns: camps.map(c => ({ id: c.id, name: c.name, platform: c.platform })),\n          leads: bizLeads,\n          responses,\n        });\n      }\n      res.json(result);\n    } catch (error) {\n      console.error(\"Admin: Error fetching all leads:\", error);\n      res.status(500).json({ error: \"Failed to fetch all leads\" });\n    }\n  });\n\n  app.get(\"/api/admin/check\", isAuthenticated, async (req: any, res) => {\n    const userId = req.user.claims.sub;\n    if (userId === SUPER_ADMIN_ID) {\n      return res.json({ isAdmin: true, isSuperAdmin: true });\n    }\n    try {\n      const dbUser = await storage.getUserById(userId);\n      return res.json({ isAdmin: dbUser?.role === \"admin\", isSuperAdmin: false });\n    } catch {\n      return res.json({ isAdmin: false, isSuperAdmin: false });\n    }\n  });\n\n  app.get(\"/api/admin/monitoring\", isAuthenticated, isAdmin, async (_req: any, res) => {\n    res.json({ enabled: monitoringEnabled });\n  });\n\n  app.post(\"/api/admin/monitoring\", isAuthenticated, isAdmin, async (req: any, res) => {\n    const { enabled } = req.body;\n    if (typeof enabled !== \"boolean\") {\n      return res.status(400).json({ error: \"enabled must be a boolean\" });\n    }\n\n    monitoringEnabled = enabled;\n\n    if (enabled) {\n      process.env.MONITORING_DISABLED = \"false\";\n      startRedditMonitor();\n      startGoogleAlertsMonitor();\n      console.log(\"Admin: Monitoring ENABLED via admin panel\");\n    } else {\n      process.env.MONITORING_DISABLED = \"true\";\n      stopRedditMonitor();\n      stopGoogleAlertsMonitor();\n      console.log(\"Admin: Monitoring DISABLED via admin panel\");\n    }\n\n    res.json({ enabled: monitoringEnabled });\n  });\n\n  app.get(\"/api/admin/users\", isAuthenticated, isAdmin, async (_req: any, res) => {\n    try {\n      const allUsers = await storage.getAllUsers();\n      res.json(allUsers);\n    } catch (error) {\n      console.error(\"Admin: Error fetching users:\", error);\n      res.status(500).json({ error: \"Failed to fetch users\" });\n    }\n  });\n\n  app.patch(\"/api/admin/businesses/:id/owner\", isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const { userId } = req.body;\n      if (!userId || typeof userId !== \"string\") {\n        return res.status(400).json({ error: \"userId is required\" });\n      }\n      const targetUser = await storage.getUserById(userId);\n      if (!targetUser) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n      const biz = await storage.getBusinessById(id);\n      if (!biz) {\n        return res.status(404).json({ error: \"Business not found\" });\n      }\n      const updated = await storage.updateBusiness(id, { userId });\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Admin: Error assigning business owner:\", error);\n      res.status(500).json({ error: \"Failed to assign owner\" });\n    }\n  });\n\n  app.patch(\"/api/admin/users/:userId/role\", isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const requesterId = req.user.claims.sub;\n      if (requesterId !== SUPER_ADMIN_ID) {\n        return res.status(403).json({ error: \"Only the super admin can change user roles\" });\n      }\n      const { userId } = req.params;\n      const { role } = req.body;\n      if (!role || ![\"admin\", \"user\"].includes(role)) {\n        return res.status(400).json({ error: \"Role must be 'admin' or 'user'\" });\n      }\n      if (userId === SUPER_ADMIN_ID) {\n        return res.status(400).json({ error: \"Cannot change the super admin's role\" });\n      }\n      const updated = await storage.updateUserRole(userId, role);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Admin: Error updating user role:\", error);\n      res.status(500).json({ error: \"Failed to update user role\" });\n    }\n  });\n\n  app.get(\"/api/admin/businesses/:id/bookmarklets\", isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const businessId = Number(req.params.id);\n      const biz = await storage.getBusinessById(businessId);\n      if (!biz) {\n        return res.status(404).json({ error: \"Business not found\" });\n      }\n      const chatId = biz.telegramChatId || process.env.TELEGRAM_CHAT_ID;\n      if (!chatId) {\n        return res.json({ error: \"no_telegram\", message: \"This business has no Telegram chat connected and no default admin chat ID configured.\" });\n      }\n      const baseUrl = getAppBaseUrl();\n      const token = generateScanToken(chatId, businessId);\n      const facebook = generateBookmarkletCode(baseUrl, chatId, businessId, token);\n      const linkedin = generateLinkedInBookmarkletCode(baseUrl, chatId, businessId, token);\n      res.json({ facebook, linkedin, businessName: biz.name, chatId });\n    } catch (error) {\n      console.error(\"Admin: Error generating bookmarklets:\", error);\n      res.status(500).json({ error: \"Failed to generate bookmarklets\" });\n    }\n  });\n}\n","path":null,"size_bytes":12215,"size_tokens":null},"server/telegram/analysis.ts":{"content":"import { db } from \"../db\";\nimport { businesses, campaigns, leads, aiResponses, responseFeedback } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\nimport { generateContent, safeParseJsonFromAI, parseAIJsonWithSchema, analysisMatchSchema } from \"../utils/ai\";\nimport { escapeHtml } from \"../utils/html\";\nimport { getFeedbackGuidance } from \"../utils/feedback\";\nimport { markOwnResponse } from \"../utils/dedup\";\nimport { isMonitoringEnabled } from \"../routes/admin\";\n\nexport interface BusinessWithCampaigns {\n  id: number;\n  name: string;\n  type: string;\n  targetAudience: string;\n  coreOffering: string;\n  preferredTone: string;\n  campaigns: Array<{\n    id: number;\n    name: string;\n    platform: string;\n    keywords: string[];\n    targetGroups: string[];\n  }>;\n}\n\nexport async function getAllBusinessesWithCampaigns(): Promise<BusinessWithCampaigns[]> {\n  const allBiz = await db.select().from(businesses);\n  const allCamps = await db.select().from(campaigns);\n\n  return allBiz.map((b) => ({\n    id: b.id,\n    name: b.name,\n    type: b.type,\n    targetAudience: b.targetAudience,\n    coreOffering: b.coreOffering,\n    preferredTone: b.preferredTone,\n    campaigns: allCamps\n      .filter((c) => c.businessId === b.id && c.status === \"active\")\n      .map((c) => ({\n        id: c.id,\n        name: c.name,\n        platform: c.platform,\n        keywords: (c.keywords as string[]) || [],\n        targetGroups: (c.targetGroups as string[]) || [],\n      })),\n  })).filter((b) => b.campaigns.length > 0);\n}\n\nconst URL_REGEX = /https?:\\/\\/(?:www\\.)?(?:reddit\\.com|old\\.reddit\\.com|redd\\.it|facebook\\.com|fb\\.com|m\\.facebook\\.com)[^\\s)>\\]]+/gi;\n\nexport function extractPostUrl(text: string): string | null {\n  const matches = text.match(URL_REGEX);\n  return matches ? matches[0] : null;\n}\n\nexport function stripUrls(text: string): string {\n  return text.replace(URL_REGEX, \"\").trim();\n}\n\nexport function detectPlatformFromUrl(url: string): \"reddit\" | \"facebook\" | null {\n  if (/reddit\\.com|redd\\.it/i.test(url)) return \"reddit\";\n  if (/facebook\\.com|fb\\.com/i.test(url)) return \"facebook\";\n  return null;\n}\n\nexport function detectPlatformFromText(text: string): \"reddit\" | \"facebook\" | null {\n  const lower = text.toLowerCase();\n  if (lower.includes(\"reddit\") || lower.includes(\"r/\") || lower.includes(\"/r/\")) return \"reddit\";\n  if (lower.includes(\"facebook\") || lower.includes(\"fb group\")) return \"facebook\";\n  return null;\n}\n\nexport interface ImageExtraction {\n  text: string;\n  platform: \"reddit\" | \"facebook\" | null;\n  groupName: string | null;\n  authorName: string | null;\n  postUrl: string | null;\n}\n\nfunction detectMimeType(filePath: string): string {\n  if (filePath.endsWith(\".png\")) return \"image/png\";\n  if (filePath.endsWith(\".webp\")) return \"image/webp\";\n  return \"image/jpeg\";\n}\n\nexport async function downloadTelegramPhotoWithMime(fileId: string): Promise<{ buffer: Buffer; mimeType: string } | null> {\n  const token = process.env.TELEGRAM_BOT_TOKEN;\n  if (!token) return null;\n\n  try {\n    const fileRes = await fetch(`https://api.telegram.org/bot${token}/getFile`, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify({ file_id: fileId }),\n    });\n    const fileData = await fileRes.json() as any;\n    if (!fileData.ok || !fileData.result?.file_path) return null;\n\n    const filePath = fileData.result.file_path as string;\n    const mimeType = detectMimeType(filePath);\n    const downloadUrl = `https://api.telegram.org/file/bot${token}/${filePath}`;\n    const imgRes = await fetch(downloadUrl);\n    if (!imgRes.ok) return null;\n\n    const arrayBuf = await imgRes.arrayBuffer();\n    return { buffer: Buffer.from(arrayBuf), mimeType };\n  } catch (error) {\n    console.error(\"Error downloading Telegram photo:\", error);\n    return null;\n  }\n}\n\nexport async function extractTextFromImage(imageBuffer: Buffer, mimeType: string): Promise<ImageExtraction | null> {\n  try {\n    const base64Image = imageBuffer.toString(\"base64\");\n\n    const result = await generateContent({\n      model: \"gemini-2.5-flash\",\n      contents: [\n        {\n          role: \"user\",\n          parts: [\n            {\n              inlineData: {\n                mimeType,\n                data: base64Image,\n              },\n            },\n            {\n              text: `You are analyzing a screenshot of a social media post. Extract the following information:\n\n1. The full text content of the post (the main body/question being asked)\n2. The platform (Reddit or Facebook) - look for visual cues like Reddit's upvote arrows, subreddit names (r/...), Facebook's blue header, group names, like/comment buttons\n3. The group or subreddit name if visible\n4. The author's name/username if visible\n\nReturn ONLY valid JSON:\n{\n  \"post_text\": \"<the full text of the post>\",\n  \"platform\": \"<reddit or facebook or unknown>\",\n  \"group_name\": \"<group or subreddit name, or null>\",\n  \"author_name\": \"<author name or null>\",\n  \"post_url\": \"<any visible URL in the screenshot, or null>\"\n}\n\nIf you cannot read any text from the image, return: {\"post_text\": \"\", \"platform\": \"unknown\", \"group_name\": null, \"author_name\": null, \"post_url\": null}`,\n            },\n          ],\n        },\n      ],\n      config: { maxOutputTokens: 2048 },\n    });\n\n    const responseText = result.text;\n    const parsed = safeParseJsonFromAI(responseText) as Record<string, any> | null;\n    if (!parsed) return null;\n    if (!parsed.post_text || parsed.post_text.length < 3) return null;\n\n    let platform: \"reddit\" | \"facebook\" | null = null;\n    if (parsed.platform === \"reddit\") platform = \"reddit\";\n    else if (parsed.platform === \"facebook\") platform = \"facebook\";\n\n    return {\n      text: parsed.post_text,\n      platform,\n      groupName: parsed.group_name || null,\n      authorName: parsed.author_name || null,\n      postUrl: parsed.post_url || null,\n    };\n  } catch (error) {\n    console.error(\"Error extracting text from image:\", error);\n    return null;\n  }\n}\n\nexport interface PostAnalysis {\n  message: string;\n  responseText: string | null;\n  postUrl: string | null;\n  platform: \"reddit\" | \"facebook\" | null;\n  responseId: number | null;\n  needsGroupContext: boolean;\n}\n\nexport async function handlePost(postText: string, groupName?: string, postUrl?: string | null, overridePlatform?: \"reddit\" | \"facebook\" | null): Promise<PostAnalysis> {\n  if (!isMonitoringEnabled()) {\n    return {\n      message: \"Monitoring is currently paused. Turn it back on from the admin panel.\",\n      responseText: null,\n      postUrl: postUrl || null,\n      platform: null,\n      responseId: null,\n      needsGroupContext: false,\n    };\n  }\n\n  const allBiz = await getAllBusinessesWithCampaigns();\n  const platform = overridePlatform || (postUrl ? detectPlatformFromUrl(postUrl) : null) || detectPlatformFromText(postText) || null;\n\n  if (allBiz.length === 0) {\n    return {\n      message: \"No businesses set up yet. Add a business through the Gemin-Eye dashboard or use /newclient.\",\n      responseText: null,\n      postUrl: postUrl || null,\n      platform,\n      responseId: null,\n      needsGroupContext: false,\n    };\n  }\n\n  const bizSummaries = allBiz.map((b) => {\n    const kws = b.campaigns.flatMap((c) => c.keywords);\n    return `- ${b.name} (${b.type}): keywords=[${kws.join(\", \")}], audience=\"${b.targetAudience}\"`;\n  }).join(\"\\n\");\n\n  const matchPrompt = `You are a lead matching AI. Given a social media post, determine which business (if any) is the best match and score the lead intent.\nAlso rate your confidence in the match from 1-10 (10 = certain, 1 = guessing).\n\nAvailable businesses:\n${bizSummaries}\n\nPost: \"${postText}\"\n${groupName ? `Group: \"${groupName}\"` : \"\"}\n\nINTENT SCORING GUIDE (be strict and spread scores across the full range):\n1-2: Completely unrelated topic, no connection to any business\n3-4: Loosely related topic but NOT asking for help or recommendations\n5-6: Related topic, asking a question, but not specifically looking for what the business offers\n7-8: Clearly seeking help/recommendations in this business's area\n9-10: Actively looking for EXACTLY what this business offers, urgent need, ready to buy/act\n\nReturn ONLY valid JSON:\n{\n  \"matched_business\": \"<exact business name or null if no match>\",\n  \"intent_score\": 5,\n  \"confidence\": 5,\n  \"reasoning\": \"<one sentence>\"\n}`;\n\n  const matchResult = await generateContent({\n    model: \"gemini-2.5-flash\",\n    contents: matchPrompt,\n    config: { maxOutputTokens: 1024 },\n  });\n\n  const matchText = matchResult.text;\n  const match = parseAIJsonWithSchema(matchText, analysisMatchSchema);\n  if (!match) {\n    return {\n      message: \"Could not analyze this post. Try again.\",\n      responseText: null,\n      postUrl: postUrl || null,\n      platform,\n      responseId: null,\n      needsGroupContext: false,\n    };\n  }\n  const confidence = match.confidence || 10;\n\n  if (!groupName && allBiz.length > 1 && (!match.matched_business || match.matched_business === \"null\" || confidence < 6)) {\n    return {\n      message: \"\",\n      responseText: null,\n      postUrl: postUrl || null,\n      platform,\n      responseId: null,\n      needsGroupContext: true,\n    };\n  }\n\n  if (!match.matched_business || match.matched_business === \"null\") {\n    return {\n      message: `<b>No match found</b>\\n\\nThis post doesn't seem relevant to any of your businesses.\\n\\n<b>Intent score:</b> ${match.intent_score}/10\\n<b>Reason:</b> ${escapeHtml(match.reasoning || \"\")}`,\n      responseText: null,\n      postUrl: postUrl || null,\n      platform,\n      responseId: null,\n      needsGroupContext: false,\n    };\n  }\n\n  const biz = allBiz.find((b) => b.name.toLowerCase() === match.matched_business!.toLowerCase());\n  if (!biz) {\n    return {\n      message: `<b>No match found</b>\\n\\nCouldn't match to a specific business.\\n\\n<b>Reason:</b> ${escapeHtml(match.reasoning || \"\")}`,\n      responseText: null,\n      postUrl: postUrl || null,\n      platform,\n      responseId: null,\n      needsGroupContext: false,\n    };\n  }\n\n  if (match.intent_score < 4) {\n    return {\n      message: `<b>Low intent detected</b>\\n\\n<b>Business:</b> ${escapeHtml(biz.name)}\\n<b>Intent:</b> ${\"*\".repeat(match.intent_score)}${\"_\".repeat(10 - match.intent_score)} ${match.intent_score}/10\\n<b>Reason:</b> ${escapeHtml(match.reasoning || \"\")}\\n\\nIntent too low to generate a response. Keep monitoring!`,\n      responseText: null,\n      postUrl: postUrl || null,\n      platform,\n      responseId: null,\n      needsGroupContext: false,\n    };\n  }\n\n  const toneMap: Record<string, string> = {\n    empathetic: \"empathetic, warm, and supportive\",\n    professional: \"professional, authoritative, and informative\",\n    casual: \"casual, friendly, and approachable\",\n  };\n\n  const platformContext = platform === \"reddit\" ? \"Reddit\" : platform === \"facebook\" ? \"Facebook group\" : \"social media\";\n\n  let feedbackGuidance = \"\";\n  try {\n    const recentFeedback = await db\n      .select({ feedback: responseFeedback.feedback })\n      .from(responseFeedback)\n      .innerJoin(aiResponses, eq(responseFeedback.responseId, aiResponses.id))\n      .innerJoin(leads, eq(aiResponses.leadId, leads.id))\n      .innerJoin(campaigns, eq(leads.campaignId, campaigns.id))\n      .where(eq(campaigns.businessId, biz.id))\n      .orderBy(responseFeedback.id)\n      .limit(20);\n\n    const negCount = recentFeedback.filter(f => f.feedback !== \"positive\").length;\n    const salesyCount = recentFeedback.filter(f => f.feedback === \"too_salesy\").length;\n    const total = recentFeedback.length;\n\n    if (total > 0) {\n      if (salesyCount > total * 0.3) {\n        feedbackGuidance = \"\\nIMPORTANT: Previous responses for this business were rated as too salesy. Be EXTRA subtle - barely mention the business. Focus 90% on being helpful and only naturally mention the business if it truly fits.\";\n      } else if (negCount > total * 0.5) {\n        feedbackGuidance = \"\\nIMPORTANT: Previous responses had mixed reviews. Focus on being more genuine, helpful, and less promotional. The recommendation should feel organic, not forced.\";\n      }\n    }\n  } catch (err) {\n  }\n\n  const isReddit = platform === \"reddit\";\n\n  const responsePrompt = isReddit\n    ? `You are writing a Reddit comment${groupName ? ` in ${groupName}` : \"\"}. Your ONLY goal is to be genuinely helpful. This must comply with Reddit's rules against self-promotion and spam.\n\nThe post: \"${postText}\"\n\nYour expertise area: ${biz.coreOffering}\nTone: ${toneMap[biz.preferredTone] || \"friendly and helpful\"}\n${feedbackGuidance}\n\nSTRICT RULES FOR REDDIT COMPLIANCE:\n- Do NOT mention any business name, brand, website, or link\n- Do NOT say \"I recommend\" or \"check out\" or \"you should try\"\n- Do NOT hint that you represent or work for any company\n- Write as a knowledgeable community member sharing genuine advice\n- Answer their question directly with useful, specific information\n- Sound like a real Redditor  casual, helpful, maybe slightly opinionated\n- Keep it 2-4 sentences, natural and conversational\n\nThe response should be PURELY helpful advice based on your expertise. The value is in demonstrating knowledge, not promoting anything.\n\nReturn ONLY the response text, no quotes or formatting.`\n    : `You are writing a response to a ${platformContext} post in a community group. Your goal is to be genuinely helpful while subtly recommending a business.\n\nThe post: \"${postText}\"\n${groupName ? `Group: \"${groupName}\"` : \"\"}\n\nBusiness to recommend: ${biz.name}\nWhat they do: ${biz.coreOffering}\nTone: ${toneMap[biz.preferredTone] || \"friendly and helpful\"}\n${feedbackGuidance}\n\nWrite a natural, human-sounding response (2-3 sentences). Do NOT make it sound like an ad. Sound like a real person sharing a helpful recommendation based on personal experience or knowledge. Include the business name naturally.\n\nReturn ONLY the response text, no quotes or formatting.`;\n\n  const responseResult = await generateContent({\n    model: \"gemini-2.5-pro\",\n    contents: responsePrompt,\n    config: { maxOutputTokens: 8192 },\n  });\n\n  const responseText = responseResult.text.trim();\n\n  await markOwnResponse(responseText);\n\n  const activeCampaign = biz.campaigns[0];\n  let savedResponseId: number | null = null;\n\n  if (activeCampaign) {\n    try {\n      const [savedLead] = await db.insert(leads).values({\n        campaignId: activeCampaign.id,\n        platform: platform || \"unknown\",\n        groupName: groupName || \"Unknown Group\",\n        authorName: \"via Telegram\",\n        originalPost: postText,\n        postUrl: postUrl || null,\n        intentScore: match.intent_score,\n        status: \"matched\",\n      }).returning();\n\n      if (savedLead) {\n        const [savedResponse] = await db.insert(aiResponses).values({\n          leadId: savedLead.id,\n          content: responseText,\n          status: \"pending\",\n        }).returning();\n        savedResponseId = savedResponse?.id || null;\n      }\n    } catch (err) {\n      console.error(\"Error saving lead/response to DB:\", err);\n    }\n  }\n\n  const scoreBar = \"*\".repeat(match.intent_score) + \"_\".repeat(10 - match.intent_score);\n  const platformLabel = platform === \"reddit\" ? \"Reddit\" : platform === \"facebook\" ? \"Facebook\" : \"Post\";\n\n  let msg = `<b>Lead Matched!</b>\\n\\n`;\n  msg += `<b>Business:</b> ${escapeHtml(biz.name)}\\n`;\n  if (platform) msg += `<b>Platform:</b> ${platformLabel}\\n`;\n  if (groupName) msg += `<b>Group:</b> ${escapeHtml(groupName)}\\n`;\n  msg += `<b>Intent:</b> ${scoreBar} ${match.intent_score}/10\\n`;\n  msg += `<b>Why:</b> ${escapeHtml(match.reasoning)}\\n\\n`;\n  msg += `<b>Original post:</b>\\n<i>\"${escapeHtml(postText.length > 300 ? postText.slice(0, 300) + \"...\" : postText)}\"</i>`;\n\n  if (postUrl) {\n    msg += `\\n\\nTap \"Open Post\" below, then paste the reply.`;\n  }\n\n  return {\n    message: msg,\n    responseText,\n    postUrl: postUrl || null,\n    platform,\n    responseId: savedResponseId,\n    needsGroupContext: false,\n  };\n}\n","path":null,"size_bytes":15861,"size_tokens":null},"server/utils/ai.ts":{"content":"import { GoogleGenAI } from \"@google/genai\";\nimport { z, ZodSchema } from \"zod\";\n\nexport const ai = new GoogleGenAI({\n  apiKey: process.env.AI_INTEGRATIONS_GEMINI_API_KEY,\n  httpOptions: {\n    apiVersion: \"\",\n    baseUrl: process.env.AI_INTEGRATIONS_GEMINI_BASE_URL,\n  },\n});\n\nconst AI_TIMEOUT_MS = parseInt(process.env.AI_TIMEOUT_MS || \"30000\", 10);\nconst AI_MAX_RETRIES = parseInt(process.env.AI_MAX_RETRIES || \"2\", 10);\n\nfunction isRetryableError(err: unknown): boolean {\n  if (err instanceof Error) {\n    const msg = err.message.toLowerCase();\n    if (msg.includes(\"timed out\")) return true;\n    if (msg.includes(\"429\") || msg.includes(\"rate limit\") || msg.includes(\"quota\")) return true;\n    if (msg.includes(\"503\") || msg.includes(\"500\") || msg.includes(\"unavailable\")) return true;\n    if (msg.includes(\"econnreset\") || msg.includes(\"econnrefused\") || msg.includes(\"socket\")) return true;\n  }\n  return false;\n}\n\nfunction sleep(ms: number): Promise<void> {\n  return new Promise((resolve) => setTimeout(resolve, ms));\n}\n\nasync function generateContentOnce(\n  opts: { model: string; contents: any; config?: any },\n  timeoutMs: number,\n): Promise<{ text: string }> {\n  const aiCall = ai.models.generateContent(opts);\n  const timeout = new Promise<never>((_, reject) => {\n    const timer = setTimeout(() => {\n      reject(new Error(`AI call timed out after ${timeoutMs}ms (model: ${opts.model})`));\n    }, timeoutMs);\n    timer.unref?.();\n  });\n  const result = await Promise.race([aiCall, timeout]);\n  return { text: result.text || \"\" };\n}\n\nexport async function generateContent(\n  opts: { model: string; contents: any; config?: any },\n  timeoutMs: number = AI_TIMEOUT_MS,\n  retries: number = AI_MAX_RETRIES,\n): Promise<{ text: string }> {\n  let lastError: unknown;\n  for (let attempt = 0; attempt <= retries; attempt++) {\n    try {\n      return await generateContentOnce(opts, timeoutMs);\n    } catch (err) {\n      lastError = err;\n      if (attempt < retries && isRetryableError(err)) {\n        const backoffMs = 1000 * Math.pow(2, attempt);\n        console.warn(`AI call failed (attempt ${attempt + 1}/${retries + 1}, model: ${opts.model}), retrying in ${backoffMs}ms...`, err instanceof Error ? err.message : err);\n        await sleep(backoffMs);\n      } else if (!isRetryableError(err)) {\n        throw err;\n      }\n    }\n  }\n  throw lastError;\n}\n\nexport function safeParseJsonFromAI(text: string): unknown | null {\n  const cleaned = text\n    .replace(/```json\\s*/gi, \"\")\n    .replace(/```\\s*/g, \"\")\n    .trim();\n\n  try { return JSON.parse(cleaned); } catch {}\n\n  const match = cleaned.match(/(\\{[\\s\\S]*\\}|\\[[\\s\\S]*\\])/);\n  if (!match) return null;\n  try { return JSON.parse(match[1]); } catch { return null; }\n}\n\nexport function parseAIJsonWithSchema<T>(\n  text: string,\n  schema: ZodSchema<T>,\n): T | null {\n  const parsed = safeParseJsonFromAI(text);\n  if (!parsed) return null;\n  const validated = schema.safeParse(parsed);\n  if (validated.success) return validated.data;\n  console.warn(\"AI JSON schema validation failed:\", validated.error.issues);\n  return null;\n}\n\nexport async function parseAIJsonWithRetry<T>(\n  generateFn: () => Promise<string>,\n  schema: ZodSchema<T>,\n  maxRetries: number = 1\n): Promise<T | null> {\n  for (let attempt = 0; attempt <= maxRetries; attempt++) {\n    try {\n      const text = await generateFn();\n      const parsed = safeParseJsonFromAI(text);\n      if (!parsed) {\n        if (attempt < maxRetries) {\n          console.warn(`AI JSON parse failed (attempt ${attempt + 1}), retrying...`);\n          continue;\n        }\n        return null;\n      }\n\n      const validated = schema.safeParse(parsed);\n      if (validated.success) {\n        return validated.data;\n      }\n\n      console.warn(`AI JSON validation failed (attempt ${attempt + 1}):`, validated.error.issues);\n      if (attempt < maxRetries) continue;\n\n      return null;\n    } catch (err) {\n      console.error(`AI generation error (attempt ${attempt + 1}):`, err);\n      if (attempt >= maxRetries) return null;\n    }\n  }\n  return null;\n}\n\nexport const leadScoreSchema = z.object({\n  is_lead: z.boolean(),\n  intent_score: z.number().min(1).max(10),\n  reasoning: z.string(),\n});\n\nexport type LeadScore = z.infer<typeof leadScoreSchema>;\n\nexport const strategySchema = z.object({\n  platforms: z.array(z.object({ name: z.string() })),\n  groups: z.array(z.string()),\n  keywords: z.array(z.string()),\n  sampleResponse: z.string(),\n  rationale: z.string(),\n});\n\nexport type Strategy = z.infer<typeof strategySchema>;\n\nexport const scanMatchSchema = z.object({\n  is_lead: z.boolean(),\n  intent_score: z.number().min(1).max(10),\n  reasoning: z.string(),\n});\n\nexport type ScanMatch = z.infer<typeof scanMatchSchema>;\n\nexport const analysisMatchSchema = z.object({\n  matched_business: z.string().nullable(),\n  intent_score: z.number().min(1).max(10),\n  confidence: z.number().min(1).max(10).optional(),\n  reasoning: z.string(),\n});\n\nexport type AnalysisMatch = z.infer<typeof analysisMatchSchema>;\n\nexport const TONE_MAP: Record<string, string> = {\n  empathetic: \"empathetic, warm, and supportive\",\n  professional: \"professional, authoritative, and informative\",\n  casual: \"casual, friendly, and approachable\",\n  helpful: \"helpful, knowledgeable, and conversational\",\n};\n\nexport const MIN_POST_LENGTH = 25;\nexport const MIN_SCAN_INTENT_SCORE = 4;\nexport const MIN_MONITOR_INTENT_SCORE = 5;\nexport const SALESY_FEEDBACK_THRESHOLD = 0.3;\n","path":null,"size_bytes":5432,"size_tokens":null},"server/telegram/callbacks.ts":{"content":"import { db } from \"../db\";\nimport { aiResponses, responseFeedback } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\nimport { sendTelegramMessage, answerCallbackQuery, editMessageReplyMarkup } from \"../telegram\";\nimport { postRedditComment, isRedditConfigured } from \"../reddit-poster\";\nimport { pendingRedditPosts, REDDIT_POST_TTL } from \"./state\";\n\nexport async function handleCallbackQuery(cbq: any): Promise<void> {\n  const data = cbq.data as string;\n  const cbqChatId = String(cbq.message?.chat?.id || \"\");\n\n  if (data.startsWith(\"fb_\") || data.startsWith(\"li_\")) {\n    await handleFeedbackCallback(cbq, data, cbqChatId);\n  } else if (data.startsWith(\"reddit_post_\")) {\n    await handleRedditPostCallback(cbq, data, cbqChatId);\n  } else if (data === \"noop\") {\n    await answerCallbackQuery(cbq.id, \"Feedback already recorded.\");\n  } else {\n    await answerCallbackQuery(cbq.id);\n  }\n}\n\nasync function handleFeedbackCallback(cbq: any, data: string, cbqChatId: string): Promise<void> {\n  const parts = data.split(\"_\");\n  const feedbackType = parts[1];\n  const responseId = parseInt(parts[2]);\n\n  if (isNaN(responseId)) {\n    await answerCallbackQuery(cbq.id);\n    return;\n  }\n\n  const feedbackMap: Record<string, string> = {\n    good: \"positive\",\n    bad: \"bad_match\",\n    salesy: \"too_salesy\",\n    wrong: \"wrong_client\",\n  };\n\n  const feedbackValue = feedbackMap[feedbackType] || feedbackType;\n\n  try {\n    const existing = await db.select().from(responseFeedback).where(eq(responseFeedback.responseId, responseId)).limit(1);\n    if (existing.length > 0) {\n      await answerCallbackQuery(cbq.id, \"Feedback already recorded for this response.\");\n      return;\n    }\n\n    await db.insert(responseFeedback).values({\n      responseId,\n      feedback: feedbackValue,\n    });\n\n    if (feedbackValue === \"positive\") {\n      await db.update(aiResponses).set({ status: \"approved\", approvedAt: new Date() }).where(eq(aiResponses.id, responseId));\n    }\n  } catch (err) {\n    console.error(\"Error saving feedback:\", err);\n  }\n\n  const feedbackLabels: Record<string, string> = {\n    positive: \"Marked as used - great!\",\n    bad_match: \"Noted: bad match. I'll learn from this.\",\n    too_salesy: \"Noted: too salesy. I'll adjust the tone.\",\n    wrong_client: \"Noted: wrong client matched.\",\n  };\n\n  await answerCallbackQuery(cbq.id, feedbackLabels[feedbackValue] || \"Feedback saved!\");\n\n  if (cbq.message?.message_id && cbqChatId) {\n    const existingButtons = cbq.message?.reply_markup?.inline_keyboard || [];\n    const urlButtons = existingButtons.filter((row: any[]) => row.some((b: any) => b.url));\n    const selectedLabel = feedbackType === \"good\" ? \"Used It\" : feedbackType === \"salesy\" ? \"Too Salesy\" : feedbackType === \"wrong\" ? \"Wrong Client\" : \"Bad Match\";\n    const confirmRow = [{ text: `[${selectedLabel}]`, callback_data: \"noop\" }];\n    const newKeyboard = [...urlButtons, confirmRow];\n    await editMessageReplyMarkup(cbqChatId, cbq.message.message_id, { inline_keyboard: newKeyboard });\n  }\n}\n\nasync function handleRedditPostCallback(cbq: any, data: string, cbqChatId: string): Promise<void> {\n  const responseId = parseInt(data.replace(\"reddit_post_\", \"\"));\n  if (isNaN(responseId)) {\n    await answerCallbackQuery(cbq.id);\n    return;\n  }\n\n  const pending = pendingRedditPosts.get(responseId);\n  if (!pending || (Date.now() - pending.timestamp) > REDDIT_POST_TTL) {\n    pendingRedditPosts.delete(responseId);\n    await answerCallbackQuery(cbq.id, \"This post link has expired. Trigger a new analysis.\");\n    return;\n  }\n\n  await answerCallbackQuery(cbq.id, \"Posting to Reddit...\");\n  const result = await postRedditComment(pending.postUrl, pending.responseText);\n  pendingRedditPosts.delete(responseId);\n\n  if (result.success) {\n    await db.insert(responseFeedback).values({ responseId, feedback: \"positive\" }).catch(() => {});\n    await db.update(aiResponses).set({ status: \"approved\", approvedAt: new Date() }).where(eq(aiResponses.id, responseId)).catch(() => {});\n\n    let confirmMsg = \"Posted to Reddit!\";\n    if (result.commentUrl) {\n      confirmMsg += `\\n\\n<a href=\"${result.commentUrl}\">View your comment</a>`;\n    }\n    await sendTelegramMessage(confirmMsg);\n\n    if (cbq.message?.message_id && cbqChatId) {\n      const existingButtons = cbq.message?.reply_markup?.inline_keyboard || [];\n      const urlButtons = existingButtons.filter((row: any[]) => row.some((b: any) => b.url));\n      const newKeyboard = [...urlButtons, [{ text: \"[Posted to Reddit]\", callback_data: \"noop\" }]];\n      await editMessageReplyMarkup(cbqChatId, cbq.message.message_id, { inline_keyboard: newKeyboard });\n    }\n  } else {\n    await sendTelegramMessage(`Failed to post: ${result.error}`);\n  }\n}\n","path":null,"size_bytes":4703,"size_tokens":null},"client/src/pages/bookmarklets.tsx":{"content":"import { useState } from \"react\";\nimport { useParams } from \"wouter\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Copy, Check, Eye, Loader2, BookmarkIcon, AlertCircle } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { SiFacebook, SiLinkedin } from \"react-icons/si\";\n\ninterface BookmarkletData {\n  businessName: string;\n  facebookCode: string;\n  linkedinCode: string;\n}\n\nfunction CopyButton({ code, label, testId }: { code: string; label: string; testId: string }) {\n  const [copied, setCopied] = useState(false);\n  const { toast } = useToast();\n\n  const handleCopy = async () => {\n    try {\n      await navigator.clipboard.writeText(code);\n      setCopied(true);\n      toast({ title: \"Copied!\", description: `${label} bookmarklet code copied to clipboard.` });\n      setTimeout(() => setCopied(false), 2000);\n    } catch {\n      toast({ title: \"Copy failed\", description: \"Please try selecting and copying manually.\", variant: \"destructive\" });\n    }\n  };\n\n  return (\n    <Button onClick={handleCopy} className=\"w-full\" data-testid={testId}>\n      {copied ? <Check className=\"w-4 h-4 mr-2\" /> : <Copy className=\"w-4 h-4 mr-2\" />}\n      {copied ? \"Copied!\" : `Copy ${label} Code`}\n    </Button>\n  );\n}\n\nexport default function BookmarkletsPage() {\n  const params = useParams<{ businessId: string; chatId: string; token: string }>();\n  const { businessId, chatId, token } = params;\n\n  const { data, isLoading, error } = useQuery<BookmarkletData>({\n    queryKey: [\"/api/bookmarklets\", businessId, chatId, token],\n    enabled: !!businessId && !!chatId && !!token,\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center\">\n        <div className=\"text-center space-y-3\">\n          <Loader2 className=\"w-8 h-8 text-primary animate-spin mx-auto\" />\n          <p className=\"text-sm text-muted-foreground\">Loading bookmarklets...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (error || !data) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n        <Card className=\"p-6 max-w-md w-full text-center space-y-4\">\n          <AlertCircle className=\"w-10 h-10 text-destructive mx-auto\" />\n          <h2 className=\"text-lg font-semibold\" data-testid=\"text-error-title\">Link Expired or Invalid</h2>\n          <p className=\"text-sm text-muted-foreground\" data-testid=\"text-error-message\">\n            This bookmarklet link may have expired. Please visit your dashboard to get a fresh link.\n          </p>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <nav className=\"border-b\">\n        <div className=\"max-w-2xl mx-auto px-4 sm:px-6 h-14 flex items-center gap-2\">\n          <Eye className=\"w-5 h-5 text-primary\" />\n          <span className=\"font-semibold text-lg tracking-tight\">Gemin-Eye</span>\n        </div>\n      </nav>\n\n      <main className=\"max-w-2xl mx-auto px-4 sm:px-6 py-8 space-y-6\">\n        <div className=\"space-y-1\">\n          <h1 className=\"text-2xl font-serif font-bold\" data-testid=\"text-page-title\">Bookmarklet Setup</h1>\n          <p className=\"text-muted-foreground text-sm\" data-testid=\"text-business-name\">\n            for <span className=\"font-medium text-foreground\">{data.businessName}</span>\n          </p>\n        </div>\n\n        <Card className=\"p-5 space-y-4\">\n          <h2 className=\"font-semibold flex items-center gap-2\">\n            <BookmarkIcon className=\"w-4 h-4 text-primary\" />\n            How to Install\n          </h2>\n          <div className=\"space-y-4\">\n            <div className=\"flex items-start gap-3\">\n              <div className=\"w-7 h-7 rounded-full bg-primary/10 flex items-center justify-center shrink-0 mt-0.5\">\n                <span className=\"text-xs font-bold text-primary\">1</span>\n              </div>\n              <div>\n                <p className=\"text-sm font-medium\">Copy the bookmarklet code</p>\n                <p className=\"text-xs text-muted-foreground\">Use the copy button below for Facebook or LinkedIn</p>\n              </div>\n            </div>\n            <div className=\"flex items-start gap-3\">\n              <div className=\"w-7 h-7 rounded-full bg-primary/10 flex items-center justify-center shrink-0 mt-0.5\">\n                <span className=\"text-xs font-bold text-primary\">2</span>\n              </div>\n              <div>\n                <p className=\"text-sm font-medium\">Create a new bookmark in your browser</p>\n                <p className=\"text-xs text-muted-foreground\">Right-click your bookmarks bar and choose \"Add page\" or \"Add bookmark\"</p>\n              </div>\n            </div>\n            <div className=\"flex items-start gap-3\">\n              <div className=\"w-7 h-7 rounded-full bg-primary/10 flex items-center justify-center shrink-0 mt-0.5\">\n                <span className=\"text-xs font-bold text-primary\">3</span>\n              </div>\n              <div>\n                <p className=\"text-sm font-medium\">Paste the code as the URL</p>\n                <p className=\"text-xs text-muted-foreground\">Name it \"Gemin-Eye FB\" or \"Gemin-Eye LinkedIn\", then paste the copied code into the URL field</p>\n              </div>\n            </div>\n            <div className=\"flex items-start gap-3\">\n              <div className=\"w-7 h-7 rounded-full bg-primary/10 flex items-center justify-center shrink-0 mt-0.5\">\n                <span className=\"text-xs font-bold text-primary\">4</span>\n              </div>\n              <div>\n                <p className=\"text-sm font-medium\">Click the bookmark while on Facebook or LinkedIn</p>\n                <p className=\"text-xs text-muted-foreground\">Navigate to a Facebook group or your LinkedIn feed, then click the bookmark to start scanning</p>\n              </div>\n            </div>\n          </div>\n        </Card>\n\n        <Card className=\"p-5 space-y-4\">\n          <div className=\"flex items-center gap-2\">\n            <SiFacebook className=\"w-4 h-4 text-[#1877F2]\" />\n            <h2 className=\"font-semibold\">Facebook Scanner</h2>\n            <Badge variant=\"secondary\" className=\"text-xs\">Groups</Badge>\n          </div>\n          <p className=\"text-xs text-muted-foreground\">\n            Scans Facebook group posts for potential leads and sends matches to your Telegram.\n          </p>\n          <div className=\"bg-muted/50 p-3 rounded-md\">\n            <code className=\"text-xs break-all text-muted-foreground select-all block max-h-20 overflow-y-auto\" data-testid=\"text-facebook-code\">\n              {data.facebookCode}\n            </code>\n          </div>\n          <CopyButton code={data.facebookCode} label=\"Facebook\" testId=\"button-copy-facebook\" />\n        </Card>\n\n        <Card className=\"p-5 space-y-4\">\n          <div className=\"flex items-center gap-2\">\n            <SiLinkedin className=\"w-4 h-4 text-[#0A66C2]\" />\n            <h2 className=\"font-semibold\">LinkedIn Scanner</h2>\n            <Badge variant=\"secondary\" className=\"text-xs\">Feed</Badge>\n          </div>\n          <p className=\"text-xs text-muted-foreground\">\n            Scans your LinkedIn feed for potential leads and sends matches to your Telegram.\n          </p>\n          <div className=\"bg-muted/50 p-3 rounded-md\">\n            <code className=\"text-xs break-all text-muted-foreground select-all block max-h-20 overflow-y-auto\" data-testid=\"text-linkedin-code\">\n              {data.linkedinCode}\n            </code>\n          </div>\n          <CopyButton code={data.linkedinCode} label=\"LinkedIn\" testId=\"button-copy-linkedin\" />\n        </Card>\n      </main>\n    </div>\n  );\n}\n","path":null,"size_bytes":7759,"size_tokens":null}},"version":2}